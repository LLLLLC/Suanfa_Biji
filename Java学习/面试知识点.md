# 1.æ•°æ®ç»“æ„

## 1.1 æ ‘

### 1.1.1 å‰ä¸­ååºéå†

### 1.1.2 DFS BFS

### 1.1.3 å±‚æ¬¡éå†

### 1.1.4 å“ˆå¤«æ›¼æ ‘

## 1.2 å›¾

### 1.2.1 å›¾çš„DFS BFS

### 1.2.2 æœ€å°ç”Ÿæˆæ ‘

### 1.2.3 æœ€çŸ­è·¯å¾„

## 1.3 æ’åºç®—æ³•

### 1.3.1 æ’å…¥ç±»æ’åºç®—æ³•

### 1.3.2 é€‰æ‹©ç±»æ’åº

### 1.3.3 äº¤æ¢ç±»æ’åº

### 1.3.4 å…¶ä»–æ’åº

## 1.4 æŸ¥æ‰¾æ–¹æ³•

### 1.4.1 å¹³è¡¡äºŒå‰æ ‘ çº¢é»‘æ ‘

#### ä»€ä¹ˆæ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Ÿ

å¹³è¡¡äºŒå‰æ ‘åˆç§°ä¸ºAVLæ ‘ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ’åºæ ‘ã€‚å…¶å·¦å³å­æ ‘éƒ½æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œä¸”å·¦å³å­æ ‘çš„é«˜åº¦ä¹‹å·®é¥¿ç»å¯¹å€¼ä¸è¶…è¿‡1ã€‚ä¸€å¥è¯è¡¨è¿°ä¸ºï¼šä»¥ä¹¦ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„æ ¹çš„å·¦å³å­æ ‘çš„é«˜åº¦ä¹‹å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ã€‚

#### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¢é»‘æ ‘ï¼Ÿ

å› ä¸ºï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½é€€åŒ–ä¸ºçº¿æ€§ã€‚

åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘å¢åˆ æŸ¥æ”¹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)ï¼ˆå…¶ä¸­Nä¸ºèŠ‚ç‚¹æ•°ï¼‰ï¼Œæœ€åçš„æƒ…å†µä¸‹ä¸ºO(N)ã€‚å½“å®ƒçš„é«˜åº¦ä¸ºlogN+1æ—¶ï¼Œæˆ‘ä»¬å°±è¯´äºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ã€‚

![v2-e64df5b2126506c59bad4604d298d818_1440w.png](./images/v2-e64df5b2126506c59bad4604d298d818_1440w.png)

åŸºäºBSTå­˜åœ¨çš„é—®é¢˜ï¼Œä¸€ç§æ–°çš„æ ‘â€”â€”å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘(Balanced BST)äº§ç”Ÿäº†ã€‚å¹³è¡¡æ ‘åœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ—‹è½¬æ“ä½œå°†é«˜åº¦ä¿æŒåœ¨logNã€‚å…¶ä¸­ä¸¤æ¬¾å…·æœ‰ä»£è¡¨æ€§çš„å¹³è¡¡æ ‘åˆ†åˆ«ä¸ºAVLæ ‘å’Œçº¢é»‘æ ‘ã€‚AVLæ ‘ç”±äºå®ç°æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”æ’å…¥å’Œåˆ é™¤æ€§èƒ½å·®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸‹çš„åº”ç”¨ä¸å¦‚çº¢é»‘æ ‘ã€‚

#### ä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿï¼ˆè‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼‰

1.èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚

2.æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚

3.æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ç©ºèŠ‚ç‚¹ï¼ˆNILèŠ‚ç‚¹ï¼‰ã€‚

4 æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²ã€‚(ä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹)

5.ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚

**å› ä¸ºè¿™äº›è§„åˆ™çš„é™åˆ¶ï¼Œæ‰ä¿è¯äº†çº¢é»‘æ ‘çš„è‡ªå¹³è¡¡ã€‚çº¢é»‘æ ‘ä»æ ¹åˆ°å¶å­çš„æœ€é•¿è·¯å¾„ä¸ä¼šè¶…è¿‡æœ€çŸ­è·¯å¾„çš„2å€ã€‚**

çº¢é»‘æ ‘ç»´æŒè‡ªèº«æ€§è´¨çš„ä¸¤å¤§æ–¹å¼ï¼š

- è‡ªæ—‹ï¼ˆå·¦æ—‹å’Œå³æ—‹ï¼‰
- å˜è‰²

### 1.4.2 Bæ ‘ B+æ ‘ 

###  1.4.3 å“ˆå¸Œè¡¨

# 2. è®¡ç®—æœºç½‘ç»œ

## 2.1 IP

### 2.11 RIP  ä¸ OSPF

å…ˆäº†è§£åç§°ï¼š

- RIPï¼ˆè·¯ç”±ä¿¡æ¯åè®®ï¼‰â€”â€”åˆ†å¸ƒå¼çš„åŸºäºè·ç¦»å‘é‡çš„è·¯ç”±é€‰æ‹©åè®®ï¼›
- OSPFï¼ˆå¼€æ”¾æœ€çŸ­è·¯å¾„ä¼˜å…ˆåè®®ï¼‰â€”â€” ä½¿ç”¨åˆ†å¸ƒå¼çš„åŸºäºé“¾è·¯çŠ¶æ€çš„è·¯ç”±é€‰æ‹©åè®®

å·¥ä½œæ ¸å¿ƒä¸åŒï¼š

- RIPï¼šæ•°è·³æ•°ï¼›
- OSPFï¼šè®¡ç®—é“¾è·¯çš„åº¦é‡å€¼

å‘è°å‘ï¼Ÿ

- RIPï¼šä»…å’Œ**ç›¸é‚»è·¯ç”±å™¨**äº¤æ¢ä¿¡æ¯ï¼›
- OSPFï¼šå‘æœ¬è‡ªæ²»ç³»ç»Ÿ**æ‰€æœ‰è·¯ç”±å™¨**å‘é€æ¶ˆæ¯ï¼Œç”±äºè·¯ç”±å™¨å‘é€çš„é“¾è·¯çŠ¶æ€ä¿¡æ¯åªèƒ½å•å‘ä¼ é€ï¼ŒOSPFä¸å­˜åœ¨â€œåæ¶ˆæ¯ä¼ æ’­å¾—æ…¢â€çš„é—®é¢˜ï¼Œæ›´æ–°è¿‡ç¨‹çš„æ”¶æ•›æ€§å¾—åˆ°ä¿è¯ã€‚

å‘ä»€ä¹ˆï¼Ÿ

- RIPï¼šè·¯ç”±å™¨äº¤æ¢çš„ä¿¡æ¯æ˜¯å½“å‰**æœ¬è·¯ç”±å™¨**æ‰€çŸ¥é“çš„å…¨éƒ¨ä¿¡æ¯ï¼Œå³è‡ªå·±ç°åœ¨çš„è·¯ç”±è¡¨
- OSPFï¼šå‘é€çš„ä¿¡æ¯æ˜¯ä¸æœ¬è·¯ç”±å™¨**ç›¸é‚»çš„æ‰€æœ‰è·¯ç”±å™¨**çš„é“¾è·¯çŠ¶æ€ ï¼Œåªæ¶‰åŠä¸ç›¸é‚»è·¯ç”±å™¨çš„è¿é€šçŠ¶æ€ï¼Œä¸æ•´ä¸ªäº’è”ç½‘çš„è§„æ¨¡æ— å…³ã€‚

ä»€ä¹ˆæ—¶å€™å‘ï¼Ÿ

- RIPï¼šæŒ‰å›ºå®šçš„æ—¶é—´é—´éš”äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼ˆå½“ç½‘ç»œæ‹“æ‰‘å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè·¯ç”±å™¨ä¹ŸåŠæ—¶å‘ç›¸é‚»è·¯ç”±å™¨é€šå‘Šæ‹“æ‰‘å˜åŒ–åçš„è·¯ç”±ä¿¡æ¯ï¼‰

- OSPFï¼šåœ¨ç½‘ç»œåˆšåˆšå¯åŠ¨è®¡ç®—ç¬¬ä¸€æ¬¡è·¯ç”±è¡¨æ—¶ï¼Œä¸€å®šå‘è·¯ç”±ä¿¡æ¯ã€‚åªæœ‰å½“é“¾è·¯çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè·¯ç”±å™¨æ‰èƒ½å‘æ‰€æœ‰è·¯ç”±å™¨ç”¨æ´ªæ³›æ³•å‘é€æ­¤æ¶ˆæ¯ã€‚ï¼ˆé“¾è·¯çŠ¶æ€ï¼šè¯´æ˜æœ¬è·¯ç”±å™¨éƒ½å’Œå“ªäº›è·¯ç”±å™¨ç›¸é‚»ä»¥åŠè¯¥é“¾è·¯çš„åº¦é‡ï¼‰

èŒƒå›´;

- RIPï¼šé™åˆ¶äº†ç½‘ç»œè§„æ¨¡ï¼Œèƒ½ä½¿ç”¨çš„æœ€å¤§è·ç¦»ä¸º15,16è¡¨ç¤ºä¸å¯è¾¾
- OSPFï¼šé“¾è·¯çš„åº¦é‡å¯ä»¥æ˜¯1~65 535ä¸­çš„ä»»ä½•ä¸€ä¸ªæ— é‡çº²çš„æ•°ï¼Œå¯ä¾›ç®¡ç†äººå‘˜æ¥å†³å®šã€‚å› æ­¤ååˆ†çµæ´»ã€‚

æ•°æ®åŒ…ä¼ è¾“å±‚ï¼š

- RIPåè®®ä½¿ç”¨è¿è¾“å±‚çš„ç”¨æˆ·æ•°æ®åŒ…UDPæ¥è¿›è¡Œä¼ é€
- OSPFçš„ä½ç½®åœ¨ç½‘ç»œå±‚ï¼Œç›´æ¥ç”¨IPæ•°æ®æŠ¥ä¼ é€(å…¶IPæ•°æ®æŠ¥é¦–éƒ¨çš„åè®®å­—æ®µå€¼ä¸º89)ã€‚ç”±äºOSPFæ„æˆçš„æ•°æ®æŠ¥å¾ˆçŸ­ï¼Œä¸ä»…å‡å°‘äº†è·¯ç”±ä¿¡æ¯çš„é€šä¿¡é‡ï¼Œè€Œä¸”åœ¨ä¼ é€ä¸­ä¸å¿…åˆ†ç‰‡ï¼Œä¸ä¼šå‡ºç°ä¸€ç‰‡ä¸¢å¤±è€Œé‡ä¼ æ•´ä¸ªæ•°æ®æŠ¥çš„ç°è±¡ã€‚

### 2.1.2 å¿ƒè·³åŒ…

å¿ƒè·³åŒ…å°±æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´å®šæ—¶é€šçŸ¥å¯¹æ–¹è‡ªå·±çŠ¶æ€çš„ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„å‘½ä»¤å­—ï¼ŒæŒ‰ç…§ä¸€å®šçš„æ—¶é—´é—´éš”å‘é€ï¼Œç±»ä¼¼äºå¿ƒè·³ï¼Œæ‰€ä»¥å«åšå¿ƒè·³åŒ…ã€‚

æ‰€è°“çš„å¿ƒè·³åŒ…å°±æ˜¯å®¢æˆ·ç«¯å®šæ—¶å‘é€ç®€å•çš„ä¿¡æ¯ç»™æœåŠ¡å™¨ç«¯å‘Šè¯‰å®ƒæˆ‘è¿˜åœ¨è€Œå·²ã€‚ä»£ç å°±æ˜¯æ¯éš”å‡ åˆ†é’Ÿå‘é€ä¸€ä¸ªå›ºå®šä¿¡æ¯ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åå›å¤ä¸€ä¸ªå›ºå®šä¿¡æ¯ã€‚å¦‚æœæœåŠ¡ç«¯å‡ åˆ†é’Ÿå†…æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯ä¿¡æ¯åˆ™è§†å®¢æˆ·ç«¯æ–­å¼€

è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„å¿ƒè·³åŒ…çš„é€»è¾‘ï¼š

![QQå›¾ç‰‡20211008072359.png](./images/QQå›¾ç‰‡20211008072359.png)



## 2.2 TCP

## 2.3 åº”ç”¨å±‚

### 2.3.1  http1.0 å’Œ http1.1æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

é•¿è¿æ¥ï¼š

- åœ¨HTTP1.1ä¸­é»˜è®¤å¼€å¯é•¿è¿æ¥keep-aliveï¼Œä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†HTTP1.0æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ›å»ºè¿æ¥çš„ç¼ºç‚¹ã€‚HTTP1.0éœ€è¦ä½¿ç”¨keep-aliveå‚æ•°æ¥å‘ŠçŸ¥æœåŠ¡å™¨ç«¯è¦å»ºç«‹ä¸€ä¸ªé•¿è¿æ¥ã€‚

èŠ‚çº¦å¸¦å®½ï¼š

- HTTP1.0ä¸­å­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªæ˜¯éœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œå¹¶ä¸”ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ã€‚HTTP1.1æ”¯æŒåªå‘é€headerä¿¡æ¯ï¼ˆä¸å¸¦ä»»ä½•bodyä¿¡æ¯ï¼‰ï¼Œå¦‚æœæœåŠ¡å™¨è®¤ä¸ºå®¢æˆ·ç«¯æœ‰æƒé™è¯·æ±‚æœåŠ¡å™¨ï¼Œåˆ™è¿”å›100ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°100æ‰å¼€å§‹æŠŠè¯·æ±‚bodyå‘é€åˆ°æœåŠ¡å™¨ï¼›å¦‚æœè¿”å›401ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ä¸ç”¨å‘é€è¯·æ±‚bodyäº†èŠ‚çº¦äº†å¸¦å®½ã€‚

HOSTåŸŸï¼š

- åœ¨HTTP1.0ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œå› æ­¤ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼ˆhostnameï¼‰ï¼ŒHTTP1.0æ²¡æœ‰hoståŸŸã€‚éšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼ˆMulti-homed Web Serversï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€ã€‚HTTP1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯éƒ½æ”¯æŒhoståŸŸï¼Œä¸”è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœæ²¡æœ‰hoståŸŸä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼ˆ400 Bad Requestï¼‰ã€‚

ç¼“å­˜å¤„ç†ï¼š

- åœ¨HTTP1.0ä¸­ä¸»è¦ä½¿ç”¨headeré‡Œçš„If-Modified-Since,Expiresæ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP1.1åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¾‹å¦‚Entity tagï¼ŒIf-Unmodified-Since, If-Match, If-None-Matchç­‰æ›´å¤šå¯ä¾›é€‰æ‹©çš„ç¼“å­˜å¤´æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚

é”™è¯¯é€šçŸ¥çš„ç®¡ç†ï¼šï¼ˆå¢åŠ äº†çŠ¶æ€ç ï¼‰

- åœ¨HTTP1.1ä¸­æ–°å¢äº†24ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ï¼Œå¦‚409ï¼ˆConflictï¼‰è¡¨ç¤ºè¯·æ±‚çš„èµ„æºä¸èµ„æºçš„å½“å‰çŠ¶æ€å‘ç”Ÿå†²çªï¼›410ï¼ˆGoneï¼‰è¡¨ç¤ºæœåŠ¡å™¨ä¸Šçš„æŸä¸ªèµ„æºè¢«æ°¸ä¹…æ€§çš„åˆ é™¤ã€‚

### 2.3.2 HTTP1.1å’ŒHTTP2.0çš„åŒºåˆ«

å¤šè·¯å¤ç”¨

- HTTP2.0ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œåšåˆ°åŒä¸€ä¸ªè¿æ¥å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”å¹¶å‘è¯·æ±‚çš„æ•°é‡æ¯”HTTP1.1å¤§äº†å¥½å‡ ä¸ªæ•°é‡çº§ã€‚HTTP1.1ä¹Ÿå¯ä»¥å¤šå»ºç«‹å‡ ä¸ªTCPè¿æ¥ï¼Œæ¥æ”¯æŒå¤„ç†æ›´å¤šå¹¶å‘çš„è¯·æ±‚ï¼Œä½†æ˜¯åˆ›å»ºTCPè¿æ¥æœ¬èº«ä¹Ÿæ˜¯æœ‰å¼€é”€çš„ã€‚

å¤´éƒ¨æ•°æ®å‹ç¼©ï¼š

-  HTTP1.1ä¸æ”¯æŒheaderæ•°æ®çš„å‹ç¼©ï¼ŒHTTP2.0ä½¿ç”¨HPACKç®—æ³•å¯¹headerçš„æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œè¿™æ ·æ•°æ®ä½“ç§¯å°äº†ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“å°±ä¼šæ›´å¿«ã€‚å¯¹Cookieï¼ŒUserAgentç­‰å†…å®¹è¿›è¡Œå‹ç¼©ã€‚

**æ–°çš„äºŒè¿›åˆ¶æ ¼å¼**ï¼ˆBinary Formatï¼‰ï¼š

- HTTP1.xçš„è§£ææ˜¯åŸºäºæ–‡æœ¬ã€‚åŸºäºæ–‡æœ¬åè®®çš„æ ¼å¼è§£æå­˜åœ¨å¤©ç„¶ç¼ºé™·ï¼Œæ–‡æœ¬çš„è¡¨ç°å½¢å¼æœ‰å¤šæ ·æ€§ï¼Œè¦åšåˆ°å¥å£®æ€§è€ƒè™‘çš„åœºæ™¯å¿…ç„¶å¾ˆå¤šï¼ŒäºŒè¿›åˆ¶åˆ™ä¸åŒï¼Œåªè®¤0å’Œ1çš„ç»„åˆã€‚åŸºäºè¿™ç§è€ƒè™‘HTTP2.0çš„åè®®è§£æå†³å®šé‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ç°æ–¹ä¾¿ä¸”å¥å£®ã€‚

æœåŠ¡å™¨æ¨é€ï¼š

       æœåŠ¡ç«¯æ¨é€æ˜¯ä¸€ç§åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¹‹å‰å‘é€æ•°æ®çš„æœºåˆ¶ã€‚ç½‘é¡µä½¿ç”¨äº†è®¸å¤šèµ„æºï¼šHTMLã€æ ·å¼è¡¨ã€è„šæœ¬ã€å›¾ç‰‡ç­‰ç­‰ã€‚åœ¨HTTP1.1ä¸­è¿™äº›èµ„æºæ¯ä¸€ä¸ªéƒ½å¿…é¡»æ˜ç¡®åœ°è¯·æ±‚ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆæ…¢çš„è¿‡ç¨‹ã€‚æµè§ˆå™¨ä»è·å–HTMLå¼€å§‹ï¼Œç„¶ååœ¨å®ƒè§£æå’Œè¯„ä¼°é¡µé¢çš„æ—¶å€™ï¼Œå¢é‡åœ°è·å–æ›´å¤šçš„èµ„æºã€‚å› ä¸ºæœåŠ¡å™¨å¿…é¡»ç­‰å¾…æµè§ˆå™¨åšæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œç½‘ç»œç»å¸¸æ˜¯ç©ºé—²çš„å’Œæœªå……åˆ†ä½¿ç”¨çš„ã€‚
    
       ä¸ºäº†æ”¹å–„å»¶è¿Ÿï¼ŒHTTP2.0å¼•å…¥äº†server pushï¼Œå®ƒå…è®¸æœåŠ¡ç«¯æ¨é€èµ„æºç»™æµè§ˆå™¨ï¼Œåœ¨æµè§ˆå™¨æ˜ç¡®åœ°è¯·æ±‚ä¹‹å‰ï¼Œå…å¾—å®¢æˆ·ç«¯å†æ¬¡åˆ›å»ºè¿æ¥å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ç«¯è·å–ã€‚è¿™æ ·å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä»æœ¬åœ°åŠ è½½è¿™äº›èµ„æºï¼Œä¸ç”¨å†é€šè¿‡ç½‘ç»œ
![20190730231423477.jpg](./images/20190730231423477.jpg)



### 2.3.3 **HTTP2.0çš„å¤šè·¯å¤ç”¨å’ŒHTTP1.Xä¸­çš„é•¿è¿æ¥å¤ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

- HTTP/1.* ä¸€æ¬¡è¯·æ±‚-å“åº”ï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œç”¨å®Œå…³é—­ï¼›æ¯ä¸€ä¸ªè¯·æ±‚éƒ½è¦å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼›
- HTTP/1.1 Pipelingè§£å†³æ–¹å¼ä¸ºï¼Œè‹¥å¹²ä¸ªè¯·æ±‚æ’é˜Ÿä¸²è¡ŒåŒ–å•çº¿ç¨‹å¤„ç†ï¼Œåé¢çš„è¯·æ±‚ç­‰å¾…å‰é¢è¯·æ±‚çš„è¿”å›æ‰èƒ½è·å¾—æ‰§è¡Œæœºä¼šï¼Œä¸€æ—¦æœ‰æŸè¯·æ±‚è¶…æ—¶ç­‰ï¼Œåç»­è¯·æ±‚åªèƒ½è¢«é˜»å¡ï¼Œæ¯«æ— åŠæ³•ï¼Œä¹Ÿå°±æ˜¯äººä»¬å¸¸è¯´çš„çº¿å¤´é˜»å¡ï¼›
- HTTP/2å¤šä¸ªè¯·æ±‚å¯åŒæ—¶åœ¨ä¸€ä¸ªè¿æ¥ä¸Šå¹¶è¡Œæ‰§è¡Œã€‚æŸä¸ªè¯·æ±‚ä»»åŠ¡è€—æ—¶ä¸¥é‡ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒè¿æ¥çš„æ­£å¸¸æ‰§è¡Œï¼›å…·ä½“å¦‚å›¾ï¼š

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2017/8/3/718e6c0340dc43ff55af6f7f08965256~tplv-t2oaga2asx-watermark.awebp)



### 2.3.3 httpå’Œhttpsæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œç½‘ç»œå®‰å…¨å…³å¿ƒä¸‰ä¸ªé—®é¢˜ï¼šä¿å¯†æ€§ã€å®Œæ•´æ€§ã€å¯ç”¨æ€§ï¼ˆCIA confidentiality, integrity, availability)

HTTPSç¼ºçœå·¥ä½œåœ¨TCPåè®®443ç«¯å£ï¼Œå®ƒçš„å·¥ä½œæµç¨‹ä¸€èˆ¬å¦‚ä»¥ä¸‹æ–¹å¼ï¼š

- 1ï¼‰ å®ŒæˆTCPä¸‰æ¬¡åŒæ­¥æ¡æ‰‹
- 2ï¼‰ å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨æ•°å­—è¯ä¹¦ï¼Œé€šè¿‡ï¼Œè¿›å…¥æ­¥éª¤3
- 3ï¼‰ DHç®—æ³•åå•†å¯¹ç§°åŠ å¯†ç®—æ³•çš„å¯†é’¥ã€hashç®—æ³•çš„å¯†é’¥
- 4ï¼‰ SSLå®‰å…¨åŠ å¯†éš§é“åå•†å®Œæˆ
- 5ï¼‰ç½‘é¡µä»¥åŠ å¯†çš„æ–¹å¼ä¼ è¾“ï¼Œç”¨åå•†çš„å¯¹ç§°åŠ å¯†ç®—æ³•å’Œå¯†é’¥åŠ å¯†ï¼Œä¿è¯æ•°æ®æœºå¯†æ€§ï¼›ç”¨åå•†çš„hashç®—æ³•è¿›è¡Œæ•°æ®å®Œæ•´æ€§ä¿æŠ¤ï¼Œä¿è¯æ•°æ®ä¸è¢«ç¯¡æ”¹

å¦‚æœHTTPSæ˜¯ç½‘é“¶æœåŠ¡ï¼Œä»¥ä¸ŠSSLå®‰å…¨éš§é“æˆåŠŸå»ºç«‹æ‰ä¼šè¦æ±‚ç”¨æˆ·è¾“å…¥è´¦æˆ·ä¿¡æ¯ï¼Œè´¦æˆ·ä¿¡æ¯æ˜¯åœ¨å®‰å…¨éš§é“é‡Œä¼ è¾“ï¼Œæ‰€ä»¥ä¸ä¼šæ³„å¯†ï¼

ç«¯å£ä¸åŒï¼š

- http 80ç«¯å£
- https 443 ç«¯å£

ä¼ è¾“ä¿¡æ¯å®‰å…¨æ€§ä¸åŒ:

- 1ã€httpåè®®ï¼šæ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œä¿¡æ¯æ˜¯æ˜æ–‡ä¼ è¾“ã€‚å¦‚æœæ”»å‡»è€…æˆªå–äº†Webæµè§ˆå™¨å’Œç½‘ç«™æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“æŠ¥æ–‡ï¼Œå°±å¯ä»¥ç›´æ¥è¯»æ‡‚å…¶ä¸­çš„ä¿¡æ¯ã€‚
- 2ã€httpsåè®®ï¼šæ˜¯å…·æœ‰å®‰å…¨æ€§çš„sslåŠ å¯†ä¼ è¾“åè®®ï¼Œä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡åŠ å¯†ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“çš„å®‰å…¨ã€‚

![d01373f082025aaf65da6a13f5edab64024f1a79.png](./images/d01373f082025aaf65da6a13f5edab64024f1a79.png)

è¿æ¥æ–¹å¼ä¸åŒ:

- 1ã€httpåè®®ï¼šhttpçš„è¿æ¥å¾ˆç®€å•ï¼Œæ˜¯æ— çŠ¶æ€çš„ã€‚
- 2ã€httpsåè®®ï¼šæ˜¯ç”±SSLï¼‹HTTPåè®®æ„å»ºçš„å¯è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€èº«ä»½è®¤è¯çš„ç½‘ç»œåè®®ã€‚

è¯ä¹¦ç”³è¯·æ–¹å¼ä¸åŒï¼š

- 1ã€httpåè®®ï¼šå…è´¹ç”³è¯·ã€‚
- 2ã€httpsåè®®ï¼šéœ€è¦åˆ°caç”³è¯·è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦å¾ˆå°‘ï¼Œéœ€è¦äº¤è´¹ã€‚

# 3.MySQL

## 3.1 MySQLç´¢å¼•

### 3.1.1 ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ

ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®åº“ç»“æ„ï¼Œç”±æ•°æ®è¡¨ä¸­çš„ä¸€åˆ—æˆ–å¤šåˆ—ç»„åˆè€Œæˆï¼Œå¯ä»¥ç”¨æ¥å¿«é€ŸæŸ¥è¯¢æ•°æ®è¡¨ä¸­æœ‰æŸä¸€ç‰¹å®šå€¼çš„è®°å½•ã€‚æœ¬èŠ‚å°†è¯¦ç»†è®²è§£ç´¢å¼•çš„å«ä¹‰ã€ä½œç”¨å’Œä¼˜ç¼ºç‚¹ã€‚

é€šè¿‡ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•°æ®æ—¶ä¸ç”¨è¯»å®Œè®°å½•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè€Œåªæ˜¯æŸ¥è¯¢ç´¢å¼•åˆ—ã€‚å¦åˆ™ï¼Œæ•°æ®åº“ç³»ç»Ÿå°†è¯»å–æ¯æ¡è®°å½•çš„æ‰€æœ‰ä¿¡æ¯è¿›è¡ŒåŒ¹é…ã€‚

å¯ä»¥æŠŠç´¢å¼•æ¯”ä½œæ–°åå­—å…¸çš„éŸ³åºè¡¨ã€‚ä¾‹å¦‚ï¼Œè¦æŸ¥â€œåº“â€å­—ï¼Œå¦‚æœä¸ä½¿ç”¨éŸ³åºï¼Œå°±éœ€è¦ä»å­—å…¸çš„ 400 é¡µä¸­é€é¡µæ¥æ‰¾ã€‚ä½†æ˜¯ï¼Œå¦‚æœæå–æ‹¼éŸ³å‡ºæ¥ï¼Œæ„æˆéŸ³åºè¡¨ï¼Œå°±åªéœ€è¦ä» 10 å¤šé¡µçš„éŸ³åºè¡¨ä¸­ç›´æ¥æŸ¥æ‰¾ã€‚è¿™æ ·å°±å¯ä»¥å¤§å¤§èŠ‚çœæ—¶é—´ã€‚

å› æ­¤ï¼Œä½¿ç”¨ç´¢å¼•å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜æ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œè¿˜æœ‰æ•ˆçš„æé«˜äº†æ•°æ®åº“ç³»ç»Ÿçš„æ€§èƒ½ã€‚

### 3.1.2 ä¸ºä»€ä¹ˆä½¿ç”¨ç´¢å¼•ï¼Ÿ

ç´¢å¼•å°±æ˜¯æ ¹æ®è¡¨ä¸­çš„ä¸€åˆ—æˆ–è‹¥å¹²åˆ—æŒ‰ç…§ä¸€å®šé¡ºåºå»ºç«‹çš„åˆ—å€¼ä¸è®°å½•è¡Œä¹‹é—´çš„å¯¹åº”å…³ç³»è¡¨ï¼Œå®è´¨ä¸Šæ˜¯ä¸€å¼ æè¿°ç´¢å¼•åˆ—çš„åˆ—å€¼ä¸åŸè¡¨ä¸­è®°å½•è¡Œä¹‹é—´ä¸€ ä¸€å¯¹åº”å…³ç³»çš„æœ‰åºè¡¨ã€‚

ç´¢å¼•æ˜¯ MySQL ä¸­ååˆ†é‡è¦çš„æ•°æ®åº“å¯¹è±¡ï¼Œæ˜¯æ•°æ®åº“æ€§èƒ½è°ƒä¼˜æŠ€æœ¯çš„åŸºç¡€ï¼Œå¸¸ç”¨äºå®ç°æ•°æ®çš„å¿«é€Ÿæ£€ç´¢ã€‚

åœ¨ MySQL ä¸­ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼è®¿é—®æ•°æ®åº“è¡¨çš„è¡Œæ•°æ®ï¼š

#### 1) é¡ºåºè®¿é—®

é¡ºåºè®¿é—®æ˜¯åœ¨è¡¨ä¸­å®è¡Œå…¨è¡¨æ‰«æï¼Œä»å¤´åˆ°å°¾é€è¡Œéå†ï¼Œç›´åˆ°åœ¨æ— åºçš„è¡Œæ•°æ®ä¸­æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ•°æ®ã€‚

é¡ºåºè®¿é—®å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å½“è¡¨ä¸­æœ‰å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚ä¾‹å¦‚ï¼Œåœ¨å‡ åƒä¸‡æ¡æ•°æ®ä¸­æŸ¥æ‰¾å°‘é‡çš„æ•°æ®æ—¶ï¼Œä½¿ç”¨é¡ºåºè®¿é—®æ–¹å¼å°†ä¼šéå†æ‰€æœ‰çš„æ•°æ®ï¼ŒèŠ±è´¹å¤§é‡çš„æ—¶é—´ï¼Œæ˜¾ç„¶ä¼šå½±å“æ•°æ®åº“çš„å¤„ç†æ€§èƒ½ã€‚

#### 2) ç´¢å¼•è®¿é—®

ç´¢å¼•è®¿é—®æ˜¯é€šè¿‡éå†ç´¢å¼•æ¥ç›´æ¥è®¿é—®è¡¨ä¸­è®°å½•è¡Œçš„æ–¹å¼ã€‚

ä½¿ç”¨è¿™ç§æ–¹å¼çš„å‰ææ˜¯å¯¹è¡¨å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œåœ¨åˆ—ä¸Šåˆ›å»ºäº†ç´¢å¼•ä¹‹åï¼ŒæŸ¥æ‰¾æ•°æ®æ—¶å¯ä»¥ç›´æ¥æ ¹æ®è¯¥åˆ—ä¸Šçš„ç´¢å¼•æ‰¾åˆ°å¯¹åº”è®°å½•è¡Œçš„ä½ç½®ï¼Œä»è€Œå¿«æ·åœ°æŸ¥æ‰¾åˆ°æ•°æ®ã€‚ç´¢å¼•å­˜å‚¨äº†æŒ‡å®šåˆ—æ•°æ®å€¼çš„æŒ‡é’ˆï¼Œæ ¹æ®æŒ‡å®šçš„æ’åºé¡ºåºå¯¹è¿™äº›æŒ‡é’ˆæ’åºã€‚

ä¾‹å¦‚ï¼Œåœ¨å­¦ç”ŸåŸºæœ¬ä¿¡æ¯è¡¨ tb_students ä¸­ï¼Œå¦‚æœåŸºäº student_id å»ºç«‹äº†ç´¢å¼•ï¼Œç³»ç»Ÿå°±å»ºç«‹äº†ä¸€å¼ ç´¢å¼•åˆ—åˆ°å®é™…è®°å½•çš„æ˜ å°„è¡¨ã€‚å½“ç”¨æˆ·éœ€è¦æŸ¥æ‰¾ student_id ä¸º 12022 çš„æ•°æ®çš„æ—¶å€™ï¼Œç³»ç»Ÿå…ˆåœ¨ student_id ç´¢å¼•ä¸Šæ‰¾åˆ°è¯¥è®°å½•ï¼Œç„¶åé€šè¿‡æ˜ å°„è¡¨ç›´æ¥æ‰¾åˆ°æ•°æ®è¡Œï¼Œå¹¶ä¸”è¿”å›è¯¥è¡Œæ•°æ®ã€‚å› ä¸ºæ‰«æç´¢å¼•çš„é€Ÿåº¦ä¸€èˆ¬è¿œè¿œå¤§äºæ‰«æå®é™…æ•°æ®è¡Œçš„é€Ÿåº¦ï¼Œæ‰€ä»¥é‡‡ç”¨ç´¢å¼•çš„æ–¹å¼å¯ä»¥å¤§å¤§æé«˜æ•°æ®åº“çš„å·¥ä½œæ•ˆç‡ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œä¸ä½¿ç”¨ç´¢å¼•ï¼ŒMySQL å°±å¿…é¡»ä»ç¬¬ä¸€æ¡è®°å½•å¼€å§‹è¯»å®Œæ•´ä¸ªè¡¨ï¼Œç›´åˆ°æ‰¾å‡ºç›¸å…³çš„è¡Œã€‚è¡¨è¶Šå¤§ï¼ŒæŸ¥è¯¢æ•°æ®æ‰€èŠ±è´¹çš„æ—¶é—´å°±è¶Šå¤šã€‚å¦‚æœè¡¨ä¸­æŸ¥è¯¢çš„åˆ—æœ‰ä¸€ä¸ªç´¢å¼•ï¼ŒMySQL å°±èƒ½å¿«é€Ÿåˆ°è¾¾ä¸€ä¸ªä½ç½®å»æœç´¢æ•°æ®æ–‡ä»¶ï¼Œè€Œä¸å¿…æŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼Œè¿™æ ·å°†ä¼šèŠ‚çœå¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´ã€‚

### 3.1.3 ç´¢å¼•çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

ç´¢å¼•æœ‰å…¶æ˜æ˜¾çš„ä¼˜åŠ¿ï¼Œä¹Ÿæœ‰å…¶ä¸å¯é¿å…çš„ç¼ºç‚¹ã€‚

#### a) ä¼˜ç‚¹

ç´¢å¼•çš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š

- é€šè¿‡åˆ›å»ºå”¯ä¸€ç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ã€‚
- å¯ä»¥ç»™æ‰€æœ‰çš„ MySQL åˆ—ç±»å‹è®¾ç½®ç´¢å¼•ã€‚
- å¯ä»¥å¤§å¤§åŠ å¿«æ•°æ®çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œè¿™æ˜¯ä½¿ç”¨ç´¢å¼•æœ€ä¸»è¦çš„åŸå› ã€‚
- åœ¨å®ç°æ•°æ®çš„å‚è€ƒå®Œæ•´æ€§æ–¹é¢å¯ä»¥åŠ é€Ÿè¡¨ä¸è¡¨ä¹‹é—´çš„è¿æ¥ã€‚
- åœ¨ä½¿ç”¨åˆ†ç»„å’Œæ’åºå­å¥è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ä¹Ÿå¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´

#### b) ç¼ºç‚¹

å¢åŠ ç´¢å¼•ä¹Ÿæœ‰è®¸å¤šä¸åˆ©çš„æ–¹é¢ï¼Œä¸»è¦å¦‚ä¸‹ï¼š

- åˆ›å»ºå’Œç»´æŠ¤ç´¢å¼•ç»„è¦è€—è´¹æ—¶é—´ï¼Œå¹¶ä¸”éšç€æ•°æ®é‡çš„å¢åŠ æ‰€è€—è´¹çš„æ—¶é—´ä¹Ÿä¼šå¢åŠ ã€‚
- ç´¢å¼•éœ€è¦å ç£ç›˜ç©ºé—´ï¼Œé™¤äº†æ•°æ®è¡¨å æ•°æ®ç©ºé—´ä»¥å¤–ï¼Œæ¯ä¸€ä¸ªç´¢å¼•è¿˜è¦å ä¸€å®šçš„ç‰©ç†ç©ºé—´ã€‚å¦‚æœæœ‰å¤§é‡çš„ç´¢å¼•ï¼Œç´¢å¼•æ–‡ä»¶å¯èƒ½æ¯”æ•°æ®æ–‡ä»¶æ›´å¿«è¾¾åˆ°æœ€å¤§æ–‡ä»¶å°ºå¯¸ã€‚
- å½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€ç»´æŠ¤ï¼Œè¿™æ ·å°±é™ä½äº†æ•°æ®çš„ç»´æŠ¤é€Ÿåº¦ã€‚


ä½¿ç”¨ç´¢å¼•æ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘ç´¢å¼•çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚

ç´¢å¼•å¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯ä¼šå½±å“æ’å…¥è®°å½•çš„é€Ÿåº¦ã€‚å› ä¸ºï¼Œå‘æœ‰ç´¢å¼•çš„è¡¨ä¸­æ’å…¥è®°å½•æ—¶ï¼Œæ•°æ®åº“ç³»ç»Ÿä¼šæŒ‰ç…§ç´¢å¼•è¿›è¡Œæ’åºï¼Œè¿™æ ·å°±é™ä½äº†æ’å…¥è®°å½•çš„é€Ÿåº¦ï¼Œæ’å…¥å¤§é‡è®°å½•æ—¶çš„é€Ÿåº¦å½±å“ä¼šæ›´åŠ æ˜æ˜¾ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å…ˆåˆ é™¤è¡¨ä¸­çš„ç´¢å¼•ï¼Œç„¶åæ’å…¥æ•°æ®ï¼Œæ’å…¥å®Œæˆåï¼Œå†åˆ›å»ºç´¢å¼•ã€‚



### 3.1.4 B+æ ‘æœ‰ä»€ä¹ˆç‰¹ç‚¹

#### B+æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ˜¯å¤šå°‘ï¼Ÿ



#### ä¸ºä»€ä¹ˆè¦ç”¨B+æ ‘åšç´¢å¼•ï¼ŸB+æ ‘æœ‰ä»€ä¹ˆä¼˜ç‚¹?

è¿™é‡Œè‚¯å®šå°±æ˜¯è¦è¯´ä¸€ä¸‹å…¶ä»–æ•°æ®ç»“æ„çš„ç¼ºç‚¹äº†ã€‚

**äºŒå‰æŸ¥æ‰¾æ ‘**

äºŒå‰æŸ¥æ‰¾æ ‘BSTå¯èƒ½é•¿æ­ªè€Œå˜å¾—ä¸å¹³è¡¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ­¤æ—¶BSTé€€åŒ–ä¸ºé“¾è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦é€€åŒ–ä¸ºO(n)ã€‚

![v2-e64df5b2126506c59bad4604d298d818_1440w.png](./images/v2-e64df5b2126506c59bad4604d298d818_1440w.png)

å› æ­¤å°±æœ‰äº†**å¹³è¡¡äºŒå‰æ ‘(AVL)**ï¼ŒAVLæ ‘æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤åœ¨å¹³å‡å’Œæœ€åæƒ…å†µä¸‹éƒ½æ˜¯O(lgn)ã€‚

AVLå®ç°å¹³è¡¡çš„å…³é”®åœ¨äºæ—‹è½¬æ“ä½œï¼šæ’å…¥å’Œåˆ é™¤å¯èƒ½ç ´åäºŒå‰æ ‘çš„å¹³è¡¡ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡ä¸€æ¬¡æˆ–å¤šæ¬¡æ ‘æ—‹è½¬æ¥é‡æ–°å¹³è¡¡è¿™ä¸ªæ ‘ã€‚å½“æ’å…¥æ•°æ®æ—¶ï¼Œæœ€å¤šåªéœ€è¦1æ¬¡æ—‹è½¬(å•æ—‹è½¬æˆ–åŒæ—‹è½¬)ï¼›ä½†æ˜¯å½“åˆ é™¤æ•°æ®æ—¶ï¼Œä¼šå¯¼è‡´æ ‘å¤±è¡¡ï¼ŒAVLéœ€è¦ç»´æŠ¤ä»è¢«åˆ é™¤èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹è¿™æ¡è·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„å¹³è¡¡ï¼Œæ—‹è½¬çš„é‡çº§ä¸ºO(lgn)ã€‚ç”±äºæ—‹è½¬çš„è€—æ—¶ï¼ŒAVLæ ‘åœ¨åˆ é™¤æ•°æ®æ—¶æ•ˆç‡å¾ˆä½ï¼›åœ¨åˆ é™¤æ“ä½œè¾ƒå¤šæ—¶ï¼Œç»´æŠ¤å¹³è¡¡æ‰€éœ€çš„ä»£ä»·å¯èƒ½é«˜äºå…¶å¸¦æ¥çš„å¥½å¤„ï¼Œå› æ­¤AVLå®é™…ä½¿ç”¨å¹¶ä¸å¹¿æ³›ã€‚

**çº¢é»‘æ ‘**

ä¸AVLæ ‘ç›¸æ¯”ï¼Œçº¢é»‘æ ‘å¹¶ä¸è¿½æ±‚ä¸¥æ ¼çš„å¹³è¡¡ï¼Œè€Œæ˜¯å¤§è‡´çš„å¹³è¡¡ï¼šåªæ˜¯ç¡®ä¿ä»æ ¹åˆ°å¶å­çš„æœ€é•¿çš„å¯èƒ½è·¯å¾„ä¸å¤šäºæœ€çŸ­çš„å¯èƒ½è·¯å¾„çš„ä¸¤å€é•¿ã€‚ä»å®ç°æ¥çœ‹ï¼Œçº¢é»‘æ ‘æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å±äºä¸¤ç§é¢œè‰²(çº¢è‰²æˆ–é»‘è‰²)ä¹‹ä¸€ï¼Œä¸”èŠ‚ç‚¹é¢œè‰²çš„åˆ’åˆ†éœ€è¦æ»¡è¶³ç‰¹å®šçš„è§„åˆ™ã€‚

ä¸AVLæ ‘ç›¸æ¯”ï¼Œçº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡ä¼šæœ‰æ‰€ä¸‹é™ï¼Œè¿™æ˜¯å› ä¸ºæ ‘çš„å¹³è¡¡æ€§å˜å·®ï¼Œé«˜åº¦æ›´é«˜ã€‚ä½†çº¢é»‘æ ‘çš„åˆ é™¤æ•ˆç‡å¤§å¤§æé«˜äº†ï¼Œå› ä¸ºçº¢é»‘æ ‘åŒæ—¶å¼•å…¥äº†é¢œè‰²ï¼Œå½“æ’å…¥æˆ–åˆ é™¤æ•°æ®æ—¶ï¼Œåªéœ€è¦è¿›è¡ŒO(1)æ¬¡æ•°çš„æ—‹è½¬ä»¥åŠå˜è‰²å°±èƒ½ä¿è¯åŸºæœ¬çš„å¹³è¡¡ï¼Œä¸éœ€è¦åƒAVLæ ‘è¿›è¡ŒO(lgn)æ¬¡æ•°çš„æ—‹è½¬ã€‚æ€»çš„æ¥è¯´ï¼Œçº¢é»‘æ ‘çš„ç»Ÿè®¡æ€§èƒ½é«˜äºAVLã€‚å› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒAVLæ ‘çš„ä½¿ç”¨ç›¸å¯¹è¾ƒå°‘ï¼Œè€Œçº¢é»‘æ ‘çš„ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚ä¾‹å¦‚ï¼ŒJavaä¸­çš„TreeMapä½¿ç”¨çº¢é»‘æ ‘å­˜å‚¨æ’åºé”®å€¼å¯¹ï¼›Java8ä¸­çš„HashMapä½¿ç”¨é“¾è¡¨+çº¢é»‘æ ‘è§£å†³å“ˆå¸Œå†²çªé—®é¢˜(å½“å†²çªèŠ‚ç‚¹è¾ƒå°‘æ—¶ï¼Œä½¿ç”¨é“¾è¡¨ï¼Œå½“å†²çªèŠ‚ç‚¹è¾ƒå¤šæ—¶ï¼Œä½¿ç”¨çº¢é»‘æ ‘)ã€‚å¯¹äºæ•°æ®åœ¨å†…å­˜ä¸­çš„æƒ…å†µï¼ˆå¦‚ä¸Šè¿°çš„TreeMapå’ŒHashMapï¼‰ï¼Œçº¢é»‘æ ‘çš„è¡¨ç°æ˜¯éå¸¸ä¼˜å¼‚çš„ã€‚ä½†æ˜¯å¯¹äºæ•°æ®åœ¨ç£ç›˜ç­‰è¾…åŠ©å­˜å‚¨è®¾å¤‡ä¸­çš„æƒ…å†µï¼ˆå¦‚MySQLç­‰æ•°æ®åº“ï¼‰ï¼Œçº¢é»‘æ ‘å¹¶ä¸æ“…é•¿ï¼Œå› ä¸ºçº¢é»‘æ ‘é•¿å¾—è¿˜æ˜¯å¤ªé«˜äº†ã€‚å½“æ•°æ®åœ¨ç£ç›˜ä¸­æ—¶ï¼Œç£ç›˜IOä¼šæˆä¸ºæœ€å¤§çš„æ€§èƒ½ç“¶é¢ˆï¼Œè®¾è®¡çš„ç›®æ ‡åº”è¯¥æ˜¯å°½é‡å‡å°‘IOæ¬¡æ•°ï¼›è€Œæ ‘çš„é«˜åº¦è¶Šé«˜ï¼Œå¢åˆ æ”¹æŸ¥æ‰€éœ€è¦çš„IOæ¬¡æ•°ä¹Ÿè¶Šå¤šï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚

**Bæ ‘**

Bæ ‘ä¹Ÿç§°B-æ ‘(å…¶ä¸­-ä¸æ˜¯å‡å·)ï¼Œæ˜¯ä¸ºç£ç›˜ç­‰è¾…å­˜è®¾å¤‡è®¾è®¡çš„å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œä¸äºŒå‰æ ‘ç›¸æ¯”ï¼ŒBæ ‘çš„æ¯ä¸ªéå¶èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªå­æ ‘ã€‚å› æ­¤ï¼Œå½“æ€»èŠ‚ç‚¹æ•°é‡ç›¸åŒæ—¶ï¼ŒBæ ‘çš„é«˜åº¦è¿œè¿œå°äºAVLæ ‘å’Œçº¢é»‘æ ‘(Bæ ‘æ˜¯ä¸€é¢—â€œçŸ®èƒ–å­â€)ï¼Œç£ç›˜IOæ¬¡æ•°å¤§å¤§å‡å°‘ã€‚

å®šä¹‰Bæ ‘æœ€é‡è¦çš„æ¦‚å¿µæ˜¯é˜¶æ•°(Order)ï¼Œå¯¹äºä¸€é¢—mé˜¶Bæ ‘ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

- æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåŒ…å« m ä¸ªå­èŠ‚ç‚¹ã€‚

- å¦‚æœæ ¹èŠ‚ç‚¹åŒ…å«å­èŠ‚ç‚¹ï¼Œåˆ™è‡³å°‘åŒ…å« 2 ä¸ªå­èŠ‚ç‚¹ï¼›é™¤æ ¹èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸ªéå¶èŠ‚ç‚¹è‡³å°‘åŒ…å« m/2 ä¸ªå­èŠ‚ç‚¹ã€‚

- æ‹¥æœ‰ k ä¸ªå­èŠ‚ç‚¹çš„éå¶èŠ‚ç‚¹å°†åŒ…å« k - 1 æ¡è®°å½•ã€‚

- æ‰€æœ‰å¶èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ä¸­ã€‚

  

å¯ä»¥çœ‹å‡ºï¼ŒBæ ‘çš„å®šä¹‰ï¼Œä¸»è¦æ˜¯å¯¹éå¶ç»“ç‚¹çš„å­èŠ‚ç‚¹æ•°é‡å’Œè®°å½•æ•°é‡çš„é™åˆ¶ã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ª3é˜¶Bæ ‘çš„ä¾‹å­ï¼š

![e8fa533198fb9764bc0e705704b3201b.jpg](./images/e8fa533198fb9764bc0e705704b3201b.jpg)

Bæ ‘çš„ä¼˜åŠ¿é™¤äº†æ ‘é«˜å°ï¼Œè¿˜æœ‰å¯¹è®¿é—®å±€éƒ¨æ€§åŸç†çš„åˆ©ç”¨ã€‚æ‰€è°“å±€éƒ¨æ€§åŸç†ï¼Œæ˜¯æŒ‡å½“ä¸€ä¸ªæ•°æ®è¢«ä½¿ç”¨æ—¶ï¼Œå…¶é™„è¿‘çš„æ•°æ®æœ‰è¾ƒå¤§æ¦‚ç‡åœ¨çŸ­æ—¶é—´å†…è¢«ä½¿ç”¨ã€‚Bæ ‘å°†é”®ç›¸è¿‘çš„æ•°æ®å­˜å‚¨åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“è®¿é—®å…¶ä¸­æŸä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šå°†è¯¥æ•´ä¸ªèŠ‚ç‚¹è¯»åˆ°ç¼“å­˜ä¸­ï¼›å½“å®ƒä¸´è¿‘çš„æ•°æ®ç´§æ¥ç€è¢«è®¿é—®æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨ç¼“å­˜ä¸­è¯»å–ï¼Œæ— éœ€è¿›è¡Œç£ç›˜IOï¼›æ¢å¥è¯è¯´ï¼ŒBæ ‘çš„ç¼“å­˜å‘½ä¸­ç‡æ›´é«˜ã€‚

**B+æ ‘**

B+æ ‘ä¹Ÿæ˜¯å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œå…¶ä¸Bæ ‘çš„åŒºåˆ«ä¸»è¦åœ¨äºï¼š

- Bæ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å¶èŠ‚ç‚¹å’Œéå¶èŠ‚ç‚¹ï¼‰éƒ½å­˜å‚¨çœŸå®çš„æ•°æ®ï¼ŒB+æ ‘ä¸­åªæœ‰å¶å­èŠ‚ç‚¹å­˜å‚¨çœŸå®çš„æ•°æ®ï¼Œéå¶èŠ‚ç‚¹åªå­˜å‚¨é”®ã€‚åœ¨MySQLä¸­ï¼Œè¿™é‡Œæ‰€è¯´çš„çœŸå®æ•°æ®ï¼Œå¯èƒ½æ˜¯è¡Œçš„å…¨éƒ¨æ•°æ®ï¼ˆå¦‚Innodbçš„èšç°‡ç´¢å¼•ï¼‰ï¼Œä¹Ÿå¯èƒ½åªæ˜¯è¡Œçš„ä¸»é”®ï¼ˆå¦‚Innodbçš„è¾…åŠ©ç´¢å¼•ï¼‰ï¼Œæˆ–è€…æ˜¯è¡Œæ‰€åœ¨çš„åœ°å€ï¼ˆå¦‚MyIsamçš„éèšç°‡ç´¢å¼•ï¼‰ã€‚
- Bæ ‘ä¸­ä¸€æ¡è®°å½•åªä¼šå‡ºç°ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤å‡ºç°ï¼Œè€ŒB+æ ‘çš„é”®åˆ™å¯èƒ½é‡å¤é‡ç°â€”â€”ä¸€å®šä¼šåœ¨å¶èŠ‚ç‚¹å‡ºç°ï¼Œä¹Ÿå¯èƒ½åœ¨éå¶èŠ‚ç‚¹é‡å¤å‡ºç°ã€‚
  B+æ ‘çš„å¶èŠ‚ç‚¹ä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨é“¾æ¥ã€‚
- Bæ ‘ä¸­çš„éå¶èŠ‚ç‚¹ï¼Œè®°å½•æ•°æ¯”å­èŠ‚ç‚¹ä¸ªæ•°å°‘1ï¼›è€ŒB+æ ‘ä¸­è®°å½•æ•°ä¸å­èŠ‚ç‚¹ä¸ªæ•°ç›¸åŒã€‚

B+æ ‘çš„ä¾‹å­ï¼š

![QQæˆªå›¾20211008075736.png](./images/QQæˆªå›¾20211008075736.png)



ç”±æ­¤ï¼ŒB+æ ‘ä¸Bæ ‘ç›¸æ¯”ï¼Œæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- æ›´å°‘çš„IOæ¬¡æ•°ï¼šB+æ ‘çš„éå¶èŠ‚ç‚¹åªåŒ…å«é”®ï¼Œè€Œä¸åŒ…å«çœŸå®æ•°æ®ï¼Œå› æ­¤æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„è®°å½•ä¸ªæ•°æ¯”Bæ•°å¤šå¾ˆå¤šï¼ˆå³é˜¶mæ›´å¤§ï¼‰ï¼Œå› æ­¤B+æ ‘çš„é«˜åº¦æ›´ä½ï¼Œè®¿é—®æ—¶æ‰€éœ€è¦çš„IOæ¬¡æ•°æ›´å°‘ã€‚æ­¤å¤–ï¼Œç”±äºæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„è®°å½•æ•°æ›´å¤šï¼Œæ‰€ä»¥å¯¹è®¿é—®å±€éƒ¨æ€§åŸç†çš„åˆ©ç”¨æ›´å¥½ï¼Œç¼“å­˜å‘½ä¸­ç‡æ›´é«˜ã€‚
- æ›´é€‚äºèŒƒå›´æŸ¥è¯¢ï¼šåœ¨Bæ ‘ä¸­è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆæ‰¾åˆ°è¦æŸ¥æ‰¾çš„ä¸‹é™ï¼Œç„¶åå¯¹Bæ ‘è¿›è¡Œä¸­åºéå†ï¼Œç›´åˆ°æ‰¾åˆ°æŸ¥æ‰¾çš„ä¸Šé™ï¼›è€ŒB+æ ‘çš„èŒƒå›´æŸ¥è¯¢ï¼Œåªéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†å³å¯ã€‚
- æ›´ç¨³å®šçš„æŸ¥è¯¢æ•ˆç‡ï¼šBæ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦åœ¨1åˆ°æ ‘é«˜ä¹‹é—´(åˆ†åˆ«å¯¹åº”è®°å½•åœ¨æ ¹èŠ‚ç‚¹å’Œå¶èŠ‚ç‚¹)ï¼Œè€ŒB+æ ‘çš„æŸ¥è¯¢å¤æ‚åº¦åˆ™ç¨³å®šä¸ºæ ‘é«˜ï¼Œå› ä¸ºæ‰€æœ‰æ•°æ®éƒ½åœ¨å¶èŠ‚ç‚¹ã€‚
  

B+æ ‘ä¹Ÿå­˜åœ¨åŠ£åŠ¿ï¼šç”±äºé”®ä¼šé‡å¤å‡ºç°ï¼Œå› æ­¤ä¼šå ç”¨æ›´å¤šçš„ç©ºé—´ã€‚ä½†æ˜¯ä¸å¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿ç›¸æ¯”ï¼Œç©ºé—´åŠ£åŠ¿å¾€å¾€å¯ä»¥æ¥å—ï¼Œå› æ­¤B+æ ‘çš„åœ¨æ•°æ®åº“ä¸­çš„ä½¿ç”¨æ¯”Bæ ‘æ›´åŠ å¹¿æ³›ã€‚

**æ€»ç»“**

æœ€åï¼Œæ€»ç»“ä¸€ä¸‹å„ç§æ ‘è§£å†³çš„é—®é¢˜ä»¥åŠé¢ä¸´çš„æ–°é—®é¢˜ï¼š

1) äºŒå‰æŸ¥æ‰¾æ ‘(BST)ï¼šè§£å†³äº†æ’åºçš„åŸºæœ¬é—®é¢˜ï¼Œä½†æ˜¯ç”±äºæ— æ³•ä¿è¯å¹³è¡¡ï¼Œå¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ï¼›
2) å¹³è¡¡äºŒå‰æ ‘(AVL)ï¼šé€šè¿‡æ—‹è½¬è§£å†³äº†å¹³è¡¡çš„é—®é¢˜ï¼Œä½†æ˜¯æ—‹è½¬æ“ä½œæ•ˆç‡å¤ªä½ï¼›
3) çº¢é»‘æ ‘ï¼šé€šè¿‡èˆå¼ƒä¸¥æ ¼çš„å¹³è¡¡å’Œå¼•å…¥çº¢é»‘èŠ‚ç‚¹ï¼Œè§£å†³äº†AVLæ—‹è½¬æ•ˆç‡è¿‡ä½çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ç£ç›˜ç­‰åœºæ™¯ä¸‹ï¼Œæ ‘ä»ç„¶å¤ªé«˜ï¼ŒIOæ¬¡æ•°å¤ªå¤šï¼›
4) Bæ ‘ï¼šé€šè¿‡å°†äºŒå‰æ ‘æ”¹ä¸ºå¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œè§£å†³äº†æ ‘è¿‡é«˜çš„é—®é¢˜ï¼›
5) B+æ ‘ï¼šåœ¨Bæ ‘çš„åŸºç¡€ä¸Šï¼Œå°†éå¶èŠ‚ç‚¹æ”¹é€ ä¸ºä¸å­˜å‚¨æ•°æ®çš„çº¯ç´¢å¼•èŠ‚ç‚¹ï¼Œè¿›ä¸€æ­¥é™ä½äº†æ ‘çš„é«˜åº¦ï¼›æ­¤å¤–å°†å¶èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆè¿æ¥æˆé“¾è¡¨ï¼ŒèŒƒå›´æŸ¥è¯¢æ›´åŠ é«˜æ•ˆã€‚

#### ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨ï¼Ÿ

è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§éšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§å¯ä»¥äºå¹³è¡¡æ ‘åª²ç¾çš„å±‚æ¬¡åŒ–é“¾è¡¨ç»“æ„â€”â€”æŸ¥æ‰¾ã€åˆ é™¤ã€æ·»åŠ ç­‰æ“ä½œéƒ½å¯ä»¥åœ¨å¯¹æ•°æœŸæœ›æ—¶é—´ä¸‹å®Œæˆï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„è·³è·ƒè¡¨ä¾‹å­ï¼š

![v2-5dca67ee1b5ca9b08d140feca7cdc373_1440w.jpg](./images/v2-5dca67ee1b5ca9b08d140feca7cdc373_1440w.jpg)

> å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œç„¶åå¯ä»¥æœ‰å‡ å±‚ï¼Œè¿™æ ·å¯ä»¥æ›´ä¸ºå¿«é€Ÿçš„æŸ¥æ‰¾ã€‚

 Redis çš„äº”ç§åŸºæœ¬ç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªå«åš **æœ‰åºåˆ—è¡¨ zset** çš„æ•°æ®ç»“æ„ï¼Œå®ƒç±»ä¼¼äº Java ä¸­çš„ **SortedSet** å’Œ **HashMap** çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª set ä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢åˆå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ªæ’åºçš„æƒé‡å€¼ scoreï¼Œæ¥è¾¾åˆ° **æ’åº** çš„ç›®çš„ã€‚

#### ä¸ºä»€ä¹ˆRedisä½¿ç”¨è·³è·ƒè¡¨

é¦–å…ˆï¼Œå› ä¸º zset è¦æ”¯æŒéšæœºçš„æ’å…¥å’Œåˆ é™¤ï¼Œæ‰€ä»¥å®ƒ **ä¸å®œä½¿ç”¨æ•°ç»„æ¥å®ç°**ï¼Œå…³äºæ’åºé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“å°±æƒ³åˆ° **çº¢é»‘æ ‘/ å¹³è¡¡æ ‘** è¿™æ ·çš„æ ‘å½¢ç»“æ„ï¼Œä¸ºä»€ä¹ˆ Redis ä¸ä½¿ç”¨è¿™æ ·ä¸€äº›ç»“æ„å‘¢ï¼Ÿ

1. **æ€§èƒ½è€ƒè™‘ï¼š** åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ ‘å½¢ç»“æ„éœ€è¦æ‰§è¡Œä¸€äº›ç±»ä¼¼äº rebalance è¿™æ ·çš„å¯èƒ½æ¶‰åŠæ•´æ£µæ ‘çš„æ“ä½œï¼Œç›¸å¯¹æ¥è¯´è·³è·ƒè¡¨çš„å˜åŒ–åªæ¶‰åŠå±€éƒ¨ *(ä¸‹é¢è¯¦ç»†è¯´)*ï¼›

2. **å®ç°è€ƒè™‘ï¼š** åœ¨å¤æ‚åº¦ä¸çº¢é»‘æ ‘ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè·³è·ƒè¡¨å®ç°èµ·æ¥æ›´ç®€å•ï¼Œçœ‹èµ·æ¥ä¹Ÿæ›´åŠ ç›´è§‚ï¼›

3. > éå¸¸çœå†…å­˜çš„**é“¾è¡¨**ï¼ˆä»£ä»·æ˜¯æ€§èƒ½ç•¥ä½ï¼‰

#### è·³è·ƒè¡¨çš„éšæœºå±‚æ•°é—®é¢˜

**è·³è·ƒè¡¨ skiplist** å°±æ˜¯å—åˆ°è¿™ç§å¤šå±‚é“¾è¡¨ç»“æ„çš„å¯å‘è€Œè®¾è®¡å‡ºæ¥çš„ã€‚æŒ‰ç…§ä¸Šé¢ç”Ÿæˆé“¾è¡¨çš„æ–¹å¼ï¼Œä¸Šé¢æ¯ä¸€å±‚é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ˜¯ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œè¿™æ ·æŸ¥æ‰¾è¿‡ç¨‹å°±éå¸¸ç±»ä¼¼äºä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° *O(logn)*ã€‚

ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œå°±ä¼šæ‰“ä¹±ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¸ŠèŠ‚ç‚¹ä¸ªæ•°ä¸¥æ ¼çš„ 2:1 çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè¦ç»´æŒè¿™ç§å¯¹åº”å…³ç³»ï¼Œå°±å¿…é¡»æŠŠæ–°æ’å…¥çš„èŠ‚ç‚¹åé¢çš„æ‰€æœ‰èŠ‚ç‚¹ *ï¼ˆä¹ŸåŒ…æ‹¬æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼‰* é‡æ–°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¼šè®©æ—¶é—´å¤æ‚åº¦é‡æ–°èœ•åŒ–æˆ *O(n)*ã€‚åˆ é™¤æ•°æ®ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ã€‚

> ä½ è¦æ˜¯æ’å…¥ï¼Œä½ ä¸Šé¢çš„å±‚æ•°å‡è®¾æ˜¯ä¸‹é¢çš„ä¸€åŠï¼Œä½ ä¸€æ’å…¥ï¼Œå…¨ä¹±äº†ï¼Œ

**skiplist** ä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œå®ƒä¸è¦æ±‚ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¹‹é—´çš„èŠ‚ç‚¹ä¸ªæ•°æœ‰ä¸¥æ ¼çš„å¯¹åº”å…³ç³»ï¼Œè€Œæ˜¯ **ä¸ºæ¯ä¸ªèŠ‚ç‚¹éšæœºå‡ºä¸€ä¸ªå±‚æ•°(level)**ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹éšæœºå‡ºçš„å±‚æ•°æ˜¯ 3ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒé“¾å…¥åˆ°ç¬¬ 1 å±‚åˆ°ç¬¬ 3 å±‚è¿™ä¸‰å±‚é“¾è¡¨ä¸­ã€‚ä¸ºäº†è¡¨è¾¾æ¸…æ¥šï¼Œä¸‹å›¾å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä¸€æ­¥æ­¥çš„æ’å…¥æ“ä½œä»è€Œå½¢æˆä¸€ä¸ª skiplist çš„è¿‡ç¨‹ï¼š

![v2-f5ee3e457b1db81cd8bc5491f35d68df_1440w.jpg](./images/v2-f5ee3e457b1db81cd8bc5491f35d68df_1440w.jpg)

ä»ä¸Šé¢çš„åˆ›å»ºå’Œæ’å…¥çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆlevelï¼‰æ˜¯éšæœºå‡ºæ¥çš„ï¼Œè€Œä¸”æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å¹¶ä¸ä¼šå½±å“åˆ°å…¶ä»–èŠ‚ç‚¹çš„å±‚æ•°ï¼Œå› æ­¤ï¼Œ**æ’å…¥æ“ä½œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹å‰åçš„æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦å¯¹å¤šä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œè°ƒæ•´**ï¼Œè¿™å°±é™ä½äº†æ’å…¥æ“ä½œçš„å¤æ‚åº¦ã€‚

ç°åœ¨æˆ‘ä»¬å‡è®¾ä»æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„è¿™ä¸ªç»“æ„ä¸­æŸ¥æ‰¾ 23 è¿™ä¸ªä¸å­˜åœ¨çš„æ•°ï¼Œé‚£ä¹ˆæŸ¥æ‰¾è·¯å¾„ä¼šå¦‚ä¸‹å›¾ï¼š

![v2-f27cfe45b653e2737b050089a5ed5919_1440w.jpg](./images/v2-f27cfe45b653e2737b050089a5ed5919_1440w.jpg)



#### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨è·³è·ƒè¡¨ï¼Ÿ

é¦–å…ˆï¼Œè·³è·ƒè¡¨ä¸é€‚ç”¨äºç£ç›˜è¯»å–çš„åœºæ™¯ï¼Œå…¶äºŒï¼Œè·³è·ƒè¡¨çš„æŸ¥æ‰¾æ•ˆç‡ä¸å¦‚B+æ ‘æ•ˆç‡é«˜ï¼Œä¹Ÿä¸å¦‚B+æ ‘ç¨³å®šã€‚

### 3.1.5 mysqlæœ‰å“ªäº›ç´¢å¼•?

#### ä»æ•°æ®ç»“æ„çš„è§’åº¦ï¼š

- B+ æ ‘ç´¢å¼•

- Hash ç´¢å¼•

  > a ä»…ä»…èƒ½æ»¡è¶³"=","IN"å’Œ"<=>"æŸ¥è¯¢ï¼Œä¸èƒ½ä½¿ç”¨èŒƒå›´æŸ¥è¯¢
  > b å…¶æ£€ç´¢æ•ˆç‡éå¸¸é«˜ï¼Œç´¢å¼•çš„æ£€ç´¢å¯ä»¥ä¸€æ¬¡å®šä½ï¼Œä¸åƒB-Tree ç´¢å¼•éœ€è¦ä»æ ¹èŠ‚ç‚¹åˆ°æèŠ‚ç‚¹ï¼Œæœ€åæ‰èƒ½è®¿é—®åˆ°é¡µèŠ‚ç‚¹è¿™æ ·å¤šæ¬¡çš„IOè®¿é—®ï¼Œæ‰€ä»¥ Hash ç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡è¦è¿œé«˜äº B-Tree ç´¢å¼•
  > c åªæœ‰Memoryå­˜å‚¨å¼•æ“æ˜¾ç¤ºæ”¯æŒhashç´¢å¼•

- **FULLTEXT**ç´¢å¼•

- **R-Treeç´¢å¼•**ï¼ˆç”¨äºå¯¹GISæ•°æ®ç±»å‹åˆ›å»ºSPATIALç´¢å¼•ï¼‰

#### ä»ç‰©ç†å­˜å‚¨è§’åº¦ï¼š

##### 1ã€**èšé›†ç´¢å¼•**ï¼ˆclustered indexï¼‰

##### 2ã€**éèšé›†ç´¢å¼•**ï¼ˆnon-clustered indexï¼‰

å®é™…ä¸Šï¼Œå¯ä»¥æŠŠç´¢å¼•ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„ç›®å½•ã€‚å¾®è½¯çš„SQL SERVERæä¾›äº†ä¸¤ç§ç´¢å¼•ï¼šèšé›†ç´¢å¼•ï¼ˆclustered indexï¼Œä¹Ÿç§°èšç±»ç´¢å¼•ã€ç°‡é›†ç´¢å¼•ï¼‰å’Œéèšé›†ç´¢å¼•ï¼ˆnonclustered indexï¼Œä¹Ÿç§°éèšç±»ç´¢å¼•ã€éç°‡é›†ç´¢å¼•ï¼‰ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸¾ä¾‹æ¥è¯´æ˜ä¸€ä¸‹èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„åŒºåˆ«ï¼š

å…¶å®ï¼Œæˆ‘ä»¬çš„æ±‰è¯­å­—å…¸çš„æ­£æ–‡æœ¬èº«å°±æ˜¯ä¸€ä¸ªèšé›†ç´¢å¼•ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬è¦æŸ¥â€œå®‰â€å­—ï¼Œå› ä¸ºâ€œå®‰â€çš„æ‹¼éŸ³æ˜¯â€œanâ€ï¼Œè€ŒæŒ‰ç…§æ‹¼éŸ³æ’åºæ±‰å­—çš„å­—å…¸æ˜¯ä»¥è‹±æ–‡å­—æ¯â€œaâ€å¼€å¤´å¹¶ä»¥â€œzâ€ç»“å°¾çš„ï¼Œé‚£ä¹ˆâ€œå®‰â€å­—å°±è‡ªç„¶åœ°æ’åœ¨å­—å…¸çš„å‰éƒ¨ã€‚å¦‚æœæ‚¨ç¿»å®Œäº†æ‰€æœ‰ä»¥â€œaâ€å¼€å¤´çš„éƒ¨åˆ†ä»ç„¶æ‰¾ä¸åˆ°è¿™ä¸ªå­—ï¼Œé‚£ä¹ˆå°±è¯´æ˜æ‚¨çš„å­—å…¸ä¸­æ²¡æœ‰è¿™ä¸ªå­—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­—å…¸çš„æ­£æ–‡éƒ¨åˆ†æœ¬èº«å°±æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‚¨ä¸éœ€è¦å†å»æŸ¥å…¶ä»–ç›®å½•æ¥æ‰¾åˆ°æ‚¨éœ€è¦æ‰¾çš„å†…å®¹ã€‚æˆ‘ä»¬æŠŠè¿™ç§æ­£æ–‡å†…å®¹æœ¬èº«å°±æ˜¯ä¸€ç§æŒ‰ç…§ä¸€å®šè§„åˆ™æ’åˆ—çš„ç›®å½•ç§°ä¸ºâ€œèšé›†ç´¢å¼•â€ã€‚

å¦‚æœé‡åˆ°ä¸è®¤è¯†çš„å­—ï¼Œä¸çŸ¥é“å®ƒçš„å‘éŸ³ï¼Œè¿™æ—¶å€™ï¼Œéœ€è¦å»æ ¹æ®â€œåæ—éƒ¨é¦–â€æŸ¥åˆ°æ‚¨è¦æ‰¾çš„å­—ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå­—åçš„é¡µç ç›´æ¥ç¿»åˆ°æŸé¡µæ¥æ‰¾åˆ°æ‚¨è¦æ‰¾çš„å­—ã€‚ä½†æ‚¨ç»“åˆâ€œéƒ¨é¦–ç›®å½•â€å’Œâ€œæ£€å­—è¡¨â€è€ŒæŸ¥åˆ°çš„å­—çš„æ’åºå¹¶ä¸æ˜¯çœŸæ­£çš„æ­£æ–‡çš„æ’åºæ–¹æ³•ï¼Œæ¯”å¦‚æ‚¨æŸ¥â€œå¼ â€å­—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æŸ¥éƒ¨é¦–ä¹‹åçš„æ£€å­—è¡¨ä¸­â€œå¼ â€çš„é¡µç æ˜¯672é¡µï¼Œæ£€å­—è¡¨ä¸­â€œå¼ â€çš„ä¸Šé¢æ˜¯â€œé©°â€å­—ï¼Œä½†é¡µç å´æ˜¯63é¡µï¼Œâ€œå¼ â€çš„ä¸‹é¢æ˜¯â€œå¼©â€å­—ï¼Œé¡µé¢æ˜¯390é¡µã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™äº›å­—å¹¶ä¸æ˜¯çœŸæ­£çš„åˆ†åˆ«ä½äºâ€œå¼ â€å­—çš„ä¸Šä¸‹æ–¹ï¼Œç°åœ¨æ‚¨çœ‹åˆ°çš„è¿ç»­çš„â€œé©°ã€å¼ ã€å¼©â€ä¸‰å­—å®é™…ä¸Šå°±æ˜¯ä»–ä»¬åœ¨éèšé›†ç´¢å¼•ä¸­çš„æ’åºï¼Œæ˜¯å­—å…¸æ­£æ–‡ä¸­çš„å­—åœ¨éèšé›†ç´¢å¼•ä¸­çš„æ˜ å°„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥æ‰¾åˆ°æ‚¨æ‰€éœ€è¦çš„å­—ï¼Œä½†å®ƒéœ€è¦ä¸¤ä¸ªè¿‡ç¨‹ï¼Œå…ˆæ‰¾åˆ°ç›®å½•ä¸­çš„ç»“æœï¼Œç„¶åå†ç¿»åˆ°æ‚¨æ‰€éœ€è¦çš„é¡µç ã€‚æˆ‘ä»¬æŠŠè¿™ç§ç›®å½•çº¯ç²¹æ˜¯ç›®å½•ï¼Œæ­£æ–‡çº¯ç²¹æ˜¯æ­£æ–‡çš„æ’åºæ–¹å¼ç§°ä¸ºâ€œéèšé›†ç´¢å¼•â€ã€‚

é€šè¿‡ä»¥ä¸Šä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£åˆ°ä»€ä¹ˆæ˜¯â€œèšé›†ç´¢å¼•â€å’Œâ€œéèšé›†ç´¢å¼•â€ã€‚è¿›ä¸€æ­¥å¼•ç”³ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„ç†è§£ï¼šæ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œå› ä¸ºç›®å½•åªèƒ½æŒ‰ç…§ä¸€ç§æ–¹æ³•è¿›è¡Œæ’åºã€‚
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

##### èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„åŒºåˆ«å¦‚ä¸‹ï¼š

  ã€€ã€€1) **èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„æ ¹æœ¬åŒºåˆ«æ˜¯è¡¨è®°å½•çš„æ’åˆ—é¡ºåºå’Œä¸ç´¢å¼•çš„æ’åˆ—é¡ºåºæ˜¯å¦ä¸€è‡´**ï¼Œèšé›†ç´¢å¼•è¡¨è®°å½•çš„æ’åˆ—é¡ºåºä¸ç´¢å¼•çš„æ’åˆ—é¡ºåºä¸€è‡´ï¼Œä¼˜ç‚¹æ˜¯æŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œå› ä¸ºä¸€æ—¦å…·æœ‰ç¬¬ä¸€ä¸ªç´¢å¼•å€¼çš„çºªå½•è¢«æ‰¾åˆ°ï¼Œå…·æœ‰è¿ç»­ç´¢å¼•å€¼çš„è®°å½•ä¹Ÿä¸€å®šç‰©ç†çš„ç´§è·Ÿå…¶åã€‚
        ã€€ã€€2) **èšé›†ç´¢å¼•çš„ç¼ºç‚¹æ˜¯å¯¹è¡¨è¿›è¡Œä¿®æ”¹é€Ÿåº¦è¾ƒæ…¢**ï¼Œè¿™æ˜¯ä¸ºäº†ä¿æŒè¡¨ä¸­çš„è®°å½•çš„ç‰©ç†é¡ºåºä¸ç´¢å¼•çš„é¡ºåºä¸€è‡´ï¼Œè€ŒæŠŠè®°å½•æ’å…¥åˆ°æ•°æ®é¡µçš„ç›¸åº”ä½ç½®ï¼Œå¿…é¡»åœ¨æ•°æ®é¡µä¸­è¿›è¡Œæ•°æ®é‡æ’ï¼Œé™ä½äº†æ‰§è¡Œé€Ÿåº¦ã€‚**éèšé›†ç´¢å¼•æŒ‡å®šäº†è¡¨ä¸­è®°å½•çš„é€»è¾‘é¡ºåºï¼Œä½†è®°å½•çš„ç‰©ç†é¡ºåºå’Œç´¢å¼•çš„é¡ºåºä¸ä¸€è‡´ï¼Œèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•éƒ½é‡‡ç”¨äº†B+æ ‘çš„ç»“æ„ï¼Œä½†éèšé›†ç´¢å¼•çš„å¶å­å±‚å¹¶ä¸ä¸å®é™…çš„**

##### åŒºåˆ«ï¼š

- èšé›†ç´¢å¼•ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œè€Œéèšé›†ç´¢å¼•ä¸€ä¸ªè¡¨å¯ä»¥å­˜åœ¨å¤šä¸ª
  èšé›†ç´¢å¼•å­˜å‚¨è®°å½•æ˜¯ç‰©ç†ä¸Šè¿ç»­å­˜åœ¨ï¼Œè€Œéèšé›†ç´¢å¼•æ˜¯é€»è¾‘ä¸Šçš„è¿ç»­ï¼Œç‰©ç†å­˜å‚¨å¹¶ä¸è¿ç»­
  èšé›†ç´¢å¼•:ç‰©ç†å­˜å‚¨æŒ‰ç…§ç´¢å¼•æ’åºï¼›èšé›†ç´¢å¼•æ˜¯ä¸€ç§ç´¢å¼•ç»„ç»‡å½¢å¼ï¼Œç´¢å¼•çš„é”®å€¼é€»è¾‘é¡ºåºå†³å®šäº†è¡¨æ•°æ®è¡Œçš„ç‰©ç†å­˜å‚¨é¡ºåºã€‚
  éèšé›†ç´¢å¼•:ç‰©ç†å­˜å‚¨ä¸æŒ‰ç…§ç´¢å¼•æ’åºï¼›éèšé›†ç´¢å¼•åˆ™å°±æ˜¯æ™®é€šç´¢å¼•äº†ï¼Œä»…ä»…åªæ˜¯å¯¹æ•°æ®åˆ—åˆ›å»ºç›¸åº”çš„ç´¢å¼•ï¼Œä¸å½±å“æ•´ä¸ªè¡¨çš„ç‰©ç†å­˜å‚¨é¡ºåºã€‚
  ç´¢å¼•æ˜¯é€šè¿‡äºŒå‰æ ‘çš„æ•°æ®ç»“æ„æ¥æè¿°çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£èšç°‡ç´¢å¼•ï¼šç´¢å¼•çš„å¶èŠ‚ç‚¹å°±æ˜¯æ•°æ®èŠ‚ç‚¹ã€‚è€Œéèšç°‡ç´¢å¼•çš„å¶èŠ‚ç‚¹ä»ç„¶æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œåªä¸è¿‡æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„æ•°æ®å—ã€‚

##### ä¼˜åŠ¿ä¸ç¼ºç‚¹ï¼š

- èšé›†ç´¢å¼•æ’å…¥æ•°æ®æ—¶é€Ÿåº¦è¦æ…¢ï¼ˆæ—¶é—´èŠ±è´¹åœ¨â€œç‰©ç†å­˜å‚¨çš„æ’åºâ€ä¸Šï¼Œä¹Ÿå°±æ˜¯é¦–å…ˆè¦æ‰¾åˆ°ä½ç½®ç„¶åæ’å…¥ï¼‰ï¼ŒæŸ¥è¯¢æ•°æ®æ¯”éèšé›†æ•°æ®çš„é€Ÿåº¦å¿«ã€‚

##### ä½•æ—¶ä½¿ç”¨èšé›†ç´¢å¼•æˆ–éèšé›†ç´¢å¼•?

| åŠ¨ä½œæè¿°           | ä½¿ç”¨èšé›†ç´¢å¼• | ä½¿ç”¨éèšé›†ç´¢å¼• |
| ------------------ | ------------ | -------------- |
| åˆ—ç»å¸¸è¢«åˆ†ç»„æ’åº   | åº”           | åº”             |
| è¿”å›æŸèŒƒå›´å†…çš„æ•°æ® | åº”           | ä¸åº”           |
| ä¸€ä¸ªæˆ–æå°‘ä¸åŒå€¼   | ä¸åº”         | ä¸åº”           |
| å°æ•°ç›®çš„ä¸åŒå€¼     | åº”           | ä¸åº”           |
| å¤§æ•°ç›®çš„ä¸åŒå€¼     | ä¸åº”         | åº”             |
| é¢‘ç¹æ›´æ–°çš„åˆ—       | ä¸åº”         | åº”             |
| å¤–é”®åˆ—             | åº”           | åº”             |
| ä¸»é”®åˆ—             | åº”           | åº”             |
| é¢‘ç¹ä¿®æ”¹ç´¢å¼•åˆ—     | ä¸åº”         | åº”             |

#### ä»é€»è¾‘è§’åº¦ï¼š

1ã€**ä¸»é”®ç´¢å¼•**ï¼šä¸»é”®ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸æœ‰ç©ºå€¼

2ã€**æ™®é€šç´¢å¼•æˆ–è€…å•åˆ—ç´¢å¼•**

3ã€**å¤åˆç´¢å¼•ï¼šå¤åˆç´¢å¼•æŒ‡å¤šä¸ªå­—æ®µä¸Šåˆ›å»ºçš„ç´¢å¼•ï¼Œåªæœ‰åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­ä½¿ç”¨äº†åˆ›å»ºç´¢å¼•æ—¶çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œç´¢å¼•æ‰ä¼šè¢«ä½¿ç”¨ã€‚ä½¿ç”¨å¤åˆç´¢å¼•æ—¶éµå¾ªæœ€å·¦å‰ç¼€é›†åˆã€‚

4ã€**å”¯ä¸€ç´¢å¼•**æˆ–è€…éå”¯ä¸€ç´¢å¼•

5ã€**ç©ºé—´ç´¢å¼•**ï¼šç©ºé—´ç´¢å¼•æ˜¯å¯¹ç©ºé—´æ•°æ®ç±»å‹çš„å­—æ®µå»ºç«‹çš„ç´¢å¼•ï¼ŒMYSQLä¸­çš„ç©ºé—´æ•°æ®ç±»å‹æœ‰4ç§ï¼Œåˆ†åˆ«æ˜¯GEOMETRYã€POINTã€LINESTRINGã€POLYGONã€‚MYSQLä½¿ç”¨SPATIALå…³é”®å­—è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—èƒ½å¤Ÿç”¨äºåˆ›å»ºæ­£è§„ç´¢å¼•ç±»å‹çš„è¯­æ³•åˆ›å»ºç©ºé—´ç´¢å¼•ã€‚åˆ›å»ºç©ºé—´ç´¢å¼•çš„åˆ—ï¼Œå¿…é¡»å°†å…¶å£°æ˜ä¸ºNOT NULLï¼Œç©ºé—´ç´¢å¼•åªèƒ½åœ¨å­˜å‚¨å¼•æ“ä¸ºMYISAMçš„è¡¨ä¸­åˆ›å»º

### 3.1.6 è¯´ä¸€è¯´è”åˆç´¢å¼•å’Œè¦†ç›–ç´¢å¼•?

**è”åˆç´¢å¼•ï¼š**
å°±æ˜¯ç”±å¤šåˆ—ç»„æˆçš„çš„ç´¢å¼•ã€‚éµå¾ªæœ€å·¦å‰ç¼€è§„åˆ™ã€‚å¯¹whereï¼Œorder byï¼Œgroup by éƒ½ç”Ÿæ•ˆã€‚

**è¦†ç›–ç´¢å¼•ï¼š**
æŒ‡ä»è¾…åŠ©ç´¢å¼•ä¸­å°±èƒ½è·å–åˆ°éœ€è¦çš„è®°å½•ï¼Œè€Œä¸éœ€è¦æŸ¥æ‰¾èšç°‡ç´¢å¼•ä¸­çš„è®°å½•ã€‚ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„ä¸€ä¸ªå¥½å¤„æ˜¯å› ä¸ºè¾…åŠ©ç´¢å¼•ä¸åŒ…æ‹¬ä¸€æ¡è®°å½•çš„æ•´è¡Œä¿¡æ¯ï¼Œæ‰€ä»¥æ•°æ®é‡è¾ƒèšé›†ç´¢å¼•è¦å°‘ï¼Œå¯ä»¥å‡å°‘å¤§é‡ioæ“ä½œã€‚

### 3.1.7 mysqlä½¿ç”¨B+æ ‘ç´¢å¼•è€Œä¸ä½¿ç”¨Bæ ‘æˆ–è€…hashç´¢å¼•?

### 3.1.8 ç´¢å¼•çš„æŸ¥è¯¢è§„åˆ™ä»¥åŠç´¢å¼•å¤±æ•ˆ

**ç´¢å¼•æŸ¥è¯¢è§„åˆ™ï¼š**

- å”¯ä¸€æ€§ç´¢å¼•

- ä¸ºç»å¸¸æ’åºï¼Œåˆ†ç»„ï¼Œè”åˆæŸ¥è¯¢ï¼ˆå¤–é”®ï¼‰çš„å­—æ®µå»ºç«‹ç´¢å¼•

- ä¸ºç»å¸¸æŸ¥è¯¢çš„å­—æ®µå»ºç«‹ç´¢å¼•

- å°½é‡ä½¿ç”¨æ•°æ®é‡å°‘çš„ç´¢å¼•å­—æ®µ

- é™åˆ¶ç´¢å¼•çš„æ•°é‡

- å°½é‡ä½¿ç”¨å‰ç¼€æ¥ç´¢å¼•

- åˆ é™¤ä¸å†ä½¿ç”¨æˆ–å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•

- **æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™**

  mysqlä¼šä¸€ç›´å‘å³åŒ¹é…åˆ¶å¯¼é‡åˆ°èŒƒå›´æŸ¥è¯¢ï¼ˆ> < between likeï¼‰å°±åœæ­¢åŒ¹é…ã€‚ä¾‹å¦‚æŸ¥è¯¢a=1,b=5,c<8,d=9ï¼ŒåŒæ—¶å»ºç«‹äº†ï¼ˆa,b,c,dï¼‰å¤åˆç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ã€‚å¦‚æœå»ºç«‹ï¼ˆa,b,d,cï¼‰é¡ºåºç´¢å¼•a,b,dé¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚

- =å’Œinå¯ä»¥ä¹±åº

- å°½é‡é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•

- ç´¢å¼•åˆ—ä¸èƒ½å‚ä¸è¿ç®—

- å°½é‡å°½é‡æ‰©å±•ç´¢å¼•ï¼Œä¸è¦æ–°å»ºç´¢å¼•

**ç´¢å¼•å¤±æ•ˆ**

ä»€ä¹ˆæ—¶å€™æ²¡ç”¨ï¼Ÿ

- **ä½¿ç”¨!= æˆ–è€… <> å¯¼è‡´ç´¢å¼•å¤±æ•ˆ**

- **ç±»å‹ä¸ä¸€è‡´å¯¼è‡´çš„ç´¢å¼•å¤±æ•ˆ**ï¼ˆä½ ç´¢å¼•intï¼Œä½ ç”¨charæ¥ç›¸ç­‰ï¼‰

- **å‡½æ•°å¯¼è‡´çš„ç´¢å¼•å¤±æ•ˆ**

- **è¿ç®—ç¬¦å¯¼è‡´çš„ç´¢å¼•å¤±æ•ˆ**

- **ORå¼•èµ·çš„ç´¢å¼•å¤±æ•ˆ** 

  ORå¯¼è‡´ç´¢å¼•æ˜¯åœ¨ç‰¹å®šæƒ…å†µä¸‹çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ORéƒ½æ˜¯ä½¿ç´¢å¼•å¤±æ•ˆï¼Œå¦‚æœORè¿æ¥çš„æ˜¯åŒä¸€ä¸ªå­—æ®µï¼Œé‚£ä¹ˆç´¢å¼•ä¸ä¼šå¤±æ•ˆï¼Œåä¹‹ç´¢å¼•å¤±æ•ˆã€‚

- **æ¨¡ç³Šæœç´¢å¯¼è‡´çš„ç´¢å¼•å¤±æ•ˆ**

- **NOT INã€NOT EXISTSå¯¼è‡´ç´¢å¼•å¤±æ•ˆ**

- **IS NULLä¸èµ°ç´¢å¼•ï¼ŒIS NOT NULLèµ°ç´¢å¼•**

ä»€ä¹ˆæ—¶å€™ä¸ç”¨ç´¢å¼•ï¼Ÿ

1. å”¯ä¸€æ€§å·®;
2. é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸ç”¨ï¼ˆæ›´æ–°ç´¢å¼•æ¶ˆè€—ï¼‰;
3. whereä¸­ä¸ç”¨çš„å­—æ®µ;
4. ç´¢å¼•ä½¿ç”¨<>æ—¶ï¼Œæ•ˆæœä¸€èˆ¬;







## 3.3 MySQLå¼•æ“

### 3.3.1 myISAMå’ŒInnoDBåŒºåˆ«

MySQL 5.5 ä¹‹å‰ï¼ŒMyISAM å¼•æ“æ˜¯ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œå¯è°“æ˜¯é£å…‰ä¸€æ—¶ã€‚

è™½ç„¶ï¼ŒMyISAM çš„æ€§èƒ½è¿˜è¡Œï¼Œå„ç§ç‰¹æ€§ä¹Ÿè¿˜ä¸é”™ï¼ˆæ¯”å¦‚å…¨æ–‡ç´¢å¼•ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°ç­‰ï¼‰ã€‚ä½†æ˜¯ï¼ŒMyISAM ä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œè€Œä¸”æœ€å¤§çš„ç¼ºé™·å°±æ˜¯å´©æºƒåæ— æ³•å®‰å…¨æ¢å¤ã€‚

5.5 ç‰ˆæœ¬ä¹‹åï¼ŒMySQL å¼•å…¥äº† InnoDBï¼ˆäº‹åŠ¡æ€§æ•°æ®åº“å¼•æ“ï¼‰ï¼ŒMySQL 5.5 ç‰ˆæœ¬åé»˜è®¤çš„å­˜å‚¨å¼•æ“ä¸º InnoDBã€‚å°ä¼™å­ï¼Œä¸€å®šè¦è®°å¥½è¿™ä¸ª InnoDB ï¼Œä½ æ¯æ¬¡ä½¿ç”¨ MySQL æ•°æ®åº“éƒ½æ˜¯ç”¨çš„è¿™ä¸ªå­˜å‚¨å¼•æ“å§ï¼Ÿ

è¨€å½’æ­£ä¼ ï¼å’±ä»¬ä¸‹é¢è¿˜æ˜¯æ¥ç®€å•å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…ï¼š

**1.æ˜¯å¦æ”¯æŒè¡Œçº§é”**

MyISAM åªæœ‰è¡¨çº§é”(table-level locking)ï¼Œè€Œ InnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”,é»˜è®¤ä¸ºè¡Œçº§é”ã€‚

ä¹Ÿå°±è¯´ï¼ŒMyISAM ä¸€é”å°±æ˜¯é”ä½äº†æ•´å¼ è¡¨ï¼Œè¿™åœ¨å¹¶å‘å†™çš„æƒ…å†µä¸‹æ˜¯å¤šä¹ˆæ»´æ†¨æ†¨å•Šï¼è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ InnoDB åœ¨å¹¶å‘å†™çš„æ—¶å€™ï¼Œæ€§èƒ½æ›´ç‰›çš®äº†ï¼

**2.æ˜¯å¦æ”¯æŒäº‹åŠ¡**

MyISAM ä¸æä¾›äº‹åŠ¡æ”¯æŒã€‚

InnoDB æä¾›äº‹åŠ¡æ”¯æŒï¼Œå…·æœ‰æäº¤(commit)å’Œå›æ»š(rollback)äº‹åŠ¡çš„èƒ½åŠ›ã€‚

**3.æ˜¯å¦æ”¯æŒå¤–é”®**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š

ä¸€èˆ¬æˆ‘ä»¬ä¹Ÿæ˜¯ä¸å»ºè®®åœ¨æ•°æ®åº“å±‚é¢ä½¿ç”¨å¤–é”®çš„ï¼Œåº”ç”¨å±‚é¢å¯ä»¥è§£å†³ã€‚ä¸è¿‡ï¼Œè¿™æ ·ä¼šå¯¹æ•°æ®çš„ä¸€è‡´æ€§é€ æˆå¨èƒã€‚å…·ä½“è¦ä¸è¦ä½¿ç”¨å¤–é”®è¿˜æ˜¯è¦æ ¹æ®ä½ çš„é¡¹ç›®æ¥å†³å®šã€‚

**4.æ˜¯å¦æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„å®‰å…¨æ¢å¤**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

ä½¿ç”¨ InnoDB çš„æ•°æ®åº“åœ¨å¼‚å¸¸å´©æºƒåï¼Œæ•°æ®åº“é‡æ–°å¯åŠ¨çš„æ—¶å€™ä¼šä¿è¯æ•°æ®åº“æ¢å¤åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ä¾èµ–äº `redo log` ã€‚

ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š

- MySQL InnoDB å¼•æ“ä½¿ç”¨ **redo log(é‡åšæ—¥å¿—)** ä¿è¯äº‹åŠ¡çš„**æŒä¹…æ€§**ï¼Œä½¿ç”¨ **undo log(å›æ»šæ—¥å¿—)** æ¥ä¿è¯äº‹åŠ¡çš„**åŸå­æ€§**ã€‚
- MySQL InnoDB å¼•æ“é€šè¿‡ **é”æœºåˆ¶**ã€**MVCC** ç­‰æ‰‹æ®µæ¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼ˆ é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **`REPEATABLE-READ`** ï¼‰ã€‚
- ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚

**5.æ˜¯å¦æ”¯æŒ MVCC**

MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚

è®²çœŸï¼Œè¿™ä¸ªå¯¹æ¯”æœ‰ç‚¹åºŸè¯ï¼Œæ¯•ç«Ÿ MyISAM è¿è¡Œçº§é”éƒ½ä¸æ”¯æŒã€‚

MVCC å¯ä»¥çœ‹ä½œæ˜¯è¡Œçº§é”çš„ä¸€ä¸ªå‡çº§ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘åŠ é”æ“ä½œï¼Œæä¾›æ€§èƒ½ã€‚

### 3.3.2  é”æœºåˆ¶ä¸ InnoDB é”ç®—æ³•

**MyISAM å’Œ InnoDB å­˜å‚¨å¼•æ“ä½¿ç”¨çš„é”ï¼š**

- MyISAM é‡‡ç”¨è¡¨çº§é”(table-level locking)ã€‚
- InnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”,é»˜è®¤ä¸ºè¡Œçº§é”

**è¡¨çº§é”å’Œè¡Œçº§é”å¯¹æ¯”ï¼š**

- **è¡¨çº§é”ï¼š** MySQL ä¸­é”å®š **ç²’åº¦æœ€å¤§** çš„ä¸€ç§é”ï¼Œå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—ä¹Ÿæ¯”è¾ƒå°‘ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šå‡ºç°æ­»é”ã€‚å…¶é”å®šç²’åº¦æœ€å¤§ï¼Œè§¦å‘é”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼ŒMyISAM å’Œ InnoDB å¼•æ“éƒ½æ”¯æŒè¡¨çº§é”ã€‚
- **è¡Œçº§é”ï¼š** MySQL ä¸­é”å®š **ç²’åº¦æœ€å°** çš„ä¸€ç§é”ï¼Œåªé’ˆå¯¹å½“å‰æ“ä½œçš„è¡Œè¿›è¡ŒåŠ é”ã€‚ è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œå¹¶å‘åº¦é«˜ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‡ºç°æ­»é”ã€‚

**InnoDB å­˜å‚¨å¼•æ“çš„é”çš„ç®—æ³•æœ‰ä¸‰ç§ï¼š**

- Record lockï¼šè®°å½•é”ï¼Œå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”
- Gap lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸åŒ…æ‹¬è®°å½•æœ¬èº«
- Next-key lockï¼šrecord+gap ä¸´é”®é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº«

### 3.3.2 InnoDBçš„æ•°æ®ç»“æ„



## 3.4 æ•°æ®åº“çš„éš”ç¦»çº§åˆ«

SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š

- **READ-UNCOMMITTED(è¯»å–æœªæäº¤)ï¼š** æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œ**å¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»**ã€‚
- **READ-COMMITTED(è¯»å–å·²æäº¤)ï¼š** å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œ**å¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿ**ã€‚
- **REPEATABLE-READ(å¯é‡å¤è¯»)ï¼š** å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œ**å¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿ**ã€‚
- **SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)ï¼š** æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**è¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»**ã€‚

| éš”ç¦»çº§åˆ«         | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| ---------------- | ---- | ---------- | ---- |
| READ-UNCOMMITTED | âˆš    | âˆš          | âˆš    |
| READ-COMMITTED   | Ã—    | âˆš          | âˆš    |
| REPEATABLE-READ  | Ã—    | Ã—          | âˆš    |
| SERIALIZABLE     | Ã—    | Ã—          | Ã—    |

###  3.4.1 MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ?

MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰**ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`SELECT @@tx_isolation;`å‘½ä»¤æ¥æŸ¥çœ‹ï¼ŒMySQL 8.0 è¯¥å‘½ä»¤æ”¹ä¸º`SELECT @@transaction_isolation;`

## 3.5 MySQL äº‹åŠ¡

### 3.5.1 è¯´ä¸€è¯´ä»€ä¹ˆæ˜¯äº‹åŠ¡?

ä¸€è¨€è”½ä¹‹ï¼Œ**äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚**

**å¯ä»¥ç®€å•ä¸¾ä¸€ä¸ªä¾‹å­ä¸ï¼Ÿ**

äº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚å‡å¦‚å°æ˜è¦ç»™å°çº¢è½¬è´¦ 1000 å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œå°±æ˜¯ï¼š

1. å°†å°æ˜çš„ä½™é¢å‡å°‘ 1000 å…ƒ
2. å°†å°çº¢çš„ä½™é¢å¢åŠ  1000 å…ƒã€‚

äº‹åŠ¡ä¼šæŠŠè¿™ä¸¤ä¸ªæ“ä½œå°±å¯ä»¥çœ‹æˆé€»è¾‘ä¸Šçš„ä¸€ä¸ªæ•´ä½“ï¼Œè¿™ä¸ªæ•´ä½“åŒ…å«çš„æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚

è¿™æ ·å°±ä¸ä¼šå‡ºç°å°æ˜ä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢å´å¹¶æ²¡æœ‰å¢åŠ çš„æƒ…å†µã€‚

### 3.5.2 äº‹åŠ¡çš„å››å¤§ç‰¹æ€§  (ACID)

1. **åŸå­æ€§**ï¼ˆ`Atomicity`ï¼‰ ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **ä¸€è‡´æ€§**ï¼ˆ`Consistency`ï¼‰ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œä¾‹å¦‚è½¬è´¦ä¸šåŠ¡ä¸­ï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œè½¬è´¦è€…å’Œæ”¶æ¬¾äººçš„æ€»é¢åº”è¯¥æ˜¯ä¸å˜çš„ï¼›
3. **éš”ç¦»æ€§**ï¼ˆ`Isolation`ï¼‰ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
4. **æŒä¹…æ€§**ï¼ˆ`Durability`ï¼‰ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚

### 3.5.3 æ€ä¹ˆæ ·å®ç°äº‹åŠ¡å‘¢ï¼Ÿ

æˆ‘ä»¬è¿™é‡Œä»¥ MySQL çš„ InnoDB å¼•æ“ä¸ºä¾‹æ¥ç®€å•è¯´ä¸€ä¸‹ã€‚

- MySQL InnoDB å¼•æ“ä½¿ç”¨ **redo log(é‡åšæ—¥å¿—)** ä¿è¯äº‹åŠ¡çš„**æŒä¹…æ€§**ï¼Œä½¿ç”¨ **undo log(å›æ»šæ—¥å¿—)** æ¥ä¿è¯äº‹åŠ¡çš„**åŸå­æ€§**ã€‚
- MySQL InnoDB å¼•æ“é€šè¿‡ **é”æœºåˆ¶**ã€**MVCC** ç­‰æ‰‹æ®µæ¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼ˆ é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **`REPEATABLE-READ`** ï¼‰ã€‚
- ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚

### 3.5.4 å¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ

åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿è¡Œï¼Œç»å¸¸ä¼šæ“ä½œç›¸åŒçš„æ•°æ®æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼ˆå¤šä¸ªç”¨æˆ·å¯¹åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼‰ã€‚å¹¶å‘è™½ç„¶æ˜¯å¿…é¡»çš„ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹çš„é—®é¢˜ã€‚

- **è„è¯»ï¼ˆDirty readï¼‰:** å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°çš„è¿™ä¸ªæ•°æ®æ˜¯â€œè„æ•°æ®â€ï¼Œä¾æ®â€œè„æ•°æ®â€æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚
- **ä¸¢å¤±ä¿®æ”¹ï¼ˆLost to modifyï¼‰:** æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®åï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ã€‚è¿™æ ·ç¬¬ä¸€ä¸ªäº‹åŠ¡å†…çš„ä¿®æ”¹ç»“æœå°±è¢«ä¸¢å¤±ï¼Œå› æ­¤ç§°ä¸ºä¸¢å¤±ä¿®æ”¹ã€‚ ä¾‹å¦‚ï¼šäº‹åŠ¡ 1 è¯»å–æŸè¡¨ä¸­çš„æ•°æ® A=20ï¼Œäº‹åŠ¡ 2 ä¹Ÿè¯»å– A=20ï¼Œäº‹åŠ¡ 1 ä¿®æ”¹ A=A-1ï¼Œäº‹åŠ¡ 2 ä¹Ÿä¿®æ”¹ A=A-1ï¼Œæœ€ç»ˆç»“æœ A=19ï¼Œäº‹åŠ¡ 1 çš„ä¿®æ”¹è¢«ä¸¢å¤±ã€‚
- **ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatable readï¼‰:** æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚è¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚
- **å¹»è¯»ï¼ˆPhantom readï¼‰:** å¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡ï¼ˆT2ï¼‰æ’å…¥äº†ä¸€äº›æ•°æ®æ—¶ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸ºå¹»è¯»ã€‚

**ä¸å¯é‡å¤è¯»å’Œå¹»è¯»åŒºåˆ«ï¼š**

ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°å…¶ä¸­æŸäº›åˆ—çš„å€¼è¢«ä¿®æ”¹ï¼Œå¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°è®°å½•å¢å¤šæˆ–å‡å°‘äº†ã€‚

###  3.5.5 MySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ?

MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰**ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`SELECT @@tx_isolation;`å‘½ä»¤æ¥æŸ¥çœ‹ï¼ŒMySQL 8.0 è¯¥å‘½ä»¤æ”¹ä¸º`SELECT @@transaction_isolation;`

**MySQL InnoDB çš„ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰å¹¶ä¸ä¿è¯é¿å…å¹»è¯»ï¼Œéœ€è¦åº”ç”¨ä½¿ç”¨åŠ é”è¯»æ¥ä¿è¯ã€‚è€Œè¿™ä¸ªåŠ é”åº¦ä½¿ç”¨åˆ°çš„æœºåˆ¶å°±æ˜¯ Next-Key Locksã€‚**

### 3.5.2 æ€æ ·é˜²æ­¢å¤§äº‹åŠ¡ï¼ŒåŠå¤„ç†åŠæ³•

## 3.6 SQL è¯­å¥åŸºç¡€

 left join  full join

## 3.7 æ•°æ®åº“åŸºç¡€

### 3.7.1 æ•°æ®åº“çš„å‡ å¤§èŒƒå¼

- ç¬¬ä¸€èŒƒå¼ï¼šç¡®ä¿åŸå­æ€§ï¼Œç¡®ä¿æ•°æ®æ˜¯ä¸å¯ä»¥å†åˆ†å‰²çš„ï¼Œæ¯”å¦‚åœ°å€å¯ä»¥åˆ†å‰²æˆçœå¸‚å°±ä¸ç¬¦åˆåŸå­æ€§

- ç¬¬äºŒèŒƒå¼ï¼šç¡®ä¿å’Œä¸»é”®ç›¸å…³ï¼Œä¸èƒ½é‡å¤æ€§ï¼Œå¦‚æœæœ‰çš„ä¸œè¥¿å’Œä¸»é”®æ— å…³ï¼Œå°±åº”è¯¥æ‹†å¼€ï¼Œæ¯”å¦‚å®¢æˆ·ä¿¡æ¯å’Œè®¢å•ä¿¡æ¯å°±æ˜¯ä¸ç›¸å…³çš„ã€‚

- ç¬¬ä¸‰èŒƒå¼ï¼šç¡®ä¿éä¼ é€’æ€§ï¼Œç¡®ä¿ä¸»é”®æ˜¯ä¸ä¼ é€’çš„ï¼Œ

  æ¯”å¦‚Studentè¡¨ï¼ˆå­¦å·ï¼Œå§“åï¼Œå¹´é¾„ï¼Œæ€§åˆ«ï¼Œæ‰€åœ¨é™¢æ ¡ï¼Œé™¢æ ¡åœ°å€ï¼Œé™¢æ ¡ç”µè¯ï¼‰

  è¿™æ ·ä¸€ä¸ªè¡¨ç»“æ„ï¼Œå°±å­˜åœ¨ä¸Šè¿°å…³ç³»ã€‚ å­¦å·--> æ‰€åœ¨é™¢æ ¡ --> (é™¢æ ¡åœ°å€ï¼Œé™¢æ ¡ç”µè¯)

  è¿™æ ·çš„è¡¨ç»“æ„ï¼Œæˆ‘ä»¬åº”è¯¥æ‹†å¼€æ¥ï¼Œå¦‚ä¸‹ã€‚

     ï¼ˆå­¦å·ï¼Œå§“åï¼Œå¹´é¾„ï¼Œæ€§åˆ«ï¼Œæ‰€åœ¨é™¢æ ¡ï¼‰--ï¼ˆæ‰€åœ¨é™¢æ ¡ï¼Œé™¢æ ¡åœ°å€ï¼Œé™¢æ ¡ç”µè¯ï¼‰

### 3.7.2  ä»€ä¹ˆæ˜¯ ER å›¾ï¼Ÿ

**E-R å›¾**ä¹Ÿç§°å®ä½“-è”ç³»å›¾(Entity Relationship Diagram)ï¼Œæä¾›äº†è¡¨ç¤ºå®ä½“ç±»å‹ã€å±æ€§å’Œè”ç³»çš„æ–¹æ³•ï¼Œç”¨æ¥æè¿°ç°å®ä¸–ç•Œçš„æ¦‚å¿µæ¨¡å‹ã€‚ å®ƒæ˜¯æè¿°ç°å®ä¸–ç•Œå…³ç³»æ¦‚å¿µæ¨¡å‹çš„æœ‰æ•ˆæ–¹æ³•ã€‚ æ˜¯è¡¨ç¤ºæ¦‚å¿µå…³ç³»æ¨¡å‹çš„ä¸€ç§æ–¹å¼ã€‚

### 3.7.3 SQLçš„å‡ ç§è¿æ¥æ–¹å¼

æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼šä¸¤ä¸ªè¡¨åˆ†åˆ«ä¸ºï¼Œbookè¡¨ï¼Œstuè¡¨

![86735519.jpg.png](./images/031916444725632.png) ![ 031917185195500.png](./images/031917185195500.png)

**1.å†…è¿æ¥**

ä¸»è¦åˆ†ä¸º3ç§ï¼š

1. ç­‰å€¼è¿æ¥ï¼šåœ¨è¿æ¥æ¡ä»¶ä¸­ä½¿ç”¨ç­‰äºå·(=)è¿ç®—ç¬¦æ¯”è¾ƒè¢«è¿æ¥åˆ—çš„åˆ—å€¼ï¼Œå…¶æŸ¥è¯¢ç»“æœä¸­åˆ—å‡ºè¢«è¿æ¥è¡¨ä¸­çš„æ‰€æœ‰åˆ—ï¼ŒåŒ…æ‹¬å…¶ä¸­çš„é‡å¤åˆ—ã€‚
2. ä¸ç­‰å€¼è¿æ¥ï¼šåœ¨è¿æ¥æ¡ä»¶ä½¿ç”¨é™¤ç­‰äºè¿ç®—ç¬¦ä»¥å¤–çš„å…¶å®ƒæ¯”è¾ƒè¿ç®—ç¬¦æ¯”è¾ƒè¢«è¿æ¥çš„åˆ—çš„åˆ—å€¼ã€‚è¿™äº›è¿ç®—ç¬¦åŒ…æ‹¬>ã€>=ã€<=ã€<ã€!>ã€!<å’Œ<>ã€‚
3. è‡ªç„¶è¿æ¥ï¼šåœ¨è¿æ¥æ¡ä»¶ä¸­ä½¿ç”¨ç­‰äº(=)è¿ç®—ç¬¦æ¯”è¾ƒè¢«è¿æ¥åˆ—çš„åˆ—å€¼ï¼Œä½†å®ƒä½¿ç”¨é€‰æ‹©åˆ—è¡¨æŒ‡å‡ºæŸ¥è¯¢ç»“æœé›†åˆä¸­æ‰€åŒ…æ‹¬çš„åˆ—ï¼Œå¹¶åˆ é™¤è¿æ¥è¡¨ä¸­çš„é‡å¤åˆ—ã€‚

å†…è¿æ¥ï¼šå†…è¿æ¥æŸ¥è¯¢æ“ä½œåˆ—å‡ºä¸è¿æ¥æ¡ä»¶åŒ¹é…çš„æ•°æ®è¡Œï¼Œå®ƒä½¿ç”¨æ¯”è¾ƒè¿ç®—ç¬¦æ¯”è¾ƒè¢«è¿æ¥åˆ—çš„åˆ—å€¼ã€‚

```sql
select * from book as a,stu as b where a.sutid = b.stuid

select * from book as a inner join stu as b on a.sutid = b.stuid
```

è¿™æ ·å°±æ˜¯å†…è¿æ¥ï¼š

![031919334726729.png](./images/031919334726729.png)

**2.å¤–è¿æ¥**

å¤–è¿æ¥å¯ä»¥åˆ†ä¸ºï¼Œå·¦è¿æ¥ï¼Œå³è¿æ¥ï¼Œå’Œå…¨è¿æ¥ï¼Œ

2.1.å·¦è”æ¥ï¼šæ˜¯ä»¥å·¦è¡¨ä¸ºåŸºå‡†ï¼Œå°†a.stuid = b.stuidçš„æ•°æ®è¿›è¡Œè¿æ¥ï¼Œç„¶åå°†å·¦è¡¨æ²¡æœ‰çš„å¯¹åº”é¡¹æ˜¾ç¤ºï¼Œå³è¡¨çš„åˆ—ä¸ºNULL

```sql
select * from book as a left join stu as b on a.sutid = b.stuid
```

![031923512064134.png](./images/031923512064134.png)

2.2.å³è¿æ¥ï¼šæ˜¯ä»¥å³è¡¨ä¸ºåŸºå‡†ï¼Œå°†a.stuid = b.stuidçš„æ•°æ®è¿›è¡Œè¿æ¥ï¼Œç„¶ä»¥å°†å³è¡¨æ²¡æœ‰çš„å¯¹åº”é¡¹æ˜¾ç¤ºï¼Œå·¦è¡¨çš„åˆ—ä¸ºNULL

```sql
select * from book as a right join stu as b on a.sutid = b.stuid
```

![031925286448136.png](./images/031925286448136.png)

2.3.å…¨è¿æ¥ï¼šå®Œæ•´å¤–éƒ¨è”æ¥è¿”å›å·¦è¡¨å’Œå³è¡¨ä¸­çš„æ‰€æœ‰è¡Œã€‚å½“æŸè¡Œåœ¨å¦ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰åŒ¹é…è¡Œæ—¶ï¼Œåˆ™å¦ä¸€ä¸ªè¡¨çš„é€‰æ‹©åˆ—è¡¨åˆ—åŒ…å«ç©ºå€¼ã€‚å¦‚æœè¡¨ä¹‹é—´æœ‰åŒ¹é…è¡Œï¼Œåˆ™æ•´ä¸ªç»“æœé›†è¡ŒåŒ…å«åŸºè¡¨çš„æ•°æ®å€¼ã€‚

```sql
select * from book as a full outer join stu as b on a.sutid = b.stuid
```

![031929431919967.png](./images/031929431919967.png)

**3.äº¤å‰è¿æ¥**

äº¤å‰è¿æ¥ï¼šäº¤å‰è”æ¥è¿”å›å·¦è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œå·¦è¡¨ä¸­çš„æ¯ä¸€è¡Œä¸å³è¡¨ä¸­çš„æ‰€æœ‰è¡Œç»„åˆã€‚äº¤å‰è”æ¥ä¹Ÿç§°ä½œç¬›å¡å°”ç§¯ã€‚

```sql
select * from book as a cross join stu as b order by a.id
```

![031933183471500.png](./images/031933183471500.png)



## 3.8 å…¶ä»–

### 3.6.1 å¦‚ä½•é˜²æ­¢sqlæ³¨å…¥



### 3.6.2 æ…¢æŸ¥è¯¢

### 3.6.3 MySQL å¦‚ä½•è°ƒä¼˜







# 4.Java åŸºç¡€

## 4.1 Java åŸºç¡€

### 4.1.1 Java åŸºæœ¬æ•°æ®ç±»å‹

![86735519.jpg.png](./images/86735519.jpg)

### 4.1.2  Java æ³›å‹

Java æ³›å‹ï¼ˆgenericsï¼‰æ˜¯ JDK 5 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§, æ³›å‹æä¾›äº†ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨æ£€æµ‹æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸ç¨‹åºå‘˜åœ¨ç¼–è¯‘æ—¶æ£€æµ‹åˆ°éæ³•çš„ç±»å‹ã€‚æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æ“ä½œçš„æ•°æ®ç±»å‹è¢«æŒ‡å®šä¸ºä¸€ä¸ªå‚æ•°ã€‚

Java çš„æ³›å‹æ˜¯ä¼ªæ³›å‹ï¼Œè¿™æ˜¯å› ä¸º Java åœ¨è¿è¡ŒæœŸé—´ï¼Œæ‰€æœ‰çš„æ³›å‹ä¿¡æ¯éƒ½ä¼šè¢«æ“¦æ‰ï¼Œè¿™ä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´ç±»å‹æ“¦é™¤ ã€‚

```java
List<Integer> list = new ArrayList<>();

list.add(12);
//è¿™é‡Œç›´æ¥æ·»åŠ ä¼šæŠ¥é”™
list.add("a");
Class<? extends List> clazz = list.getClass();
Method add = clazz.getDeclaredMethod("add", Object.class);
//ä½†æ˜¯é€šè¿‡åå°„æ·»åŠ ï¼Œæ˜¯å¯ä»¥çš„
add.invoke(list, "kl");

System.out.println(list);
```

æ³›å‹ä¸€èˆ¬æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼:æ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•ã€‚

**1.æ³›å‹ç±»**

```java
//æ­¤å¤„Tå¯ä»¥éšä¾¿å†™ä¸ºä»»æ„æ ‡è¯†ï¼Œå¸¸è§çš„å¦‚Tã€Eã€Kã€Vç­‰å½¢å¼çš„å‚æ•°å¸¸ç”¨äºè¡¨ç¤ºæ³›å‹
//åœ¨å®ä¾‹åŒ–æ³›å‹ç±»æ—¶ï¼Œå¿…é¡»æŒ‡å®šTçš„å…·ä½“ç±»å‹
public class Generic<T> {

    private T key;

    public Generic(T key) {
        this.key = key;
    }

    public T getKey() {
        return key;
    }
}
```

å¦‚ä½•å®ä¾‹åŒ–æ³›å‹ç±»ï¼š

```java
Generic<Integer> genericInteger = new Generic<Integer>(123456);
```

**2.æ³›å‹æ¥å£** ï¼š

```java
public interface Generator<T> {
    public T method();
}
```

å®ç°æ³›å‹æ¥å£ï¼Œä¸æŒ‡å®šç±»å‹ï¼š

```javascript
class GeneratorImpl<T> implements Generator<T>{
    @Override
    public T method() {
        return null;
    }
}
```

å®ç°æ³›å‹æ¥å£ï¼ŒæŒ‡å®šç±»å‹ï¼š

```java
class GeneratorImpl implements Generator<String>{
    @Override
    public String method() {
        return "hello";
    }
}
```

**3.æ³›å‹æ–¹æ³•** ï¼š

```java
public static <E> void printArray(E[] inputArray) {
    for (E element : inputArray) {
        System.out.printf("%s ", element);
    }
    System.out.println();
}
```

ä½¿ç”¨ï¼š

```java
// åˆ›å»ºä¸åŒç±»å‹æ•°ç»„ï¼š Integer, Double å’Œ Character
Integer[] intArray = { 1, 2, 3 };
String[] stringArray = { "Hello", "World" };
printArray(intArray);
printArray(stringArray);
```

**å¸¸ç”¨çš„é€šé…ç¬¦ä¸ºï¼š Tï¼ŒEï¼ŒKï¼ŒVï¼Œï¼Ÿ**

- ï¼Ÿ è¡¨ç¤ºä¸ç¡®å®šçš„ java ç±»å‹
- T (type) è¡¨ç¤ºå…·ä½“çš„ä¸€ä¸ª java ç±»å‹
- K V (key value) åˆ†åˆ«ä»£è¡¨ java é”®å€¼ä¸­çš„ Key Value
- E (element) ä»£è¡¨ Element

###  4.1.3 ==å’Œ equals çš„åŒºåˆ«

å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼Œ==æ¯”è¾ƒçš„æ˜¯å€¼ã€‚å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹æ¥è¯´ï¼Œ==æ¯”è¾ƒçš„æ˜¯å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚

> é‡ç‚¹åœ¨äºï¼š
>
> - å¦‚æœæ˜¯== å·ï¼Œæ¯”è¾ƒçš„æ˜¯å€¼ï¼ˆåŸºæœ¬ç±»å‹ï¼‰å’Œåœ°å€çš„å€¼ï¼ˆå¼•ç”¨ç±»å‹ï¼‰ã€‚
> - å¦‚æœæ˜¯equalsï¼Œä½ é‡å†™äº†å—ï¼Ÿä¸é‡å†™è¿˜æ˜¯æ²¡ä»€ä¹ˆç”¨ï¼Œè¿˜æ˜¯==ï¼Œåªæœ‰é‡å†™äº†æ‰æ˜¯çœŸçš„æ¯”è¾ƒå†…å®¹

###  4.1.4 hashCode()ä¸ equals()

Java ä»»ä½•ç±»ä¸­éƒ½æœ‰hashCodeå‡½æ•°ï¼ŒhashCodeå‡½æ•°æ¥æŸ¥è¯¢ä¸¤ä¸ªå¯¹è±¡çš„hashå€¼æ˜¯å¦ç›¸ç­‰ï¼Œ`hashcode` åªæ˜¯ç”¨æ¥ç¼©å°æŸ¥æ‰¾æˆæœ¬ã€‚

> hashcode å’Œ equals ä¸ä¸€å®šæ˜¯å…³è”çš„ã€‚é‡å†™äº†equalsæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰é‡å†™hashcodeæ–¹æ³•ï¼Œå°±ç®—ä»–ä»¬ç›¸ç­‰ï¼Œä»–ä»¬ä¹Ÿä¼šç®—ä¸ºhashcodeä¸åŒï¼Œæ­¤æ—¶è¿˜éœ€è¦é‡å†™hashcodeæ–¹æ³•ï¼Œä¸ç„¶è¿™ä¸ªæ—¶å€™ï¼Œä»–ä»¬æ”¾åˆ°ä¸€ä¸ªsetå¯¹è±¡ï¼Œä»–ä»¬éƒ½ä¸ç­‰ã€‚

### 4.1.5 åŸºæœ¬ç±»å‹çš„å¸¸é‡æ± æŠ€æœ¯

Java åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»çš„å¤§éƒ¨åˆ†éƒ½å®ç°äº†å¸¸é‡æ± æŠ€æœ¯ã€‚`Byte`,`Short`,`Integer`,`Long` è¿™ 4 ç§åŒ…è£…ç±»é»˜è®¤åˆ›å»ºäº†æ•°å€¼ **[-128ï¼Œ127]** çš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œ`Character` åˆ›å»ºäº†æ•°å€¼åœ¨[0,127]èŒƒå›´çš„ç¼“å­˜æ•°æ®ï¼Œ`Boolean` ç›´æ¥è¿”å› `True` Or `False`ã€‚

å¦‚æœè¶…å‡ºå¯¹åº”èŒƒå›´ä»ç„¶ä¼šå»åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç¼“å­˜çš„èŒƒå›´åŒºé—´çš„å¤§å°åªæ˜¯åœ¨æ€§èƒ½å’Œèµ„æºä¹‹é—´çš„æƒè¡¡ã€‚

ä¸¤ç§æµ®ç‚¹æ•°ç±»å‹çš„åŒ…è£…ç±» `Float`,`Double` å¹¶æ²¡æœ‰å®ç°å¸¸é‡æ± æŠ€æœ¯ã€‚

![20210422164544846.png](./images/20210422164544846.png)

### 4.1.6 åœ¨ä¸€ä¸ªé™æ€æ–¹æ³•å†…è°ƒç”¨ä¸€ä¸ªéé™æ€æˆå‘˜ä¸ºä»€ä¹ˆæ˜¯éæ³•çš„?

è¿™ä¸ªéœ€è¦ç»“åˆ JVM çš„ç›¸å…³çŸ¥è¯†ï¼Œé™æ€æ–¹æ³•æ˜¯å±äºç±»çš„ï¼Œåœ¨ç±»åŠ è½½çš„æ—¶å€™å°±ä¼šåˆ†é…å†…å­˜ï¼Œå¯ä»¥é€šè¿‡ç±»åç›´æ¥è®¿é—®ã€‚è€Œéé™æ€æˆå‘˜å±äºå®ä¾‹å¯¹è±¡ï¼Œåªæœ‰åœ¨å¯¹è±¡å®ä¾‹åŒ–ä¹‹åæ‰å­˜åœ¨ï¼Œç„¶åé€šè¿‡ç±»çš„å®ä¾‹å¯¹è±¡å»è®¿é—®ã€‚åœ¨ç±»çš„éé™æ€æˆå‘˜ä¸å­˜åœ¨çš„æ—¶å€™é™æ€æˆå‘˜å°±å·²ç»å­˜åœ¨äº†ï¼Œæ­¤æ—¶è°ƒç”¨åœ¨å†…å­˜ä¸­è¿˜ä¸å­˜åœ¨çš„éé™æ€æˆå‘˜ï¼Œå±äºéæ³•æ“ä½œã€‚

###  4.1.7 é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•æœ‰ä½•ä¸åŒï¼Ÿ

åœ¨å¤–éƒ¨è°ƒç”¨é™æ€æ–¹æ³•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `ç±»å.æ–¹æ³•å` çš„æ–¹å¼ï¼Œ<u>ä¹Ÿå¯ä»¥ä½¿ç”¨ `å¯¹è±¡.æ–¹æ³•å` çš„æ–¹å¼</u>ï¼Œè€Œå®ä¾‹æ–¹æ³•åªæœ‰åé¢è¿™ç§æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è°ƒç”¨é™æ€æ–¹æ³•å¯ä»¥æ— éœ€åˆ›å»ºå¯¹è±¡** ã€‚

### 4.1.8 String StringBuffer å’Œ StringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ? String ä¸ºä»€ä¹ˆæ˜¯ä¸å¯å˜çš„?

ç®€å•çš„æ¥è¯´ï¼š`String` ç±»ä¸­ä½¿ç”¨ final å…³é”®å­—ä¿®é¥°å­—ç¬¦æ•°ç»„æ¥ä¿å­˜å­—ç¬¦ä¸²ï¼Œ`private final char value[]`ï¼Œæ‰€ä»¥`String` å¯¹è±¡æ˜¯ä¸å¯å˜çš„ã€‚

1. æ“ä½œå°‘é‡çš„æ•°æ®: é€‚ç”¨ `String`
2. å•çº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ®: é€‚ç”¨ `StringBuilder`
3. å¤šçº¿ç¨‹æ“ä½œå­—ç¬¦ä¸²ç¼“å†²åŒºä¸‹æ“ä½œå¤§é‡æ•°æ®: é€‚ç”¨ `StringBuffer`

### 4.1.9 Java å¼‚å¸¸

![Javaå¼‚å¸¸ç±»å±‚æ¬¡ç»“æ„å›¾.png](./images/Javaå¼‚å¸¸ç±»å±‚æ¬¡ç»“æ„å›¾.png)

åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„å¼‚å¸¸éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç¥–å…ˆ `java.lang` åŒ…ä¸­çš„ `Throwable` ç±»ã€‚`Throwable` ç±»æœ‰ä¸¤ä¸ªé‡è¦çš„å­ç±» `Exception`ï¼ˆå¼‚å¸¸ï¼‰å’Œ `Error`ï¼ˆé”™è¯¯ï¼‰ã€‚`Exception` èƒ½è¢«ç¨‹åºæœ¬èº«å¤„ç†(`try-catch`)ï¼Œ `Error` æ˜¯æ— æ³•å¤„ç†çš„(åªèƒ½å°½é‡é¿å…)ã€‚

`Exception` å’Œ `Error` äºŒè€…éƒ½æ˜¯ Java å¼‚å¸¸å¤„ç†çš„é‡è¦å­ç±»ï¼Œå„è‡ªéƒ½åŒ…å«å¤§é‡å­ç±»ã€‚

- **`Exception`** :ç¨‹åºæœ¬èº«å¯ä»¥å¤„ç†çš„å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡ `catch` æ¥è¿›è¡Œæ•è·ã€‚`Exception` åˆå¯ä»¥åˆ†ä¸º å—æ£€æŸ¥å¼‚å¸¸(å¿…é¡»å¤„ç†) å’Œ ä¸å—æ£€æŸ¥å¼‚å¸¸(å¯ä»¥ä¸å¤„ç†)ã€‚
- **`Error`** ï¼š`Error` å±äºç¨‹åºæ— æ³•å¤„ç†çš„é”™è¯¯ ï¼Œæˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡ `catch` æ¥è¿›è¡Œæ•è· ã€‚ä¾‹å¦‚ï¼ŒJava è™šæ‹Ÿæœºè¿è¡Œé”™è¯¯ï¼ˆ`Virtual MachineError`ï¼‰ã€è™šæ‹Ÿæœºå†…å­˜ä¸å¤Ÿé”™è¯¯(`OutOfMemoryError`)ã€ç±»å®šä¹‰é”™è¯¯ï¼ˆ`NoClassDefFoundError`ï¼‰ç­‰ ã€‚è¿™äº›å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒJava è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸€èˆ¬ä¼šé€‰æ‹©çº¿ç¨‹ç»ˆæ­¢ã€‚

####  Throwable ç±»å¸¸ç”¨æ–¹æ³•

- **`public String getMessage()`**:è¿”å›å¼‚å¸¸å‘ç”Ÿæ—¶çš„ç®€è¦æè¿°
- **`public String toString()`**:è¿”å›å¼‚å¸¸å‘ç”Ÿæ—¶çš„è¯¦ç»†ä¿¡æ¯
- **`public String getLocalizedMessage()`**:è¿”å›å¼‚å¸¸å¯¹è±¡çš„æœ¬åœ°åŒ–ä¿¡æ¯ã€‚ä½¿ç”¨ `Throwable` çš„å­ç±»è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç”Ÿæˆæœ¬åœ°åŒ–ä¿¡æ¯ã€‚å¦‚æœå­ç±»æ²¡æœ‰è¦†ç›–è¯¥æ–¹æ³•ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å›çš„ä¿¡æ¯ä¸ `getMessage()`è¿”å›çš„ç»“æœç›¸åŒ
- **`public void printStackTrace()`**:åœ¨æ§åˆ¶å°ä¸Šæ‰“å° `Throwable` å¯¹è±¡å°è£…çš„å¼‚å¸¸ä¿¡æ¯

### 4.1.10  ä»€ä¹ˆæ˜¯åºåˆ—åŒ–?ä»€ä¹ˆæ˜¯ååºåˆ—åŒ–?

å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚

ç®€å•æ¥è¯´ï¼š

- **åºåˆ—åŒ–**ï¼š å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹
- **ååºåˆ—åŒ–**ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹

å¯¹äº Java è¿™ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„éƒ½æ˜¯å¯¹è±¡ï¼ˆObjectï¼‰ä¹Ÿå°±æ˜¯å®ä¾‹åŒ–åçš„ç±»(Class)ï¼Œä½†æ˜¯åœ¨ C++è¿™ç§åŠé¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œstruct(ç»“æ„ä½“)å®šä¹‰çš„æ˜¯æ•°æ®ç»“æ„ç±»å‹ï¼Œè€Œ class å¯¹åº”çš„æ˜¯å¯¹è±¡ç±»å‹

**åºåˆ—åŒ–**ï¼ˆserializationï¼‰åœ¨è®¡ç®—æœºç§‘å­¦çš„æ•°æ®å¤„ç†ä¸­ï¼Œæ˜¯æŒ‡å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡çŠ¶æ€è½¬æ¢æˆå¯å–ç”¨æ ¼å¼ï¼ˆä¾‹å¦‚å­˜æˆæ–‡ä»¶ï¼Œå­˜äºç¼“å†²ï¼Œæˆ–ç»ç”±ç½‘ç»œä¸­å‘é€ï¼‰ï¼Œä»¥ç•™å¾…åç»­åœ¨ç›¸åŒæˆ–å¦ä¸€å°è®¡ç®—æœºç¯å¢ƒä¸­ï¼Œèƒ½æ¢å¤åŸå…ˆçŠ¶æ€çš„è¿‡ç¨‹ã€‚ä¾ç…§åºåˆ—åŒ–æ ¼å¼é‡æ–°è·å–å­—èŠ‚çš„ç»“æœæ—¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥äº§ç”Ÿä¸åŸå§‹å¯¹è±¡ç›¸åŒè¯­ä¹‰çš„å‰¯æœ¬ã€‚å¯¹äºè®¸å¤šå¯¹è±¡ï¼Œåƒæ˜¯ä½¿ç”¨å¤§é‡å¼•ç”¨çš„å¤æ‚å¯¹è±¡ï¼Œè¿™ç§åºåˆ—åŒ–é‡å»ºçš„è¿‡ç¨‹å¹¶ä¸å®¹æ˜“ã€‚é¢å‘å¯¹è±¡ä¸­çš„å¯¹è±¡åºåˆ—åŒ–ï¼Œå¹¶ä¸æ¦‚æ‹¬ä¹‹å‰åŸå§‹å¯¹è±¡æ‰€å…³ç³»çš„å‡½æ•°ã€‚è¿™ç§è¿‡ç¨‹ä¹Ÿç§°ä¸ºå¯¹è±¡ç¼–ç»„ï¼ˆmarshallingï¼‰ã€‚ä»ä¸€ç³»åˆ—å­—èŠ‚æå–æ•°æ®ç»“æ„çš„åå‘æ“ä½œï¼Œæ˜¯ååºåˆ—åŒ–ï¼ˆä¹Ÿç§°ä¸ºè§£ç¼–ç»„ã€deserializationã€unmarshallingï¼‰ã€‚

ç»¼ä¸Šï¼š**åºåˆ—åŒ–çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“å¯¹è±¡æˆ–è€…è¯´æ˜¯å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…å­˜ä¸­ã€‚**

![a478c74d-2c48-40ae-9374-87aacf05188c.png](./images/a478c74d-2c48-40ae-9374-87aacf05188c.png)

#### Java åºåˆ—åŒ–ä¸­å¦‚æœæœ‰äº›å­—æ®µä¸æƒ³è¿›è¡Œåºåˆ—åŒ–ï¼Œæ€ä¹ˆåŠï¼Ÿ

å¯¹äºä¸æƒ³è¿›è¡Œåºåˆ—åŒ–çš„å˜é‡ï¼Œä½¿ç”¨ `transient` å…³é”®å­—ä¿®é¥°ã€‚

`transient` å…³é”®å­—çš„ä½œç”¨æ˜¯ï¼šé˜»æ­¢å®ä¾‹ä¸­é‚£äº›ç”¨æ­¤å…³é”®å­—ä¿®é¥°çš„çš„å˜é‡åºåˆ—åŒ–ï¼›å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œè¢« `transient` ä¿®é¥°çš„å˜é‡å€¼ä¸ä¼šè¢«æŒä¹…åŒ–å’Œæ¢å¤ã€‚

å…³äº `transient` è¿˜æœ‰å‡ ç‚¹æ³¨æ„ï¼š

- `transient` åªèƒ½ä¿®é¥°å˜é‡ï¼Œä¸èƒ½ä¿®é¥°ç±»å’Œæ–¹æ³•ã€‚
- `transient` ä¿®é¥°çš„å˜é‡ï¼Œåœ¨ååºåˆ—åŒ–åå˜é‡å€¼å°†ä¼šè¢«ç½®æˆç±»å‹çš„é»˜è®¤å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ä¿®é¥° `int` ç±»å‹ï¼Œé‚£ä¹ˆååºåˆ—åç»“æœå°±æ˜¯ `0`ã€‚
- `static` å˜é‡å› ä¸ºä¸å±äºä»»ä½•å¯¹è±¡(Object)ï¼Œæ‰€ä»¥æ— è®ºæœ‰æ²¡æœ‰ `transient` å…³é”®å­—ä¿®é¥°ï¼Œå‡ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚

####  è·å–ç”¨é”®ç›˜è¾“å…¥å¸¸ç”¨çš„ä¸¤ç§æ–¹æ³•ï¼š

æ–¹æ³• 1ï¼šé€šè¿‡ `Scanner`

```java
Scanner input = new Scanner(System.in);
String s  = input.nextLine();
input.close();
```

æ–¹æ³• 2ï¼šé€šè¿‡ `BufferedReader`

```java
BufferedReader input = new BufferedReader(new InputStreamReader(System.in));
String s = input.readLine();
```

####  Java ä¸­ IO æµåˆ†ä¸ºå‡ ç§?

- æŒ‰ç…§æµçš„æµå‘åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºè¾“å…¥æµå’Œè¾“å‡ºæµï¼›
- æŒ‰ç…§æ“ä½œå•å…ƒåˆ’åˆ†ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå­—èŠ‚æµå’Œå­—ç¬¦æµï¼›
- æŒ‰ç…§æµçš„è§’è‰²åˆ’åˆ†ä¸ºèŠ‚ç‚¹æµå’Œå¤„ç†æµã€‚

Java IO æµå…±æ¶‰åŠ 40 å¤šä¸ªç±»ï¼Œè¿™äº›ç±»çœ‹ä¸Šå»å¾ˆæ‚ä¹±ï¼Œä½†å®é™…ä¸Šå¾ˆæœ‰è§„åˆ™ï¼Œè€Œä¸”å½¼æ­¤ä¹‹é—´å­˜åœ¨éå¸¸ç´§å¯†çš„è”ç³»ï¼Œ Java IO æµçš„ 40 å¤šä¸ªç±»éƒ½æ˜¯ä»å¦‚ä¸‹ 4 ä¸ªæŠ½è±¡ç±»åŸºç±»ä¸­æ´¾ç”Ÿå‡ºæ¥çš„ã€‚

- InputStream/Reader: æ‰€æœ‰çš„è¾“å…¥æµçš„åŸºç±»ï¼Œå‰è€…æ˜¯å­—èŠ‚è¾“å…¥æµï¼Œåè€…æ˜¯å­—ç¬¦è¾“å…¥æµã€‚
- OutputStream/Writer: æ‰€æœ‰è¾“å‡ºæµçš„åŸºç±»ï¼Œå‰è€…æ˜¯å­—èŠ‚è¾“å‡ºæµï¼Œåè€…æ˜¯å­—ç¬¦è¾“å‡ºæµã€‚

![IO-æ“ä½œæ–¹å¼åˆ†ç±».png](./images/IO-æ“ä½œæ–¹å¼åˆ†ç±».png)

æŒ‰æ“ä½œå¯¹è±¡åˆ†ç±»ç»“æ„å›¾:

![IO-æ“ä½œå¯¹è±¡åˆ†ç±».png](./images/IO-æ“ä½œå¯¹è±¡åˆ†ç±».png)



####  æ—¢ç„¶æœ‰äº†å­—èŠ‚æµ,ä¸ºä»€ä¹ˆè¿˜è¦æœ‰å­—ç¬¦æµ?

é—®é¢˜æœ¬è´¨æƒ³é—®ï¼š**ä¸ç®¡æ˜¯æ–‡ä»¶è¯»å†™è¿˜æ˜¯ç½‘ç»œå‘é€æ¥æ”¶ï¼Œä¿¡æ¯çš„æœ€å°å­˜å‚¨å•å…ƒéƒ½æ˜¯å­—èŠ‚ï¼Œé‚£ä¸ºä»€ä¹ˆ I/O æµæ“ä½œè¦åˆ†ä¸ºå­—èŠ‚æµæ“ä½œå’Œå­—ç¬¦æµæ“ä½œå‘¢ï¼Ÿ**

å›ç­”ï¼šå­—ç¬¦æµæ˜¯ç”± Java è™šæ‹Ÿæœºå°†å­—èŠ‚è½¬æ¢å¾—åˆ°çš„ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™ä¸ªè¿‡ç¨‹è¿˜ç®—æ˜¯éå¸¸è€—æ—¶ï¼Œå¹¶ä¸”ï¼Œå¦‚æœæˆ‘ä»¬ä¸çŸ¥é“ç¼–ç ç±»å‹å°±å¾ˆå®¹æ˜“å‡ºç°ä¹±ç é—®é¢˜ã€‚æ‰€ä»¥ï¼Œ I/O æµå°±å¹²è„†æä¾›äº†ä¸€ä¸ªç›´æ¥æ“ä½œå­—ç¬¦çš„æ¥å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¹³æ—¶å¯¹å­—ç¬¦è¿›è¡Œæµæ“ä½œã€‚å¦‚æœéŸ³é¢‘æ–‡ä»¶ã€å›¾ç‰‡ç­‰åª’ä½“æ–‡ä»¶ç”¨å­—èŠ‚æµæ¯”è¾ƒå¥½ï¼Œå¦‚æœæ¶‰åŠåˆ°å­—ç¬¦çš„è¯ä½¿ç”¨å­—ç¬¦æµæ¯”è¾ƒå¥½ã€‚

## 4.2 é›†åˆ

### 4.1.1 HashMap 

#### HashMap ç»“æ„åŸç†ï¼Ÿ

HashMap ä¸»è¦ç”¨æ¥å­˜æ”¾é”®å€¼å¯¹ï¼Œå®ƒåŸºäºå“ˆå¸Œè¡¨çš„ Map æ¥å£å®ç°ï¼Œæ˜¯å¸¸ç”¨çš„ Java é›†åˆä¹‹ä¸€ï¼Œæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚

å‡ ä¸ªå…³é”®çš„ä¿¡æ¯ï¼šåŸºäºMapæ¥å£å®ç°ã€å…è®¸nullé”®/å€¼ã€éåŒæ­¥ã€ä¸ä¿è¯æœ‰åº(æ¯”å¦‚æ’å…¥çš„é¡ºåº)ã€ä¹Ÿä¸ä¿è¯åºä¸éšæ—¶é—´å˜åŒ–ã€‚

#### hashmapçš„åº•å±‚ï¼Ÿ

#### HashMapæ‰©å®¹æ–¹å¼ï¼Ÿ

JDK1.8 ä¹‹å‰ HashMap ç”± æ•°ç»„+é“¾è¡¨ ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ HashMap çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼ˆâ€œæ‹‰é“¾æ³•â€è§£å†³å†²çªï¼‰ã€‚ JDK1.8 ä»¥åçš„ `HashMap` åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚

HashMap æ‰©å®¹çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨çš„æ˜¯2æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥2å€)ã€‚æ‰€ä»¥ï¼Œå…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨2æ¬¡å¹‚çš„ä½ç½®ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œæ˜¯0çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯1çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ã€‚å¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º16æ‰©å……ä¸º32çš„resizeç¤ºæ„å›¾ï¼š

![d7acbad8-d941-11e4-9493-2c5e69d084c0.png](./images/d7acbad8-d941-11e4-9493-2c5e69d084c0.png)

è¿™ä¸ªè®¾è®¡ç¡®å®éå¸¸çš„å·§å¦™ï¼Œæ—¢çœå»äº†é‡æ–°è®¡ç®—hashå€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„1bitæ˜¯0è¿˜æ˜¯1å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤resizeçš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„bucketäº†ã€‚

#### hashmap jdk1.7å’Œ1.8çš„å…ƒç´ æ’å…¥åŒºåˆ«ï¼Ÿ

ä¸ƒä¸Šå…«ä¸‹ï¼ŒåŸå› ï¼šjdk7çš„æ’å…¥æ–¹å¼å¯èƒ½ä¼šäº§ç”Ÿç¯

#### hashmapå’Œhashtableçš„åŒºåˆ«ï¼Ÿ

#### ConcurrentHashMapå’ŒHashMapçš„åŒºåˆ«ï¼Ÿ

#### hashmapåœ¨jdk1.7å’Œ1.8ç‰ˆæœ¬ä¸­æœ‰å“ªäº›æ”¹åŠ¨?

JDK1.8 ä¹‹å‰

JDK1.8 ä¹‹å‰ HashMap åº•å±‚æ˜¯ **æ•°ç»„å’Œé“¾è¡¨** ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ **é“¾è¡¨æ•£åˆ—**ã€‚

HashMap é€šè¿‡ key çš„ hashCode ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ `(n - 1) & hash` åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚

æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ hash æ–¹æ³•ã€‚ä½¿ç”¨ hash æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ hashCode() æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚

HashMapåº•å±‚æ•°æ®ç»“æ„ï¼Œä¸ºä»€ä¹ˆé˜ˆå€¼è¶…è¿‡å…«å˜æˆçº¢é»‘æ ‘ï¼Ÿ

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚

æ‰€è°“ **â€œæ‹‰é“¾æ³•â€** å°±æ˜¯ï¼šå°†é“¾è¡¨å’Œæ•°ç»„ç›¸ç»“åˆã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€æ ¼å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚è‹¥é‡åˆ°å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­å³å¯ã€‚

 JDK1.8 ä¹‹å

ç›¸æ¯”äºä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒJDK1.8 ä»¥ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ã€‚

å½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰æ—¶ï¼Œä¼šé¦–å…ˆè°ƒç”¨ `treeifyBin()`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® HashMap æ•°ç»„æ¥å†³å®šæ˜¯å¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚åªæœ‰å½“æ•°ç»„é•¿åº¦å¤§äºæˆ–è€…ç­‰äº 64 çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚å¦åˆ™ï¼Œå°±æ˜¯åªæ˜¯æ‰§è¡Œ `resize()` æ–¹æ³•å¯¹æ•°ç»„æ‰©å®¹ã€‚ç›¸å…³æºç è¿™é‡Œå°±ä¸è´´äº†ï¼Œé‡ç‚¹å…³æ³¨ `treeifyBin()`æ–¹æ³•å³å¯ï¼

#### å…¶å®ƒ

- **loadFactor åŠ è½½å› å­**

  loadFactor åŠ è½½å› å­æ˜¯æ§åˆ¶æ•°ç»„å­˜æ”¾æ•°æ®çš„ç–å¯†ç¨‹åº¦ï¼ŒloadFactor è¶Šè¶‹è¿‘äº 1ï¼Œé‚£ä¹ˆ æ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®(entry)ä¹Ÿå°±è¶Šå¤šï¼Œä¹Ÿå°±è¶Šå¯†ï¼Œä¹Ÿå°±æ˜¯ä¼šè®©é“¾è¡¨çš„é•¿åº¦å¢åŠ ï¼ŒloadFactor è¶Šå°ï¼Œä¹Ÿå°±æ˜¯è¶‹è¿‘äº 0ï¼Œæ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®(entry)ä¹Ÿå°±è¶Šå°‘ï¼Œä¹Ÿå°±è¶Šç¨€ç–ã€‚

  **loadFactor å¤ªå¤§å¯¼è‡´æŸ¥æ‰¾å…ƒç´ æ•ˆç‡ä½ï¼Œå¤ªå°å¯¼è‡´æ•°ç»„çš„åˆ©ç”¨ç‡ä½ï¼Œå­˜æ”¾çš„æ•°æ®ä¼šå¾ˆåˆ†æ•£ã€‚loadFactor çš„é»˜è®¤å€¼ä¸º 0.75f æ˜¯å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¸´ç•Œå€¼**ã€‚

  ç»™å®šçš„é»˜è®¤å®¹é‡ä¸º 16ï¼Œè´Ÿè½½å› å­ä¸º 0.75ã€‚Map åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸æ–­çš„å¾€é‡Œé¢å­˜æ”¾æ•°æ®ï¼Œå½“æ•°é‡è¾¾åˆ°äº† 16 * 0.75 = 12 å°±éœ€è¦å°†å½“å‰ 16 çš„å®¹é‡è¿›è¡Œæ‰©å®¹ï¼Œè€Œæ‰©å®¹è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ° rehashã€å¤åˆ¶æ•°æ®ç­‰æ“ä½œï¼Œæ‰€ä»¥éå¸¸æ¶ˆè€—æ€§èƒ½ã€‚

- **threshold**

  **threshold = capacity \* loadFactor**ï¼Œ**å½“ Size>=threshold**çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘å¯¹æ•°ç»„çš„æ‰©å¢äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªçš„æ„æ€å°±æ˜¯ **è¡¡é‡æ•°ç»„æ˜¯å¦éœ€è¦æ‰©å¢çš„ä¸€ä¸ªæ ‡å‡†**

### 4.1.2 List

ArrayList LinkListçš„åŒºåˆ«?

### 4.1.3 ArrayList

#### ArrayList æ‰©å®¹æœºåˆ¶åˆ†æ

é»˜è®¤æ„é€ å‡½æ•°ï¼Œä½¿ç”¨åˆå§‹å®¹é‡10æ„é€ ä¸€ä¸ªç©ºåˆ—è¡¨(æ— å‚æ•°æ„é€ )



## 4.2 é¢å‘å¯¹è±¡

### 4.2.1 å¤šæ€

- å¯¹è±¡ç±»å‹å’Œå¼•ç”¨ç±»å‹ä¹‹é—´å…·æœ‰ç»§æ‰¿ï¼ˆç±»ï¼‰/å®ç°ï¼ˆæ¥å£ï¼‰çš„å…³ç³»ï¼›
- å¼•ç”¨ç±»å‹å˜é‡å‘å‡ºçš„æ–¹æ³•è°ƒç”¨çš„åˆ°åº•æ˜¯å“ªä¸ªç±»ä¸­çš„æ–¹æ³•ï¼Œå¿…é¡»åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ‰èƒ½ç¡®å®šï¼›
- å¤šæ€ä¸èƒ½è°ƒç”¨â€œåªåœ¨å­ç±»å­˜åœ¨ä½†åœ¨çˆ¶ç±»ä¸å­˜åœ¨â€çš„æ–¹æ³•ï¼›
- å¦‚æœå­ç±»é‡å†™äº†çˆ¶ç±»çš„æ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œçš„æ˜¯å­ç±»è¦†ç›–çš„æ–¹æ³•ï¼Œå¦‚æœå­ç±»æ²¡æœ‰è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ï¼Œæ‰§è¡Œçš„æ˜¯çˆ¶ç±»çš„æ–¹æ³•ã€‚

## 4.3 å¤šçº¿ç¨‹

### 4.3.1 ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨

### 4.3.2 javaä¸­éƒ½æœ‰ä¸­æ€æ ·å¤„ç†å¹¶å‘

### 4.3.3 è¯´ä¸€è¯´volatileå…³é”®å­—çš„åº•å±‚åŸç†

### 4.3.4 åˆ›å»ºçº¿ç¨‹éƒ½æœ‰å“ªäº›æ–¹å¼?

### 4.3.5 ThreadLocal

Threadlocalåœ¨ä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„å“ªäº›é—®é¢˜

ThreadLocalå¼±å¼•ç”¨ç›¸å…³

### 4.3.6 çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

### 4.3.7 sleep()å’Œwait()çš„åŒºåˆ«

### 4.3.8 æ­»é”çš„å¿…è¦æ¡ä»¶ä»¥åŠè§£é™¤æ­»é”çš„ç®—æ³•

### 4.3.9 è¿›ç¨‹é—´çš„é€šä¿¡ä¸çº¿ç¨‹é—´çš„é€šä¿¡



## 4.4 JVMå†…å­˜æœºåˆ¶

### 4.4.1 è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ

![JVMè¿è¡Œæ—¶æ•°æ®åŒºåŸŸ.png](./images/JVMè¿è¡Œæ—¶æ•°æ®åŒºåŸŸ.png)

**JDK 1.8 ï¼š**

![JVMè¿è¡Œæ—¶æ•°æ®åŒºåŸŸ.png](./images/Javaè¿è¡Œæ—¶æ•°æ®åŒºåŸŸJDK1.8.png)

**çº¿ç¨‹ç§æœ‰çš„ï¼š**

- ç¨‹åºè®¡æ•°å™¨
- è™šæ‹Ÿæœºæ ˆ
- æœ¬åœ°æ–¹æ³•æ ˆ

**çº¿ç¨‹å…±äº«çš„ï¼š**

- å †
- æ–¹æ³•åŒº
- ç›´æ¥å†…å­˜ (éè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†)

#### 4.4.1.1 ç¨‹åºè®¡æ•°å™¨

ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚**å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚**

å¦å¤–ï¼Œ**ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„çº¿ç¨‹ä¹‹é—´è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ã€‚**

**ä»ä¸Šé¢çš„ä»‹ç»ä¸­æˆ‘ä»¬çŸ¥é“ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š**

1. å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€‚
2. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†ã€‚

**æ³¨æ„ï¼šç¨‹åºè®¡æ•°å™¨æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‡ºç° `OutOfMemoryError` çš„å†…å­˜åŒºåŸŸï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œæ­»äº¡ã€‚**

#### 4.4.1.2 Java è™šæ‹Ÿæœºæ ˆ

**ä¸ç¨‹åºè®¡æ•°å™¨ä¸€æ ·ï¼ŒJava è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç›¸åŒï¼Œæè¿°çš„æ˜¯ Java æ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯æ¬¡æ–¹æ³•è°ƒç”¨çš„æ•°æ®éƒ½æ˜¯é€šè¿‡æ ˆä¼ é€’çš„ã€‚**

**Java å†…å­˜å¯ä»¥ç²—ç³™çš„åŒºåˆ†ä¸ºå †å†…å­˜ï¼ˆHeapï¼‰å’Œæ ˆå†…å­˜ (Stack)ï¼Œå…¶ä¸­æ ˆå°±æ˜¯ç°åœ¨è¯´çš„è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´æ˜¯è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ã€‚** ï¼ˆå®é™…ä¸Šï¼ŒJava è™šæ‹Ÿæœºæ ˆæ˜¯ç”±ä¸€ä¸ªä¸ªæ ˆå¸§ç»„æˆï¼Œè€Œæ¯ä¸ªæ ˆå¸§ä¸­éƒ½æ‹¥æœ‰ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ä¿¡æ¯ã€‚ï¼‰

**å±€éƒ¨å˜é‡è¡¨ä¸»è¦å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»å‹**ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€**å¯¹è±¡å¼•ç”¨**ï¼ˆreference ç±»å‹ï¼Œå®ƒä¸åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰ã€‚

**Java è™šæ‹Ÿæœºæ ˆä¼šå‡ºç°ä¸¤ç§é”™è¯¯ï¼š`StackOverFlowError` å’Œ `OutOfMemoryError`ã€‚**

- **`StackOverFlowError`ï¼š** è‹¥ Java è™šæ‹Ÿæœºæ ˆçš„å†…å­˜å¤§å°ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦çš„æ—¶å€™ï¼Œå°±æŠ›å‡º StackOverFlowError é”™è¯¯ã€‚
- **`OutOfMemoryError`ï¼š** Java è™šæ‹Ÿæœºæ ˆçš„å†…å­˜å¤§å°å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œ å¦‚æœè™šæ‹Ÿæœºåœ¨åŠ¨æ€æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡º`OutOfMemoryError`å¼‚å¸¸ã€‚

![ã€Šæ·±å…¥ç†è§£è™šæ‹Ÿæœºã€‹ç¬¬ä¸‰ç‰ˆçš„ç¬¬2ç« -è™šæ‹Ÿæœºæ ˆ.png](./images/ã€Šæ·±å…¥ç†è§£è™šæ‹Ÿæœºã€‹ç¬¬ä¸‰ç‰ˆçš„ç¬¬2ç« -è™šæ‹Ÿæœºæ ˆ.png)

Java è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å„è‡ªçš„ Java è™šæ‹Ÿæœºæ ˆï¼Œè€Œä¸”éšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„æ­»äº¡è€Œæ­»äº¡ã€‚

**æ‰©å±•ï¼šé‚£ä¹ˆæ–¹æ³•/å‡½æ•°å¦‚ä½•è°ƒç”¨ï¼Ÿ**

Java æ ˆå¯ä»¥ç±»æ¯”æ•°æ®ç»“æ„ä¸­æ ˆï¼ŒJava æ ˆä¸­ä¿å­˜çš„ä¸»è¦å†…å®¹æ˜¯æ ˆå¸§ï¼Œæ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§è¢«å‹å…¥ Java æ ˆï¼Œæ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ç»“æŸåï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ ˆå¸§è¢«å¼¹å‡ºã€‚

Java æ–¹æ³•æœ‰ä¸¤ç§è¿”å›æ–¹å¼ï¼š

1. return è¯­å¥ã€‚
2. æŠ›å‡ºå¼‚å¸¸ã€‚

ä¸ç®¡å“ªç§è¿”å›æ–¹å¼éƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚

####  4.4.1.3 æœ¬åœ°æ–¹æ³•æ ˆ

å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š **è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ã€‚** åœ¨ HotSpot è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚

æœ¬åœ°æ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜æ”¾è¯¥æœ¬åœ°æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€å‡ºå£ä¿¡æ¯ã€‚

æ–¹æ³•æ‰§è¡Œå®Œæ¯•åç›¸åº”çš„æ ˆå¸§ä¹Ÿä¼šå‡ºæ ˆå¹¶é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œä¹Ÿä¼šå‡ºç° `StackOverFlowError` å’Œ `OutOfMemoryError` ä¸¤ç§é”™è¯¯ã€‚

####  4.4.1.4 å †

Java è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼ŒJava å †æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚**æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚**

Java ä¸–ç•Œä¸­â€œ**å‡ ä¹â€**æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨å †ä¸­åˆ†é…ï¼Œä½†æ˜¯ï¼Œéšç€ JIT ç¼–è¯‘å™¨çš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚ä» JDK 1.7 å¼€å§‹å·²ç»é»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚æœæŸäº›æ–¹æ³•ä¸­çš„å¯¹è±¡å¼•ç”¨æ²¡æœ‰è¢«è¿”å›æˆ–è€…æœªè¢«å¤–é¢ä½¿ç”¨ï¼ˆä¹Ÿå°±æ˜¯æœª**é€ƒé€¸**å‡ºå»ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡å¯ä»¥ç›´æ¥åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ã€‚

Java å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä½œ**GC å †ï¼ˆGarbage Collected Heapï¼‰**ã€‚ä»åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ‰€ä»¥ Java å †è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼›å†ç»†è‡´ä¸€ç‚¹æœ‰ï¼šEden ç©ºé—´ã€From Survivorã€To Survivor ç©ºé—´ç­‰ã€‚**è¿›ä¸€æ­¥åˆ’åˆ†çš„ç›®çš„æ˜¯æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«åœ°åˆ†é…å†…å­˜ã€‚**

åœ¨ JDK 7 ç‰ˆæœ¬åŠ JDK 7 ç‰ˆæœ¬ä¹‹å‰ï¼Œå †å†…å­˜è¢«é€šå¸¸åˆ†ä¸ºä¸‹é¢ä¸‰éƒ¨åˆ†ï¼š

1. æ–°ç”Ÿä»£å†…å­˜(Young Generation)
2. è€ç”Ÿä»£(Old Generation)
3. æ°¸ç”Ÿä»£(Permanent Generation)

![JVMå †å†…å­˜ç»“æ„-JDK7.png](./images/JVMå †å†…å­˜ç»“æ„-JDK7.png)

JDK 8 ç‰ˆæœ¬ä¹‹åæ–¹æ³•åŒºï¼ˆHotSpot çš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•ç§»é™¤äº†ï¼ˆJDK1.7 å°±å·²ç»å¼€å§‹äº†ï¼‰ï¼Œå–è€Œä»£ä¹‹æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ã€‚

![JVMå †å†…å­˜ç»“æ„-jdk8.png](./images/JVMå †å†…å­˜ç»“æ„-jdk8.png)

**ä¸Šå›¾æ‰€ç¤ºçš„ Eden åŒºã€ä¸¤ä¸ª Survivor åŒºéƒ½å±äºæ–°ç”Ÿä»£ï¼ˆä¸ºäº†åŒºåˆ†ï¼Œè¿™ä¸¤ä¸ª Survivor åŒºåŸŸæŒ‰ç…§é¡ºåºè¢«å‘½åä¸º from å’Œ toï¼‰ï¼Œä¸­é—´ä¸€å±‚å±äºè€å¹´ä»£ã€‚**

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ï¼Œåœ¨ä¸€æ¬¡æ–°ç”Ÿä»£åƒåœ¾å›æ”¶åï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œåˆ™ä¼šè¿›å…¥ s0 æˆ–è€… s1ï¼Œå¹¶ä¸”å¯¹è±¡çš„å¹´é¾„è¿˜ä¼šåŠ  1(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®ã€‚

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue552](https://github.com/Snailclimb/JavaGuide/issues/552)ï¼‰** ï¼šâ€œHotspot éå†æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¹´é¾„ä»å°åˆ°å¤§å¯¹å…¶æ‰€å ç”¨çš„å¤§å°è¿›è¡Œç´¯ç§¯ï¼Œå½“ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº† survivor åŒºçš„ä¸€åŠæ—¶ï¼Œå–è¿™ä¸ªå¹´é¾„å’Œ MaxTenuringThreshold ä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼â€ã€‚

**åŠ¨æ€å¹´é¾„è®¡ç®—çš„ä»£ç å¦‚ä¸‹**

```java
uint ageTable::compute_tenuring_threshold(size_t survivor_capacity) {
	//survivor_capacityæ˜¯survivorç©ºé—´çš„å¤§å°
size_t desired_survivor_size = (size_t)((((double) survivor_capacity)*TargetSurvivorRatio)/100);
size_t total = 0;
uint age = 1;
while (age < table_size) {
total += sizes[age];//sizesæ•°ç»„æ˜¯æ¯ä¸ªå¹´é¾„æ®µå¯¹è±¡å¤§å°
if (total > desired_survivor_size) break;
age++;
}
uint result = age < MaxTenuringThreshold ? age : MaxTenuringThreshold;
	...
}
```

å †è¿™é‡Œæœ€å®¹æ˜“å‡ºç°çš„å°±æ˜¯ OutOfMemoryError é”™è¯¯ï¼Œå¹¶ä¸”å‡ºç°è¿™ç§é”™è¯¯ä¹‹åçš„è¡¨ç°å½¢å¼è¿˜ä¼šæœ‰å‡ ç§ï¼Œæ¯”å¦‚ï¼š

1. **`java.lang.OutOfMemoryError: GC Overhead Limit Exceeded`** ï¼š å½“ JVM èŠ±å¤ªå¤šæ—¶é—´æ‰§è¡Œåƒåœ¾å›æ”¶å¹¶ä¸”åªèƒ½å›æ”¶å¾ˆå°‘çš„å †ç©ºé—´æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­¤é”™è¯¯ã€‚
2. **`java.lang.OutOfMemoryError: Java heap space`** :å‡å¦‚åœ¨åˆ›å»ºæ–°çš„å¯¹è±¡æ—¶, å †å†…å­˜ä¸­çš„ç©ºé—´ä¸è¶³ä»¥å­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡, å°±ä¼šå¼•å‘æ­¤é”™è¯¯ã€‚(å’Œé…ç½®çš„æœ€å¤§å †å†…å­˜æœ‰å…³ï¼Œä¸”å—åˆ¶äºç‰©ç†å†…å­˜å¤§å°ã€‚æœ€å¤§å †å†…å­˜å¯é€šè¿‡`-Xmx`å‚æ•°é…ç½®ï¼Œè‹¥æ²¡æœ‰ç‰¹åˆ«é…ç½®ï¼Œå°†ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œè¯¦è§ï¼š[Default Java 8 max heap size](https://stackoverflow.com/questions/28272923/default-xmxsize-in-java-8-max-heap-size))
3. ......

####  4.4.1.5 æ–¹æ³•åŒº

æ–¹æ³•åŒºä¸ Java å †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚è™½ç„¶ **Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†**ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«åš **Non-Heapï¼ˆéå †ï¼‰**ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€æ¥ã€‚

æ–¹æ³•åŒºä¹Ÿè¢«ç§°ä¸ºæ°¸ä¹…ä»£ã€‚å¾ˆå¤šäººéƒ½ä¼šåˆ†ä¸æ¸…æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»ï¼Œä¸ºæ­¤æˆ‘ä¹ŸæŸ¥é˜…äº†æ–‡çŒ®ã€‚

Q: æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»

> ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹åªæ˜¯è§„å®šäº†æœ‰æ–¹æ³•åŒºè¿™ä¹ˆä¸ªæ¦‚å¿µå’Œå®ƒçš„ä½œç”¨ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å®ç°å®ƒã€‚é‚£ä¹ˆï¼Œåœ¨ä¸åŒçš„ JVM ä¸Šæ–¹æ³•åŒºçš„å®ç°è‚¯å®šæ˜¯ä¸åŒçš„äº†ã€‚ **æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»å¾ˆåƒ Java ä¸­æ¥å£å’Œç±»çš„å…³ç³»ï¼Œç±»å®ç°äº†æ¥å£ï¼Œè€Œæ°¸ä¹…ä»£å°±æ˜¯ HotSpot è™šæ‹Ÿæœºå¯¹è™šæ‹Ÿæœºè§„èŒƒä¸­æ–¹æ³•åŒºçš„ä¸€ç§å®ç°æ–¹å¼ã€‚** ä¹Ÿå°±æ˜¯è¯´ï¼Œæ°¸ä¹…ä»£æ˜¯ HotSpot çš„æ¦‚å¿µï¼Œæ–¹æ³•åŒºæ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­çš„å®šä¹‰ï¼Œæ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œæ°¸ä¹…ä»£æ˜¯ä¸€ç§å®ç°ï¼Œä¸€ä¸ªæ˜¯æ ‡å‡†ä¸€ä¸ªæ˜¯å®ç°ï¼Œå…¶ä»–çš„è™šæ‹Ÿæœºå®ç°å¹¶æ²¡æœ‰æ°¸ä¹…ä»£è¿™ä¸€è¯´æ³•ã€‚

 å¸¸ç”¨å‚æ•°

JDK 1.8 ä¹‹å‰æ°¸ä¹…ä»£è¿˜æ²¡è¢«å½»åº•ç§»é™¤çš„æ—¶å€™é€šå¸¸é€šè¿‡ä¸‹é¢è¿™äº›å‚æ•°æ¥è°ƒèŠ‚æ–¹æ³•åŒºå¤§å°

```java
-XX:PermSize=N //æ–¹æ³•åŒº (æ°¸ä¹…ä»£) åˆå§‹å¤§å°
-XX:MaxPermSize=N //æ–¹æ³•åŒº (æ°¸ä¹…ä»£) æœ€å¤§å¤§å°,è¶…è¿‡è¿™ä¸ªå€¼å°†ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸:java.lang.OutOfMemoryError: PermGen
```

ç›¸å¯¹è€Œè¨€ï¼Œåƒåœ¾æ”¶é›†è¡Œä¸ºåœ¨è¿™ä¸ªåŒºåŸŸæ˜¯æ¯”è¾ƒå°‘å‡ºç°çš„ï¼Œä½†å¹¶éæ•°æ®è¿›å…¥æ–¹æ³•åŒºåå°±â€œæ°¸ä¹…å­˜åœ¨â€äº†ã€‚

JDK 1.8 çš„æ—¶å€™ï¼Œæ–¹æ³•åŒºï¼ˆHotSpot çš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•ç§»é™¤äº†ï¼ˆJDK1.7 å°±å·²ç»å¼€å§‹äº†ï¼‰ï¼Œå–è€Œä»£ä¹‹æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨å‚æ•°ï¼š

```java
-XX:MetaspaceSize=N //è®¾ç½® Metaspace çš„åˆå§‹ï¼ˆå’Œæœ€å°å¤§å°ï¼‰
-XX:MaxMetaspaceSize=N //è®¾ç½® Metaspace çš„æœ€å¤§å¤§å°
```

ä¸æ°¸ä¹…ä»£å¾ˆå¤§çš„ä¸åŒå°±æ˜¯ï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°çš„è¯ï¼Œéšç€æ›´å¤šç±»çš„åˆ›å»ºï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰å¯ç”¨çš„ç³»ç»Ÿå†…å­˜

Q: ä»€ä¹ˆè¦å°†æ°¸ä¹…ä»£ (PermGen) æ›¿æ¢ä¸ºå…ƒç©ºé—´ (MetaSpace) å‘¢?

ä¸‹å›¾æ¥è‡ªã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ç¬¬ 3 ç‰ˆ 2.2.5

![20210425134508117.png](./images/20210425134508117.png)

1. æ•´ä¸ªæ°¸ä¹…ä»£æœ‰ä¸€ä¸ª JVM æœ¬èº«è®¾ç½®çš„å›ºå®šå¤§å°ä¸Šé™ï¼Œæ— æ³•è¿›è¡Œè°ƒæ•´ï¼Œè€Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ï¼Œå—æœ¬æœºå¯ç”¨å†…å­˜çš„é™åˆ¶ï¼Œè™½ç„¶å…ƒç©ºé—´ä»æ—§å¯èƒ½æº¢å‡ºï¼Œä½†æ˜¯æ¯”åŸæ¥å‡ºç°çš„å‡ ç‡ä¼šæ›´å°ã€‚

   > å½“å…ƒç©ºé—´æº¢å‡ºæ—¶ä¼šå¾—åˆ°å¦‚ä¸‹é”™è¯¯ï¼š `java.lang.OutOfMemoryError: MetaSpace`

ä½ å¯ä»¥ä½¿ç”¨ `-XXï¼šMaxMetaspaceSize` æ ‡å¿—è®¾ç½®æœ€å¤§å…ƒç©ºé—´å¤§å°ï¼Œé»˜è®¤å€¼ä¸º unlimitedï¼Œè¿™æ„å‘³ç€å®ƒåªå—ç³»ç»Ÿå†…å­˜çš„é™åˆ¶ã€‚`-XXï¼šMetaspaceSize` è°ƒæ•´æ ‡å¿—å®šä¹‰å…ƒç©ºé—´çš„åˆå§‹å¤§å°å¦‚æœæœªæŒ‡å®šæ­¤æ ‡å¿—ï¼Œåˆ™ Metaspace å°†æ ¹æ®è¿è¡Œæ—¶çš„åº”ç”¨ç¨‹åºéœ€æ±‚åŠ¨æ€åœ°é‡æ–°è°ƒæ•´å¤§å°ã€‚

1. å…ƒç©ºé—´é‡Œé¢å­˜æ”¾çš„æ˜¯ç±»çš„å…ƒæ•°æ®ï¼Œè¿™æ ·åŠ è½½å¤šå°‘ç±»çš„å…ƒæ•°æ®å°±ä¸ç”± `MaxPermSize` æ§åˆ¶äº†, è€Œç”±ç³»ç»Ÿçš„å®é™…å¯ç”¨ç©ºé—´æ¥æ§åˆ¶ï¼Œè¿™æ ·èƒ½åŠ è½½çš„ç±»å°±æ›´å¤šäº†ã€‚
2. åœ¨ JDK8ï¼Œåˆå¹¶ HotSpot å’Œ JRockit çš„ä»£ç æ—¶, JRockit ä»æ¥æ²¡æœ‰ä¸€ä¸ªå«æ°¸ä¹…ä»£çš„ä¸œè¥¿, åˆå¹¶ä¹‹åå°±æ²¡æœ‰å¿…è¦é¢å¤–çš„è®¾ç½®è¿™ä¹ˆä¸€ä¸ªæ°¸ä¹…ä»£çš„åœ°æ–¹äº†ã€‚

#### 4.4.1.6 è¿è¡Œæ—¶å¸¸é‡æ± 

è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰å¸¸é‡æ± è¡¨ï¼ˆç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼‰

æ—¢ç„¶è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œè‡ªç„¶å—åˆ°æ–¹æ³•åŒºå†…å­˜çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡º OutOfMemoryError é”™è¯¯ã€‚

~~**JDK1.7 åŠä¹‹åç‰ˆæœ¬çš„ JVM å·²ç»å°†è¿è¡Œæ—¶å¸¸é‡æ± ä»æ–¹æ³•åŒºä¸­ç§»äº†å‡ºæ¥ï¼Œåœ¨ Java å †ï¼ˆHeapï¼‰ä¸­å¼€è¾Ÿäº†ä¸€å—åŒºåŸŸå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ã€‚**~~

> **ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue747](https://github.com/Snailclimb/JavaGuide/issues/747)ï¼Œ[reference](https://blog.csdn.net/q5706503/article/details/84640762)ï¼‰** ï¼š
>
> 1. **JDK1.7 ä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒº, æ­¤æ—¶ hotspot è™šæ‹Ÿæœºå¯¹æ–¹æ³•åŒºçš„å®ç°ä¸ºæ°¸ä¹…ä»£**
> 2. **JDK1.7 å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­, è¿™é‡Œæ²¡æœ‰æåˆ°è¿è¡Œæ—¶å¸¸é‡æ± ,ä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²å¸¸é‡æ± è¢«å•ç‹¬æ‹¿åˆ°å †,è¿è¡Œæ—¶å¸¸é‡æ± å‰©ä¸‹çš„ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒº, ä¹Ÿå°±æ˜¯ hotspot ä¸­çš„æ°¸ä¹…ä»£** ã€‚
> 3. **JDK1.8 hotspot ç§»é™¤äº†æ°¸ä¹…ä»£ç”¨å…ƒç©ºé—´(Metaspace)å–è€Œä»£ä¹‹, è¿™æ—¶å€™å­—ç¬¦ä¸²å¸¸é‡æ± è¿˜åœ¨å †, è¿è¡Œæ—¶å¸¸é‡æ± è¿˜åœ¨æ–¹æ³•åŒº, åªä¸è¿‡æ–¹æ³•åŒºçš„å®ç°ä»æ°¸ä¹…ä»£å˜æˆäº†å…ƒç©ºé—´(Metaspace)**

ç›¸å…³é—®é¢˜ï¼šJVM å¸¸é‡æ± ä¸­å­˜å‚¨çš„æ˜¯å¯¹è±¡è¿˜æ˜¯å¼•ç”¨å‘¢ï¼Ÿï¼š https://www.zhihu.com/question/57109429/answer/151717241 by RednaxelaFX

####  4.4.1.7 ç›´æ¥å†…å­˜

**ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨ã€‚è€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ OutOfMemoryError é”™è¯¯å‡ºç°ã€‚**

JDK1.4 ä¸­æ–°åŠ å…¥çš„ **NIO(New Input/Output) ç±»**ï¼Œå¼•å…¥äº†ä¸€ç§åŸºäº**é€šé“ï¼ˆChannelï¼‰\**ä¸\**ç¼“å­˜åŒºï¼ˆBufferï¼‰\**çš„ I/O æ–¹å¼ï¼Œå®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨ Java å †ä¸­çš„ DirectByteBuffer å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·å°±èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸º\**é¿å…äº†åœ¨ Java å †å’Œ Native å †ä¹‹é—´æ¥å›å¤åˆ¶æ•°æ®**ã€‚

æœ¬æœºç›´æ¥å†…å­˜çš„åˆ†é…ä¸ä¼šå—åˆ° Java å †çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜å°±ä¼šå—åˆ°æœ¬æœºæ€»å†…å­˜å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚

### 4.4.2 HotSpot è™šæ‹Ÿæœºå¯¹è±¡æ¢ç§˜

é€šè¿‡ä¸Šé¢çš„ä»‹ç»æˆ‘ä»¬å¤§æ¦‚çŸ¥é“äº†è™šæ‹Ÿæœºçš„å†…å­˜æƒ…å†µï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çš„äº†è§£ä¸€ä¸‹ HotSpot è™šæ‹Ÿæœºåœ¨ Java å †ä¸­å¯¹è±¡åˆ†é…ã€å¸ƒå±€å’Œè®¿é—®çš„å…¨è¿‡ç¨‹ã€‚

####  4.4.2.1 å¯¹è±¡çš„åˆ›å»º

ä¸‹å›¾ä¾¿æ˜¯ Java å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæˆ‘å»ºè®®æœ€å¥½æ˜¯èƒ½é»˜å†™å‡ºæ¥ï¼Œå¹¶ä¸”è¦æŒæ¡æ¯ä¸€æ­¥åœ¨åšä»€ä¹ˆã€‚

![Javaåˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹.png](./images/Javaåˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹.png)

#####  Step1:ç±»åŠ è½½æ£€æŸ¥

è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡ new æŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆå°†å»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°è¿™ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²è¢«åŠ è½½è¿‡ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ã€‚

#####  Step2:åˆ†é…å†…å­˜

åœ¨**ç±»åŠ è½½æ£€æŸ¥**é€šè¿‡åï¼Œæ¥ä¸‹æ¥è™šæ‹Ÿæœºå°†ä¸ºæ–°ç”Ÿå¯¹è±¡**åˆ†é…å†…å­˜**ã€‚å¯¹è±¡æ‰€éœ€çš„å†…å­˜å¤§å°åœ¨ç±»åŠ è½½å®Œæˆåä¾¿å¯ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä» Java å †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚**åˆ†é…æ–¹å¼**æœ‰ **â€œæŒ‡é’ˆç¢°æ’â€** å’Œ **â€œç©ºé—²åˆ—è¡¨â€** ä¸¤ç§ï¼Œ**é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”± Java å †æ˜¯å¦è§„æ•´å†³å®šï¼Œè€Œ Java å †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®š**ã€‚

**å†…å­˜åˆ†é…çš„ä¸¤ç§æ–¹å¼ï¼šï¼ˆè¡¥å……å†…å®¹ï¼Œéœ€è¦æŒæ¡ï¼‰**

é€‰æ‹©ä»¥ä¸Šä¸¤ç§æ–¹å¼ä¸­çš„å“ªä¸€ç§ï¼Œå–å†³äº Java å †å†…å­˜æ˜¯å¦è§„æ•´ã€‚è€Œ Java å †å†…å­˜æ˜¯å¦è§„æ•´ï¼Œå–å†³äº GC æ”¶é›†å™¨çš„ç®—æ³•æ˜¯"æ ‡è®°-æ¸…é™¤"ï¼Œè¿˜æ˜¯"æ ‡è®°-æ•´ç†"ï¼ˆä¹Ÿç§°ä½œ"æ ‡è®°-å‹ç¼©"ï¼‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¤åˆ¶ç®—æ³•å†…å­˜ä¹Ÿæ˜¯è§„æ•´çš„

![å†…å­˜åˆ†é…çš„ä¸¤ç§æ–¹å¼.png](./images/å†…å­˜åˆ†é…çš„ä¸¤ç§æ–¹å¼.png)

**å†…å­˜åˆ†é…å¹¶å‘é—®é¢˜ï¼ˆè¡¥å……å†…å®¹ï¼Œéœ€è¦æŒæ¡ï¼‰**

åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºå¯¹è±¡æ˜¯å¾ˆé¢‘ç¹çš„äº‹æƒ…ï¼Œä½œä¸ºè™šæ‹Ÿæœºæ¥è¯´ï¼Œå¿…é¡»è¦ä¿è¯çº¿ç¨‹æ˜¯å®‰å…¨çš„ï¼Œé€šå¸¸æ¥è®²ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨ä¸¤ç§æ–¹å¼æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š

- **CAS+å¤±è´¥é‡è¯•ï¼š** CAS æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ã€‚æ‰€è°“ä¹è§‚é”å°±æ˜¯ï¼Œæ¯æ¬¡ä¸åŠ é”è€Œæ˜¯å‡è®¾æ²¡æœ‰å†²çªè€Œå»å®ŒæˆæŸé¡¹æ“ä½œï¼Œå¦‚æœå› ä¸ºå†²çªå¤±è´¥å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚**è™šæ‹Ÿæœºé‡‡ç”¨ CAS é…ä¸Šå¤±è´¥é‡è¯•çš„æ–¹å¼ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§ã€‚**
- **TLABï¼š** ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹é¢„å…ˆåœ¨ Eden åŒºåˆ†é…ä¸€å—å„¿å†…å­˜ï¼ŒJVM åœ¨ç»™çº¿ç¨‹ä¸­çš„å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œé¦–å…ˆåœ¨ TLAB åˆ†é…ï¼Œå½“å¯¹è±¡å¤§äº TLAB ä¸­çš„å‰©ä½™å†…å­˜æˆ– TLAB çš„å†…å­˜å·²ç”¨å°½æ—¶ï¼Œå†é‡‡ç”¨ä¸Šè¿°çš„ CAS è¿›è¡Œå†…å­˜åˆ†é…

#####  Step3:åˆå§‹åŒ–é›¶å€¼

å†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨ Java ä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚

##### Step4:è®¾ç½®å¯¹è±¡å¤´

åˆå§‹åŒ–é›¶å€¼å®Œæˆä¹‹åï¼Œ**è™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®**ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚ **è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ã€‚** å¦å¤–ï¼Œæ ¹æ®è™šæ‹Ÿæœºå½“å‰è¿è¡ŒçŠ¶æ€çš„ä¸åŒï¼Œå¦‚æ˜¯å¦å¯ç”¨åå‘é”ç­‰ï¼Œå¯¹è±¡å¤´ä¼šæœ‰ä¸åŒçš„è®¾ç½®æ–¹å¼ã€‚

##### Step5:æ‰§è¡Œ init æ–¹æ³•

åœ¨ä¸Šé¢å·¥ä½œéƒ½å®Œæˆä¹‹åï¼Œä»è™šæ‹Ÿæœºçš„è§†è§’æ¥çœ‹ï¼Œä¸€ä¸ªæ–°çš„å¯¹è±¡å·²ç»äº§ç”Ÿäº†ï¼Œä½†ä» Java ç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œå¯¹è±¡åˆ›å»ºæ‰åˆšå¼€å§‹ï¼Œ`<init>` æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½è¿˜ä¸ºé›¶ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œæ‰§è¡Œ new æŒ‡ä»¤ä¹‹åä¼šæ¥ç€æ‰§è¡Œ `<init>` æ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œå…¨äº§ç”Ÿå‡ºæ¥ã€‚

####  4.4.2.2 å¯¹è±¡çš„å†…å­˜å¸ƒå±€

åœ¨ Hotspot è™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¯ä»¥åˆ†ä¸º 3 å—åŒºåŸŸï¼š**å¯¹è±¡å¤´**ã€**å®ä¾‹æ•°æ®**å’Œ**å¯¹é½å¡«å……**ã€‚

**Hotspot è™šæ‹Ÿæœºçš„å¯¹è±¡å¤´åŒ…æ‹¬ä¸¤éƒ¨åˆ†ä¿¡æ¯**ï¼Œ**ç¬¬ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®**ï¼ˆå“ˆå¸Œç ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ç­‰ç­‰ï¼‰ï¼Œ**å¦ä¸€éƒ¨åˆ†æ˜¯ç±»å‹æŒ‡é’ˆ**ï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯é‚£ä¸ªç±»çš„å®ä¾‹ã€‚

**å®ä¾‹æ•°æ®éƒ¨åˆ†æ˜¯å¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯**ï¼Œä¹Ÿæ˜¯åœ¨ç¨‹åºä¸­æ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹ã€‚

**å¯¹é½å¡«å……éƒ¨åˆ†ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰ï¼Œä»…ä»…èµ·å ä½ä½œç”¨ã€‚** å› ä¸º Hotspot è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯ **8 å­—èŠ‚çš„æ•´æ•°å€**ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ã€‚è€Œå¯¹è±¡å¤´éƒ¨åˆ†æ­£å¥½æ˜¯ 8 å­—èŠ‚çš„å€æ•°ï¼ˆ1 å€æˆ– 2 å€ï¼‰ï¼Œå› æ­¤ï¼Œå½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½æ—¶ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨ã€‚

#### 4.4.2.3 å¯¹è±¡çš„è®¿é—®å®šä½

å»ºç«‹å¯¹è±¡å°±æ˜¯ä¸ºäº†ä½¿ç”¨å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ Java ç¨‹åºé€šè¿‡æ ˆä¸Šçš„ reference æ•°æ®æ¥æ“ä½œå †ä¸Šçš„å…·ä½“å¯¹è±¡ã€‚å¯¹è±¡çš„è®¿é—®æ–¹å¼ç”±è™šæ‹Ÿæœºå®ç°è€Œå®šï¼Œç›®å‰ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰**â‘  ä½¿ç”¨å¥æŸ„**å’Œ**â‘¡ ç›´æ¥æŒ‡é’ˆ**ä¸¤ç§ï¼š

1. **å¥æŸ„ï¼š** å¦‚æœä½¿ç”¨å¥æŸ„çš„è¯ï¼Œé‚£ä¹ˆ Java å †ä¸­å°†ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œreference ä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®ä¸ç±»å‹æ•°æ®å„è‡ªçš„å…·ä½“åœ°å€ä¿¡æ¯ï¼›

![å¯¹è±¡çš„è®¿é—®å®šä½-ä½¿ç”¨å¥æŸ„.png](./images/å¯¹è±¡çš„è®¿é—®å®šä½-ä½¿ç”¨å¥æŸ„.png)

1. **ç›´æ¥æŒ‡é’ˆï¼š** å¦‚æœä½¿ç”¨ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼Œé‚£ä¹ˆ Java å †å¯¹è±¡çš„å¸ƒå±€ä¸­å°±å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œè€Œ reference ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡çš„åœ°å€ã€‚

![å¯¹è±¡çš„è®¿é—®å®šä½-ç›´æ¥æŒ‡é’ˆ.png](./images/å¯¹è±¡çš„è®¿é—®å®šä½-ç›´æ¥æŒ‡é’ˆ.png)

**è¿™ä¸¤ç§å¯¹è±¡è®¿é—®æ–¹å¼å„æœ‰ä¼˜åŠ¿ã€‚ä½¿ç”¨å¥æŸ„æ¥è®¿é—®çš„æœ€å¤§å¥½å¤„æ˜¯ reference ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œ reference æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚ä½¿ç”¨ç›´æ¥æŒ‡é’ˆè®¿é—®æ–¹å¼æœ€å¤§çš„å¥½å¤„å°±æ˜¯é€Ÿåº¦å¿«ï¼Œå®ƒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ã€‚**

### 4.4.3 JVMå†…å­˜æ¨¡å‹çš„ä¸€äº›é—®é¢˜

#### a) å¸¸é‡æ± åœ¨å“ªï¼Ÿ

åœ¨JDK1.6åŠä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒº, æ­¤æ—¶hotspotè™šæ‹Ÿæœºå¯¹æ–¹æ³•åŒºçš„å®ç°ä¸ºæ°¸ä¹…ä»£ï¼ˆä½äºå †å†…å­˜ä¸­ï¼‰

åœ¨JDK1.7 å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­, è¿™é‡Œæ²¡æœ‰æåˆ°è¿è¡Œæ—¶å¸¸é‡æ± ,ä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²å¸¸é‡æ± è¢«å•ç‹¬æ‹¿åˆ°å †,è¿è¡Œæ—¶å¸¸é‡æ± å‰©ä¸‹çš„ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒº, ä¹Ÿå°±æ˜¯hotspotä¸­çš„æ°¸ä¹…ä»£

åœ¨JDK1.8 hotspotç§»é™¤äº†æ°¸ä¹…ä»£ç”¨å…ƒç©ºé—´å–è€Œä»£ä¹‹, è¿™æ—¶å€™å­—ç¬¦ä¸²å¸¸é‡æ± è¿˜åœ¨å †, è¿è¡Œæ—¶å¸¸é‡æ± è¿˜åœ¨æ–¹æ³•åŒº, åªä¸è¿‡æ–¹æ³•åŒºçš„å®ç°ä»æ°¸ä¹…ä»£å˜æˆäº†å…ƒç©ºé—´(å †å¤–å†…å­˜)

#### b) JVM å¸¸é‡æ± ä¸­å­˜å‚¨çš„æ˜¯å¯¹è±¡è¿˜æ˜¯å¼•ç”¨å‘¢ï¼Ÿ

> ç›®å‰æ¥çœ‹ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆéå­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰å…¶ä¸­çš„å¼•ç”¨ç±»å‹å¸¸é‡éƒ½å­˜çš„æ˜¯å¼•ç”¨ï¼Œå®é™…çš„å¯¹è±¡è¿˜æ˜¯å­˜åœ¨Java heapä¸Šçš„ã€‚

#### c) Jdk8ä¹‹åä¸ºä»€ä¹ˆåºŸé™¤æ°¸ä¹…ä»£ï¼Œæ”¹ç”¨å…ƒç©ºé—´

#### d) ä½ è¯´cmså­˜åœ¨å†…å­˜ç¢ç‰‡ä¸¥é‡çš„é—®é¢˜ï¼Œå½“å†…å­˜ç¢ç‰‡ä¸¥é‡ä¼šå‘ç”Ÿä»€ä¹ˆ

(èµ·å§‹é—®æ³•æ²¡ç†è§£ï¼Œåæ¥æ‰çŸ¥é“æ˜¯è¦å›ç­”é‡‡ç”¨serialå›æ”¶å™¨åšå¤‡é€‰æ–¹æ¡ˆ)

#### f) jVMå„ä¸ªå†…å­˜åŒºåŸŸçš„é»˜è®¤å¤§å°

#### eï¼‰**String ç±»å‹çš„å˜é‡å’Œå¸¸é‡åšâ€œ+â€è¿ç®—æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

å…ˆæ¥çœ‹å­—ç¬¦ä¸²ä¸åŠ  `final` å…³é”®å­—æ‹¼æ¥çš„æƒ…å†µï¼ˆJDK1.8ï¼‰ï¼š

```Java
String str1 = "str";
String str2 = "ing";
String str3 = "str" + "ing";//å¸¸é‡æ± ä¸­çš„å¯¹è±¡
String str4 = str1 + str2; //åœ¨å †ä¸Šåˆ›å»ºçš„æ–°çš„å¯¹è±¡
String str5 = "string";//å¸¸é‡æ± ä¸­çš„å¯¹è±¡
System.out.println(str3 == str4);//false
System.out.println(str3 == str5);//true
System.out.println(str4 == str5);//false
```

**æ³¨æ„** ï¼šæ¯”è¾ƒ String å­—ç¬¦ä¸²çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¯ä»¥ä½¿ç”¨ `equals()` æ–¹æ³•ã€‚ `String` ä¸­çš„ `equals` æ–¹æ³•æ˜¯è¢«é‡å†™è¿‡çš„ã€‚ `Object` çš„ `equals` æ–¹æ³•æ˜¯æ¯”è¾ƒçš„å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œè€Œ `String` çš„ `equals` æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²çš„å€¼æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœä½ ä½¿ç”¨ `==` æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰çš„è¯ï¼ŒIDEA è¿˜æ˜¯æç¤ºä½ ä½¿ç”¨ `equals()` æ–¹æ³•æ›¿æ¢ã€‚

![image-20210817123252441.png](./images/image-20210817123252441.png)

å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼Œ== æ¯”è¾ƒçš„æ˜¯å€¼ã€‚å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹æ¥è¯´ï¼Œ==æ¯”è¾ƒçš„æ˜¯å¯¹è±¡çš„å†…å­˜åœ°å€

å¯¹äºç¼–è¯‘æœŸå¯ä»¥ç¡®å®šå€¼çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯å¸¸é‡å­—ç¬¦ä¸² ï¼Œjvm ä¼šå°†å…¶å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± 

**å­—ç¬¦ä¸²å¸¸é‡æ± ** æ˜¯ JVM ä¸ºäº†æå‡æ€§èƒ½å’Œå‡å°‘å†…å­˜æ¶ˆè€—é’ˆä¸ºå­—ç¬¦ä¸²ï¼ˆString ç±»ï¼‰ä¸“é—¨å¼€è¾Ÿçš„ä¸€å—åŒºåŸŸï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é¿å…å­—ç¬¦ä¸²çš„é‡å¤åˆ›å»ºã€‚

```java
String aa = "ab"; // æ”¾åœ¨å¸¸é‡æ± ä¸­
String bb = "ab"; // ä»å¸¸é‡æ± ä¸­æŸ¥æ‰¾
System.out.println("aa==bb");// true
```

JDK1.7 ä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒºã€‚JDK1.7 çš„æ—¶å€™ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­ã€‚

å¹¶ä¸”ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ‹¼æ¥å¾—åˆ°çš„å­—ç¬¦ä¸²å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²ç»è¢«å­˜æ”¾å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œè¿™ä¸ªå¾—ç›Šäºç¼–è¯‘å™¨çš„ä¼˜åŒ–ã€‚

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒJavac ç¼–è¯‘å™¨ï¼ˆä¸‹æ–‡ä¸­ç»Ÿç§°ä¸ºç¼–è¯‘å™¨ï¼‰ä¼šè¿›è¡Œä¸€ä¸ªå«åš **å¸¸é‡æŠ˜å (Constant Folding)** çš„ä»£ç ä¼˜åŒ–ã€‚ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ä¸­æ˜¯ä¹Ÿæœ‰ä»‹ç»åˆ°

![image-20210817142715396.png](./images/image-20210817142715396.png)

å¸¸é‡æŠ˜å ä¼šæŠŠå¸¸é‡è¡¨è¾¾å¼çš„å€¼æ±‚å‡ºæ¥ä½œä¸ºå¸¸é‡åµŒåœ¨æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¸­ï¼Œè¿™æ˜¯ Javac ç¼–è¯‘å™¨ä¼šå¯¹æºä»£ç åšçš„æå°‘é‡ä¼˜åŒ–æªæ–½ä¹‹ä¸€(ä»£ç ä¼˜åŒ–å‡ ä¹éƒ½åœ¨å³æ—¶ç¼–è¯‘å™¨ä¸­è¿›è¡Œ)ã€‚

å¯¹äº `String str3 = "str" + "ing";` ç¼–è¯‘å™¨ä¼šç»™ä½ ä¼˜åŒ–æˆ `String str3 = "string";` ã€‚

å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¸¸é‡éƒ½ä¼šè¿›è¡ŒæŠ˜å ï¼Œåªæœ‰ç¼–è¯‘å™¨åœ¨ç¨‹åºç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šå€¼çš„å¸¸é‡æ‰å¯ä»¥ï¼š

1. åŸºæœ¬æ•°æ®ç±»å‹(byteã€booleanã€shortã€charã€intã€floatã€longã€double)ä»¥åŠå­—ç¬¦ä¸²å¸¸é‡
2. `final` ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹å’Œå­—ç¬¦ä¸²å˜é‡
3. å­—ç¬¦ä¸²é€šè¿‡ â€œ+â€æ‹¼æ¥å¾—åˆ°çš„å­—ç¬¦ä¸²ã€åŸºæœ¬æ•°æ®ç±»å‹ä¹‹é—´ç®—æ•°è¿ç®—ï¼ˆåŠ å‡ä¹˜é™¤ï¼‰ã€åŸºæœ¬æ•°æ®ç±»å‹çš„ä½è¿ç®—ï¼ˆ<<ã€>>ã€>>> ï¼‰

å› æ­¤ï¼Œ`str1` ã€ `str2` ã€ `str3` éƒ½å±äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡ã€‚

å¼•ç”¨çš„å€¼åœ¨ç¨‹åºç¼–è¯‘æœŸæ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç¼–è¯‘å™¨æ— æ³•å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚

å¯¹è±¡å¼•ç”¨å’Œâ€œ+â€çš„å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡ `StringBuilder` è°ƒç”¨ `append()` æ–¹æ³•å®ç°çš„ï¼Œæ‹¼æ¥å®Œæˆä¹‹åè°ƒç”¨ `toString()` å¾—åˆ°ä¸€ä¸ª `String` å¯¹è±¡ ã€‚

```java
String str4 = new StringBuilder().append(str1).append(str2).toString();
```

å› æ­¤ï¼Œ`str4` å¹¶ä¸æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜åœ¨çš„å¯¹è±¡ï¼Œå±äºå †ä¸Šçš„æ–°å¯¹è±¡ã€‚

æˆ‘ç”»äº†ä¸€ä¸ªå›¾å¸®åŠ©ç†è§£ï¼š

![å­—ç¬¦ä¸²æ‹¼æ¥-å¸¸é‡æ± .png](./images/å­—ç¬¦ä¸²æ‹¼æ¥-å¸¸é‡æ± .png)

æˆ‘ä»¬åœ¨å¹³æ—¶å†™ä»£ç çš„æ—¶å€™ï¼Œå°½é‡é¿å…å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡æ‹¼æ¥ï¼Œå› ä¸ºè¿™æ ·ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœéœ€è¦æ”¹å˜å­—ç¬¦ä¸²çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `StringBuilder` æˆ–è€… `StringBuffer`ã€‚

ä¸è¿‡ï¼Œå­—ç¬¦ä¸²ä½¿ç”¨ `final` å…³é”®å­—å£°æ˜ä¹‹åï¼Œå¯ä»¥è®©ç¼–è¯‘å™¨å½“åšå¸¸é‡æ¥å¤„ç†ã€‚

```java
final String str1 = "str";
final String str2 = "ing";
// ä¸‹é¢ä¸¤ä¸ªè¡¨è¾¾å¼å…¶å®æ˜¯ç­‰ä»·çš„
String c = "str" + "str2";// å¸¸é‡æ± ä¸­çš„å¯¹è±¡
String d = str1 + str2; // å¸¸é‡æ± ä¸­çš„å¯¹è±¡
System.out.println(c == d);// true
```

è¢« `final` å…³é”®å­—ä¿®æ”¹ä¹‹åçš„ `String` ä¼šè¢«ç¼–è¯‘å™¨å½“åšå¸¸é‡æ¥å¤„ç†ï¼Œç¼–è¯‘å™¨åœ¨ç¨‹åºç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šå®ƒçš„å€¼ï¼Œå…¶æ•ˆæœå°±æƒ³åˆ°äºè®¿é—®å¸¸é‡ã€‚

å¦‚æœ ï¼Œç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶æ‰èƒ½çŸ¥é“å…¶ç¡®åˆ‡å€¼çš„è¯ï¼Œå°±æ— æ³•å¯¹å…¶ä¼˜åŒ–ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆ`str2` åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šå…¶å€¼ï¼‰ï¼š

```java
final String str1 = "str";
final String str2 = getStr();
String c = "str" + "str2";// å¸¸é‡æ± ä¸­çš„å¯¹è±¡
String d = str1 + str2; // å¸¸é‡æ± ä¸­çš„å¯¹è±¡
System.out.println(c == d);// false
public static String getStr() {
      return "ing";
}
```

**æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜ï¼**

```java
String str1 = "abcd";
String str2 = new String("abcd");
String str3 = new String("abcd");
System.out.println(str1==str2);
System.out.println(str2==str3);
```

ä¸Šé¢çš„ä»£ç è¿è¡Œä¹‹åä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š

```java
false
false
```

**è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢è¿™ç§åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹å¼ï¼š

```java
// ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ‹¿å¯¹è±¡
String str1 = "abcd";
```

è¿™ç§æƒ…å†µä¸‹ï¼Œjvm ä¼šå…ˆæ£€æŸ¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰æ²¡æœ‰"abcd"ï¼Œå¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªï¼Œç„¶å str1 æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥å°† str1 æŒ‡å‘"abcd""ï¼›

å› æ­¤ï¼Œ`str1` æŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¯¹è±¡ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸‹é¢è¿™ç§åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡çš„æ–¹å¼ï¼š

```java
// ç›´æ¥åœ¨å †å†…å­˜ç©ºé—´åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚
String str2 = new String("abcd");
String str3 = new String("abcd");
```

**åªè¦ä½¿ç”¨ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œä¾¿éœ€è¦åˆ›å»ºæ–°çš„å¯¹è±¡** ã€‚

ä½¿ç”¨ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡çš„æ–¹å¼å¦‚ä¸‹ï¼Œå¯ä»¥ç®€å•æ¦‚æ‹¬ä¸º 3 æ­¥ï¼š

1. åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡
2. æ£€æŸ¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦æœ‰å’Œ new çš„å­—ç¬¦ä¸²å€¼ç›¸ç­‰çš„å­—ç¬¦ä¸²å¸¸é‡
3. å¦‚æœæ²¡æœ‰çš„è¯éœ€è¦åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¹Ÿåˆ›å»ºä¸€ä¸ªå€¼ç›¸ç­‰çš„å­—ç¬¦ä¸²å¸¸é‡ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±ç›´æ¥è¿”å›å †ä¸­çš„å­—ç¬¦ä¸²å®ä¾‹å¯¹è±¡åœ°å€ã€‚

å› æ­¤ï¼Œ`str2` å’Œ `str3` éƒ½æ˜¯åœ¨å †ä¸­æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚

**å­—ç¬¦ä¸²å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼š**

1. ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„ `String` å¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­ã€‚
2. å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„ `String` å¯¹è±¡ï¼Œä½¿ç”¨ `String` æä¾›çš„ `intern()` æ–¹æ³•ä¹Ÿæœ‰åŒæ ·çš„æ•ˆæœã€‚`String.intern()` æ˜¯ä¸€ä¸ª Native æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼šå¦‚æœè¿è¡Œæ—¶å¸¸é‡æ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡å†…å®¹çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›å¸¸é‡æ± ä¸­è¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼›å¦‚æœæ²¡æœ‰ï¼ŒJDK1.7 ä¹‹å‰ï¼ˆä¸åŒ…å« 1.7ï¼‰çš„å¤„ç†æ–¹å¼æ˜¯åœ¨å¸¸é‡æ± ä¸­åˆ›å»ºä¸æ­¤ `String` å†…å®¹ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›å¸¸é‡æ± ä¸­åˆ›å»ºçš„å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼ŒJDK1.7 ä»¥åŠä¹‹åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­ï¼Œjvm ä¸ä¼šåœ¨å¸¸é‡æ± ä¸­åˆ›å»ºè¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†å †ä¸­è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ç›´æ¥æ”¾åˆ°å¸¸é‡æ± ä¸­ï¼Œå‡å°‘ä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆJDK 1.8ï¼‰ :

```java
String s1 = "Javatpoint";
String s2 = s1.intern();
String s3 = new String("Javatpoint");
String s4 = s3.intern();
System.out.println(s1==s2); // True
System.out.println(s1==s3); // False
System.out.println(s1==s4); // True
System.out.println(s2==s3); // False
System.out.println(s2==s4); // True
System.out.println(s3==s4); // False
```

**æ€»ç»“** ï¼š

1. å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼Œ==æ¯”è¾ƒçš„æ˜¯å€¼ã€‚å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹æ¥è¯´ï¼Œ==æ¯”è¾ƒçš„æ˜¯å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚
2. åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒJavac ç¼–è¯‘å™¨ï¼ˆä¸‹æ–‡ä¸­ç»Ÿç§°ä¸ºç¼–è¯‘å™¨ï¼‰ä¼šè¿›è¡Œä¸€ä¸ªå«åš **å¸¸é‡æŠ˜å (Constant Folding)** çš„ä»£ç ä¼˜åŒ–ã€‚å¸¸é‡æŠ˜å ä¼šæŠŠå¸¸é‡è¡¨è¾¾å¼çš„å€¼æ±‚å‡ºæ¥ä½œä¸ºå¸¸é‡åµŒåœ¨æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¸­ï¼Œè¿™æ˜¯ Javac ç¼–è¯‘å™¨ä¼šå¯¹æºä»£ç åšçš„æå°‘é‡ä¼˜åŒ–æªæ–½ä¹‹ä¸€(ä»£ç ä¼˜åŒ–å‡ ä¹éƒ½åœ¨å³æ—¶ç¼–è¯‘å™¨ä¸­è¿›è¡Œ)ã€‚
3. ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è¦å°½é‡é¿å…é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºå­—ç¬¦ä¸²ã€‚ä½¿ç”¨åŒå¼•å·å£°æ˜çš„ `String` å¯¹è±¡ï¼ˆ `String s1 = "java"` ï¼‰æ›´åˆ©äºè®©ç¼–è¯‘å™¨æœ‰æœºä¼šä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ï¼ŒåŒæ—¶ä¹Ÿæ›´æ˜“äºé˜…è¯»ã€‚
4. è¢« `final` å…³é”®å­—ä¿®æ”¹ä¹‹åçš„ `String` ä¼šè¢«ç¼–è¯‘å™¨å½“åšå¸¸é‡æ¥å¤„ç†ï¼Œç¼–è¯‘å™¨ç¨‹åºç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šå®ƒçš„å€¼ï¼Œå…¶æ•ˆæœå°±æƒ³åˆ°äºè®¿é—®å¸¸é‡ã€‚

#### f) String s1 = new String("abc");è¿™å¥è¯åˆ›å»ºäº†å‡ ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Ÿ

ä¼šåˆ›å»º 1 æˆ– 2 ä¸ªå­—ç¬¦ä¸²ï¼š

- å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²å­˜åœ¨å­—ç¬¦ä¸²å¸¸é‡â€œabcâ€ï¼Œåˆ™åªä¼šåœ¨å †ç©ºé—´åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡â€œabcâ€ã€‚
- å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰å­—ç¬¦ä¸²å¸¸é‡â€œabcâ€ï¼Œé‚£ä¹ˆå®ƒå°†é¦–å…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºï¼Œç„¶ååœ¨å †ç©ºé—´ä¸­åˆ›å»ºï¼Œå› æ­¤å°†åˆ›å»ºæ€»å…± 2 ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚

**éªŒè¯ï¼š**

```java
String s1 = new String("abc");// å †å†…å­˜çš„åœ°å€å€¼
String s2 = "abc";
System.out.println(s1 == s2);// è¾“å‡º false,å› ä¸ºä¸€ä¸ªæ˜¯å †å†…å­˜ï¼Œä¸€ä¸ªæ˜¯å¸¸é‡æ± çš„å†…å­˜ï¼Œæ•…ä¸¤è€…æ˜¯ä¸åŒçš„ã€‚
System.out.println(s1.equals(s2));// è¾“å‡º true
```

**ç»“æœï¼š**

```java
false
true
```

#### g) 8 ç§åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»å’Œå¸¸é‡æ± 

Java åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»çš„å¤§éƒ¨åˆ†éƒ½å®ç°äº†å¸¸é‡æ± æŠ€æœ¯ã€‚

`Byte`,`Short`,`Integer`,`Long` è¿™ 4 ç§åŒ…è£…ç±»é»˜è®¤åˆ›å»ºäº†æ•°å€¼ **[-128ï¼Œ127]** çš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œ`Character` åˆ›å»ºäº†æ•°å€¼åœ¨ **[0,127]** èŒƒå›´çš„ç¼“å­˜æ•°æ®ï¼Œ`Boolean` ç›´æ¥è¿”å› `True` Or `False`ã€‚

ä¸¤ç§æµ®ç‚¹æ•°ç±»å‹çš„åŒ…è£…ç±» `Float`,`Double` å¹¶æ²¡æœ‰å®ç°å¸¸é‡æ± æŠ€æœ¯ã€‚

```java
Integer i1 = 33;
Integer i2 = 33;
System.out.println(i1 == i2);// è¾“å‡º true
Integer i11 = 333;
Integer i22 = 333;
System.out.println(i11 == i22);// è¾“å‡º false
Double i3 = 1.2;
Double i4 = 1.2;
System.out.println(i3 == i4);// è¾“å‡º false
```

**Integer ç¼“å­˜æºä»£ç ï¼š**

```java
/**
*æ­¤æ–¹æ³•å°†å§‹ç»ˆç¼“å­˜-128 åˆ° 127ï¼ˆåŒ…æ‹¬ç«¯ç‚¹ï¼‰èŒƒå›´å†…çš„å€¼ï¼Œå¹¶å¯ä»¥ç¼“å­˜æ­¤èŒƒå›´ä¹‹å¤–çš„å…¶ä»–å€¼ã€‚
*/
public static Integer valueOf(int i) {
    if (i >= IntegerCache.low && i <= IntegerCache.high)
      return IntegerCache.cache[i + (-IntegerCache.low)];
    return new Integer(i);
}
private static class IntegerCache {
    static final int low = -128;
    static final int high;
    static final Integer cache[];
}
```

**`Character` ç¼“å­˜æºç :**

```java
public static Character valueOf(char c) {
    if (c <= 127) { // must cache
      return CharacterCache.cache[(int)c];
    }
    return new Character(c);
}

private static class CharacterCache {
    private CharacterCache(){}

    static final Character cache[] = new Character[127 + 1];
    static {
        for (int i = 0; i < cache.length; i++)
            cache[i] = new Character((char)i);
    }
}
```

**`Boolean` ç¼“å­˜æºç ï¼š**

```java
public static Boolean valueOf(boolean b) {
    return (b ? TRUE : FALSE);
}
```

å¦‚æœè¶…å‡ºå¯¹åº”èŒƒå›´ä»ç„¶ä¼šå»åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç¼“å­˜çš„èŒƒå›´åŒºé—´çš„å¤§å°åªæ˜¯åœ¨æ€§èƒ½å’Œèµ„æºä¹‹é—´çš„æƒè¡¡ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é—®é¢˜ã€‚ä¸‹é¢çš„ä»£ç çš„è¾“å‡ºç»“æœæ˜¯ `true` è¿˜æ˜¯ `flase` å‘¢ï¼Ÿ

```java
Integer i1 = 40;
Integer i2 = new Integer(40);
System.out.println(i1==i2);
```

`Integer i1=40` è¿™ä¸€è¡Œä»£ç ä¼šå‘ç”Ÿæ‹†ç®±ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™è¡Œä»£ç ç­‰ä»·äº `Integer i1=Integer.valueOf(40)` ã€‚å› æ­¤ï¼Œ`i1` ç›´æ¥ä½¿ç”¨çš„æ˜¯å¸¸é‡æ± ä¸­çš„å¯¹è±¡ã€‚è€Œ`Integer i1 = new Integer(40)` ä¼šç›´æ¥åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚

å› æ­¤ï¼Œç­”æ¡ˆæ˜¯ `false` ã€‚ä½ ç­”å¯¹äº†å—ï¼Ÿ

è®°ä½ï¼š**æ‰€æœ‰æ•´å‹åŒ…è£…ç±»å¯¹è±¡ä¹‹é—´å€¼çš„æ¯”è¾ƒï¼Œå…¨éƒ¨ä½¿ç”¨ equals æ–¹æ³•æ¯”è¾ƒ**ã€‚

![20210313164740893.png](./images/20210313164740893.png)

**Integer æ¯”è¾ƒæ›´ä¸°å¯Œçš„ä¸€ä¸ªä¾‹å­:**

```java
Integer i1 = 40;
Integer i2 = 40;
Integer i3 = 0;
Integer i4 = new Integer(40);
Integer i5 = new Integer(40);
Integer i6 = new Integer(0);

System.out.println(i1 == i2);// true
System.out.println(i1 == i2 + i3);//true
System.out.println(i1 == i4);// false
System.out.println(i4 == i5);// false
System.out.println(i4 == i5 + i6);// true
System.out.println(40 == i5 + i6);// true
```

`i1` , `i2 `, `i3` éƒ½æ˜¯å¸¸é‡æ± ä¸­çš„å¯¹è±¡ï¼Œ`i4` , `i5` , `i6` æ˜¯å †ä¸­çš„å¯¹è±¡ã€‚

`i4 == i5 + i6` ä¸ºä»€ä¹ˆæ˜¯ true å‘¢ï¼Ÿå› ä¸ºï¼Œ `i5` å’Œ `i6` ä¼šè¿›è¡Œè‡ªåŠ¨æ‹†ç®±æ“ä½œï¼Œè¿›è¡Œæ•°å€¼ç›¸åŠ ï¼Œå³ `i4 == 40` ã€‚ `Integer` å¯¹è±¡æ— æ³•ä¸æ•°å€¼è¿›è¡Œç›´æ¥æ¯”è¾ƒï¼Œæ‰€ä»¥ `i4` è‡ªåŠ¨æ‹†ç®±è½¬ä¸º int å€¼ 40ï¼Œæœ€ç»ˆè¿™æ¡è¯­å¥è½¬ä¸º `40 == 40` è¿›è¡Œæ•°å€¼æ¯”è¾ƒã€‚



### 4.4.4 ç±»åŠ è½½è¿‡ç¨‹

ç±»åŠ è½½è¿‡ç¨‹ï¼š**åŠ è½½->è¿æ¥->åˆå§‹åŒ–**ã€‚è¿æ¥è¿‡ç¨‹åˆå¯åˆ†ä¸ºä¸‰æ­¥ï¼š**éªŒè¯->å‡†å¤‡->è§£æ**ã€‚

![ç±»åŠ è½½è¿‡ç¨‹.png](./images/ç±»åŠ è½½è¿‡ç¨‹.png)

ä¸€ä¸ªéæ•°ç»„ç±»çš„åŠ è½½é˜¶æ®µï¼ˆåŠ è½½é˜¶æ®µè·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠ¨ä½œï¼‰æ˜¯å¯æ§æ€§æœ€å¼ºçš„é˜¶æ®µï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å¯ä»¥å»è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ï¼ˆé‡å†™ä¸€ä¸ªç±»åŠ è½½å™¨çš„ `loadClass()` æ–¹æ³•ï¼‰ã€‚æ•°ç»„ç±»å‹ä¸é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºï¼Œå®ƒç”± Java è™šæ‹Ÿæœºç›´æ¥åˆ›å»ºã€‚

æ‰€æœ‰çš„ç±»éƒ½ç”±ç±»åŠ è½½å™¨åŠ è½½ï¼ŒåŠ è½½çš„ä½œç”¨å°±æ˜¯å°† `.class`æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ã€‚

####  ç±»åŠ è½½å™¨æ€»ç»“

JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ ClassLoaderï¼Œé™¤äº† BootstrapClassLoader å…¶ä»–ç±»åŠ è½½å™¨å‡ç”± Java å®ç°ä¸”å…¨éƒ¨ç»§æ‰¿è‡ª`java.lang.ClassLoader`ï¼š

1. **BootstrapClassLoader(å¯åŠ¨ç±»åŠ è½½å™¨)** ï¼šæœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++å®ç°ï¼Œè´Ÿè´£åŠ è½½ `%JAVA_HOME%/lib`ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»æˆ–è€…è¢« `-Xbootclasspath`å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»ã€‚
2. **ExtensionClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)** ï¼šä¸»è¦è´Ÿè´£åŠ è½½ `%JRE_HOME%/lib/ext` ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ï¼Œæˆ–è¢« `java.ext.dirs` ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„ jar åŒ…ã€‚
3. **AppClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)** ï¼šé¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»ã€‚

####  åŒäº²å§”æ´¾æ¨¡å‹

æ¯ä¸€ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªå¯¹åº”å®ƒçš„ç±»åŠ è½½å™¨ã€‚ç³»ç»Ÿä¸­çš„ ClassLoader åœ¨ååŒå·¥ä½œçš„æ—¶å€™ä¼šé»˜è®¤ä½¿ç”¨ **åŒäº²å§”æ´¾æ¨¡å‹** ã€‚å³åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚åŠ è½½çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæŠŠè¯¥è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨çš„ `loadClass()` å¤„ç†ï¼Œå› æ­¤æ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä¸­ã€‚å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å¤„ç†æ—¶ï¼Œæ‰ç”±è‡ªå·±æ¥å¤„ç†ã€‚å½“çˆ¶ç±»åŠ è½½å™¨ä¸º null æ—¶ï¼Œä¼šä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä½œä¸ºçˆ¶ç±»åŠ è½½å™¨ã€‚

![classloader_WPSå›¾ç‰‡.png](./images/classloader_WPSå›¾ç‰‡.png)

æ¯ä¸ªç±»åŠ è½½éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ç¨‹åºæ¥éªŒè¯ã€‚

```Java
public class ClassLoaderDemo {
    public static void main(String[] args) {
        System.out.println("ClassLodarDemo's ClassLoader is " + ClassLoaderDemo.class.getClassLoader());
        System.out.println("The Parent of ClassLodarDemo's ClassLoader is " + ClassLoaderDemo.class.getClassLoader().getParent());
        System.out.println("The GrandParent of ClassLodarDemo's ClassLoader is " + ClassLoaderDemo.class.getClassLoader().getParent().getParent());
    }
}
```

Output

```Java
ClassLodarDemo's ClassLoader is sun.misc.Launcher$AppClassLoader@18b4aac2
The Parent of ClassLodarDemo's ClassLoader is sun.misc.Launcher$ExtClassLoader@1b6d3586
The GrandParent of ClassLodarDemo's ClassLoader is null
```

`AppClassLoader`çš„çˆ¶ç±»åŠ è½½å™¨ä¸º`ExtClassLoader`ï¼Œ `ExtClassLoader`çš„çˆ¶ç±»åŠ è½½å™¨ä¸º nullï¼Œ**null å¹¶ä¸ä»£è¡¨`ExtClassLoader`æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨ï¼Œè€Œæ˜¯ `BootstrapClassLoader`** ã€‚

å…¶å®è¿™ä¸ªåŒäº²ç¿»è¯‘çš„å®¹æ˜“è®©åˆ«äººè¯¯è§£ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç†è§£çš„åŒäº²éƒ½æ˜¯çˆ¶æ¯ï¼Œè¿™é‡Œçš„åŒäº²æ›´å¤šåœ°è¡¨è¾¾çš„æ˜¯â€œçˆ¶æ¯è¿™ä¸€è¾ˆâ€çš„äººè€Œå·²ï¼Œå¹¶ä¸æ˜¯è¯´çœŸçš„æœ‰ä¸€ä¸ª Mother ClassLoader å’Œä¸€ä¸ª Father ClassLoader ã€‚å¦å¤–ï¼Œç±»åŠ è½½å™¨ä¹‹é—´çš„â€œçˆ¶å­â€å…³ç³»ä¹Ÿä¸æ˜¯é€šè¿‡ç»§æ‰¿æ¥ä½“ç°çš„ï¼Œæ˜¯ç”±â€œä¼˜å…ˆçº§â€æ¥å†³å®šã€‚å®˜æ–¹ API æ–‡æ¡£å¯¹è¿™éƒ¨åˆ†çš„æè¿°å¦‚ä¸‹:

> The Java platform uses a delegation model for loading classes. **The basic idea is that every class loader has a "parent" class loader.** When loading a class, a class loader first "delegates" the search for the class to its parent class loader before attempting to find the class itself.
>
> Java å¹³å°ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥åŠ è½½ç±»ã€‚ åŸºæœ¬æ€æƒ³æ˜¯æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªâ€œçˆ¶â€ç±»åŠ è½½å™¨ã€‚ åŠ è½½ç±»æ—¶ï¼Œç±»åŠ è½½å™¨é¦–å…ˆå°†å¯¹è¯¥ç±»çš„æœç´¢â€œå§”æ‰˜â€ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œç„¶åå†å°è¯•æŸ¥æ‰¾è¯¥ç±»æœ¬èº«ã€‚

####  åŒäº²å§”æ´¾æ¨¡å‹å®ç°æºç åˆ†æ

åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œé€»è¾‘éå¸¸æ¸…æ™°ï¼Œéƒ½é›†ä¸­åœ¨ `java.lang.ClassLoader` çš„ `loadClass()` ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```Java
private final ClassLoader parent;
protected Class<?> loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
        synchronized (getClassLoadingLock(name)) {
            // é¦–å…ˆï¼Œæ£€æŸ¥è¯·æ±‚çš„ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                long t0 = System.nanoTime();
                try {
                    if (parent != null) {//çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œè°ƒç”¨çˆ¶åŠ è½½å™¨loadClass()æ–¹æ³•å¤„ç†
                        c = parent.loadClass(name, false);
                    } else {//çˆ¶åŠ è½½å™¨ä¸ºç©ºï¼Œä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ BootstrapClassLoader åŠ è½½
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {
                   //æŠ›å‡ºå¼‚å¸¸è¯´æ˜çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®ŒæˆåŠ è½½è¯·æ±‚
                }

                if (c == null) {
                    long t1 = System.nanoTime();
                    //è‡ªå·±å°è¯•åŠ è½½
                    c = findClass(name);

                    // this is the defining class loader; record the stats
                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    sun.misc.PerfCounter.getFindClasses().increment();
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }
```

####  åŒäº²å§”æ´¾æ¨¡å‹çš„å¥½å¤„

åŒäº²å§”æ´¾æ¨¡å‹ä¿è¯äº† Java ç¨‹åºçš„ç¨³å®šè¿è¡Œï¼Œå¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼ˆJVM åŒºåˆ†ä¸åŒç±»çš„æ–¹å¼ä¸ä»…ä»…æ ¹æ®ç±»åï¼Œç›¸åŒçš„ç±»æ–‡ä»¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½äº§ç”Ÿçš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼‰ï¼Œä¹Ÿä¿è¯äº† Java çš„æ ¸å¿ƒ API ä¸è¢«ç¯¡æ”¹ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œè€Œæ˜¯æ¯ä¸ªç±»åŠ è½½å™¨åŠ è½½è‡ªå·±çš„è¯å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç§°ä¸º `java.lang.Object` ç±»çš„è¯ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šå‡ºç°å¤šä¸ªä¸åŒçš„ `Object` ç±»ã€‚

#### å¦‚æœæˆ‘ä»¬ä¸æƒ³ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ€ä¹ˆåŠï¼Ÿ

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue871](https://github.com/Snailclimb/JavaGuide/issues/871) ï¼‰** ï¼šè‡ªå®šä¹‰åŠ è½½å™¨çš„è¯ï¼Œéœ€è¦ç»§æ‰¿ `ClassLoader` ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ `loadClass()` æ–¹æ³•

é™¤äº† `BootstrapClassLoader` å…¶ä»–ç±»åŠ è½½å™¨å‡ç”± Java å®ç°ä¸”å…¨éƒ¨ç»§æ‰¿è‡ª`java.lang.ClassLoader`ã€‚å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå¾ˆæ˜æ˜¾éœ€è¦ç»§æ‰¿ `ClassLoader`ã€‚



### 4.4.5 è¯´ä¸€è¯´jvmå·¥ä½œæµç¨‹



## 4.5 GC

### 4.5.1 GC å¸¸è§é—®é¢˜ï¼š

- å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­»äº¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰ã€‚
- ç®€å•çš„ä»‹ç»ä¸€ä¸‹å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ï¼ˆè™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„åŒºåˆ«ã€ä½¿ç”¨è½¯å¼•ç”¨èƒ½å¸¦æ¥çš„å¥½å¤„ï¼‰ã€‚
- å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡
- å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»
- åƒåœ¾æ”¶é›†æœ‰å“ªäº›ç®—æ³•ï¼Œå„è‡ªçš„ç‰¹ç‚¹ï¼Ÿ
- HotSpot ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Ÿ
- å¸¸è§çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ï¼Ÿ
- ä»‹ç»ä¸€ä¸‹ CMS,G1 æ”¶é›†å™¨ã€‚
- Minor Gc å’Œ Full GC æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

> Qï¼šCMS åƒåœ¾å›æ”¶æœŸä¸ºä»€ä¹ˆä¼šäº§ç”Ÿæµ®åŠ¨çš„åƒåœ¾ï¼Ÿ

![29176325.png](./images/29176325.png)

Java çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ä¸»è¦æ˜¯é’ˆå¯¹å¯¹è±¡å†…å­˜çš„å›æ”¶å’Œå¯¹è±¡å†…å­˜çš„åˆ†é…ã€‚åŒæ—¶ï¼ŒJava è‡ªåŠ¨å†…å­˜ç®¡ç†æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯ **å †** å†…å­˜ä¸­å¯¹è±¡çš„åˆ†é…ä¸å›æ”¶ã€‚

Java å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä½œ**GC å †ï¼ˆGarbage Collected Heapï¼‰**.ä»åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ‰€ä»¥ Java å †è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼šå†ç»†è‡´ä¸€ç‚¹æœ‰ï¼šEden ç©ºé—´ã€From Survivorã€To Survivor ç©ºé—´ç­‰ã€‚**è¿›ä¸€æ­¥åˆ’åˆ†çš„ç›®çš„æ˜¯æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«åœ°åˆ†é…å†…å­˜ã€‚**

**å †ç©ºé—´çš„åŸºæœ¬ç»“æ„ï¼š**

![01d330d8-2710-4fad-a91c-7bbbfaaefc0e.png](./images/01d330d8-2710-4fad-a91c-7bbbfaaefc0e.png)

ä¸Šå›¾æ‰€ç¤ºçš„ Eden åŒºã€From Survivor0("From") åŒºã€To Survivor1("To") åŒºéƒ½å±äºæ–°ç”Ÿä»£ï¼ŒOld Memory åŒºå±äºè€å¹´ä»£ã€‚

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ï¼Œåœ¨ä¸€æ¬¡æ–°ç”Ÿä»£åƒåœ¾å›æ”¶åï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œåˆ™ä¼šè¿›å…¥ s0 æˆ–è€… s1ï¼Œå¹¶ä¸”å¯¹è±¡çš„å¹´é¾„è¿˜ä¼šåŠ  1(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸ºå¤§äº 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®é»˜è®¤å€¼ï¼Œè¿™ä¸ªå€¼ä¼šåœ¨è™šæ‹Ÿæœºè¿è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œè°ƒæ•´ï¼Œå¯ä»¥é€šè¿‡`-XX:+PrintTenuringDistribution`æ¥æ‰“å°å‡ºå½“æ¬¡GCåçš„Thresholdã€‚

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue552](https://github.com/Snailclimb/JavaGuide/issues/552)ï¼‰**ï¼šâ€œHotspot éå†æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¹´é¾„ä»å°åˆ°å¤§å¯¹å…¶æ‰€å ç”¨çš„å¤§å°è¿›è¡Œç´¯ç§¯ï¼Œå½“ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº† survivor åŒºçš„ä¸€åŠæ—¶ï¼Œå–è¿™ä¸ªå¹´é¾„å’Œ MaxTenuringThreshold ä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼â€ã€‚

**åŠ¨æ€å¹´é¾„è®¡ç®—çš„ä»£ç å¦‚ä¸‹**

```java
uint ageTable::compute_tenuring_threshold(size_t survivor_capacity) {
    //survivor_capacityæ˜¯survivorç©ºé—´çš„å¤§å°
    size_t desired_survivor_size = (size_t)((((double)survivor_capacity)*TargetSurvivorRatio)/100);
    size_t total = 0;
    uint age = 1;
    while (age < table_size) {
        //sizesæ•°ç»„æ˜¯æ¯ä¸ªå¹´é¾„æ®µå¯¹è±¡å¤§å°
        total += sizes[age];
        if (total > desired_survivor_size) {
            break;
        }
        age++;
    }
    uint result = age < MaxTenuringThreshold ? age : MaxTenuringThreshold;
    ...
}
```

ç»è¿‡è¿™æ¬¡ GC åï¼ŒEden åŒºå’Œ"From"åŒºå·²ç»è¢«æ¸…ç©ºã€‚è¿™ä¸ªæ—¶å€™ï¼Œ"From"å’Œ"To"ä¼šäº¤æ¢ä»–ä»¬çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯æ–°çš„"To"å°±æ˜¯ä¸Šæ¬¡ GC å‰çš„â€œFromâ€ï¼Œæ–°çš„"From"å°±æ˜¯ä¸Šæ¬¡ GC å‰çš„"To"ã€‚ä¸ç®¡æ€æ ·ï¼Œéƒ½ä¼šä¿è¯åä¸º To çš„ Survivor åŒºåŸŸæ˜¯ç©ºçš„ã€‚Minor GC ä¼šä¸€ç›´é‡å¤è¿™æ ·çš„è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å½“æ¬¡Minor GCåï¼ŒSurvivor çš„"From"åŒºåŸŸç©ºé—´ä¸å¤Ÿç”¨ï¼Œæœ‰ä¸€äº›è¿˜è¾¾ä¸åˆ°è¿›å…¥è€å¹´ä»£æ¡ä»¶çš„å®ä¾‹æ”¾ä¸ä¸‹ï¼Œåˆ™æ”¾ä¸ä¸‹çš„éƒ¨åˆ†ä¼šæå‰è¿›å…¥è€å¹´ä»£ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æä¾›ä¸€ä¸ªè°ƒè¯•è„šæœ¬æ¥æµ‹è¯•è¿™ä¸ªè¿‡ç¨‹ã€‚

```java
-verbose:gc
-Xmx200M
-Xms200M
-Xmn50M
-XX:+PrintGCDetails
-XX:TargetSurvivorRatio=60
-XX:+PrintTenuringDistribution
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-XX:MaxTenuringThreshold=3
-XX:+UseConcMarkSweepGC
-XX:+UseParNewGC
```

**ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š**

```java
/*
* æœ¬å®ä¾‹ç”¨äºjava GCä»¥åï¼Œæ–°ç”Ÿä»£survivoråŒºåŸŸçš„å˜åŒ–ï¼Œä»¥åŠæ™‹å‡åˆ°è€å¹´ä»£çš„æ—¶é—´å’Œæ–¹å¼çš„æµ‹è¯•ä»£ç ã€‚éœ€è¦è‡ªè¡Œåˆ†æ­¥æ³¨é‡Šä¸éœ€è¦çš„ä»£ç è¿›è¡Œåå¤æµ‹è¯•å¯¹æ¯”
*
* ç”±äºjavaçš„mainå‡½æ•°ä»¥åŠå…¶ä»–åŸºç¡€æœåŠ¡ä¹Ÿä¼šå ç”¨ä¸€äº›edenç©ºé—´ï¼Œæ‰€ä»¥è¦æå‰ç©ºè·‘ä¸€æ¬¡mainå‡½æ•°ï¼Œæ¥çœ‹çœ‹è¿™éƒ¨åˆ†å ç”¨ã€‚
*
* è‡ªå®šä¹‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å †å†…åˆ†é…æ•°ç»„å’Œæ ˆå†…åˆ†é…æ•°ç»„çš„æ–¹å¼æ¥åˆ†åˆ«æ¨¡æ‹Ÿä¸å¯è¢«GCçš„å’Œå¯è¢«GCçš„èµ„æºã€‚
*
*
* */

public class JavaGcTest {

    public static void main(String[] args) throws InterruptedException {
        //ç©ºè·‘ä¸€æ¬¡mainå‡½æ•°æ¥æŸ¥çœ‹javaæœåŠ¡æœ¬èº«å ç”¨çš„ç©ºé—´å¤§å°ï¼Œæˆ‘è¿™é‡Œæ˜¯å ç”¨äº†3Mã€‚æ‰€ä»¥40-3=37ï¼Œä¸‹é¢åˆ†é…ä¸‰ä¸ª1Mçš„æ•°ç»„å’Œä¸€ä¸ª34Mçš„åƒåœ¾æ•°ç»„ã€‚


        // ä¸ºäº†è¾¾åˆ°TargetSurvivorRatioï¼ˆæœŸæœ›å ç”¨çš„SurvivoråŒºåŸŸçš„å¤§å°ï¼‰è¿™ä¸ªæ¯”ä¾‹æŒ‡å®šçš„å€¼, å³5M*60%=3M(Desired survivor size)ï¼Œ
        // è¿™é‡Œç”¨1Mçš„æ•°ç»„çš„åˆ†é…æ¥è¾¾åˆ°Desired survivor size
        //è¯´æ˜: 5Mä¸ºSåŒºçš„Fromæˆ–Toçš„å¤§å°ï¼Œ60%ä¸ºTargetSurvivorRatioå‚æ•°æŒ‡å®š,å¯ä»¥æ›´æ”¹å‚æ•°è·å–ä¸åŒçš„æ•ˆæœã€‚
        byte[] byte1m_1 = new byte[1 * 1024 * 1024];
        byte[] byte1m_2 = new byte[1 * 1024 * 1024];
        byte[] byte1m_3 = new byte[1 * 1024 * 1024];

        //ä½¿ç”¨å‡½æ•°æ–¹å¼æ¥ç”³è¯·ç©ºé—´ï¼Œå‡½æ•°è¿è¡Œå®Œæ¯•ä»¥åï¼Œå°±ä¼šå˜æˆåƒåœ¾ç­‰å¾…å›æ”¶ã€‚æ­¤æ—¶åº”ä¿è¯edençš„åŒºåŸŸå ç”¨è¾¾åˆ°100%ã€‚å¯ä»¥é€šè¿‡è°ƒæ•´ä¼ å…¥å€¼æ¥è¾¾åˆ°æ•ˆæœã€‚
        makeGarbage(34);

        //å†æ¬¡ç”³è¯·ä¸€ä¸ªæ•°ç»„ï¼Œå› ä¸ºedenå·²ç»æ»¡äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè§¦å‘Minor GC
        byte[] byteArr = new byte[10*1024*1024];
        // è¿™æ¬¡Minor Gcæ—¶, ä¸‰ä¸ª1Mçš„æ•°ç»„å› ä¸ºå°šæœ‰å¼•ç”¨ï¼Œæ‰€ä»¥è¿›å…¥FromåŒºåŸŸï¼ˆå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡GCï¼‰ageä¸º1
        // ä¸”ç”±äºFromåŒºå·²ç»å ç”¨è¾¾åˆ°äº†60%(-XX:TargetSurvivorRatio=60), æ‰€ä»¥ä¼šé‡æ–°è®¡ç®—å¯¹è±¡æ™‹å‡çš„ageã€‚
        // è®¡ç®—æ–¹æ³•è§ä¸Šæ–‡ï¼Œè®¡ç®—å‡ºageï¼šmin(age, MaxTenuringThreshold) = 1ï¼Œè¾“å‡ºä¸­ä¼šæœ‰Desired survivor size 3145728 bytes, new threshold 1 (max 3)å­—æ ·
        //æ–°çš„æ•°ç»„byteArrè¿›å…¥edenåŒºåŸŸã€‚


        //å†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œè¯æ˜ä¸‰ä¸ª1Mçš„æ•°ç»„ä¼šå› ä¸ºå…¶ç¬¬äºŒæ¬¡å›æ”¶åageä¸º2ï¼Œå¤§äºä¸Šä¸€æ¬¡è®¡ç®—å‡ºçš„new threshold 1ï¼Œæ‰€ä»¥è¿›å…¥è€å¹´ä»£ã€‚
        //è€ŒbyteArrå› ä¸ºè¶…è¿‡survivorçš„å•ä¸ªåŒºåŸŸï¼Œç›´æ¥è¿›å…¥äº†è€å¹´ä»£ã€‚
        makeGarbage(34);
    }
    private static void makeGarbage(int size){
        byte[] byteArrTemp = new byte[size * 1024 * 1024];
    }
}
```

æ³¨æ„:å¦‚ä¸‹è¾“å‡ºç»“æœä¸­è€å¹´ä»£çš„ä¿¡æ¯ä¸º `concurrent mark-sweep generation` å’Œä»¥å‰ç‰ˆæœ¬ç•¥æœ‰ä¸åŒã€‚å¦å¤–ï¼Œè¿˜åˆ—å‡ºäº†æŸæ¬¡GCåæ˜¯å¦é‡æ–°ç”Ÿæˆäº†thresholdï¼Œä»¥åŠå„ä¸ªå¹´é¾„å ç”¨ç©ºé—´çš„å¤§å°ã€‚

```java
2021-07-01T10:41:32.257+0800: [GC (Allocation Failure) 2021-07-01T10:41:32.257+0800: [ParNew
Desired survivor size 3145728 bytes, new threshold 1 (max 3)
- age   1:    3739264 bytes,    3739264 total
: 40345K->3674K(46080K), 0.0014584 secs] 40345K->3674K(199680K), 0.0015063 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2021-07-01T10:41:32.259+0800: [GC (Allocation Failure) 2021-07-01T10:41:32.259+0800: [ParNew
Desired survivor size 3145728 bytes, new threshold 3 (max 3)
: 13914K->0K(46080K), 0.0046596 secs] 13914K->13895K(199680K), 0.0046873 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
Heap
 par new generation   total 46080K, used 35225K [0x05000000, 0x08200000, 0x08200000)
  eden space 40960K,  86% used [0x05000000, 0x072667f0, 0x07800000)
  from space 5120K,   0% used [0x07800000, 0x07800000, 0x07d00000)
  to   space 5120K,   0% used [0x07d00000, 0x07d00000, 0x08200000)
 concurrent mark-sweep generation total 153600K, used 13895K [0x08200000, 0x11800000, 0x11800000)
 Metaspace       used 153K, capacity 2280K, committed 2368K, reserved 4480K
```

![å †å†…å­˜.png](./images/å †å†…å­˜.png)

### 4.5.2 GC åŸºæœ¬è¯´æ˜

####  4.5.3 å¯¹è±¡ä¼˜å…ˆåœ¨ eden åŒºåˆ†é…

ç›®å‰ä¸»æµçš„åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šé‡‡ç”¨åˆ†ä»£å›æ”¶ç®—æ³•ï¼Œå› æ­¤éœ€è¦å°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­ eden åŒºåˆ†é…ã€‚å½“ eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GC.ä¸‹é¢æˆ‘ä»¬æ¥è¿›è¡Œå®é™…æµ‹è¯•ä»¥ä¸‹ã€‚

**æµ‹è¯•ï¼š**

```Java
public class GCTest {

	public static void main(String[] args) {
		byte[] allocation1, allocation2;
		allocation1 = new byte[30900*1024];
		//allocation2 = new byte[900*1024];
	}
}
```

é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿è¡Œï¼š 

![25178350.png](./images/25178350.png)

æ·»åŠ çš„å‚æ•°ï¼š`-XX:+PrintGCDetails`

![25178350.png](./images/10317146.png)

è¿è¡Œç»“æœ (çº¢è‰²å­—ä½“æè¿°æœ‰è¯¯ï¼Œåº”è¯¥æ˜¯å¯¹åº”äº JDK1.7 çš„æ°¸ä¹…ä»£)ï¼š

![25178350.png](./images/28954286.jpg)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡º eden åŒºå†…å­˜å‡ ä¹å·²ç»è¢«åˆ†é…å®Œå…¨ï¼ˆå³ä½¿ç¨‹åºä»€ä¹ˆä¹Ÿä¸åšï¼Œæ–°ç”Ÿä»£ä¹Ÿä¼šä½¿ç”¨ 2000 å¤š k å†…å­˜ï¼‰ã€‚å‡å¦‚æˆ‘ä»¬å†ä¸º allocation2 åˆ†é…å†…å­˜ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

```Java
allocation2 = new byte[900*1024];
```

![28128785.jpg](./images/28128785.jpg)

**ç®€å•è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š** å› ä¸ºç»™ allocation2 åˆ†é…å†…å­˜çš„æ—¶å€™ eden åŒºå†…å­˜å‡ ä¹å·²ç»è¢«åˆ†é…å®Œäº†ï¼Œæˆ‘ä»¬åˆšåˆšè®²äº†å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GC.GC æœŸé—´è™šæ‹Ÿæœºåˆå‘ç° allocation1 æ— æ³•å­˜å…¥ Survivor ç©ºé—´ï¼Œæ‰€ä»¥åªå¥½é€šè¿‡ **åˆ†é…æ‹…ä¿æœºåˆ¶** æŠŠæ–°ç”Ÿä»£çš„å¯¹è±¡æå‰è½¬ç§»åˆ°è€å¹´ä»£ä¸­å»ï¼Œè€å¹´ä»£ä¸Šçš„ç©ºé—´è¶³å¤Ÿå­˜æ”¾ allocation1ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° Full GCã€‚æ‰§è¡Œ Minor GC åï¼Œåé¢åˆ†é…çš„å¯¹è±¡å¦‚æœèƒ½å¤Ÿå­˜åœ¨ eden åŒºçš„è¯ï¼Œè¿˜æ˜¯ä¼šåœ¨ eden åŒºåˆ†é…å†…å­˜ã€‚å¯ä»¥æ‰§è¡Œå¦‚ä¸‹ä»£ç éªŒè¯ï¼š

```Java
public class GCTest {

	public static void main(String[] args) {
		byte[] allocation1, allocation2,allocation3,allocation4,allocation5;
		allocation1 = new byte[32000*1024];
		allocation2 = new byte[1000*1024];
		allocation3 = new byte[1000*1024];
		allocation4 = new byte[1000*1024];
		allocation5 = new byte[1000*1024];
	}
}
```



### 4.5.1  å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿåˆ¤æ–­å¯¹è±¡æ˜¯å¦å›æ”¶ã€‚

å¼•ç”¨è®¡æ•°å™¨

å¯è¾¾æ€§åˆ†æ

### 4.5.2 ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ

### 4.5.3 æ€ä¹ˆå›æ”¶ï¼Ÿå›æ”¶ç®—æ³•ã€‚

### 4.5.4 minor gcï¼Œmajor gcï¼Œfull gc



### 4.5.1 Javaä¸ºä»€ä¹ˆä¸é‡‡ç”¨å¼•ç”¨è®¡æ•°å™¨è¿™ç§GCæ–¹å¼äº†ï¼Ÿ

> å¦‚æœå­˜åœ¨å¯¹è±¡ä¹‹é—´çš„å¾ªç¯å¼•ç”¨ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°å™¨æ— æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¶ã€‚

## 4.6 é”

Synchronizedä¼˜åŒ–

### 4.6.1 synchronizedçš„åŸç†

### 4.6.2 å¦‚ä½•ç»™å˜é‡åŠ é”

## 4.7 è®¾è®¡æ¨¡å¼

### 4.7.1 å•ä¾‹æ¨¡å¼

å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯ Java ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚

è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚

**æ³¨æ„ï¼š**

- 1ã€å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚
- 2ã€å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚
- 3ã€å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚

çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼ï¼ˆåŒé‡é”æ£€æµ‹ï¼‰ï¼Ÿ

ä»‹ç»

**æ„å›¾ï¼š**ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚

**ä¸»è¦è§£å†³ï¼š**ä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯ã€‚

**ä½•æ—¶ä½¿ç”¨ï¼š**å½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™ã€‚

**å¦‚ä½•è§£å†³ï¼š**åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºã€‚

**å…³é”®ä»£ç ï¼š**æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚

**åº”ç”¨å®ä¾‹ï¼š**

- 1ã€ä¸€ä¸ªç­çº§åªæœ‰ä¸€ä¸ªç­ä¸»ä»»ã€‚
- 2ã€Windows æ˜¯å¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„ï¼Œåœ¨æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ä¸å¯é¿å…åœ°å‡ºç°å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„ç°è±¡ï¼Œæ‰€ä»¥æ‰€æœ‰æ–‡ä»¶çš„å¤„ç†å¿…é¡»é€šè¿‡å”¯ä¸€çš„å®ä¾‹æ¥è¿›è¡Œã€‚
- 3ã€ä¸€äº›è®¾å¤‡ç®¡ç†å™¨å¸¸å¸¸è®¾è®¡ä¸ºå•ä¾‹æ¨¡å¼ï¼Œæ¯”å¦‚ä¸€ä¸ªç”µè„‘æœ‰ä¸¤å°æ‰“å°æœºï¼Œåœ¨è¾“å‡ºçš„æ—¶å€™å°±è¦å¤„ç†ä¸èƒ½ä¸¤å°æ‰“å°æœºæ‰“å°åŒä¸€ä¸ªæ–‡ä»¶ã€‚

**ä¼˜ç‚¹ï¼š**

- 1ã€åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å®ä¾‹ï¼ˆæ¯”å¦‚ç®¡ç†å­¦é™¢é¦–é¡µé¡µé¢ç¼“å­˜ï¼‰ã€‚
- 2ã€é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼ˆæ¯”å¦‚å†™æ–‡ä»¶æ“ä½œï¼‰ã€‚

**ç¼ºç‚¹ï¼š**æ²¡æœ‰æ¥å£ï¼Œä¸èƒ½ç»§æ‰¿ï¼Œä¸å•ä¸€èŒè´£åŸåˆ™å†²çªï¼Œä¸€ä¸ªç±»åº”è¯¥åªå…³å¿ƒå†…éƒ¨é€»è¾‘ï¼Œè€Œä¸å…³å¿ƒå¤–é¢æ€ä¹ˆæ ·æ¥å®ä¾‹åŒ–ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**

- 1ã€è¦æ±‚ç”Ÿäº§å”¯ä¸€åºåˆ—å·ã€‚
- 2ã€WEB ä¸­çš„è®¡æ•°å™¨ï¼Œä¸ç”¨æ¯æ¬¡åˆ·æ–°éƒ½åœ¨æ•°æ®åº“é‡ŒåŠ ä¸€æ¬¡ï¼Œç”¨å•ä¾‹å…ˆç¼“å­˜èµ·æ¥ã€‚
- 3ã€åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡éœ€è¦æ¶ˆè€—çš„èµ„æºè¿‡å¤šï¼Œæ¯”å¦‚ I/O ä¸æ•°æ®åº“çš„è¿æ¥ç­‰ã€‚

**æ³¨æ„äº‹é¡¹ï¼š**getInstance() æ–¹æ³•ä¸­éœ€è¦ä½¿ç”¨åŒæ­¥é” synchronized (Singleton.class) é˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶è¿›å…¥é€ æˆ instance è¢«å¤šæ¬¡å®ä¾‹åŒ–ã€‚



#### å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼

å•ä¾‹æ¨¡å¼çš„å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

#### 1ã€æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨

**æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š**æ˜¯

**æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š**å¦

**å®ç°éš¾åº¦ï¼š**æ˜“

**æè¿°ï¼š**è¿™ç§æ–¹å¼æ˜¯æœ€åŸºæœ¬çš„å®ç°æ–¹å¼ï¼Œè¿™ç§å®ç°æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹ã€‚å› ä¸ºæ²¡æœ‰åŠ é” synchronizedï¼Œæ‰€ä»¥ä¸¥æ ¼æ„ä¹‰ä¸Šå®ƒå¹¶ä¸ç®—å•ä¾‹æ¨¡å¼ã€‚
è¿™ç§æ–¹å¼ lazy loading å¾ˆæ˜æ˜¾ï¼Œä¸è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¤šçº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚

å®ä¾‹

```java
public class Singleton {  
    private static Singleton instance;  
    private Singleton (){}  
  
    public static Singleton getInstance() {  
    if (instance == null) {  
        instance = new Singleton();  
    }  
    return instance;  
    }  
```

**æ¥ä¸‹æ¥ä»‹ç»çš„å‡ ç§å®ç°æ–¹å¼éƒ½æ”¯æŒå¤šçº¿ç¨‹ï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šæœ‰æ‰€å·®å¼‚ã€‚**

#### 2ã€æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨

**æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š**æ˜¯

**æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š**æ˜¯

**å®ç°éš¾åº¦ï¼š**æ˜“

**æè¿°ï¼š**è¿™ç§æ–¹å¼å…·å¤‡å¾ˆå¥½çš„ lazy loadingï¼Œèƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ä¸­å¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯ï¼Œæ•ˆç‡å¾ˆä½ï¼Œ99% æƒ…å†µä¸‹ä¸éœ€è¦åŒæ­¥ã€‚
ä¼˜ç‚¹ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ‰åˆå§‹åŒ–ï¼Œé¿å…å†…å­˜æµªè´¹ã€‚
ç¼ºç‚¹ï¼šå¿…é¡»åŠ é” synchronized æ‰èƒ½ä¿è¯å•ä¾‹ï¼Œä½†åŠ é”ä¼šå½±å“æ•ˆç‡ã€‚
getInstance() çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºä¸æ˜¯å¾ˆå…³é”®ï¼ˆè¯¥æ–¹æ³•ä½¿ç”¨ä¸å¤ªé¢‘ç¹ï¼‰ã€‚

å®ä¾‹

```java
public class Singleton {  
    private static Singleton instance;  
    private Singleton (){}  
    public static synchronized Singleton getInstance() {  
    if (instance == null) {  
        instance = new Singleton();  
    }  
    return instance;  
    }  
}
```



#### 3ã€é¥¿æ±‰å¼

**æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š**å¦

**æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š**æ˜¯

**å®ç°éš¾åº¦ï¼š**æ˜“

**æè¿°ï¼š**è¿™ç§æ–¹å¼æ¯”è¾ƒå¸¸ç”¨ï¼Œä½†å®¹æ˜“äº§ç”Ÿåƒåœ¾å¯¹è±¡ã€‚
ä¼˜ç‚¹ï¼šæ²¡æœ‰åŠ é”ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šæé«˜ã€‚
ç¼ºç‚¹ï¼šç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œæµªè´¹å†…å­˜ã€‚
å®ƒåŸºäº classloader æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ï¼Œä¸è¿‡ï¼Œinstance åœ¨ç±»è£…è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œè™½ç„¶å¯¼è‡´ç±»è£…è½½çš„åŸå› æœ‰å¾ˆå¤šç§ï¼Œåœ¨å•ä¾‹æ¨¡å¼ä¸­å¤§å¤šæ•°éƒ½æ˜¯è°ƒç”¨ getInstance æ–¹æ³•ï¼Œ ä½†æ˜¯ä¹Ÿä¸èƒ½ç¡®å®šæœ‰å…¶ä»–çš„æ–¹å¼ï¼ˆæˆ–è€…å…¶ä»–çš„é™æ€æ–¹æ³•ï¼‰å¯¼è‡´ç±»è£…è½½ï¼Œè¿™æ—¶å€™åˆå§‹åŒ– instance æ˜¾ç„¶æ²¡æœ‰è¾¾åˆ° lazy loading çš„æ•ˆæœã€‚

å®ä¾‹

```java
public class Singleton {  
    private static Singleton instance = new Singleton();  
    private Singleton (){}  
    public static Singleton getInstance() {  
    return instance;  
    }  
}
```



#### 4ã€åŒæ£€é”/åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³ double-checked lockingï¼‰

**JDK ç‰ˆæœ¬ï¼š**JDK1.5 èµ·

**æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š**æ˜¯

**æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š**æ˜¯

**å®ç°éš¾åº¦ï¼š**è¾ƒå¤æ‚

**æè¿°ï¼š**è¿™ç§æ–¹å¼é‡‡ç”¨åŒé”æœºåˆ¶ï¼Œå®‰å…¨ä¸”åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹èƒ½ä¿æŒé«˜æ€§èƒ½ã€‚
getInstance() çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºå¾ˆå…³é”®ã€‚

å®ä¾‹

```java
public class Singleton {  
    private volatile static Singleton singleton;  
    private Singleton (){}  
    public static Singleton getSingleton() {  
    if (singleton == null) {  
        synchronized (Singleton.class) {  
        if (singleton == null) {  
            singleton = new Singleton();  
        }  
        }  
    }  
    return singleton;  
    }  
}
```



#### 5ã€ç™»è®°å¼/é™æ€å†…éƒ¨ç±»

**æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š**æ˜¯

**æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š**æ˜¯

**å®ç°éš¾åº¦ï¼š**ä¸€èˆ¬

**æè¿°ï¼š**è¿™ç§æ–¹å¼èƒ½è¾¾åˆ°åŒæ£€é”æ–¹å¼ä¸€æ ·çš„åŠŸæ•ˆï¼Œä½†å®ç°æ›´ç®€å•ã€‚å¯¹é™æ€åŸŸä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåº”ä½¿ç”¨è¿™ç§æ–¹å¼è€Œä¸æ˜¯åŒæ£€é”æ–¹å¼ã€‚è¿™ç§æ–¹å¼åªé€‚ç”¨äºé™æ€åŸŸçš„æƒ…å†µï¼ŒåŒæ£€é”æ–¹å¼å¯åœ¨å®ä¾‹åŸŸéœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æ—¶ä½¿ç”¨ã€‚
è¿™ç§æ–¹å¼åŒæ ·åˆ©ç”¨äº† classloader æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ– instance æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒè·Ÿç¬¬ 3 ç§æ–¹å¼ä¸åŒçš„æ˜¯ï¼šç¬¬ 3 ç§æ–¹å¼åªè¦ Singleton ç±»è¢«è£…è½½äº†ï¼Œé‚£ä¹ˆ instance å°±ä¼šè¢«å®ä¾‹åŒ–ï¼ˆæ²¡æœ‰è¾¾åˆ° lazy loading æ•ˆæœï¼‰ï¼Œè€Œè¿™ç§æ–¹å¼æ˜¯ Singleton ç±»è¢«è£…è½½äº†ï¼Œinstance ä¸ä¸€å®šè¢«åˆå§‹åŒ–ã€‚å› ä¸º SingletonHolder ç±»æ²¡æœ‰è¢«ä¸»åŠ¨ä½¿ç”¨ï¼Œåªæœ‰é€šè¿‡æ˜¾å¼è°ƒç”¨ getInstance æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ˜¾å¼è£…è½½ SingletonHolder ç±»ï¼Œä»è€Œå®ä¾‹åŒ– instanceã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœå®ä¾‹åŒ– instance å¾ˆæ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥æƒ³è®©å®ƒå»¶è¿ŸåŠ è½½ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œåˆä¸å¸Œæœ›åœ¨ Singleton ç±»åŠ è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œå› ä¸ºä¸èƒ½ç¡®ä¿ Singleton ç±»è¿˜å¯èƒ½åœ¨å…¶ä»–çš„åœ°æ–¹è¢«ä¸»åŠ¨ä½¿ç”¨ä»è€Œè¢«åŠ è½½ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®ä¾‹åŒ– instance æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿™ç§æ–¹å¼ç›¸æ¯”ç¬¬ 3 ç§æ–¹å¼å°±æ˜¾å¾—å¾ˆåˆç†ã€‚

å®ä¾‹

```java
public class Singleton {  
    private static class SingletonHolder {  
    private static final Singleton INSTANCE = new Singleton();  
    }  
    private Singleton (){}  
    public static final Singleton getInstance() {  
    return SingletonHolder.INSTANCE;  
    }  
}
```



### 4.7.2 å·¥å‚æ¨¡å¼

#### è¯´ä¸€ä¸‹æŠ½è±¡å·¥å‚å’Œç®€å•å·¥å‚çš„åŒºåˆ«ï¼Ÿ

### 4.7.3 å»ºé€ è€…æ¨¡å¼

### 4.7.4 é€‚é…å™¨æ¨¡å¼

### 4.7.5 è£…é¥°å™¨æ¨¡å¼

### 4.7.6 ä»£ç†æ¨¡å¼

ä»€ä¹ˆæ˜¯é™æ€ä»£ç†æ¨¡å¼ï¼Ÿï¼ˆç‹‚ç¥çš„è§†é¢‘ï¼‰

- çœŸå®å¯¹è±¡é¢å‡½ä»£ç†å¯¹è±¡éƒ½è¦å®ç°åŒä¸€ä¸ªæ¥å£
- ä»£ç†å¯¹è±¡å¿…é¡»è¦ä»£ç†çœŸå®çš„è§’è‰²



## 4.8 æ¶ˆæ¯é˜Ÿåˆ—

æ¶ˆæ¯é˜Ÿåˆ—æ€ä¹ˆè§£å†³é‡å¤æ¶ˆè´¹é—®é¢˜æˆ–è€…å°‘æ¶ˆè´¹é—®é¢˜?

æ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–?

ä¸ºä»€ä¹ˆæ˜¯ä¸‰çº§ç¼“å­˜è€Œä¸æ˜¯äºŒçº§ç¼“å­˜?æ‰€æœ‰çš„éƒ½æ˜¯ä¸‰çº§ç¼“å­˜å—?

å¦‚æœæœ‰A,B,Cä¸‰ä¸ªconsumer,æœ‰ä¸€ä¸ªmessageé˜Ÿåˆ—,Cæ²¡æ¶ˆè´¹åˆ°,æ¶ˆæ¯ä¸¢å¤±äº†æ€ä¹ˆå¤„ç†?

## 4.9 å…¶ä»–

### 4.9.1 Integer å†…éƒ¨æ± åŒ–åŸç†

### 4.9.2 epollå’Œselect çš„åŒºåˆ«

### 4.9.3 NULLå’Œç©ºå€¼çš„åŒºåˆ«

### 4.9.4 javaéƒ½æœ‰å“ªäº›æ–¹å¼åˆ›å»ºç±»çš„å¯¹è±¡

### 4.9.5 è¯´ä¸€ä¸‹javaä¸­çš„å¸¸è§å¼‚å¸¸

### 4.9.6 å†…å­˜æº¢å‡ºæ˜¯ä»€ä¹ˆæƒ…å†µ

### 4.9.7 ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•ï¼Ÿ

### **4.9.8 åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†**

### 4.9.9 mvccå¹¶å‘æ§åˆ¶



## 4.10 çº¿ç¨‹æ± 

### 4.10.1 ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ

> **æ± åŒ–æŠ€æœ¯ç›¸æ¯”å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚**

**çº¿ç¨‹æ± **æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚ æ¯ä¸ª**çº¿ç¨‹æ± **è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹**ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„**ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

### 4.10.2 å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«

`Runnable`è‡ª Java 1.0 ä»¥æ¥ä¸€ç›´å­˜åœ¨ï¼Œä½†`Callable`ä»…åœ¨ Java 1.5 ä¸­å¼•å…¥,ç›®çš„å°±æ˜¯ä¸ºäº†æ¥å¤„ç†`Runnable`ä¸æ”¯æŒçš„ç”¨ä¾‹ã€‚**`Runnable` æ¥å£** ä¸ä¼šè¿”å›ç»“æœæˆ–æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ **`Callable` æ¥å£** å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»»åŠ¡ä¸éœ€è¦è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸æ¨èä½¿ç”¨ **`Runnable` æ¥å£** ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¼šæ›´åŠ ç®€æ´ã€‚

å·¥å…·ç±» `Executors` å¯ä»¥å®ç°å°† `Runnable` å¯¹è±¡è½¬æ¢æˆ `Callable` å¯¹è±¡ã€‚ï¼ˆ`Executors.callable(Runnable task)` æˆ– `Executors.callable(Runnable task, Object result)`ï¼‰ã€‚

```java
// Runnable.java
@FunctionalInterface
public interface Runnable {
   /**
    * è¢«çº¿ç¨‹æ‰§è¡Œï¼Œæ²¡æœ‰è¿”å›å€¼ä¹Ÿæ— æ³•æŠ›å‡ºå¼‚å¸¸
    */
    public abstract void run();
}
```

```java
// Callable.java
@FunctionalInterface
public interface Callable<V> {
    /**
     * è®¡ç®—ç»“æœï¼Œæˆ–åœ¨æ— æ³•è¿™æ ·åšæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚
     * @return è®¡ç®—å¾—å‡ºçš„ç»“æœ
     * @throws å¦‚æœæ— æ³•è®¡ç®—ç»“æœï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    V call() throws Exception;
}
```

### 4.10.3 æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

1. **`execute()`æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›**
2. **`submit()`æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª `Future` å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸ**ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `Future` çš„ `get()`æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ`get()`æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ `get(long timeoutï¼ŒTimeUnit unit)`æ–¹æ³•åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œã€‚

æˆ‘ä»¬ä»¥ **`AbstractExecutorService` æ¥å£** ä¸­çš„ä¸€ä¸ª `submit` æ–¹æ³•ä¸ºä¾‹å­æ¥çœ‹çœ‹æºä»£ç ï¼š

```java
public Future<?> submit(Runnable task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<Void> ftask = newTaskFor(task, null);
    execute(ftask);
    return ftask;
}
```

ä¸Šé¢æ–¹æ³•è°ƒç”¨çš„ `newTaskFor` æ–¹æ³•è¿”å›äº†ä¸€ä¸ª `FutureTask` å¯¹è±¡ã€‚

```java
protected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {
    return new FutureTask<T>(runnable, value);
}
```

æˆ‘ä»¬å†æ¥çœ‹çœ‹`execute()`æ–¹æ³•ï¼š

```java
public void execute(Runnable command) {
  ...
}
```

### 4.10.4  å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± 

ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

> Executors è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š
>
> - **FixedThreadPool å’Œ SingleThreadExecutor** ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
> - **CachedThreadPool å’Œ ScheduledThreadPool** ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

**æ–¹å¼ä¸€ï¼šé€šè¿‡æ„é€ æ–¹æ³•å®ç°**

![ThreadPoolExecutoræ„é€ æ–¹æ³•.png](./images/ThreadPoolExecutoræ„é€ æ–¹æ³•.png)



**æ–¹å¼äºŒï¼šé€šè¿‡ Executor æ¡†æ¶çš„å·¥å…·ç±» Executors æ¥å®ç°**

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ ThreadPoolExecutorï¼š

- **FixedThreadPool** ï¼š è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **SingleThreadExecutorï¼š** æ–¹æ³•è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **CachedThreadPoolï¼š** è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚

å¯¹åº” Executors å·¥å…·ç±»ä¸­çš„æ–¹æ³•å¦‚å›¾æ‰€ç¤ºï¼š

![Executoræ¡†æ¶çš„å·¥å…·ç±».png](./images/Executoræ¡†æ¶çš„å·¥å…·ç±».png)

### 4.10.5 ThreadPoolExecutor ç±»åˆ†æ

`ThreadPoolExecutor` ç±»ä¸­æä¾›çš„å››ä¸ªæ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹æœ€é•¿çš„é‚£ä¸ªï¼Œå…¶ä½™ä¸‰ä¸ªéƒ½æ˜¯åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„åŸºç¡€ä¸Šäº§ç”Ÿï¼ˆå…¶ä»–å‡ ä¸ªæ„é€ æ–¹æ³•è¯´ç™½ç‚¹éƒ½æ˜¯ç»™å®šæŸäº›é»˜è®¤å‚æ•°çš„æ„é€ æ–¹æ³•æ¯”å¦‚é»˜è®¤åˆ¶å®šæ‹’ç»ç­–ç•¥æ˜¯ä»€ä¹ˆï¼‰ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç è®²äº†ï¼Œæ¯”è¾ƒç®€å•ã€‚

```java
/**
 * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
 */
public ThreadPoolExecutor(int corePoolSize,
                      int maximumPoolSize,
                      long keepAliveTime,
                      TimeUnit unit,
                      BlockingQueue<Runnable> workQueue,
                      ThreadFactory threadFactory,
                      RejectedExecutionHandler handler) {
    if (corePoolSize < 0 ||
        maximumPoolSize <= 0 ||
        maximumPoolSize < corePoolSize ||
        keepAliveTime < 0)
            throw new IllegalArgumentException();
    if (workQueue == null || threadFactory == null || handler == null)
        throw new NullPointerException();
    this.corePoolSize = corePoolSize;
    this.maximumPoolSize = maximumPoolSize;
    this.workQueue = workQueue;
    this.keepAliveTime = unit.toNanos(keepAliveTime);
    this.threadFactory = threadFactory;
    this.handler = handler;
}
```

### 4.10.6 `ThreadPoolExecutor`æ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ

**`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•°:

1. **`keepAliveTime`**:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›
2. **`unit`** : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
3. **`threadFactory`** :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
4. **`handler`** :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚

### 4.10.7 `ThreadPoolExecutor` é¥±å’Œç­–ç•¥

**`ThreadPoolExecutor` é¥±å’Œç­–ç•¥å®šä¹‰:**

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- **`ThreadPoolExecutor.AbortPolicy`ï¼š** æŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- **`ThreadPoolExecutor.CallerRunsPolicy`ï¼š** è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- **`ThreadPoolExecutor.DiscardPolicy`ï¼š** ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- **`ThreadPoolExecutor.DiscardOldestPolicy`ï¼š** æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š Spring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥çš„è¯æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™é»˜è®¤ä½¿ç”¨çš„æ˜¯ `ThreadPoolExecutor.AbortPolicy`ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚ å¯¹äºå¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œå»ºè®®ä½¿ç”¨ `ThreadPoolExecutor.CallerRunsPolicy`ã€‚å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ã€‚ï¼ˆè¿™ä¸ªç›´æ¥æŸ¥çœ‹ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æºç å°±å¯ä»¥çœ‹å‡ºï¼Œæ¯”è¾ƒç®€å•çš„åŸå› ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼‰

### 4.10.8 ç®€å•çš„çº¿ç¨‹æ± Demo

```java
// MyRunnable.java
import java.util.Date;

/**
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Runnableç±»ï¼Œéœ€è¦å¤§çº¦5ç§’é’Ÿæ¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
 * @author shuang.kou
 */
public class MyRunnable implements Runnable {

    private String command;

    public MyRunnable(String s) {
        this.command = s;
    }

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " Start. Time = " + new Date());
        processCommand();
        System.out.println(Thread.currentThread().getName() + " End. Time = " + new Date());
    }

    private void processCommand() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String toString() {
        return this.command;
    }
}
```

ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é˜¿é‡Œå·´å·´æ¨èçš„ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

```java
// ThreadPoolExecutorDemo.java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class ThreadPoolExecutorDemo {

    private static final int CORE_POOL_SIZE = 5;
    private static final int MAX_POOL_SIZE = 10;
    private static final int QUEUE_CAPACITY = 100;
    private static final Long KEEP_ALIVE_TIME = 1L;
    public static void main(String[] args) {

        //ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼
        //é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(QUEUE_CAPACITY),
                new ThreadPoolExecutor.CallerRunsPolicy());

        for (int i = 0; i < 10; i++) {
            //åˆ›å»ºWorkerThreadå¯¹è±¡ï¼ˆWorkerThreadç±»å®ç°äº†Runnable æ¥å£ï¼‰
            Runnable worker = new MyRunnable("" + i);
            //æ‰§è¡ŒRunnable
            executor.execute(worker);
        }
        //ç»ˆæ­¢çº¿ç¨‹æ± 
        executor.shutdown();
        while (!executor.isTerminated()) {
        }
        System.out.println("Finished all threads");
    }
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æŒ‡å®šäº†ï¼š

1. `corePoolSize`: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5ã€‚
2. `maximumPoolSize` ï¼šæœ€å¤§çº¿ç¨‹æ•° 10
3. `keepAliveTime` : ç­‰å¾…æ—¶é—´ä¸º 1Lã€‚
4. `unit`: ç­‰å¾…æ—¶é—´çš„å•ä½ä¸º TimeUnit.SECONDSã€‚
5. `workQueue`ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸º `ArrayBlockingQueue`ï¼Œå¹¶ä¸”å®¹é‡ä¸º 100;
6. `handler`:é¥±å’Œç­–ç•¥ä¸º `CallerRunsPolicy`ã€‚

**Outputï¼š**

```java
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:47 CST 2020
```

### 4.10.9 çº¿ç¨‹æ± åŸç†åˆ†æ

æˆ‘ä»¬é€šè¿‡ä»£ç è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š**çº¿ç¨‹æ± é¦–å…ˆä¼šå…ˆæ‰§è¡Œ 5 ä¸ªä»»åŠ¡ï¼Œç„¶åè¿™äº›ä»»åŠ¡æœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œçš„è¯ï¼Œå°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚** å¤§å®¶å¯ä»¥å…ˆé€šè¿‡ä¸Šé¢è®²è§£çš„å†…å®¹ï¼Œåˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å’‹å›äº‹ï¼Ÿï¼ˆè‡ªå·±ç‹¬ç«‹æ€è€ƒä¸€ä¼šï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬å°±åˆ†æä¸Šé¢çš„è¾“å‡ºå†…å®¹æ¥ç®€å•åˆ†æä¸€ä¸‹çº¿ç¨‹æ± åŸç†ã€‚

**ä¸ºäº†ææ‡‚çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ†æä¸€ä¸‹ `execute`æ–¹æ³•ã€‚** åœ¨ 4.6 èŠ‚ä¸­çš„ Demo ä¸­æˆ‘ä»¬ä½¿ç”¨ `executor.execute(worker)`æ¥æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­å»ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç 

```java
// å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));

private static int workerCountOf(int c) {
    return c & CAPACITY;
}

private final BlockingQueue<Runnable> workQueue;

public void execute(Runnable command) {
    // å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
    if (command == null)
        throw new NullPointerException();
    // ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯
    int c = ctl.get();

    //  ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ
    // 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize
    // å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    // 2.å¦‚æœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œ
    // é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€æ‰ä¼šè¢«å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        // å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚
        if (!isRunning(recheck) && remove(command))
            reject(command);
            // å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸ºç©ºå°±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    //3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
    //å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚
    else if (!addWorker(command, false))
        reject(command);
}
```

é€šè¿‡ä¸‹å›¾å¯ä»¥æ›´å¥½çš„å¯¹ä¸Šé¢è¿™ 3 æ­¥åšä¸€ä¸ªå±•ç¤ºï¼Œä¸‹å›¾æ˜¯æˆ‘ä¸ºäº†çœäº‹ç›´æ¥ä»ç½‘ä¸Šæ‰¾åˆ°ï¼ŒåŸåœ°å€ä¸æ˜ã€‚

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†.png](./images/å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†.png)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨å›åˆ° 4.6 èŠ‚æˆ‘ä»¬å†™çš„ Demoï¼Œ ç°åœ¨åº”è¯¥æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±å¯ä»¥ææ‡‚å®ƒçš„åŸç†äº†å‘¢ï¼Ÿ

æ²¡ææ‡‚çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„åˆ†æï¼š

> æˆ‘ä»¬åœ¨ä»£ç ä¸­æ¨¡æ‹Ÿäº† 10 ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬é…ç½®çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5 ã€ç­‰å¾…é˜Ÿåˆ—å®¹é‡ä¸º 100 ï¼Œæ‰€ä»¥æ¯æ¬¡åªå¯èƒ½å­˜åœ¨ 5 ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ 5 ä¸ªä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ã€‚å½“å‰çš„5ä¸ªä»»åŠ¡ä¸­å¦‚æœæœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹æ± å°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚

### 4.10.10 çŸ¥é“å“ªäº›çº¿ç¨‹æ± æœ‰å“ªäº›ï¼Ÿ

### 4.10.11 çº¿ç¨‹æ± çš„ä¸ƒå¤§å‚æ•°

### 4.10.12 çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å·¥å‚æ˜¯å¹²ä»€ä¹ˆç”¨çš„

## 4.11 Java åŸå­ç±»

### 4.11.1 åŸå­ç±»æ˜¯ä»€ä¹ˆï¼Ÿ

`Atomic` ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŸå­çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åŸå­æ˜¯æ„æˆä¸€èˆ¬ç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚åœ¨æˆ‘ä»¬è¿™é‡Œ Atomic æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚

### 4.11.2åŸå­ç±»åŒ…å«å››ç§åŸºæœ¬çš„ç±»å‹ï¼š

**åŸºæœ¬ç±»å‹**ï¼šä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹  

- `AtomicInteger`ï¼šæ•´å½¢åŸå­ç±» 
- `AtomicLong`ï¼šé•¿æ•´å‹åŸå­ç±» 
- `AtomicBoolean`ï¼šå¸ƒå°”å‹åŸå­ç±» 

**æ•°ç»„ç±»å‹**ï¼šä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´   

- `AtomicIntegerArray`ï¼šæ•´å½¢æ•°ç»„åŸå­ç±» 
- `AtomicLongArray`ï¼šé•¿æ•´å½¢æ•°ç»„åŸå­ç±» 
- `AtomicReferenceArray`ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±» 

**å¼•ç”¨ç±»å‹**ï¼š  

- `AtomicReference`ï¼šå¼•ç”¨ç±»å‹åŸå­ç±»ï¼Œå­˜åœ¨ABAé—®é¢˜ 
- `AtomicStampedReference`ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºåŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨CASè¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ABAé—®é¢˜ã€‚ 
- `AtomicMarkableReference`ï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹ 

**åŸå­æ›´æ–°å­—æ®µç±»**

- `AtomicIntegerFieldUpdate`rï¼šåŸå­æ›´æ–°æ•´å‹çš„å­—æ®µçš„æ›´æ–°å™¨ã€‚ 
- `AtomicLongFieldUpdater`ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨ã€‚ 
- `AtomicReferenceFieldUpdater`ï¼šå¼•ç”¨ç±»å‹æ›´æ–°å™¨åŸå­ç±»

### 4.11.3 AtomicInteger ç±»çš„åŸç†

AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚

CAS çš„åŸç†æ˜¯æ‹¿æœŸæœ›çš„å€¼å’ŒåŸæœ¬çš„ä¸€ä¸ªå€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°æˆæ–°çš„å€¼ã€‚UnSafe ç±»çš„ objectFieldOffset() æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ‹¿åˆ°â€œåŸæ¥çš„å€¼â€çš„å†…å­˜åœ°å€ï¼Œè¿”å›å€¼æ˜¯ valueOffsetã€‚å¦å¤– value æ˜¯ä¸€ä¸ª volatile å˜é‡ï¼Œåœ¨å†…å­˜ä¸­å¯è§ï¼Œå› æ­¤ JVM å¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»ä»»ä½•çº¿ç¨‹æ€»èƒ½æ‹¿åˆ°è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚

## 4.12 AQS

### 4.12.1 ä»€ä¹ˆæ˜¯AQS?

AQS çš„å…¨ç§°ä¸ºï¼ˆ`AbstractQueuedSynchronizer`ï¼‰æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œè¿™ä¸ªç±»åœ¨`java.util.concurrent.locks`åŒ…ä¸‹é¢ã€‚

AQS æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ `ReentrantLock`ï¼Œ`Semaphore`ï¼Œå…¶ä»–çš„è¯¸å¦‚ `ReentrantReadWriteLock`ï¼Œ`SynchronousQueue`ï¼Œ`FutureTask` ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿèƒ½åˆ©ç”¨ AQS éå¸¸è½»æ¾å®¹æ˜“åœ°æ„é€ å‡ºç¬¦åˆæˆ‘ä»¬è‡ªå·±éœ€æ±‚çš„åŒæ­¥å™¨ã€‚

### 4.12.2 AQS åŸç†åˆ†æ

**AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ CLH é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚**

> CLH(Craig,Landin,and Hagersten)é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ã€‚AQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚

![AQSåŸç†å›¾.png](./images/AQSåŸç†å›¾.png)

AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚

> AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚

çŠ¶æ€ä¿¡æ¯é€šè¿‡ protected ç±»å‹çš„ getStateï¼ŒsetStateï¼ŒcompareAndSetState è¿›è¡Œæ“ä½œ

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {
    return state;
}
//è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) {
    state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

### 4.12.3 AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼

**AQS å®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼**

- Exclusive

  ï¼ˆç‹¬å ï¼‰ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ `ReentrantLock`ï¼ˆé‡å…¥é”ï¼‰ã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼š

  - å…¬å¹³é”ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é”
  - éå…¬å¹³é”ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œæ— è§†é˜Ÿåˆ—é¡ºåºç›´æ¥å»æŠ¢é”ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„

- **Share**ï¼ˆå…±äº«ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚` CountDownLatch`ã€`Semaphore`ã€ `CyclicBarrier`ã€`ReadWriteLock` æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚

`ReentrantReadWriteLock` (å¯é‡å…¥è¯»å†™é”ï¼‰å¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå› ä¸º `ReentrantReadWriteLock` ä¹Ÿå°±æ˜¯è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚

ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æº state çš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQS å·²ç»åœ¨é¡¶å±‚å®ç°å¥½äº†ã€‚

###  4.12.4. AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼

åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ï¼‰ï¼š

1. ä½¿ç”¨è€…ç»§æ‰¿ `AbstractQueuedSynchronizer` å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚ï¼ˆè¿™äº›é‡å†™æ–¹æ³•å¾ˆç®€å•ï¼Œæ— éæ˜¯å¯¹äºå…±äº«èµ„æº state çš„è·å–å’Œé‡Šæ”¾ï¼‰
2. å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚

è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªè¿ç”¨ã€‚

**AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š**

```java
isHeldExclusively()//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚
tryAcquire(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
tryRelease(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
tryAcquireShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚
tryReleaseShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º `UnsupportedOperationException`ã€‚ è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”é€šå¸¸åº”è¯¥ç®€çŸ­è€Œä¸æ˜¯é˜»å¡ã€‚AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨ã€‚

ä»¥ ReentrantLock ä¸ºä¾‹ï¼Œstate åˆå§‹åŒ–ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ lock()æ—¶ï¼Œä¼šè°ƒç”¨ tryAcquire()ç‹¬å è¯¥é”å¹¶å°† state+1ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† tryAcquire()æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ unlock()åˆ° state=0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstate ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚

å†ä»¥ `CountDownLatch` ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œstate ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå` countDown()` ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap)å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ state=0)ï¼Œä¼š unpark()ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» `await()` å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°`tryAcquire-tryRelease`ã€`tryAcquireShared-tryReleaseShared`ä¸­çš„ä¸€ç§å³å¯ã€‚ä½† AQS ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚`ReentrantReadWriteLock`ã€‚

### 4.12.5 AQS ç»„ä»¶æ€»ç»“

- **`Semaphore`(ä¿¡å·é‡)-å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼š** `synchronized` å’Œ `ReentrantLock` éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œ`Semaphore`(ä¿¡å·é‡)å¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚
- **`CountDownLatch `ï¼ˆå€’è®¡æ—¶å™¨ï¼‰ï¼š** `CountDownLatch` æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œç”¨æ¥åè°ƒå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚è¿™ä¸ªå·¥å…·é€šå¸¸ç”¨æ¥æ§åˆ¶çº¿ç¨‹ç­‰å¾…ï¼Œå®ƒå¯ä»¥è®©æŸä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§è¡Œã€‚
- **`CyclicBarrier`(å¾ªç¯æ …æ )ï¼š** `CyclicBarrier` å’Œ `CountDownLatch` éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” `CountDownLatch` æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ `CountDownLatch` ç±»ä¼¼ã€‚`CyclicBarrier` çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆ`Cyclic`ï¼‰çš„å±éšœï¼ˆ`Barrier`ï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚`CyclicBarrier` é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ `CyclicBarrier(int parties)`ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•å‘Šè¯‰ `CyclicBarrier` æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚

### 4.12.6 ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ

`CountDownLatch` çš„ä½œç”¨å°±æ˜¯ å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚ä¹‹å‰åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨å¤šçº¿ç¨‹è¯»å–å¤šä¸ªæ–‡ä»¶å¤„ç†çš„åœºæ™¯ï¼Œæˆ‘ç”¨åˆ°äº† `CountDownLatch` ã€‚å…·ä½“åœºæ™¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚

ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± å’Œ count ä¸º 6 çš„`CountDownLatch`å¯¹è±¡ ã€‚ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† count-1ï¼Œè°ƒç”¨`CountDownLatch`å¯¹è±¡çš„ `await()`æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚

```java
public class CountDownLatchExample1 {
    // å¤„ç†æ–‡ä»¶çš„æ•°é‡
    private static final int threadCount = 6;

    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(10);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);
        for (int i = 0; i < threadCount; i++) {
            final int threadnum = i;
            threadPool.execute(() -> {
                try {
                    //å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ
                    //......
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    //è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ
                    countDownLatch.countDown();
                }

            });
        }
        countDownLatch.await();
        threadPool.shutdown();
        System.out.println("finish");
    }
}
```

**æœ‰æ²¡æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å‘¢ï¼Ÿ**

å¯ä»¥ä½¿ç”¨ `CompletableFuture` ç±»æ¥æ”¹è¿›ï¼Java8 çš„ `CompletableFuture` æä¾›äº†å¾ˆå¤šå¯¹å¤šçº¿ç¨‹å‹å¥½çš„æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæˆ‘ä»¬ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºï¼Œä»€ä¹ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œæˆ–è€…ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä»€ä¹ˆçš„éƒ½éå¸¸æ–¹ä¾¿ã€‚

```java
CompletableFuture<Void> task1 =
    CompletableFuture.supplyAsync(()->{
        //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> task6 =
    CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> headerFuture=CompletableFuture.allOf(task1,.....,task6);

try {
    headerFuture.join();
} catch (Exception ex) {
    //......
}
System.out.println("all done. ");
```

ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥æ¥ç»­ä¼˜åŒ–ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸€ä¸ª task éƒ½åˆ—å‡ºæ¥ä¸å¤ªç°å®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¾ªç¯æ¥æ·»åŠ ä»»åŠ¡ã€‚

```java
//æ–‡ä»¶å¤¹ä½ç½®
List<String> filePaths = Arrays.asList(...)
// å¼‚æ­¥å¤„ç†æ‰€æœ‰æ–‡ä»¶
List<CompletableFuture<String>> fileFutures = filePaths.stream()
    .map(filePath -> doSomeThing(filePath))
    .collect(Collectors.toList());
// å°†ä»–ä»¬åˆå¹¶èµ·æ¥
CompletableFuture<Void> allFutures = CompletableFuture.allOf(
    fileFutures.toArray(new CompletableFuture[fileFutures.size()])
);
```

### 4.12.7 çº¿ç¨‹æœ‰å“ªå‡ ç§é˜»å¡é˜Ÿåˆ—

## 4.13 Java åå°„ ç±»åŠ è½½å™¨

### 4.13.1 Java åå°„ 

åå°„ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºæ¡†æ¶çš„çµé­‚ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒèµ‹äºˆäº†æˆ‘ä»¬åœ¨è¿è¡Œæ—¶åˆ†æç±»ä»¥åŠæ‰§è¡Œç±»ä¸­æ–¹æ³•çš„èƒ½åŠ›ã€‚

é€šè¿‡åå°„ä½ å¯ä»¥è·å–ä»»æ„ä¸€ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œä½ è¿˜å¯ä»¥è°ƒç”¨è¿™äº›æ–¹æ³•å’Œå±æ€§ã€‚

####  åå°„æœºåˆ¶ä¼˜ç¼ºç‚¹

- **ä¼˜ç‚¹** ï¼š å¯ä»¥è®©å’±ä»¬çš„ä»£ç æ›´åŠ çµæ´»ã€ä¸ºå„ç§æ¡†æ¶æä¾›å¼€ç®±å³ç”¨çš„åŠŸèƒ½æä¾›äº†ä¾¿åˆ©
- **ç¼ºç‚¹** ï¼šè®©æˆ‘ä»¬åœ¨è¿è¡Œæ—¶æœ‰äº†åˆ†ææ“ä½œç±»çš„èƒ½åŠ›ï¼Œè¿™åŒæ ·ä¹Ÿå¢åŠ äº†å®‰å…¨é—®é¢˜ã€‚æ¯”å¦‚å¯ä»¥æ— è§†æ³›å‹å‚æ•°çš„å®‰å…¨æ£€æŸ¥ï¼ˆæ³›å‹å‚æ•°çš„å®‰å…¨æ£€æŸ¥å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ï¼‰ã€‚å¦å¤–ï¼Œåå°„çš„æ€§èƒ½ä¹Ÿè¦ç¨å·®ç‚¹ï¼Œä¸è¿‡ï¼Œå¯¹äºæ¡†æ¶æ¥è¯´å®é™…æ˜¯å½±å“ä¸å¤§çš„ã€‚

åƒå’±ä»¬å¹³æ—¶å¤§éƒ¨åˆ†æ—¶å€™éƒ½æ˜¯åœ¨å†™ä¸šåŠ¡ä»£ç ï¼Œå¾ˆå°‘ä¼šæ¥è§¦åˆ°ç›´æ¥ä½¿ç”¨åå°„æœºåˆ¶çš„åœºæ™¯ã€‚

ä½†æ˜¯ï¼Œè¿™å¹¶ä¸ä»£è¡¨åå°„æ²¡æœ‰ç”¨ã€‚ç›¸åï¼Œæ­£æ˜¯å› ä¸ºåå°„ï¼Œä½ æ‰èƒ½è¿™ä¹ˆè½»æ¾åœ°ä½¿ç”¨å„ç§æ¡†æ¶ã€‚åƒ Spring/Spring Bootã€MyBatis ç­‰ç­‰æ¡†æ¶ä¸­éƒ½å¤§é‡ä½¿ç”¨äº†åå°„æœºåˆ¶ã€‚

**è¿™äº›æ¡†æ¶ä¸­ä¹Ÿå¤§é‡ä½¿ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œè€ŒåŠ¨æ€ä»£ç†çš„å®ç°ä¹Ÿä¾èµ–åå°„ã€‚**

æ¯”å¦‚ä¸‹é¢æ˜¯é€šè¿‡ JDK å®ç°åŠ¨æ€ä»£ç†çš„ç¤ºä¾‹ä»£ç ï¼Œå…¶ä¸­å°±ä½¿ç”¨äº†åå°„ç±» `Method` æ¥è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•ã€‚

```java
public class DebugInvocationHandler implements InvocationHandler {
    /**
     * ä»£ç†ç±»ä¸­çš„çœŸå®å¯¹è±¡
     */
    private final Object target;

    public DebugInvocationHandler(Object target) {
        this.target = target;
    }


    public Object invoke(Object proxy, Method method, Object[] args) throws InvocationTargetException, IllegalAccessException {
        System.out.println("before method " + method.getName());
        Object result = method.invoke(target, args);
        System.out.println("after method " + method.getName());
        return result;
    }
}
```

å¦å¤–ï¼Œåƒ Java ä¸­çš„ä¸€å¤§åˆ©å™¨ **æ³¨è§£** çš„å®ç°ä¹Ÿç”¨åˆ°äº†åå°„ã€‚

ä¸ºä»€ä¹ˆä½ ä½¿ç”¨ Spring çš„æ—¶å€™ ï¼Œä¸€ä¸ª`@Component`æ³¨è§£å°±å£°æ˜äº†ä¸€ä¸ªç±»ä¸º Spring Bean å‘¢ï¼Ÿä¸ºä»€ä¹ˆä½ é€šè¿‡ä¸€ä¸ª `@Value`æ³¨è§£å°±è¯»å–åˆ°é…ç½®æ–‡ä»¶ä¸­çš„å€¼å‘¢ï¼Ÿç©¶ç«Ÿæ˜¯æ€ä¹ˆèµ·ä½œç”¨çš„å‘¢ï¼Ÿ

è¿™äº›éƒ½æ˜¯å› ä¸ºä½ å¯ä»¥åŸºäºåå°„åˆ†æç±»ï¼Œç„¶åè·å–åˆ°ç±»/å±æ€§/æ–¹æ³•/æ–¹æ³•çš„å‚æ•°ä¸Šçš„æ³¨è§£ã€‚ä½ è·å–åˆ°æ³¨è§£ä¹‹åï¼Œå°±å¯ä»¥åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚

### 4.13.1  ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿ

é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµè¿™ä¸ªåŠ¨ä½œæ”¾åˆ°Javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—ç§°ä¸º**â€œç±»åŠ è½½å™¨â€**ã€‚

### 4.13.2 ç±»åŠ è½½å™¨æœ‰å“ªäº›ï¼Ÿ

<img src="./images/v2-9e3254602608f3d224ac1dd3ab816075_1440w.jpg" alt="v2-9e3254602608f3d224ac1dd3ab816075_1440w.jpg" style="zoom:50%;" />

- **BootstrapClassLoader**ï¼šå¯åŠ¨ç±»ç±»åŠ è½½å™¨ï¼Œå®ƒç”¨æ¥åŠ è½½<JAVA_HOME>/jre/libè·¯å¾„,**-**Xbootclasspathå‚æ•°æŒ‡å®šçš„è·¯å¾„ä»¥<JAVA_HOME>/jre/classesä¸­çš„ç±»ã€‚BootStrapClassLoaderæ˜¯ç”±c++å®ç°çš„ã€‚
- **ExtClassLoader**ï¼šæ‹“å±•ç±»ç±»åŠ è½½å™¨ï¼Œå®ƒç”¨æ¥åŠ è½½<JAVA_HOME>/jre/lib/extè·¯å¾„ä»¥åŠjava.ext.dirsç³»ç»Ÿå˜é‡æŒ‡å®šçš„ç±»è·¯å¾„ä¸‹çš„ç±»ã€‚
- **AppClassLoader**ï¼šåº”ç”¨ç¨‹åºç±»ç±»åŠ è½½å™¨ï¼Œå®ƒä¸»è¦åŠ è½½åº”ç”¨ç¨‹åºClassPathä¸‹çš„ç±»ï¼ˆåŒ…å«jaråŒ…ä¸­çš„ç±»ï¼‰ã€‚å®ƒæ˜¯javaåº”ç”¨ç¨‹åºé»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚
- **ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨**ï¼šç”¨æˆ·æ ¹æ®è‡ªå®šä¹‰éœ€æ±‚ï¼Œè‡ªç”±çš„å®šåˆ¶åŠ è½½çš„é€»è¾‘ï¼Œç»§æ‰¿AppClassLoaderï¼Œä»…ä»…è¦†ç›–findClassï¼ˆï¼‰å³å°†ç»§ç»­éµå®ˆåŒäº²å§”æ´¾æ¨¡å‹ã€‚
- ***ThreadContextClassLoader**ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œæ›´åƒä¸€ä¸ªç±»åŠ è½½å™¨çš„è§’è‰²ï¼ŒThreadContextClassLoaderå¯ä»¥æ˜¯ä¸Šè¿°ç±»åŠ è½½å™¨çš„ä»»æ„ä¸€ç§ï¼Œä½†å¾€å¾€æ˜¯AppClassLoaderï¼Œä½œç”¨æˆ‘ä»¬åé¢å†è¯´ã€‚

åœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ä¼šåˆå§‹åŒ–BootstrapClassLoaderï¼Œç„¶ååœ¨Launcherç±»ä¸­å»åŠ è½½ExtClassLoaderã€AppClassLoaderï¼Œå¹¶å°†AppClassLoaderçš„parentè®¾ç½®ä¸ºExtClassLoaderï¼Œå¹¶è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚

### 4.13.3 å¯¹è±¡å¤´åŒ…æ‹¬ä»€ä¹ˆï¼Œå­˜åœ¨å“ªé‡Œ

### 4.13.10 è¡¥å……é—®é¢˜

#### 4.13.10.1 è¯·é—®ä¸€ä¸ªJavaæ–‡ä»¶ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªç±»ï¼Œè¯·é—®ä¼šäº§ç”Ÿå‡ ä¸ªclassæ–‡ä»¶ï¼Ÿ

<img src="./images/20201201165952416.png" alt="20201201165952416.png" style="zoom: 67%;" />

å¦‚æœä¸€ä¸ªjavaæ–‡ä»¶ä¸­æœ‰å¤šä¸ªç±»ï¼Œé™¤å»å†…éƒ¨ç±»,å‰©ä¸‹çš„æ¯ä¸ªæ™®é€šç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªclassæ–‡ä»¶ã€‚
å¦‚ä¸Šå›¾:ä¸€ä¸ªjavaæ–‡ä»¶ä¸­æœ‰6ä¸ªç±»ç”Ÿæˆäº†5ä¸ªclassæ–‡ä»¶,å› ä¸ºå…¶ä¸­æœ‰ä¸ªç±»æ˜¯å†…éƒ¨ç±»,å¦‚æœéƒ½æ˜¯å¤–éƒ¨ç±»çš„è¯,åˆ™ä¼šç”Ÿæˆ6ä¸ªclassæ–‡ä»¶ã€‚

> æ³¨ï¼šé™æ€å†…éƒ¨ç±»ï¼Œå°è¯•äº†ä¸€ä¸‹å’Œå†…éƒ¨ç±»ç›¸åŒã€‚



# 5. ä¸­é—´ä»¶

## 5.1 Spring

### 5.1.1 Springä¸­å±æ€§æ³¨å…¥æœ‰å“ªäº›æ–¹å¼

### 5.1.2 é‡‡ç”¨autowiredæ³¨è§£çš„beanä»€ä¹ˆæ—¶å€™æ³¨å…¥åˆ°å®¹å™¨ä¸­

### 5.1.3 Springboot beançš„ç”Ÿå‘½å‘¨æœŸ



## 5.2 SpringBoot

### 5.2.1 ä¸ºä»€ä¹ˆä½¿ç”¨SpringBootï¼Œå®ƒæœ‰å“ªäº›ä¼˜åŠ¿

### 5.2.2 å¸¸è§æ³¨è§£

https://gitee.com/SnailClimb/JavaGuide/blob/master/docs/system-design/framework/spring/SpringBoot+Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%80%BB%E7%BB%93.md

#### `@SpringBootApplication`

è¿™é‡Œå…ˆå•ç‹¬æ‹å‡º`@SpringBootApplication` æ³¨è§£è¯´ä¸€ä¸‹ï¼Œè™½ç„¶æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å»ä½¿ç”¨å®ƒã€‚

*Guide å“¥ï¼šè¿™ä¸ªæ³¨è§£æ˜¯ Spring Boot é¡¹ç›®çš„åŸºçŸ³ï¼Œåˆ›å»º SpringBoot é¡¹ç›®ä¹‹åä¼šé»˜è®¤åœ¨ä¸»ç±»åŠ ä¸Šã€‚*

```java
@SpringBootApplication
public class SpringSecurityJwtGuideApplication {
      public static void main(java.lang.String[] args) {
        SpringApplication.run(SpringSecurityJwtGuideApplication.class, args);
    }
}
```

æˆ‘ä»¬å¯ä»¥æŠŠ `@SpringBootApplication`çœ‹ä½œæ˜¯ `@Configuration`ã€`@EnableAutoConfiguration`ã€`@ComponentScan` æ³¨è§£çš„é›†åˆã€‚

```java
package org.springframework.boot.autoconfigure;
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration
@EnableAutoConfiguration
@ComponentScan(excludeFilters = {
		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })
public @interface SpringBootApplication {
   ......
}

package org.springframework.boot;
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Configuration
public @interface SpringBootConfiguration {

}
```

æ® SpringBoot å®˜ç½‘ï¼Œè¿™ä¸‰ä¸ªæ³¨è§£çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š

- `@EnableAutoConfiguration`ï¼šå¯ç”¨ SpringBoot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶
- `@ComponentScan`ï¼š æ‰«æè¢«`@Component` (`@Service`,`@Controller`)æ³¨è§£çš„ beanï¼Œæ³¨è§£é»˜è®¤ä¼šæ‰«æè¯¥ç±»æ‰€åœ¨çš„åŒ…ä¸‹æ‰€æœ‰çš„ç±»ã€‚
- `@Configuration`ï¼šå…è®¸åœ¨ Spring ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œé¢å¤–çš„ bean æˆ–å¯¼å…¥å…¶ä»–é…ç½®ç±»

`SpringBean` ç›¸å…³

`@Autowired`

è‡ªåŠ¨å¯¼å…¥å¯¹è±¡åˆ°ç±»ä¸­ï¼Œè¢«æ³¨å…¥è¿›çš„ç±»åŒæ ·è¦è¢« Spring å®¹å™¨ç®¡ç†æ¯”å¦‚ï¼šService ç±»æ³¨å…¥åˆ° Controller ç±»ä¸­ã€‚

```java
@Service
public class UserService {
  ......
}

@RestController
@RequestMapping("/users")
public class UserController {
   @Autowired
   private UserService userService;
   ......
}
```

`@Component`,`@Repository`,`@Service`, `@Controller`

æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ `@Autowired` æ³¨è§£è®© Spring å®¹å™¨å¸®æˆ‘ä»¬è‡ªåŠ¨è£…é… beanã€‚è¦æƒ³æŠŠç±»æ ‡è¯†æˆå¯ç”¨äº `@Autowired` æ³¨è§£è‡ªåŠ¨è£…é…çš„ bean çš„ç±»,å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ³¨è§£å®ç°ï¼š

- `@Component` ï¼šé€šç”¨çš„æ³¨è§£ï¼Œå¯æ ‡æ³¨ä»»æ„ç±»ä¸º `Spring` ç»„ä»¶ã€‚å¦‚æœä¸€ä¸ª Bean ä¸çŸ¥é“å±äºå“ªä¸ªå±‚ï¼Œå¯ä»¥ä½¿ç”¨`@Component` æ³¨è§£æ ‡æ³¨ã€‚
- `@Repository` : å¯¹åº”æŒä¹…å±‚å³ Dao å±‚ï¼Œä¸»è¦ç”¨äºæ•°æ®åº“ç›¸å…³æ“ä½œã€‚
- `@Service` : å¯¹åº”æœåŠ¡å±‚ï¼Œä¸»è¦æ¶‰åŠä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œéœ€è¦ç”¨åˆ° Dao å±‚ã€‚
- `@Controller` : å¯¹åº” Spring MVC æ§åˆ¶å±‚ï¼Œä¸»è¦ç”¨äºæ¥å—ç”¨æˆ·è¯·æ±‚å¹¶è°ƒç”¨ Service å±‚è¿”å›æ•°æ®ç»™å‰ç«¯é¡µé¢ã€‚

`@RestController`

`@RestController`æ³¨è§£æ˜¯`@Controller`å’Œ`@ResponseBody`çš„åˆé›†,è¡¨ç¤ºè¿™æ˜¯ä¸ªæ§åˆ¶å™¨ bean,å¹¶ä¸”æ˜¯å°†å‡½æ•°çš„è¿”å›å€¼ç›´æ¥å¡«å…¥ HTTP å“åº”ä½“ä¸­,æ˜¯ REST é£æ ¼çš„æ§åˆ¶å™¨ã€‚

*Guide å“¥ï¼šç°åœ¨éƒ½æ˜¯å‰åç«¯åˆ†ç¦»ï¼Œè¯´å®è¯æˆ‘å·²ç»å¾ˆä¹…æ²¡æœ‰ç”¨è¿‡`@Controller`ã€‚å¦‚æœä½ çš„é¡¹ç›®å¤ªè€äº†çš„è¯ï¼Œå°±å½“æˆ‘æ²¡è¯´ã€‚*

å•ç‹¬ä½¿ç”¨ `@Controller` ä¸åŠ  `@ResponseBody`çš„è¯ä¸€èˆ¬æ˜¯ç”¨åœ¨è¦è¿”å›ä¸€ä¸ªè§†å›¾çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå±äºæ¯”è¾ƒä¼ ç»Ÿçš„ Spring MVC çš„åº”ç”¨ï¼Œå¯¹åº”äºå‰åç«¯ä¸åˆ†ç¦»çš„æƒ…å†µã€‚`@Controller` +`@ResponseBody` è¿”å› JSON æˆ– XML å½¢å¼æ•°æ®

å…³äº`@RestController` å’Œ `@Controller`çš„å¯¹æ¯”ï¼Œè¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[@RestController vs @Controller](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485544&idx=1&sn=3cc95b88979e28fe3bfe539eb421c6d8&chksm=cea247a3f9d5ceb5e324ff4b8697adc3e828ecf71a3468445e70221cce768d1e722085359907&token=1725092312&lang=zh_CN#rd)ã€‚

 `@Scope`

å£°æ˜ Spring Bean çš„ä½œç”¨åŸŸï¼Œä½¿ç”¨æ–¹æ³•:

```java
@Bean
@Scope("singleton")
public Person personSingleton() {
    return new Person();
}
```

**å››ç§å¸¸è§çš„ Spring Bean çš„ä½œç”¨åŸŸï¼š**

- singleton : å”¯ä¸€ bean å®ä¾‹ï¼ŒSpring ä¸­çš„ bean é»˜è®¤éƒ½æ˜¯å•ä¾‹çš„ã€‚
- prototype : æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ bean å®ä¾‹ã€‚
- request : æ¯ä¸€æ¬¡ HTTP è¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ beanï¼Œè¯¥ bean ä»…åœ¨å½“å‰ HTTP request å†…æœ‰æ•ˆã€‚
- session : æ¯ä¸€æ¬¡ HTTP è¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ beanï¼Œè¯¥ bean ä»…åœ¨å½“å‰ HTTP session å†…æœ‰æ•ˆã€‚

`@Configuration`

ä¸€èˆ¬ç”¨æ¥å£°æ˜é…ç½®ç±»ï¼Œå¯ä»¥ä½¿ç”¨ `@Component`æ³¨è§£æ›¿ä»£ï¼Œä¸è¿‡ä½¿ç”¨`@Configuration`æ³¨è§£å£°æ˜é…ç½®ç±»æ›´åŠ è¯­ä¹‰åŒ–ã€‚

```java
@Configuration
public class AppConfig {
    @Bean
    public TransferService transferService() {
        return new TransferServiceImpl();
    }

}
```

#### å¤„ç†å¸¸è§çš„ HTTP è¯·æ±‚ç±»å‹

** 5 ç§å¸¸è§çš„è¯·æ±‚ç±»å‹:**

- **GET** ï¼šè¯·æ±‚ä»æœåŠ¡å™¨è·å–ç‰¹å®šèµ„æºã€‚ä¸¾ä¸ªä¾‹å­ï¼š`GET /users`ï¼ˆè·å–æ‰€æœ‰å­¦ç”Ÿï¼‰
- **POST** ï¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºã€‚ä¸¾ä¸ªä¾‹å­ï¼š`POST /users`ï¼ˆåˆ›å»ºå­¦ç”Ÿï¼‰
- **PUT** ï¼šæ›´æ–°æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ›´æ–°åçš„æ•´ä¸ªèµ„æºï¼‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼š`PUT /users/12`ï¼ˆæ›´æ–°ç¼–å·ä¸º 12 çš„å­¦ç”Ÿï¼‰
- **DELETE** ï¼šä»æœåŠ¡å™¨åˆ é™¤ç‰¹å®šçš„èµ„æºã€‚ä¸¾ä¸ªä¾‹å­ï¼š`DELETE /users/12`ï¼ˆåˆ é™¤ç¼–å·ä¸º 12 çš„å­¦ç”Ÿï¼‰
- **PATCH** ï¼šæ›´æ–°æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ›´æ”¹çš„å±æ€§ï¼Œå¯ä»¥çœ‹åšä½œæ˜¯éƒ¨åˆ†æ›´æ–°ï¼‰ï¼Œä½¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œå°±ä¸ä¸¾ä¾‹å­äº†ã€‚

##### Q? Getå¯ä»¥ä¼ é€’Bodyå—?

> é»˜è®¤ä¸å…è®¸ï¼ŒGet æ˜¯URLçš„ä¸€ç§æ–¹å¼ï¼Œè·å–çš„æ˜¯èµ„æºå®šä½ç¬¦ï¼Œä½†æ˜¯å®é™…æ“ä½œä¹Ÿæ˜¯å¯ä»¥çš„

 3.1. GET è¯·æ±‚

`@GetMapping("users")`` ç­‰ä»·äº``@RequestMapping(value="/users",method=RequestMethod.GET)`

```java
@GetMapping("/users")
public ResponseEntity<List<User>> getAllUsers() {
 return userRepository.findAll();
}
```

 3.2. POST è¯·æ±‚

`@PostMapping("users")`` ç­‰ä»·äº``@RequestMapping(value="/users",method=RequestMethod.POST)`

å…³äº`@RequestBody`æ³¨è§£çš„ä½¿ç”¨ï¼Œåœ¨ä¸‹é¢çš„â€œå‰åç«¯ä¼ å€¼â€è¿™å—ä¼šè®²åˆ°

```java
@PostMapping("/users")
public ResponseEntity<User> createUser(@Valid @RequestBody UserCreateRequest userCreateRequest) {
 return userRespository.save(userCreateRequest);
}
```

 3.3. PUT è¯·æ±‚

`@PutMapping("/users/{userId}")`ç­‰ä»·äº``@RequestMapping(value="/users/{userId}",method=RequestMethod.PUT)`

```java
@PutMapping("/users/{userId}")
public ResponseEntity<User> updateUser(@PathVariable(value = "userId") Long userId,
  @Valid @RequestBody UserUpdateRequest userUpdateRequest) {
  ......
}
```

3.4. **DELETE è¯·æ±‚**

```java
@DeleteMapping("/users/{userId}")`ç­‰ä»·äº`@RequestMapping(value="/users/{userId}",method=RequestMethod.DELETE)
```

```java
@DeleteMapping("/users/{userId}")
public ResponseEntity deleteUser(@PathVariable(value = "userId") Long userId){
  ......
}
```

 3.5. **PATCH è¯·æ±‚**

ä¸€èˆ¬å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯ PUT ä¸å¤Ÿç”¨äº†ä¹‹åæ‰ç”¨ PATCH è¯·æ±‚å»æ›´æ–°æ•°æ®ã€‚

```java
  @PatchMapping("/profile")
  public ResponseEntity updateStudent(@RequestBody StudentUpdateRequest studentUpdateRequest) {
        studentRepository.updateDetail(studentUpdateRequest);
        return ResponseEntity.ok().build();
    }
```

### 5.2.3 å‰åç«¯ä¼ å€¼

**æŒæ¡å‰åç«¯ä¼ å€¼çš„æ­£ç¡®å§¿åŠ¿ï¼Œæ˜¯ä½ å¼€å§‹ CRUD çš„ç¬¬ä¸€æ­¥ï¼**

####  5.2.3 `@PathVariable` å’Œ `@RequestParam`

`@PathVariable`ç”¨äºè·å–è·¯å¾„å‚æ•°ï¼Œ`@RequestParam`ç”¨äºè·å–æŸ¥è¯¢å‚æ•°ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š

```java
@GetMapping("/klasses/{klassId}/teachers")
public List<Teacher> getKlassRelatedTeachers(
         @PathVariable("klassId") Long klassId,
         @RequestParam(value = "type", required = false) String type ) {
...
}
```

å¦‚æœæˆ‘ä»¬è¯·æ±‚çš„ url æ˜¯ï¼š`/klasses/123456/teachers?type=web`

é‚£ä¹ˆæˆ‘ä»¬æœåŠ¡è·å–åˆ°çš„æ•°æ®å°±æ˜¯ï¼š`klassId=123456,type=web`ã€‚

####  5.2.4 `@RequestBody`

ç”¨äºè¯»å– Request è¯·æ±‚ï¼ˆå¯èƒ½æ˜¯ POST,PUT,DELETE,GET è¯·æ±‚ï¼‰çš„ body éƒ¨åˆ†å¹¶ä¸”**Content-Type ä¸º application/json** æ ¼å¼çš„æ•°æ®ï¼Œæ¥æ”¶åˆ°æ•°æ®ä¹‹åä¼šè‡ªåŠ¨å°†æ•°æ®ç»‘å®šåˆ° Java å¯¹è±¡ä¸Šå»ã€‚ç³»ç»Ÿä¼šä½¿ç”¨`HttpMessageConverter`æˆ–è€…è‡ªå®šä¹‰çš„`HttpMessageConverter`å°†è¯·æ±‚çš„ body ä¸­çš„ json å­—ç¬¦ä¸²è½¬æ¢ä¸º java å¯¹è±¡ã€‚

æˆ‘ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç»™æ¼”ç¤ºä¸€ä¸‹åŸºæœ¬ä½¿ç”¨ï¼

æˆ‘ä»¬æœ‰ä¸€ä¸ªæ³¨å†Œçš„æ¥å£ï¼š

```java
@PostMapping("/sign-up")
public ResponseEntity signUp(@RequestBody @Valid UserRegisterRequest userRegisterRequest) {
  userService.save(userRegisterRequest);
  return ResponseEntity.ok().build();
}
```

`UserRegisterRequest`å¯¹è±¡ï¼š

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class UserRegisterRequest {
    @NotBlank
    private String userName;
    @NotBlank
    private String password;
    @NotBlank
    private String fullName;
}
```

æˆ‘ä»¬å‘é€ post è¯·æ±‚åˆ°è¿™ä¸ªæ¥å£ï¼Œå¹¶ä¸” body æºå¸¦ JSON æ•°æ®ï¼š

```java
{"userName":"coder","fullName":"shuangkou","password":"123456"}
```

è¿™æ ·æˆ‘ä»¬çš„åç«¯å°±å¯ä»¥ç›´æ¥æŠŠ json æ ¼å¼çš„æ•°æ®æ˜ å°„åˆ°æˆ‘ä»¬çš„ `UserRegisterRequest` ç±»ä¸Šã€‚

![@RequestBody.png](./images/@RequestBody.png)

ğŸ‘‰ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**ä¸€ä¸ªè¯·æ±‚æ–¹æ³•åªå¯ä»¥æœ‰ä¸€ä¸ª`@RequestBody`ï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ª`@RequestParam`å’Œ`@PathVariable`**ã€‚ å¦‚æœä½ çš„æ–¹æ³•å¿…é¡»è¦ç”¨ä¸¤ä¸ª `@RequestBody`æ¥æ¥å—æ•°æ®çš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯ä½ çš„æ•°æ®åº“è®¾è®¡æˆ–è€…ç³»ç»Ÿè®¾è®¡å‡ºé—®é¢˜äº†ï¼

### 5.2.4 è¯»å–é…ç½®ä¿¡æ¯

**å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦å°†ä¸€äº›å¸¸ç”¨çš„é…ç½®ä¿¡æ¯æ¯”å¦‚é˜¿é‡Œäº‘ ossã€å‘é€çŸ­ä¿¡ã€å¾®ä¿¡è®¤è¯çš„ç›¸å…³é…ç½®ä¿¡æ¯ç­‰ç­‰æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ã€‚**

**ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring ä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›æ–¹å¼å¸®åŠ©æˆ‘ä»¬ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–è¿™äº›é…ç½®ä¿¡æ¯ã€‚**

æˆ‘ä»¬çš„æ•°æ®æº`application.yml`å†…å®¹å¦‚ä¸‹ï¼š

```yaml
wuhan2020: 2020å¹´åˆæ­¦æ±‰çˆ†å‘äº†æ–°å‹å† çŠ¶ç—…æ¯’ï¼Œç–«æƒ…ä¸¥é‡ï¼Œä½†æ˜¯ï¼Œæˆ‘ç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šè¿‡å»ï¼æ­¦æ±‰åŠ æ²¹ï¼ä¸­å›½åŠ æ²¹ï¼

my-profile:
  name: Guideå“¥
  email: koushuangbwcx@163.com

library:
  location: æ¹–åŒ—æ­¦æ±‰åŠ æ²¹ä¸­å›½åŠ æ²¹
  books:
    - name: å¤©æ‰åŸºæœ¬æ³•
      description: äºŒåäºŒå²çš„æ—æœå¤•åœ¨çˆ¶äº²ç¡®è¯Šé˜¿å°”èŒ¨æµ·é»˜ç—…è¿™å¤©ï¼Œå¾—çŸ¥è‡ªå·±æš—æ‹å¤šå¹´çš„æ ¡å›­ç”·ç¥è£´ä¹‹å³å°†å‡ºå›½æ·±é€ çš„æ¶ˆæ¯â€”â€”å¯¹æ–¹è€ƒå–çš„å­¦æ ¡ï¼Œæ°æ˜¯çˆ¶äº²å½“å¹´ä¸ºå¥¹æ”¾å¼ƒçš„é‚£æ‰€ã€‚
    - name: æ—¶é—´çš„ç§©åº
      description: ä¸ºä»€ä¹ˆæˆ‘ä»¬è®°å¾—è¿‡å»ï¼Œè€Œéæœªæ¥ï¼Ÿæ—¶é—´â€œæµé€â€æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ˜¯æˆ‘ä»¬å­˜åœ¨äºæ—¶é—´ä¹‹å†…ï¼Œè¿˜æ˜¯æ—¶é—´å­˜åœ¨äºæˆ‘ä»¬ä¹‹ä¸­ï¼Ÿå¡æ´›Â·ç½—éŸ¦åˆ©ç”¨è¯—æ„çš„æ–‡å­—ï¼Œé‚€è¯·æˆ‘ä»¬æ€è€ƒè¿™ä¸€äº˜å¤éš¾é¢˜â€”â€”æ—¶é—´çš„æœ¬è´¨ã€‚
    - name: äº†ä¸èµ·çš„æˆ‘
      description: å¦‚ä½•å…»æˆä¸€ä¸ªæ–°ä¹ æƒ¯ï¼Ÿå¦‚ä½•è®©å¿ƒæ™ºå˜å¾—æ›´æˆç†Ÿï¼Ÿå¦‚ä½•æ‹¥æœ‰é«˜è´¨é‡çš„å…³ç³»ï¼Ÿ å¦‚ä½•èµ°å‡ºäººç”Ÿçš„è‰°éš¾æ—¶åˆ»ï¼Ÿ
```

####  5.2.4.1`@Value`(å¸¸ç”¨)

ä½¿ç”¨ `@Value("${property}")` è¯»å–æ¯”è¾ƒç®€å•çš„é…ç½®ä¿¡æ¯ï¼š

```java
@Value("${wuhan2020}")
String wuhan2020;
```

####  5.2.4.2 `@ConfigurationProperties`(å¸¸ç”¨)

é€šè¿‡`@ConfigurationProperties`è¯»å–é…ç½®ä¿¡æ¯å¹¶ä¸ bean ç»‘å®šã€‚

```java
@Component
@ConfigurationProperties(prefix = "library")
class LibraryProperties {
    @NotEmpty
    private String location;
    private List<Book> books;

    @Setter
    @Getter
    @ToString
    static class Book {
        String name;
        String description;
    }
  çœç•¥getter/setter
  ......
}
```

ä½ å¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ Spring bean ä¸€æ ·ï¼Œå°†å…¶æ³¨å…¥åˆ°ç±»ä¸­ä½¿ç”¨ã€‚

#### 5.2.4.3 `@PropertySource`ï¼ˆä¸å¸¸ç”¨ï¼‰

`@PropertySource`è¯»å–æŒ‡å®š properties æ–‡ä»¶

```java
@Component
@PropertySource("classpath:website.properties")

class WebSite {
    @Value("${url}")
    private String url;

  çœç•¥getter/setter
  ......
}
```

æ›´å¤šå†…å®¹è¯·æŸ¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼šã€Š[10 åˆ†é’Ÿæå®š SpringBoot å¦‚ä½•ä¼˜é›…è¯»å–é…ç½®æ–‡ä»¶ï¼Ÿ](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247486181&idx=2&sn=10db0ae64ef501f96a5b0dbc4bd78786&chksm=cea2452ef9d5cc384678e456427328600971180a77e40c13936b19369672ca3e342c26e92b50&token=816772476&lang=zh_CN#rd)ã€‹ ã€‚

### 5.2.5  å‚æ•°æ ¡éªŒ

**æ•°æ®çš„æ ¡éªŒçš„é‡è¦æ€§å°±ä¸ç”¨è¯´äº†ï¼Œå³ä½¿åœ¨å‰ç«¯å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å¯¹ä¼ å…¥åç«¯çš„æ•°æ®å†è¿›è¡Œä¸€éæ ¡éªŒï¼Œé¿å…ç”¨æˆ·ç»•è¿‡æµè§ˆå™¨ç›´æ¥é€šè¿‡ä¸€äº› HTTP å·¥å…·ç›´æ¥å‘åç«¯è¯·æ±‚ä¸€äº›è¿æ³•æ•°æ®ã€‚**

**JSR(Java Specification Requestsï¼‰** æ˜¯ä¸€å¥— JavaBean å‚æ•°æ ¡éªŒçš„æ ‡å‡†ï¼Œå®ƒå®šä¹‰äº†å¾ˆå¤šå¸¸ç”¨çš„æ ¡éªŒæ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¿™äº›æ³¨è§£åŠ åœ¨æˆ‘ä»¬ JavaBean çš„å±æ€§ä¸Šé¢ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨éœ€è¦æ ¡éªŒçš„æ—¶å€™è¿›è¡Œæ ¡éªŒäº†ï¼Œéå¸¸æ–¹ä¾¿ï¼

æ ¡éªŒçš„æ—¶å€™æˆ‘ä»¬å®é™…ç”¨çš„æ˜¯ **Hibernate Validator** æ¡†æ¶ã€‚Hibernate Validator æ˜¯ Hibernate å›¢é˜Ÿæœ€åˆçš„æ•°æ®æ ¡éªŒæ¡†æ¶ï¼ŒHibernate Validator 4.x æ˜¯ Bean Validation 1.0ï¼ˆJSR 303ï¼‰çš„å‚è€ƒå®ç°ï¼ŒHibernate Validator 5.x æ˜¯ Bean Validation 1.1ï¼ˆJSR 349ï¼‰çš„å‚è€ƒå®ç°ï¼Œç›®å‰æœ€æ–°ç‰ˆçš„ Hibernate Validator 6.x æ˜¯ Bean Validation 2.0ï¼ˆJSR 380ï¼‰çš„å‚è€ƒå®ç°ã€‚

SpringBoot é¡¹ç›®çš„ spring-boot-starter-web ä¾èµ–ä¸­å·²ç»æœ‰ hibernate-validator åŒ…ï¼Œä¸éœ€è¦å¼•ç”¨ç›¸å…³ä¾èµ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆé€šè¿‡ idea æ’ä»¶â€”Maven Helper ç”Ÿæˆï¼‰ï¼š

**æ³¨**ï¼šæ›´æ–°ç‰ˆæœ¬çš„ spring-boot-starter-web ä¾èµ–ä¸­ä¸å†æœ‰ hibernate-validator åŒ…ï¼ˆå¦‚2.3.11.RELEASEï¼‰ï¼Œéœ€è¦è‡ªå·±å¼•å…¥ `spring-boot-starter-validation` ä¾èµ–ã€‚

![c7bacd12-1c1a-4e41-aaaf-4cad840fc073.png](./images/c7bacd12-1c1a-4e41-aaaf-4cad840fc073.png)

é SpringBoot é¡¹ç›®éœ€è¦è‡ªè¡Œå¼•å…¥ç›¸å…³ä¾èµ–åŒ…ï¼Œè¿™é‡Œä¸å¤šåšè®²è§£ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼šã€Š[å¦‚ä½•åœ¨ Spring/Spring Boot ä¸­åšå‚æ•°æ ¡éªŒï¼Ÿä½ éœ€è¦äº†è§£çš„éƒ½åœ¨è¿™é‡Œï¼](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485783&idx=1&sn=a407f3b75efa17c643407daa7fb2acd6&chksm=cea2469cf9d5cf8afbcd0a8a1c9cc4294d6805b8e01bee6f76bb2884c5bc15478e91459def49&token=292197051&lang=zh_CN#rd)ã€‹ã€‚

ğŸ‘‰ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š **æ‰€æœ‰çš„æ³¨è§£ï¼Œæ¨èä½¿ç”¨ JSR æ³¨è§£ï¼Œå³`javax.validation.constraints`ï¼Œè€Œä¸æ˜¯`org.hibernate.validator.constraints`**

####  5.2.5.1 ä¸€äº›å¸¸ç”¨çš„å­—æ®µéªŒè¯çš„æ³¨è§£

- `@NotEmpty` è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„ä¸èƒ½ä¸º null ä¹Ÿä¸èƒ½ä¸ºç©º
- `@NotBlank` è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²é nullï¼Œå¹¶ä¸”å¿…é¡»åŒ…å«ä¸€ä¸ªéç©ºç™½å­—ç¬¦
- `@Null` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null
- `@NotNull` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null
- `@AssertTrue` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true
- `@AssertFalse` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false
- `@Pattern(regex=,flag=)`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼
- `@Email` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ Email æ ¼å¼ã€‚
- `@Min(value)`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼
- `@Max(value)`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼
- `@DecimalMin(value)`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼
- `@DecimalMax(value)` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼
- `@Size(max=, min=)`è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…
- `@Digits(integer, fraction)`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†…
- `@Past`è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ
- `@Future` è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ
- ......

####  5.2.5.2  éªŒè¯è¯·æ±‚ä½“(RequestBody)

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Person {

    @NotNull(message = "classId ä¸èƒ½ä¸ºç©º")
    private String classId;

    @Size(max = 33)
    @NotNull(message = "name ä¸èƒ½ä¸ºç©º")
    private String name;

    @Pattern(regexp = "((^Man$|^Woman$|^UGM$))", message = "sex å€¼ä¸åœ¨å¯é€‰èŒƒå›´")
    @NotNull(message = "sex ä¸èƒ½ä¸ºç©º")
    private String sex;

    @Email(message = "email æ ¼å¼ä¸æ­£ç¡®")
    @NotNull(message = "email ä¸èƒ½ä¸ºç©º")
    private String email;

}
```

æˆ‘ä»¬åœ¨éœ€è¦éªŒè¯çš„å‚æ•°ä¸ŠåŠ ä¸Šäº†`@Valid`æ³¨è§£ï¼Œå¦‚æœéªŒè¯å¤±è´¥ï¼Œå®ƒå°†æŠ›å‡º`MethodArgumentNotValidException`ã€‚

```java
@RestController
@RequestMapping("/api")
public class PersonController {

    @PostMapping("/person")
    public ResponseEntity<Person> getPerson(@RequestBody @Valid Person person) {
        return ResponseEntity.ok().body(person);
    }
}
```

####  6.3. éªŒè¯è¯·æ±‚å‚æ•°(Path Variables å’Œ Request Parameters)

**ä¸€å®šä¸€å®šä¸è¦å¿˜è®°åœ¨ç±»ä¸ŠåŠ ä¸Š `@Validated` æ³¨è§£äº†ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥å‘Šè¯‰ Spring å»æ ¡éªŒæ–¹æ³•å‚æ•°ã€‚**

```Java
@RestController
@RequestMapping("/api")
@Validated
public class PersonController {

    @GetMapping("/person/{id}")
    public ResponseEntity<Integer> getPersonByID(@Valid @PathVariable("id") @Max(value = 5,message = "è¶…è¿‡ id çš„èŒƒå›´äº†") Integer id) {
        return ResponseEntity.ok().body(id);
    }
}
```

æ›´å¤šå…³äºå¦‚ä½•åœ¨ Spring é¡¹ç›®ä¸­è¿›è¡Œå‚æ•°æ ¡éªŒçš„å†…å®¹ï¼Œè¯·çœ‹ã€Š[å¦‚ä½•åœ¨ Spring/Spring Boot ä¸­åšå‚æ•°æ ¡éªŒï¼Ÿä½ éœ€è¦äº†è§£çš„éƒ½åœ¨è¿™é‡Œï¼](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485783&idx=1&sn=a407f3b75efa17c643407daa7fb2acd6&chksm=cea2469cf9d5cf8afbcd0a8a1c9cc4294d6805b8e01bee6f76bb2884c5bc15478e91459def49&token=292197051&lang=zh_CN#rd)ã€‹è¿™ç¯‡æ–‡ç« ã€‚

###  5.2.6. å…¨å±€å¤„ç† Controller å±‚å¼‚å¸¸

ä»‹ç»ä¸€ä¸‹æˆ‘ä»¬ Spring é¡¹ç›®å¿…å¤‡çš„å…¨å±€å¤„ç† Controller å±‚å¼‚å¸¸ã€‚

**ç›¸å…³æ³¨è§£ï¼š**

1. `@ControllerAdvice` :æ³¨è§£å®šä¹‰å…¨å±€å¼‚å¸¸å¤„ç†ç±»
2. `@ExceptionHandler` :æ³¨è§£å£°æ˜å¼‚å¸¸å¤„ç†æ–¹æ³•

å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæ‹¿æˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚å‚æ•°æ ¡éªŒè¿™å—æ¥ä¸¾ä¾‹å­ã€‚å¦‚æœæ–¹æ³•å‚æ•°ä¸å¯¹çš„è¯å°±ä¼šæŠ›å‡º`MethodArgumentNotValidException`ï¼Œæˆ‘ä»¬æ¥å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚

```java
@ControllerAdvice
@ResponseBody
public class GlobalExceptionHandler {

    /**
     * è¯·æ±‚å‚æ•°å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<?> handleMethodArgumentNotValidException(MethodArgumentNotValidException ex, HttpServletRequest request) {
       ......
    }
}
```

æ›´å¤šå…³äº Spring Boot å¼‚å¸¸å¤„ç†çš„å†…å®¹ï¼Œè¯·çœ‹æˆ‘çš„è¿™ä¸¤ç¯‡æ–‡ç« ï¼š

1. [SpringBoot å¤„ç†å¼‚å¸¸çš„å‡ ç§å¸¸è§å§¿åŠ¿](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485568&idx=2&sn=c5ba880fd0c5d82e39531fa42cb036ac&chksm=cea2474bf9d5ce5dcbc6a5f6580198fdce4bc92ef577579183a729cb5d1430e4994720d59b34&token=2133161636&lang=zh_CN#rd)
2. [ä½¿ç”¨æšä¸¾ç®€å•å°è£…ä¸€ä¸ªä¼˜é›…çš„ Spring Boot å…¨å±€å¼‚å¸¸å¤„ç†ï¼](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247486379&idx=2&sn=48c29ae65b3ed874749f0803f0e4d90e&chksm=cea24460f9d5cd769ed53ad7e17c97a7963a89f5350e370be633db0ae8d783c3a3dbd58c70f8&token=1054498516&lang=zh_CN#rd)

### 5.2.7 JPA ç›¸å…³

####  8.1. åˆ›å»ºè¡¨

`@Entity`å£°æ˜ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªæ•°æ®åº“å®ä½“ã€‚

`@Table` è®¾ç½®è¡¨å

```java
@Entity
@Table(name = "role")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String description;
    çœç•¥getter/setter......
}
```

####  8.2. åˆ›å»ºä¸»é”®

`@Id` ï¼šå£°æ˜ä¸€ä¸ªå­—æ®µä¸ºä¸»é”®ã€‚

ä½¿ç”¨`@Id`å£°æ˜ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸»é”®çš„ç”Ÿæˆç­–ç•¥ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `@GeneratedValue` æŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ã€‚

**1.é€šè¿‡ `@GeneratedValue`ç›´æ¥ä½¿ç”¨ JPA å†…ç½®æä¾›çš„å››ç§ä¸»é”®ç”Ÿæˆç­–ç•¥æ¥æŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ã€‚**

```java
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
```

JPA ä½¿ç”¨æšä¸¾å®šä¹‰äº† 4 ç§å¸¸è§çš„ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œå¦‚ä¸‹ï¼š

*Guide å“¥ï¼šæšä¸¾æ›¿ä»£å¸¸é‡çš„ä¸€ç§ç”¨æ³•*

```java
public enum GenerationType {

    /**
     * ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„æ•°æ®åº“è¡¨æ ¼æ¥ä¿å­˜ä¸»é”®
     * æŒä¹…åŒ–å¼•æ“é€šè¿‡å…³ç³»æ•°æ®åº“çš„ä¸€å¼ ç‰¹å®šçš„è¡¨æ ¼æ¥ç”Ÿæˆä¸»é”®,
     */
    TABLE,

    /**
     *åœ¨æŸäº›æ•°æ®åº“ä¸­,ä¸æ”¯æŒä¸»é”®è‡ªå¢é•¿,æ¯”å¦‚Oracleã€PostgreSQLå…¶æä¾›äº†ä¸€ç§å«åš"åºåˆ—(sequence)"çš„æœºåˆ¶ç”Ÿæˆä¸»é”®
     */
    SEQUENCE,

    /**
     * ä¸»é”®è‡ªå¢é•¿
     */
    IDENTITY,

    /**
     *æŠŠä¸»é”®ç”Ÿæˆç­–ç•¥äº¤ç»™æŒä¹…åŒ–å¼•æ“(persistence engine),
     *æŒä¹…åŒ–å¼•æ“ä¼šæ ¹æ®æ•°æ®åº“åœ¨ä»¥ä¸Šä¸‰ç§ä¸»é”®ç”Ÿæˆ ç­–ç•¥ä¸­é€‰æ‹©å…¶ä¸­ä¸€ç§
     */
    AUTO
}
```

```java
@GeneratedValue`æ³¨è§£é»˜è®¤ä½¿ç”¨çš„ç­–ç•¥æ˜¯`GenerationType.AUTO
```

```java
public @interface GeneratedValue {

    GenerationType strategy() default AUTO;
    String generator() default "";
}
```

ä¸€èˆ¬ä½¿ç”¨ MySQL æ•°æ®åº“çš„è¯ï¼Œä½¿ç”¨`GenerationType.IDENTITY`ç­–ç•¥æ¯”è¾ƒæ™®éä¸€ç‚¹ï¼ˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯éœ€è¦å¦å¤–è€ƒè™‘ä½¿ç”¨åˆ†å¸ƒå¼ IDï¼‰ã€‚

**2.é€šè¿‡ `@GenericGenerator`å£°æ˜ä¸€ä¸ªä¸»é”®ç­–ç•¥ï¼Œç„¶å `@GeneratedValue`ä½¿ç”¨è¿™ä¸ªç­–ç•¥**

```java
@Id
@GeneratedValue(generator = "IdentityIdGenerator")
@GenericGenerator(name = "IdentityIdGenerator", strategy = "identity")
private Long id;
```

ç­‰ä»·äºï¼š

```java
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
```

jpa æä¾›çš„ä¸»é”®ç”Ÿæˆç­–ç•¥æœ‰å¦‚ä¸‹å‡ ç§ï¼š

```java
public class DefaultIdentifierGeneratorFactory
		implements MutableIdentifierGeneratorFactory, Serializable, ServiceRegistryAwareService {

	@SuppressWarnings("deprecation")
	public DefaultIdentifierGeneratorFactory() {
		register( "uuid2", UUIDGenerator.class );
		register( "guid", GUIDGenerator.class );			// can be done with UUIDGenerator + strategy
		register( "uuid", UUIDHexGenerator.class );			// "deprecated" for new use
		register( "uuid.hex", UUIDHexGenerator.class ); 	// uuid.hex is deprecated
		register( "assigned", Assigned.class );
		register( "identity", IdentityGenerator.class );
		register( "select", SelectGenerator.class );
		register( "sequence", SequenceStyleGenerator.class );
		register( "seqhilo", SequenceHiLoGenerator.class );
		register( "increment", IncrementGenerator.class );
		register( "foreign", ForeignGenerator.class );
		register( "sequence-identity", SequenceIdentityGenerator.class );
		register( "enhanced-sequence", SequenceStyleGenerator.class );
		register( "enhanced-table", TableGenerator.class );
	}

	public void register(String strategy, Class generatorClass) {
		LOG.debugf( "Registering IdentifierGenerator strategy [%s] -> [%s]", strategy, generatorClass.getName() );
		final Class previous = generatorStrategyToClassNameMap.put( strategy, generatorClass );
		if ( previous != null ) {
			LOG.debugf( "    - overriding [%s]", previous.getName() );
		}
	}

}
```

####  8.3. è®¾ç½®å­—æ®µç±»å‹

`@Column` å£°æ˜å­—æ®µã€‚

**ç¤ºä¾‹ï¼š**

è®¾ç½®å±æ€§ userName å¯¹åº”çš„æ•°æ®åº“å­—æ®µåä¸º user_nameï¼Œé•¿åº¦ä¸º 32ï¼Œéç©º

```java
@Column(name = "user_name", nullable = false, length=32)
private String userName;
```

è®¾ç½®å­—æ®µç±»å‹å¹¶ä¸”åŠ é»˜è®¤å€¼ï¼Œè¿™ä¸ªè¿˜æ˜¯æŒºå¸¸ç”¨çš„ã€‚

```java
@Column(columnDefinition = "tinyint(1) default 1")
private Boolean enabled;
```

#### æŒ‡å®šä¸æŒä¹…åŒ–ç‰¹å®šå­—æ®µ

`@Transient` ï¼šå£°æ˜ä¸éœ€è¦ä¸æ•°æ®åº“æ˜ å°„çš„å­—æ®µï¼Œåœ¨ä¿å­˜çš„æ—¶å€™ä¸éœ€è¦ä¿å­˜è¿›æ•°æ®åº“ ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è®©`secrect` è¿™ä¸ªå­—æ®µä¸è¢«æŒä¹…åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ `@Transient`å…³é”®å­—å£°æ˜ã€‚

```java
@Entity(name="USER")
public class User {

    ......
    @Transient
    private String secrect; // not persistent because of @Transient

}
```

é™¤äº† `@Transient`å…³é”®å­—å£°æ˜ï¼Œ è¿˜å¯ä»¥é‡‡ç”¨ä¸‹é¢å‡ ç§æ–¹æ³•ï¼š

```java
static String secrect; // not persistent because of static
final String secrect = "Satish"; // not persistent because of final
transient String secrect; // not persistent because of transient
```

ä¸€èˆ¬ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¯”è¾ƒå¤šã€‚

####  å£°æ˜å¤§å­—æ®µ

`@Lob`:å£°æ˜æŸä¸ªå­—æ®µä¸ºå¤§å­—æ®µã€‚

```java
@Lob
private String content;
```

æ›´è¯¦ç»†çš„å£°æ˜ï¼š

```java
@Lob
//æŒ‡å®š Lob ç±»å‹æ•°æ®çš„è·å–ç­–ç•¥ï¼Œ FetchType.EAGER è¡¨ç¤ºéå»¶è¿ŸåŠ è½½ï¼Œè€Œ FetchType.LAZY è¡¨ç¤ºå»¶è¿ŸåŠ è½½ ï¼›
@Basic(fetch = FetchType.EAGER)
//columnDefinition å±æ€§æŒ‡å®šæ•°æ®è¡¨å¯¹åº”çš„ Lob å­—æ®µç±»å‹
@Column(name = "content", columnDefinition = "LONGTEXT NOT NULL")
private String content;
```

####  8.6. åˆ›å»ºæšä¸¾ç±»å‹çš„å­—æ®µ

å¯ä»¥ä½¿ç”¨æšä¸¾ç±»å‹çš„å­—æ®µï¼Œä¸è¿‡æšä¸¾å­—æ®µè¦ç”¨`@Enumerated`æ³¨è§£ä¿®é¥°ã€‚

```java
public enum Gender {
    MALE("ç”·æ€§"),
    FEMALE("å¥³æ€§");

    private String value;
    Gender(String str){
        value=str;
    }
```

```java
@Entity
@Table(name = "role")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String description;
    @Enumerated(EnumType.STRING)
    private Gender gender;
    çœç•¥getter/setter......
}
```

æ•°æ®åº“é‡Œé¢å¯¹åº”å­˜å‚¨çš„æ˜¯ MALE/FEMALEã€‚

####  8.7. å¢åŠ å®¡è®¡åŠŸèƒ½

åªè¦ç»§æ‰¿äº† `AbstractAuditBase`çš„ç±»éƒ½ä¼šé»˜è®¤åŠ ä¸Šä¸‹é¢å››ä¸ªå­—æ®µã€‚

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
@MappedSuperclass
@EntityListeners(value = AuditingEntityListener.class)
public abstract class AbstractAuditBase {

    @CreatedDate
    @Column(updatable = false)
    @JsonIgnore
    private Instant createdAt;

    @LastModifiedDate
    @JsonIgnore
    private Instant updatedAt;

    @CreatedBy
    @Column(updatable = false)
    @JsonIgnore
    private String createdBy;

    @LastModifiedBy
    @JsonIgnore
    private String updatedBy;
}
```

æˆ‘ä»¬å¯¹åº”çš„å®¡è®¡åŠŸèƒ½å¯¹åº”åœ°é…ç½®ç±»å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼ˆSpring Security é¡¹ç›®ï¼‰:

```java
@Configuration
@EnableJpaAuditing
public class AuditSecurityConfiguration {
    @Bean
    AuditorAware<String> auditorAware() {
        return () -> Optional.ofNullable(SecurityContextHolder.getContext())
                .map(SecurityContext::getAuthentication)
                .filter(Authentication::isAuthenticated)
                .map(Authentication::getName);
    }
}
```

ç®€å•ä»‹ç»ä¸€ä¸‹ä¸Šé¢æ¶‰åŠåˆ°çš„ä¸€äº›æ³¨è§£ï¼š

1. `@CreatedDate`: è¡¨ç¤ºè¯¥å­—æ®µä¸ºåˆ›å»ºæ—¶é—´å­—æ®µï¼Œåœ¨è¿™ä¸ªå®ä½“è¢« insert çš„æ—¶å€™ï¼Œä¼šè®¾ç½®å€¼

2. `@CreatedBy` :è¡¨ç¤ºè¯¥å­—æ®µä¸ºåˆ›å»ºäººï¼Œåœ¨è¿™ä¸ªå®ä½“è¢« insert çš„æ—¶å€™ï¼Œä¼šè®¾ç½®å€¼

   `@LastModifiedDate`ã€`@LastModifiedBy`åŒç†ã€‚

`@EnableJpaAuditing`ï¼šå¼€å¯ JPA å®¡è®¡åŠŸèƒ½ã€‚

####  8.8. åˆ é™¤/ä¿®æ”¹æ•°æ®

`@Modifying` æ³¨è§£æç¤º JPA è¯¥æ“ä½œæ˜¯ä¿®æ”¹æ“ä½œ,æ³¨æ„è¿˜è¦é…åˆ`@Transactional`æ³¨è§£ä½¿ç”¨ã€‚

```java
@Repository
public interface UserRepository extends JpaRepository<User, Integer> {

    @Modifying
    @Transactional(rollbackFor = Exception.class)
    void deleteByUserName(String userName);
}
```

#### 8.9. å…³è”å…³ç³»

- `@OneToOne` å£°æ˜ä¸€å¯¹ä¸€å…³ç³»
- `@OneToMany` å£°æ˜ä¸€å¯¹å¤šå…³ç³»
- `@ManyToOne` å£°æ˜å¤šå¯¹ä¸€å…³ç³»
- `@MangToMang` å£°æ˜å¤šå¯¹å¤šå…³ç³»

æ›´å¤šå…³äº Spring Boot JPA çš„æ–‡ç« è¯·çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š[ä¸€æ–‡ææ‡‚å¦‚ä½•åœ¨ Spring Boot æ­£ç¡®ä¸­ä½¿ç”¨ JPA](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485689&idx=1&sn=061b32c2222869932be5631fb0bb5260&chksm=cea24732f9d5ce24a356fb3675170e7843addbfcc79ee267cfdb45c83fc7e90babf0f20d22e1&token=292197051&lang=zh_CN#rd) ã€‚

### 5.2.8.  äº‹åŠ¡ `@Transactional`

åœ¨è¦å¼€å¯äº‹åŠ¡çš„æ–¹æ³•ä¸Šä½¿ç”¨`@Transactional`æ³¨è§£å³å¯!

```java
@Transactional(rollbackFor = Exception.class)
public void save() {
  ......
}
```

æˆ‘ä»¬çŸ¥é“ Exception åˆ†ä¸ºè¿è¡Œæ—¶å¼‚å¸¸ RuntimeException å’Œéè¿è¡Œæ—¶å¼‚å¸¸ã€‚åœ¨`@Transactional`æ³¨è§£ä¸­å¦‚æœä¸é…ç½®`rollbackFor`å±æ€§,é‚£ä¹ˆäº‹åŠ¡åªä¼šåœ¨é‡åˆ°`RuntimeException`çš„æ—¶å€™æ‰ä¼šå›æ»š,åŠ ä¸Š`rollbackFor=Exception.class`,å¯ä»¥è®©äº‹åŠ¡åœ¨é‡åˆ°éè¿è¡Œæ—¶å¼‚å¸¸æ—¶ä¹Ÿå›æ»šã€‚

`@Transactional` æ³¨è§£ä¸€èˆ¬å¯ä»¥ä½œç”¨åœ¨`ç±»`æˆ–è€…`æ–¹æ³•`ä¸Šã€‚

- **ä½œç”¨äºç±»**ï¼šå½“æŠŠ`@Transactional` æ³¨è§£æ”¾åœ¨ç±»ä¸Šæ—¶ï¼Œè¡¨ç¤ºæ‰€æœ‰è¯¥ç±»çš„ public æ–¹æ³•éƒ½é…ç½®ç›¸åŒçš„äº‹åŠ¡å±æ€§ä¿¡æ¯ã€‚
- **ä½œç”¨äºæ–¹æ³•**ï¼šå½“ç±»é…ç½®äº†`@Transactional`ï¼Œæ–¹æ³•ä¹Ÿé…ç½®äº†`@Transactional`ï¼Œæ–¹æ³•çš„äº‹åŠ¡ä¼šè¦†ç›–ç±»çš„äº‹åŠ¡é…ç½®ä¿¡æ¯ã€‚

æ›´å¤šå…³äº Spring äº‹åŠ¡çš„å†…å®¹è¯·æŸ¥çœ‹ï¼š

1. [å¯èƒ½æ˜¯æœ€æ¼‚äº®çš„ Spring äº‹åŠ¡ç®¡ç†è¯¦è§£](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247484943&idx=1&sn=46b9082af4ec223137df7d1c8303ca24&chksm=cea249c4f9d5c0d2b8212a17252cbfb74e5fbe5488b76d829827421c53332326d1ec360f5d63&token=1082669959&lang=zh_CN#rd)
2. [ä¸€å£æ°”è¯´å‡º 6 ç§ @Transactional æ³¨è§£å¤±æ•ˆåœºæ™¯](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247486483&idx=2&sn=77be488e206186803531ea5d7164ec53&chksm=cea243d8f9d5cacecaa5c5daae4cde4c697b9b5b21f96dfc6cce428cfcb62b88b3970c26b9c2&token=816772476&lang=zh_CN#rd)

### 5.2.9. json æ•°æ®å¤„ç†

#### 10.1. è¿‡æ»¤ json æ•°æ®

**`@JsonIgnoreProperties` ä½œç”¨åœ¨ç±»ä¸Šç”¨äºè¿‡æ»¤æ‰ç‰¹å®šå­—æ®µä¸è¿”å›æˆ–è€…ä¸è§£æã€‚**

```java
//ç”Ÿæˆjsonæ—¶å°†userRoleså±æ€§è¿‡æ»¤
@JsonIgnoreProperties({"userRoles"})
public class User {

    private String userName;
    private String fullName;
    private String password;
    private List<UserRole> userRoles = new ArrayList<>();
}
```

**`@JsonIgnore`ä¸€èˆ¬ç”¨äºç±»çš„å±æ€§ä¸Šï¼Œä½œç”¨å’Œä¸Šé¢çš„`@JsonIgnoreProperties` ä¸€æ ·ã€‚**

```java
public class User {

    private String userName;
    private String fullName;
    private String password;
   //ç”Ÿæˆjsonæ—¶å°†userRoleså±æ€§è¿‡æ»¤
    @JsonIgnore
    private List<UserRole> userRoles = new ArrayList<>();
}
```

#### 10.2. æ ¼å¼åŒ– json æ•°æ®

`@JsonFormat`ä¸€èˆ¬ç”¨æ¥æ ¼å¼åŒ– json æ•°æ®ã€‚

æ¯”å¦‚ï¼š

```java
@JsonFormat(shape=JsonFormat.Shape.STRING, pattern="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", timezone="GMT")
private Date date;
```

#### 10.3. æ‰å¹³åŒ–å¯¹è±¡

```java
@Getter
@Setter
@ToString
public class Account {
    private Location location;
    private PersonInfo personInfo;

  @Getter
  @Setter
  @ToString
  public static class Location {
     private String provinceName;
     private String countyName;
  }
  @Getter
  @Setter
  @ToString
  public static class PersonInfo {
    private String userName;
    private String fullName;
  }
}
```

æœªæ‰å¹³åŒ–ä¹‹å‰ï¼š

```java
{
    "location": {
        "provinceName":"æ¹–åŒ—",
        "countyName":"æ­¦æ±‰"
    },
    "personInfo": {
        "userName": "coder1234",
        "fullName": "shaungkou"
    }
}
```

ä½¿ç”¨`@JsonUnwrapped` æ‰å¹³å¯¹è±¡ä¹‹åï¼š

```java
@Getter
@Setter
@ToString
public class Account {
    @JsonUnwrapped
    private Location location;
    @JsonUnwrapped
    private PersonInfo personInfo;
    ......
}
{
  "provinceName":"æ¹–åŒ—",
  "countyName":"æ­¦æ±‰",
  "userName": "coder1234",
  "fullName": "shaungkou"
}
```

### 5.2.10. æµ‹è¯•ç›¸å…³

**`@ActiveProfiles`ä¸€èˆ¬ä½œç”¨äºæµ‹è¯•ç±»ä¸Šï¼Œ ç”¨äºå£°æ˜ç”Ÿæ•ˆçš„ Spring é…ç½®æ–‡ä»¶ã€‚**

```java
@SpringBootTest(webEnvironment = RANDOM_PORT)
@ActiveProfiles("test")
@Slf4j
public abstract class TestBase {
  ......
}
```

**`@Test`å£°æ˜ä¸€ä¸ªæ–¹æ³•ä¸ºæµ‹è¯•æ–¹æ³•**

**`@Transactional`è¢«å£°æ˜çš„æµ‹è¯•æ–¹æ³•çš„æ•°æ®ä¼šå›æ»šï¼Œé¿å…æ±¡æŸ“æµ‹è¯•æ•°æ®ã€‚**

**`@WithMockUser` Spring Security æä¾›çš„ï¼Œç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®ç”¨æˆ·ï¼Œå¹¶ä¸”å¯ä»¥èµ‹äºˆæƒé™ã€‚**

```java
    @Test
    @Transactional
    @WithMockUser(username = "user-id-18163138155", authorities = "ROLE_TEACHER")
    void should_import_student_success() throws Exception {
        ......
    }
```





#### `@RequestMapping`

å¦‚æœæœ‰ä¸¤ä¸ªRequestMappingçš„urlæ˜¯ä¸€æ ·çš„ï¼Œ[å‰ç«¯](https://www.nowcoder.com/jump/super-jump/word?word=å‰ç«¯)è¯·æ±‚ä¼šè¿”å›ä»€ä¹ˆï¼Ÿ

500ï¼Œåç«¯ç¼–è¯‘ä¸é€šè¿‡

### 5.2.3 æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨

### 5.2.4 restfulAPI



## 5.3 Maven

### 5.3.1 mavenç”Ÿå‘½å‘¨æœŸ

## 5.4 Mybatis

## 5.5 Redis

### 5.5.1 Redis ç®€ä»‹

ç®€å•æ¥è¯´ **Redis å°±æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€å¼€å‘çš„æ•°æ®åº“**ï¼Œä¸è¿‡ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ **Redis çš„æ•°æ®æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„** ï¼Œä¹Ÿå°±æ˜¯å®ƒæ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå› æ­¤ Redis è¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜æ–¹å‘ã€‚

å¦å¤–ï¼Œ**Redis é™¤äº†åšç¼“å­˜ä¹‹å¤–ï¼Œä¹Ÿç»å¸¸ç”¨æ¥åšåˆ†å¸ƒå¼é”ï¼Œç”šè‡³æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚**

**Redis æä¾›äº†å¤šç§æ•°æ®ç±»å‹æ¥æ”¯æŒä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚Redis è¿˜æ”¯æŒäº‹åŠ¡ ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å¤šç§é›†ç¾¤æ–¹æ¡ˆã€‚**

###  5.5.2 åˆ†å¸ƒå¼ç¼“å­˜å¸¸è§çš„æŠ€æœ¯é€‰å‹æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ

åˆ†å¸ƒå¼ç¼“å­˜çš„è¯ï¼Œä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸»è¦æ˜¯ **Memcached** å’Œ **Redis**ã€‚ä¸è¿‡ï¼Œç°åœ¨åŸºæœ¬æ²¡æœ‰çœ‹è¿‡è¿˜æœ‰é¡¹ç›®ä½¿ç”¨ **Memcached** æ¥åšç¼“å­˜ï¼Œéƒ½æ˜¯ç›´æ¥ç”¨ **Redis**ã€‚

Memcached æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æœ€å¼€å§‹å…´èµ·çš„é‚£ä¼šï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ã€‚åæ¥ï¼Œéšç€ Redis çš„å‘å±•ï¼Œå¤§å®¶æ…¢æ…¢éƒ½è½¬è€Œä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ Redis äº†ã€‚

åˆ†å¸ƒå¼ç¼“å­˜ä¸»è¦è§£å†³çš„æ˜¯å•æœºç¼“å­˜çš„å®¹é‡å—æœåŠ¡å™¨é™åˆ¶å¹¶ä¸”æ— æ³•ä¿å­˜é€šç”¨ä¿¡æ¯çš„é—®é¢˜ã€‚å› ä¸ºï¼Œæœ¬åœ°ç¼“å­˜åªåœ¨å½“å‰æœåŠ¡é‡Œæœ‰æ•ˆï¼Œæ¯”å¦‚å¦‚æœä½ éƒ¨ç½²äº†ä¸¤ä¸ªç›¸åŒçš„æœåŠ¡ï¼Œä»–ä»¬ä¸¤è€…ä¹‹é—´çš„ç¼“å­˜æ•°æ®æ˜¯æ— æ³•å…±åŒçš„ã€‚

> è‡ªå·±æ³¨ï¼šåˆ†å¸ƒå¼ç¼“å­˜ä¸¤å¤§ç‰¹ç‚¹ï¼š1. å¯ä»¥çªç ´å•å°æœºå™¨çš„é™åˆ¶ã€‚2. è§£å†³å¤šå°è®¾å¤‡ç¼“å­˜æ— æ³•äº¤æµçš„é—®é¢˜ã€‚

### 5.5.3  è¯´ä¸€ä¸‹ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹

ç°åœ¨å…¬å¸ä¸€èˆ¬éƒ½æ˜¯ç”¨ Redis æ¥å®ç°ç¼“å­˜ï¼Œè€Œä¸” Redis è‡ªèº«ä¹Ÿè¶Šæ¥è¶Šå¼ºå¤§äº†ï¼ä¸è¿‡ï¼Œäº†è§£ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨åšç›¸åº”çš„æŠ€æœ¯é€‰å‹çš„æ—¶å€™ï¼Œèƒ½å¤Ÿåšåˆ°æœ‰ç†æœ‰æ®ï¼

**å…±åŒç‚¹** ï¼š

1. éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“åšç¼“å­˜ä½¿ç”¨ã€‚
2. éƒ½æœ‰è¿‡æœŸç­–ç•¥ã€‚
3. ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚

**åŒºåˆ«** ï¼š

1. **Redis æ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼‰**ã€‚Redis ä¸ä»…ä»…æ”¯æŒç®€å•çš„ k/v ç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾› listï¼Œsetï¼Œzsetï¼Œhash ç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚Memcached åªæ”¯æŒæœ€ç®€å•çš„ k/v æ•°æ®ç±»å‹ã€‚
2. **Redis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨,è€Œ Memecache æŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ã€‚**
3. **Redis æœ‰ç¾éš¾æ¢å¤æœºåˆ¶ã€‚** å› ä¸ºå¯ä»¥æŠŠç¼“å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚
4. **Redis åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå¯ä»¥å°†ä¸ç”¨çš„æ•°æ®æ”¾åˆ°ç£ç›˜ä¸Šã€‚ä½†æ˜¯ï¼ŒMemcached åœ¨æœåŠ¡å™¨å†…å­˜ä½¿ç”¨å®Œä¹‹åï¼Œå°±ä¼šç›´æ¥æŠ¥å¼‚å¸¸ã€‚**
5. **Memcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›ä½†æ˜¯ Redis ç›®å‰æ˜¯åŸç”Ÿæ”¯æŒ cluster æ¨¡å¼çš„ã€‚**
6. **Memcached æ˜¯å¤šçº¿ç¨‹ï¼Œéé˜»å¡ IO å¤ç”¨çš„ç½‘ç»œæ¨¡å‹ï¼›Redis ä½¿ç”¨å•çº¿ç¨‹çš„å¤šè·¯ IO å¤ç”¨æ¨¡å‹ã€‚** ï¼ˆRedis 6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ IO ï¼‰
7. **Redis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒã€‚å¹¶ä¸”ï¼ŒRedis æ”¯æŒæ›´å¤šçš„ç¼–ç¨‹è¯­è¨€ã€‚**
8. **Memcached è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥åªç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œè€Œ Redis åŒæ—¶ä½¿ç”¨äº†æƒ°æ€§åˆ é™¤ä¸å®šæœŸåˆ é™¤ã€‚**

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„å¯¹æ¯”ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰ä»€ä¹ˆç†ç”±å¯ä»¥é€‰æ‹©ä½¿ç”¨ Memcached æ¥ä½œä¸ºè‡ªå·±é¡¹ç›®çš„åˆ†å¸ƒå¼ç¼“å­˜äº†ã€‚

> ä¸»è¦æ˜¯æ›´å¤šçš„äº†è§£Redisçš„ç‰¹ç‚¹ã€‚

### 5.5.4 Redis å·¥ä½œè¿‡ç¨‹

![ç¼“å­˜çš„å¤„ç†æµç¨‹.png](./images/ç¼“å­˜çš„å¤„ç†æµç¨‹.png)



ç®€å•æ¥è¯´å°±æ˜¯:

1. å¦‚æœç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å°±ç›´æ¥è¿”å›ã€‚
2. ç¼“å­˜ä¸­ä¸å­˜åœ¨çš„è¯å°±çœ‹æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ã€‚
3. æ•°æ®åº“ä¸­å­˜åœ¨çš„è¯å°±æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚
4. æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„è¯å°±è¿”å›ç©ºæ•°æ®ã€‚

###  5.5.5 ä¸ºä»€ä¹ˆè¦ç”¨ Redis/ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ

*ç®€å•ï¼Œæ¥è¯´ä½¿ç”¨ç¼“å­˜ä¸»è¦æ˜¯ä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒä»¥åŠåº”å¯¹æ›´å¤šçš„ç”¨æˆ·ã€‚*

ä¸‹é¢æˆ‘ä»¬ä¸»è¦ä»â€œé«˜æ€§èƒ½â€å’Œâ€œé«˜å¹¶å‘â€è¿™ä¸¤ç‚¹æ¥çœ‹å¾…è¿™ä¸ªé—®é¢˜ã€‚

![ä½¿ç”¨ç¼“å­˜ä¹‹å.png](./images/ä½¿ç”¨ç¼“å­˜ä¹‹å.png)

**é«˜æ€§èƒ½** ï¼š

å¯¹ç…§ä¸Šé¢ ğŸ‘† æˆ‘ç”»çš„å›¾ã€‚æˆ‘ä»¬è®¾æƒ³è¿™æ ·çš„åœºæ™¯ï¼š

å‡å¦‚ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ•°æ®åº“ä¸­çš„æŸäº›æ•°æ®çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ…¢ï¼Œæ¯•ç«Ÿæ˜¯ä»ç¡¬ç›˜ä¸­è¯»å–çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¯´ï¼Œç”¨æˆ·è®¿é—®çš„æ•°æ®å±äºé«˜é¢‘æ•°æ®å¹¶ä¸”ä¸ä¼šç»å¸¸æ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¾ˆæ”¾å¿ƒåœ°å°†è¯¥ç”¨æˆ·è®¿é—®çš„æ•°æ®å­˜åœ¨ç¼“å­˜ä¸­ã€‚

**è¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ** é‚£å°±æ˜¯ä¿è¯ç”¨æˆ·ä¸‹ä¸€æ¬¡å†è®¿é—®è¿™äº›æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–äº†ã€‚æ“ä½œç¼“å­˜å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“å¿«ã€‚

ä¸è¿‡ï¼Œè¦ä¿æŒæ•°æ®åº“å’Œç¼“å­˜ä¸­çš„æ•°æ®çš„ä¸€è‡´æ€§ã€‚ å¦‚æœæ•°æ®åº“ä¸­çš„å¯¹åº”æ•°æ®æ”¹å˜çš„ä¹‹åï¼ŒåŒæ­¥æ”¹å˜ç¼“å­˜ä¸­ç›¸åº”çš„æ•°æ®å³å¯ï¼

**é«˜å¹¶å‘ï¼š**

ä¸€èˆ¬åƒ MySQL è¿™ç±»çš„æ•°æ®åº“çš„ QPS å¤§æ¦‚éƒ½åœ¨ 1w å·¦å³ï¼ˆ4 æ ¸ 8gï¼‰ ï¼Œä½†æ˜¯ä½¿ç”¨ Redis ç¼“å­˜ä¹‹åå¾ˆå®¹æ˜“è¾¾åˆ° 10w+ï¼Œç”šè‡³æœ€é«˜èƒ½è¾¾åˆ° 30w+ï¼ˆå°±å•æœº redis çš„æƒ…å†µï¼Œredis é›†ç¾¤çš„è¯ä¼šæ›´é«˜ï¼‰ã€‚

> QPSï¼ˆQuery Per Secondï¼‰ï¼šæœåŠ¡å™¨æ¯ç§’å¯ä»¥æ‰§è¡Œçš„æŸ¥è¯¢æ¬¡æ•°ï¼›

ç”±æ­¤å¯è§ï¼Œç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„æ•°æ®åº“è¯·æ±‚æ•°é‡æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚è¿›è€Œï¼Œæˆ‘ä»¬ä¹Ÿå°±æé«˜äº†ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘ã€‚

### 5.5.6 Redis é™¤äº†å¯ä»¥åšæ•°æ®åº“è¿˜å¯ä»¥åšä»€ä¹ˆï¼Ÿ

- **åˆ†å¸ƒå¼é”** ï¼š é€šè¿‡ Redis æ¥åšåˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŸºäº Redisson æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚ç›¸å…³é˜…è¯»ï¼š[ã€Šåˆ†å¸ƒå¼é”ä¸­çš„ç‹è€…æ–¹æ¡ˆ - Redissonã€‹](https://mp.weixin.qq.com/s/CbnPRfvq4m1sqo2uKI6qQw)ã€‚
- **é™æµ** ï¼šä¸€èˆ¬æ˜¯é€šè¿‡ Redis + Lua è„šæœ¬çš„æ–¹å¼æ¥å®ç°é™æµã€‚ç›¸å…³é˜…è¯»ï¼š[ã€Šæˆ‘å¸ç”¨äº† 6 å¹´çš„ Redis åˆ†å¸ƒå¼é™æµå™¨ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸å‰å®³äº†ï¼ã€‹](https://mp.weixin.qq.com/s/kyFAWH3mVNJvurQDt4vchA)ã€‚
- **æ¶ˆæ¯é˜Ÿåˆ—** ï¼šRedis è‡ªå¸¦çš„ list æ•°æ®ç»“æ„å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ä½¿ç”¨ã€‚Redis5.0 ä¸­å¢åŠ çš„ Stream ç±»å‹çš„æ•°æ®ç»“æ„æ›´åŠ é€‚åˆç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒæ¯”è¾ƒç±»ä¼¼äº Kafkaï¼Œæœ‰ä¸»é¢˜å’Œæ¶ˆè´¹ç»„çš„æ¦‚å¿µï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠ ACK æœºåˆ¶ã€‚
- **å¤æ‚ä¸šåŠ¡åœºæ™¯** ï¼šé€šè¿‡ Redis ä»¥åŠ Redis æ‰©å±•ï¼ˆæ¯”å¦‚ Redissonï¼‰æä¾›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå¾ˆå¤šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯æ¯”å¦‚é€šè¿‡ bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ã€é€šè¿‡ sorted set ç»´æŠ¤æ’è¡Œæ¦œã€‚
- ......

### 5.5.7 Redis å¸¸è§æ•°æ®ç»“æ„ä»¥åŠä½¿ç”¨åœºæ™¯åˆ†æ

**ä½ å¯ä»¥è‡ªå·±æœ¬æœºå®‰è£… redis æˆ–è€…é€šè¿‡ redis å®˜ç½‘æä¾›çš„[åœ¨çº¿ redis ç¯å¢ƒ](https://try.redis.io/)ã€‚**

####  string

1. **ä»‹ç»** ï¼šstring æ•°æ®ç»“æ„æ˜¯ç®€å•çš„ key-value ç±»å‹ã€‚è™½ç„¶ Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯ Redis å¹¶æ²¡æœ‰ä½¿ç”¨ C çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§ **ç®€å•åŠ¨æ€å­—ç¬¦ä¸²**ï¼ˆsimple dynamic stringï¼Œ**SDS**ï¼‰ã€‚ç›¸æ¯”äº C çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼ŒRedis çš„ SDS ä¸å…‰å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®è¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º O(1)ï¼ˆC å­—ç¬¦ä¸²ä¸º O(N)ï¼‰,é™¤æ­¤ä¹‹å¤–ï¼ŒRedis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `set,get,strlen,exists,decr,incr,setex` ç­‰ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯ï¼š** ä¸€èˆ¬å¸¸ç”¨åœ¨éœ€è¦è®¡æ•°çš„åœºæ™¯ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è®¿é—®æ¬¡æ•°ã€çƒ­ç‚¹æ–‡ç« çš„ç‚¹èµè½¬å‘æ•°é‡ç­‰ç­‰ã€‚

ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„ä½¿ç”¨ï¼

**æ™®é€šå­—ç¬¦ä¸²çš„åŸºæœ¬æ“ä½œï¼š**

```
127.0.0.1:6379> set key value #è®¾ç½® key-value ç±»å‹çš„å€¼
OK
127.0.0.1:6379> get key # æ ¹æ® key è·å¾—å¯¹åº”çš„ value
"value"
127.0.0.1:6379> exists key  # åˆ¤æ–­æŸä¸ª key æ˜¯å¦å­˜åœ¨
(integer) 1
127.0.0.1:6379> strlen key # è¿”å› key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦ã€‚
(integer) 5
127.0.0.1:6379> del key # åˆ é™¤æŸä¸ª key å¯¹åº”çš„å€¼
(integer) 1
127.0.0.1:6379> get key
(nil)
```

**æ‰¹é‡è®¾ç½®** :

```
127.0.0.1:6379> mset key1 value1 key2 value2 # æ‰¹é‡è®¾ç½® key-value ç±»å‹çš„å€¼
OK
127.0.0.1:6379> mget key1 key2 # æ‰¹é‡è·å–å¤šä¸ª key å¯¹åº”çš„ value
1) "value1"
2) "value2"
```

**è®¡æ•°å™¨ï¼ˆå­—ç¬¦ä¸²çš„å†…å®¹ä¸ºæ•´æ•°çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼‰ï¼š**

```
127.0.0.1:6379> set number 1
OK
127.0.0.1:6379> incr number # å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€
(integer) 2
127.0.0.1:6379> get number
"2"
127.0.0.1:6379> decr number # å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€
(integer) 1
127.0.0.1:6379> get number
"1"
```

**è¿‡æœŸï¼ˆé»˜è®¤ä¸ºæ°¸ä¸è¿‡æœŸï¼‰**ï¼š

```
127.0.0.1:6379> expire key  60 # æ•°æ®åœ¨ 60s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex key 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[set] + [ex]pire)
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56
```

####  list

1. **ä»‹ç»** ï¼š**list** å³æ˜¯ **é“¾è¡¨**ã€‚é“¾è¡¨æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œç‰¹ç‚¹æ˜¯æ˜“äºæ•°æ®å…ƒç´ çš„æ’å…¥å’Œåˆ é™¤å¹¶ä¸”å¯ä»¥çµæ´»è°ƒæ•´é“¾è¡¨é•¿åº¦ï¼Œä½†æ˜¯é“¾è¡¨çš„éšæœºè®¿é—®å›°éš¾ã€‚è®¸å¤šé«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½å†…ç½®äº†é“¾è¡¨çš„å®ç°æ¯”å¦‚ Java ä¸­çš„ **LinkedList**ï¼Œä½†æ˜¯ C è¯­è¨€å¹¶æ²¡æœ‰å®ç°é“¾è¡¨ï¼Œæ‰€ä»¥ Redis å®ç°äº†è‡ªå·±çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚Redis çš„ list çš„å®ç°ä¸ºä¸€ä¸ª **åŒå‘é“¾è¡¨**ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚
2. **å¸¸ç”¨å‘½ä»¤:** `rpush,lpop,lpush,rpop,lrange,llen` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** å‘å¸ƒä¸è®¢é˜…æˆ–è€…è¯´æ¶ˆæ¯é˜Ÿåˆ—ã€æ…¢æŸ¥è¯¢ã€‚

ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„ä½¿ç”¨ï¼

**é€šè¿‡ `rpush/lpop` å®ç°é˜Ÿåˆ—ï¼š**

```
127.0.0.1:6379> rpush myList value1 # å‘ list çš„å¤´éƒ¨ï¼ˆå³è¾¹ï¼‰æ·»åŠ å…ƒç´ 
(integer) 1
127.0.0.1:6379> rpush myList value2 value3 # å‘listçš„å¤´éƒ¨ï¼ˆæœ€å³è¾¹ï¼‰æ·»åŠ å¤šä¸ªå…ƒç´ 
(integer) 3
127.0.0.1:6379> lpop myList # å°† listçš„å°¾éƒ¨(æœ€å·¦è¾¹)å…ƒç´ å–å‡º
"value1"
127.0.0.1:6379> lrange myList 0 1 # æŸ¥çœ‹å¯¹åº”ä¸‹æ ‡çš„liståˆ—è¡¨ï¼Œ 0 ä¸º start,1ä¸º end
1) "value2"
2) "value3"
127.0.0.1:6379> lrange myList 0 -1 # æŸ¥çœ‹åˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œ-1è¡¨ç¤ºå€’æ•°ç¬¬ä¸€
1) "value2"
2) "value3"
```

**é€šè¿‡ `rpush/rpop` å®ç°æ ˆï¼š**

```
127.0.0.1:6379> rpush myList2 value1 value2 value3
(integer) 3
127.0.0.1:6379> rpop myList2 # å°† listçš„å¤´éƒ¨(æœ€å³è¾¹)å…ƒç´ å–å‡º
"value3"
```

æˆ‘ä¸“é—¨èŠ±äº†ä¸€ä¸ªå›¾æ–¹ä¾¿å°ä¼™ä¼´ä»¬æ¥ç†è§£ï¼š

![redis-list.png](./images/redis-list.png)

**é€šè¿‡ `lrange` æŸ¥çœ‹å¯¹åº”ä¸‹æ ‡èŒƒå›´çš„åˆ—è¡¨å…ƒç´ ï¼š**

```
127.0.0.1:6379> rpush myList value1 value2 value3
(integer) 3
127.0.0.1:6379> lrange myList 0 1 # æŸ¥çœ‹å¯¹åº”ä¸‹æ ‡çš„liståˆ—è¡¨ï¼Œ 0 ä¸º start,1ä¸º end
1) "value1"
2) "value2"
127.0.0.1:6379> lrange myList 0 -1 # æŸ¥çœ‹åˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œ-1è¡¨ç¤ºå€’æ•°ç¬¬ä¸€
1) "value1"
2) "value2"
3) "value3"
```

é€šè¿‡ `lrange` å‘½ä»¤ï¼Œä½ å¯ä»¥åŸºäº list å®ç°åˆ†é¡µæŸ¥è¯¢ï¼Œæ€§èƒ½éå¸¸é«˜ï¼

**é€šè¿‡ `llen` æŸ¥çœ‹é“¾è¡¨é•¿åº¦ï¼š**

```
127.0.0.1:6379> llen myList
(integer) 3
```

####  hash

1. **ä»‹ç»** ï¼šhash ç±»ä¼¼äº JDK1.8 å‰çš„ HashMapï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤š(æ•°ç»„ + é“¾è¡¨)ã€‚ä¸è¿‡ï¼ŒRedis çš„ hash åšäº†æ›´å¤šä¼˜åŒ–ã€‚å¦å¤–ï¼Œhash æ˜¯ä¸€ä¸ª string ç±»å‹çš„ field å’Œ value çš„æ˜ å°„è¡¨ï¼Œ**ç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡**ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä»…ä»…ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå­—æ®µçš„å€¼ã€‚ æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ hash æ•°æ®ç»“æ„æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œå•†å“ä¿¡æ¯ç­‰ç­‰ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `hset,hmset,hexists,hget,hgetall,hkeys,hvals` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** ç³»ç»Ÿä¸­å¯¹è±¡æ•°æ®çš„å­˜å‚¨ã€‚

ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„ä½¿ç”¨ï¼

```
127.0.0.1:6379> hmset userInfoKey name "guide" description "dev" age "24"
OK
127.0.0.1:6379> hexists userInfoKey name # æŸ¥çœ‹ key å¯¹åº”çš„ valueä¸­æŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨ã€‚
(integer) 1
127.0.0.1:6379> hget userInfoKey name # è·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼ã€‚
"guide"
127.0.0.1:6379> hget userInfoKey age
"24"
127.0.0.1:6379> hgetall userInfoKey # è·å–åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®š key çš„æ‰€æœ‰å­—æ®µå’Œå€¼
1) "name"
2) "guide"
3) "description"
4) "dev"
5) "age"
6) "24"
127.0.0.1:6379> hkeys userInfoKey # è·å– key åˆ—è¡¨
1) "name"
2) "description"
3) "age"
127.0.0.1:6379> hvals userInfoKey # è·å– value åˆ—è¡¨
1) "guide"
2) "dev"
3) "24"
127.0.0.1:6379> hset userInfoKey name "GuideGeGe" # ä¿®æ”¹æŸä¸ªå­—æ®µå¯¹åº”çš„å€¼
127.0.0.1:6379> hget userInfoKey name
"GuideGeGe"
```

####  set

1. **ä»‹ç» ï¼š** set ç±»ä¼¼äº Java ä¸­çš„ `HashSet` ã€‚Redis ä¸­çš„ set ç±»å‹æ˜¯ä¸€ç§æ— åºé›†åˆï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºã€‚å½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼Œset æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” set æä¾›äº†åˆ¤æ–­æŸä¸ªæˆå‘˜æ˜¯å¦åœ¨ä¸€ä¸ª set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ list æ‰€ä¸èƒ½æä¾›çš„ã€‚å¯ä»¥åŸºäº set è½»æ˜“å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œã€‚æ¯”å¦‚ï¼šä½ å¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚Redis å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒç²‰ä¸ã€å…±åŒå–œå¥½ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æ±‚äº¤é›†çš„è¿‡ç¨‹ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `sadd,spop,smembers,sismember,scard,sinterstore,sunion` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** éœ€è¦å­˜æ”¾çš„æ•°æ®ä¸èƒ½é‡å¤ä»¥åŠéœ€è¦è·å–å¤šä¸ªæ•°æ®æºäº¤é›†å’Œå¹¶é›†ç­‰åœºæ™¯

ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„ä½¿ç”¨ï¼

```
127.0.0.1:6379> sadd mySet value1 value2 # æ·»åŠ å…ƒç´ è¿›å»
(integer) 2
127.0.0.1:6379> sadd mySet value1 # ä¸å…è®¸æœ‰é‡å¤å…ƒç´ 
(integer) 0
127.0.0.1:6379> smembers mySet # æŸ¥çœ‹ set ä¸­æ‰€æœ‰çš„å…ƒç´ 
1) "value1"
2) "value2"
127.0.0.1:6379> scard mySet # æŸ¥çœ‹ set çš„é•¿åº¦
(integer) 2
127.0.0.1:6379> sismember mySet value1 # æ£€æŸ¥æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨set ä¸­ï¼Œåªèƒ½æ¥æ”¶å•ä¸ªå…ƒç´ 
(integer) 1
127.0.0.1:6379> sadd mySet2 value2 value3
(integer) 2
127.0.0.1:6379> sinterstore mySet3 mySet mySet2 # è·å– mySet å’Œ mySet2 çš„äº¤é›†å¹¶å­˜æ”¾åœ¨ mySet3 ä¸­
(integer) 1
127.0.0.1:6379> smembers mySet3
1) "value2"
```

####  sorted set

1. **ä»‹ç»ï¼š** å’Œ set ç›¸æ¯”ï¼Œsorted set å¢åŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œè¿˜å¯ä»¥é€šè¿‡ score çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ HashMap å’Œ TreeSet çš„ç»“åˆä½“ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `zadd,zcard,zscore,zrange,zrevrange,zrem` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯ï¼š** éœ€è¦å¯¹æ•°æ®æ ¹æ®æŸä¸ªæƒé‡è¿›è¡Œæ’åºçš„åœºæ™¯ã€‚æ¯”å¦‚åœ¨ç›´æ’­ç³»ç»Ÿä¸­ï¼Œå®æ—¶æ’è¡Œä¿¡æ¯åŒ…å«ç›´æ’­é—´åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œå„ç§ç¤¼ç‰©æ’è¡Œæ¦œï¼Œå¼¹å¹•æ¶ˆæ¯ï¼ˆå¯ä»¥ç†è§£ä¸ºæŒ‰æ¶ˆæ¯ç»´åº¦çš„æ¶ˆæ¯æ’è¡Œæ¦œï¼‰ç­‰ä¿¡æ¯ã€‚

```
127.0.0.1:6379> zadd myZset 3.0 value1 # æ·»åŠ å…ƒç´ åˆ° sorted set ä¸­ 3.0 ä¸ºæƒé‡
(integer) 1
127.0.0.1:6379> zadd myZset 2.0 value2 1.0 value3 # ä¸€æ¬¡æ·»åŠ å¤šä¸ªå…ƒç´ 
(integer) 2
127.0.0.1:6379> zcard myZset # æŸ¥çœ‹ sorted set ä¸­çš„å…ƒç´ æ•°é‡
(integer) 3
127.0.0.1:6379> zscore myZset value1 # æŸ¥çœ‹æŸä¸ª value çš„æƒé‡
"3"
127.0.0.1:6379> zrange  myZset 0 -1 # é¡ºåºè¾“å‡ºæŸä¸ªèŒƒå›´åŒºé—´çš„å…ƒç´ ï¼Œ0 -1 è¡¨ç¤ºè¾“å‡ºæ‰€æœ‰å…ƒç´ 
1) "value3"
2) "value2"
3) "value1"
127.0.0.1:6379> zrange  myZset 0 1 # é¡ºåºè¾“å‡ºæŸä¸ªèŒƒå›´åŒºé—´çš„å…ƒç´ ï¼Œ0 ä¸º start  1 ä¸º stop
1) "value3"
2) "value2"
127.0.0.1:6379> zrevrange  myZset 0 1 # é€†åºè¾“å‡ºæŸä¸ªèŒƒå›´åŒºé—´çš„å…ƒç´ ï¼Œ0 ä¸º start  1 ä¸º stop
1) "value1"
2) "value2"
```

####  bitmap

1. **ä»‹ç»ï¼š** bitmap å­˜å‚¨çš„æ˜¯è¿ç»­çš„äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰ï¼Œé€šè¿‡ bitmap, åªéœ€è¦ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œkey å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº« ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `setbit` ã€`getbit` ã€`bitcount`ã€`bitop`
3. **åº”ç”¨åœºæ™¯ï¼š** é€‚åˆéœ€è¦ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼ˆæ¯”å¦‚æ˜¯å¦ç­¾åˆ°ã€æ˜¯å¦ç™»å½•...ï¼‰å¹¶éœ€è¦è¿›ä¸€æ­¥å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œåˆ†æçš„åœºæ™¯ã€‚æ¯”å¦‚ç”¨æˆ·ç­¾åˆ°æƒ…å†µã€æ´»è·ƒç”¨æˆ·æƒ…å†µã€ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ï¼ˆæ¯”å¦‚æ˜¯å¦ç‚¹èµè¿‡æŸä¸ªè§†é¢‘ï¼‰ã€‚

```
# SETBIT ä¼šè¿”å›ä¹‹å‰ä½çš„å€¼ï¼ˆé»˜è®¤æ˜¯ 0ï¼‰è¿™é‡Œä¼šç”Ÿæˆ 7 ä¸ªä½
127.0.0.1:6379> setbit mykey 7 1
(integer) 0
127.0.0.1:6379> setbit mykey 7 0
(integer) 1
127.0.0.1:6379> getbit mykey 7
(integer) 0
127.0.0.1:6379> setbit mykey 6 1
(integer) 0
127.0.0.1:6379> setbit mykey 8 1
(integer) 0
# é€šè¿‡ bitcount ç»Ÿè®¡è¢«è¢«è®¾ç½®ä¸º 1 çš„ä½çš„æ•°é‡ã€‚
127.0.0.1:6379> bitcount mykey
(integer) 2
```

#### ä½¿ç”¨åœºæ™¯è¯´æ˜

**ä½¿ç”¨åœºæ™¯ä¸€ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ** å¾ˆå¤šç½‘ç«™ä¸ºäº†åˆ†æä½ çš„å–œå¥½ï¼Œéœ€è¦ç ”ç©¶ä½ ç‚¹èµè¿‡çš„å†…å®¹ã€‚

```
# è®°å½•ä½ å–œæ¬¢è¿‡ 001 å·å°å§å§
127.0.0.1:6379> setbit beauty_girl_001 uid 1
```

**ä½¿ç”¨åœºæ™¯äºŒï¼šç»Ÿè®¡æ´»è·ƒç”¨æˆ·**

ä½¿ç”¨æ—¶é—´ä½œä¸º keyï¼Œç„¶åç”¨æˆ· ID ä¸º offsetï¼Œå¦‚æœå½“æ—¥æ´»è·ƒè¿‡å°±è®¾ç½®ä¸º 1

é‚£ä¹ˆæˆ‘è¯¥å¦‚ä½•è®¡ç®—æŸå‡ å¤©/æœˆ/å¹´çš„æ´»è·ƒç”¨æˆ·å‘¢(æš‚ä¸”çº¦å®šï¼Œç»Ÿè®¡æ—¶é—´å†…åªè¦æœ‰ä¸€å¤©åœ¨çº¿å°±ç§°ä¸ºæ´»è·ƒ)ï¼Œæœ‰è¯·ä¸‹ä¸€ä¸ª redis çš„å‘½ä»¤

```
# å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªä¿å­˜äºŒè¿›åˆ¶ä½çš„å­—ç¬¦ä¸² key è¿›è¡Œä½å…ƒæ“ä½œï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ° destkey ä¸Šã€‚
# BITOP å‘½ä»¤æ”¯æŒ AND ã€ OR ã€ NOT ã€ XOR è¿™å››ç§æ“ä½œä¸­çš„ä»»æ„ä¸€ç§å‚æ•°
BITOP operation destkey key [key ...]
```

åˆå§‹åŒ–æ•°æ®ï¼š

```
127.0.0.1:6379> setbit 20210308 1 1
(integer) 0
127.0.0.1:6379> setbit 20210308 2 1
(integer) 0
127.0.0.1:6379> setbit 20210309 1 1
(integer) 0
```

ç»Ÿè®¡ 20210308~20210309 æ€»æ´»è·ƒç”¨æˆ·æ•°: 1

```
127.0.0.1:6379> bitop and desk1 20210308 20210309
(integer) 1
127.0.0.1:6379> bitcount desk1
(integer) 1
```

ç»Ÿè®¡ 20210308~20210309 åœ¨çº¿æ´»è·ƒç”¨æˆ·æ•°: 2

```
127.0.0.1:6379> bitop or desk2 20210308 20210309
(integer) 1
127.0.0.1:6379> bitcount desk2
(integer) 2
```

**ä½¿ç”¨åœºæ™¯ä¸‰ï¼šç”¨æˆ·åœ¨çº¿çŠ¶æ€**

å¯¹äºè·å–æˆ–è€…ç»Ÿè®¡ç”¨æˆ·åœ¨çº¿çŠ¶æ€ï¼Œä½¿ç”¨ bitmap æ˜¯ä¸€ä¸ªèŠ‚çº¦ç©ºé—´ä¸”æ•ˆç‡åˆé«˜çš„ä¸€ç§æ–¹æ³•ã€‚

åªéœ€è¦ä¸€ä¸ª keyï¼Œç„¶åç”¨æˆ· ID ä¸º offsetï¼Œå¦‚æœåœ¨çº¿å°±è®¾ç½®ä¸º 1ï¼Œä¸åœ¨çº¿å°±è®¾ç½®ä¸º 0ã€‚

### 5.5.8  Redis å•çº¿ç¨‹æ¨¡å‹è¯¦è§£

**Redis åŸºäº Reactor æ¨¡å¼æ¥è®¾è®¡å¼€å‘äº†è‡ªå·±çš„ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹** ï¼ˆNetty çš„çº¿ç¨‹æ¨¡å‹ä¹ŸåŸºäº Reactor æ¨¡å¼ï¼ŒReactor æ¨¡å¼ä¸æ„§æ˜¯é«˜æ€§èƒ½ IO çš„åŸºçŸ³ï¼‰ï¼Œè¿™å¥—äº‹ä»¶å¤„ç†æ¨¡å‹å¯¹åº”çš„æ˜¯ Redis ä¸­çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚

**æ—¢ç„¶æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ**

Redis é€šè¿‡**IO å¤šè·¯å¤ç”¨ç¨‹åº** æ¥ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼ˆæˆ–è€…è¯´æ˜¯ç›‘å¬å¤šä¸ª socketï¼‰ï¼Œå®ƒä¼šå°†æ„Ÿå…´è¶£çš„äº‹ä»¶åŠç±»å‹ï¼ˆè¯»ã€å†™ï¼‰æ³¨å†Œåˆ°å†…æ ¸ä¸­å¹¶ç›‘å¬æ¯ä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚

è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š **I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä½¿ç”¨è®© Redis ä¸éœ€è¦é¢å¤–åˆ›å»ºå¤šä½™çš„çº¿ç¨‹æ¥ç›‘å¬å®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼Œé™ä½äº†èµ„æºçš„æ¶ˆè€—**ï¼ˆå’Œ NIO ä¸­çš„ `Selector` ç»„ä»¶å¾ˆåƒï¼‰ã€‚

å¦å¤–ï¼Œ Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä¸¤ç±»äº‹ä»¶ï¼š1. æ–‡ä»¶äº‹ä»¶; 2. æ—¶é—´äº‹ä»¶ã€‚

æ—¶é—´äº‹ä»¶ä¸éœ€è¦å¤šèŠ±æ—¶é—´äº†è§£ï¼Œæˆ‘ä»¬æ¥è§¦æœ€å¤šçš„è¿˜æ˜¯ **æ–‡ä»¶äº‹ä»¶**ï¼ˆå®¢æˆ·ç«¯è¿›è¡Œè¯»å–å†™å…¥ç­‰æ“ä½œï¼Œæ¶‰åŠä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡ï¼‰ã€‚

ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æœ‰ä¸€æ®µè¯æ˜¯å¦‚æ˜¯ä»‹ç»æ–‡ä»¶äº‹ä»¶çš„ï¼Œæˆ‘è§‰å¾—å†™å¾—æŒºä¸é”™ã€‚

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
>
> å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> **è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—**ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

å¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- å¤šä¸ª socketï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰
- IO å¤šè·¯å¤ç”¨ç¨‹åºï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† socket å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰

![redisäº‹ä»¶å¤„ç†å™¨.png](./images/redisäº‹ä»¶å¤„ç†å™¨.png)

### 5.5.9 Redis æ²¡æœ‰ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

è™½ç„¶è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œ**Redis åœ¨ 4.0 ä¹‹åçš„ç‰ˆæœ¬ä¸­å°±å·²ç»åŠ å…¥äº†å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒã€‚**

![redis4.0-more-thread.png](./images/redis4.0-more-thread.png)

ä¸è¿‡ï¼ŒRedis 4.0 å¢åŠ çš„å¤šçº¿ç¨‹ä¸»è¦æ˜¯é’ˆå¯¹ä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œçš„å‘½ä»¤ï¼Œä½¿ç”¨è¿™äº›å‘½ä»¤å°±ä¼šä½¿ç”¨ä¸»å¤„ç†ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹æ¥â€œå¼‚æ­¥å¤„ç†â€ã€‚

å¤§ä½“ä¸Šæ¥è¯´ï¼Œ**Redis 6.0 ä¹‹å‰ä¸»è¦è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ã€‚**

**é‚£ï¼ŒRedis6.0 ä¹‹å‰ ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ**

ç¬”è€…è§‰å¾—ä¸»è¦åŸå› æœ‰ä¸‹é¢ 3 ä¸ªï¼š

1. å•çº¿ç¨‹ç¼–ç¨‹å®¹æ˜“å¹¶ä¸”æ›´å®¹æ˜“ç»´æŠ¤ï¼›
2. Redis çš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPU ï¼Œä¸»è¦åœ¨å†…å­˜å’Œç½‘ç»œï¼›
3. å¤šçº¿ç¨‹å°±ä¼šå­˜åœ¨æ­»é”ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰é—®é¢˜ï¼Œç”šè‡³ä¼šå½±å“æ€§èƒ½ã€‚

### 5.5.10  Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ

**Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½**ï¼Œå› ä¸ºè¿™ä¸ªç®—æ˜¯ Redis ä¸­çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ã€‚

è™½ç„¶ï¼ŒRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ Redis çš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šä½¿ç”¨äº†ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚å› æ­¤ï¼Œä½ ä¹Ÿä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` ï¼š

```
io-threads-do-reads yes
```

å¼€å¯å¤šçº¿ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦åˆ™æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚åŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` :

```
io-threads 4 #å®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹
```

æ¨èé˜…è¯»ï¼š

1. [Redis 6.0 æ–°ç‰¹æ€§-å¤šçº¿ç¨‹è¿ç¯ 13 é—®ï¼](https://mp.weixin.qq.com/s/FZu3acwK6zrCBZQ_3HoUgw)
2. [ä¸ºä»€ä¹ˆ Redis é€‰æ‹©å•çº¿ç¨‹æ¨¡å‹](https://draveness.me/whys-the-design-redis-single-thread/)

###  5.5.11 Redis ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´æœ‰å•¥ç”¨ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®ä¿å­˜çš„ç¼“å­˜æ•°æ®çš„æ—¶å€™éƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸€ç›´ä¿å­˜çš„è¯ï¼Œåˆ†åˆ†é’Ÿç›´æ¥ Out of memoryã€‚

Redis è‡ªå¸¦äº†ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

```
127.0.0.1:6379> exp key 60 # æ•°æ®åœ¨ 60s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex key 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[set] + [ex]pire)
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56
```

æ³¨æ„ï¼š**Redis ä¸­é™¤äº†å­—ç¬¦ä¸²ç±»å‹æœ‰è‡ªå·±ç‹¬æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ `setex` å¤–ï¼Œå…¶ä»–æ–¹æ³•éƒ½éœ€è¦ä¾é  `expire` å‘½ä»¤æ¥è®¾ç½®è¿‡æœŸæ—¶é—´ ã€‚å¦å¤–ï¼Œ `persist` å‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´ã€‚ **

**è¿‡æœŸæ—¶é—´é™¤äº†æœ‰åŠ©äºç¼“è§£å†…å­˜çš„æ¶ˆè€—ï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–ç”¨ä¹ˆï¼Ÿ**

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯éœ€è¦æŸä¸ªæ•°æ®åªåœ¨æŸä¸€æ—¶é—´æ®µå†…å­˜åœ¨ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„çŸ­ä¿¡éªŒè¯ç å¯èƒ½åªåœ¨ 1 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œç”¨æˆ·ç™»å½•çš„ token å¯èƒ½åªåœ¨ 1 å¤©å†…æœ‰æ•ˆã€‚

å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“æ¥å¤„ç†çš„è¯ï¼Œä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åˆ¤æ–­è¿‡æœŸï¼Œè¿™æ ·æ›´éº»çƒ¦å¹¶ä¸”æ€§èƒ½è¦å·®å¾ˆå¤šã€‚

###  5.5.12 Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿ

Redis é€šè¿‡ä¸€ä¸ªå«åšè¿‡æœŸå­—å…¸ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ hash è¡¨ï¼‰æ¥ä¿å­˜æ•°æ®è¿‡æœŸçš„æ—¶é—´ã€‚è¿‡æœŸå­—å…¸çš„é”®æŒ‡å‘ Redis æ•°æ®åº“ä¸­çš„æŸä¸ª key(é”®)ï¼Œè¿‡æœŸå­—å…¸çš„å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼‰ã€‚

![redisè¿‡æœŸæ—¶é—´.png](./images/redisè¿‡æœŸæ—¶é—´.png)

è¿‡æœŸå­—å…¸æ˜¯å­˜å‚¨åœ¨ redisDb è¿™ä¸ªç»“æ„é‡Œçš„ï¼š

```
typedef struct redisDb {
    ...

    dict *dict;     //æ•°æ®åº“é”®ç©ºé—´,ä¿å­˜ç€æ•°æ®åº“ä¸­æ‰€æœ‰é”®å€¼å¯¹
    dict *expires   // è¿‡æœŸå­—å…¸,ä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´
    ...
}  redisDb;
```

### 5.5.13 æ·˜æ±°æœºåˆ¶ä¸æŒä¹…åŒ–æœºåˆ¶

####  è¿‡æœŸçš„æ•°æ®çš„åˆ é™¤ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

å¦‚æœå‡è®¾ä½ è®¾ç½®äº†ä¸€æ‰¹ key åªèƒ½å­˜æ´» 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆ 1 åˆ†é’Ÿåï¼ŒRedis æ˜¯æ€ä¹ˆå¯¹è¿™æ‰¹ key è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿ

å¸¸ç”¨çš„è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥å°±ä¸¤ä¸ªï¼ˆé‡è¦ï¼è‡ªå·±é€ ç¼“å­˜è½®å­çš„æ—¶å€™éœ€è¦æ ¼å¤–è€ƒè™‘çš„ä¸œè¥¿ï¼‰ï¼š

1. **æƒ°æ€§åˆ é™¤** ï¼šåªä¼šåœ¨å–å‡º key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™æ ·å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚
2. **å®šæœŸåˆ é™¤** ï¼š æ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤è¿‡æœŸ key æ“ä½œã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚

å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œæ‰€ä»¥ Redis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ã€‚

ä½†æ˜¯ï¼Œä»…ä»…é€šè¿‡ç»™ key è®¾ç½®è¿‡æœŸæ—¶é—´è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚å› ä¸ºè¿˜æ˜¯å¯èƒ½å­˜åœ¨å®šæœŸåˆ é™¤å’Œæƒ°æ€§åˆ é™¤æ¼æ‰äº†å¾ˆå¤šè¿‡æœŸ key çš„æƒ…å†µã€‚è¿™æ ·å°±å¯¼è‡´å¤§é‡è¿‡æœŸ key å †ç§¯åœ¨å†…å­˜é‡Œï¼Œç„¶åå°± Out of memory äº†ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ï¼š**Redis å†…å­˜æ·˜æ±°æœºåˆ¶**

####  Redis å†…å­˜æ·˜æ±°æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

> ç›¸å…³é—®é¢˜ï¼šMySQL é‡Œæœ‰ 2000w æ•°æ®ï¼ŒRedis ä¸­åªå­˜ 20w çš„æ•°æ®ï¼Œå¦‚ä½•ä¿è¯ Redis ä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®?

Redis æä¾› 6 ç§æ•°æ®æ·˜æ±°ç­–ç•¥ï¼š

1. **volatile-lruï¼ˆleast recently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
2. **volatile-ttl**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°
3. **volatile-random**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°
4. **allkeys-lruï¼ˆleast recently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰
5. **allkeys-random**ï¼šä»æ•°æ®é›†ï¼ˆserver.db[i].dictï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°
6. **no-eviction**ï¼šç¦æ­¢é©±é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚è¿™ä¸ªåº”è¯¥æ²¡äººä½¿ç”¨å§ï¼

4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š

1. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
2. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ key

#### Redis æŒä¹…åŒ–æœºåˆ¶(æ€ä¹ˆä¿è¯ Redis æŒ‚æ‰ä¹‹åå†é‡å¯æ•°æ®å¯ä»¥è¿›è¡Œæ¢å¤)

å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦æŒä¹…åŒ–æ•°æ®ä¹Ÿå°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå¤§éƒ¨åˆ†åŸå› æ˜¯ä¸ºäº†ä¹‹åé‡ç”¨æ•°æ®ï¼ˆæ¯”å¦‚é‡å¯æœºå™¨ã€æœºå™¨æ•…éšœä¹‹åæ¢å¤æ•°æ®ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸ºäº†é˜²æ­¢ç³»ç»Ÿæ•…éšœè€Œå°†æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªè¿œç¨‹ä½ç½®ã€‚

Redis ä¸åŒäº Memcached çš„å¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯ï¼ŒRedis æ”¯æŒæŒä¹…åŒ–ï¼Œè€Œä¸”æ”¯æŒä¸¤ç§ä¸åŒçš„æŒä¹…åŒ–æ“ä½œã€‚**Redis çš„ä¸€ç§æŒä¹…åŒ–æ–¹å¼å«å¿«ç…§ï¼ˆsnapshottingï¼ŒRDBï¼‰ï¼Œå¦ä¸€ç§æ–¹å¼æ˜¯åªè¿½åŠ æ–‡ä»¶ï¼ˆappend-only file, AOFï¼‰**ã€‚è¿™ä¸¤ç§æ–¹æ³•å„æœ‰åƒç§‹ï¼Œä¸‹é¢æˆ‘ä¼šè¯¦ç»†è¿™ä¸¤ç§æŒä¹…åŒ–æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆç”¨ï¼Œå¦‚ä½•é€‰æ‹©é€‚åˆè‡ªå·±çš„æŒä¹…åŒ–æ–¹æ³•ã€‚

**å¿«ç…§ï¼ˆsnapshottingï¼‰æŒä¹…åŒ–ï¼ˆRDBï¼‰**

Redis å¯ä»¥é€šè¿‡åˆ›å»ºå¿«ç…§æ¥è·å¾—å­˜å‚¨åœ¨å†…å­˜é‡Œé¢çš„æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„å‰¯æœ¬ã€‚Redis åˆ›å»ºå¿«ç…§ä¹‹åï¼Œå¯ä»¥å¯¹å¿«ç…§è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼ˆRedis ä¸»ä»ç»“æ„ï¼Œä¸»è¦ç”¨æ¥æé«˜ Redis æ€§èƒ½ï¼‰ï¼Œè¿˜å¯ä»¥å°†å¿«ç…§ç•™åœ¨åŸåœ°ä»¥ä¾¿é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨ã€‚

å¿«ç…§æŒä¹…åŒ–æ˜¯ Redis é»˜è®¤é‡‡ç”¨çš„æŒä¹…åŒ–æ–¹å¼ï¼Œåœ¨ Redis.conf é…ç½®æ–‡ä»¶ä¸­é»˜è®¤æœ‰æ­¤ä¸‹é…ç½®ï¼š

```
save 900 1           #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 300 10          #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 60 10000        #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚
```

**AOFï¼ˆappend-only fileï¼‰æŒä¹…åŒ–**

ä¸å¿«ç…§æŒä¹…åŒ–ç›¸æ¯”ï¼ŒAOF æŒä¹…åŒ–çš„å®æ—¶æ€§æ›´å¥½ï¼Œå› æ­¤å·²æˆä¸ºä¸»æµçš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚é»˜è®¤æƒ…å†µä¸‹ Redis æ²¡æœ‰å¼€å¯ AOFï¼ˆappend only fileï¼‰æ–¹å¼çš„æŒä¹…åŒ–ï¼Œå¯ä»¥é€šè¿‡ appendonly å‚æ•°å¼€å¯ï¼š

```
appendonly yes
```

å¼€å¯ AOF æŒä¹…åŒ–åæ¯æ‰§è¡Œä¸€æ¡ä¼šæ›´æ”¹ Redis ä¸­çš„æ•°æ®çš„å‘½ä»¤ï¼ŒRedis å°±ä¼šå°†è¯¥å‘½ä»¤å†™å…¥åˆ°å†…å­˜ç¼“å­˜ `server.aof_buf` ä¸­ï¼Œç„¶åå†æ ¹æ® `appendfsync` é…ç½®æ¥å†³å®šä½•æ—¶å°†å…¶åŒæ­¥åˆ°ç¡¬ç›˜ä¸­çš„ AOF æ–‡ä»¶ã€‚

AOF æ–‡ä»¶çš„ä¿å­˜ä½ç½®å’Œ RDB æ–‡ä»¶çš„ä½ç½®ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡ dir å‚æ•°è®¾ç½®çš„ï¼Œé»˜è®¤çš„æ–‡ä»¶åæ˜¯ `appendonly.aof`ã€‚

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

```
appendfsync always    #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶,è¿™æ ·ä¼šä¸¥é‡é™ä½Redisçš„é€Ÿåº¦
appendfsync everysec  #æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ˜¾ç¤ºåœ°å°†å¤šä¸ªå†™å‘½ä»¤åŒæ­¥åˆ°ç¡¬ç›˜
appendfsync no        #è®©æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥
```

ä¸ºäº†å…¼é¡¾æ•°æ®å’Œå†™å…¥æ€§èƒ½ï¼Œç”¨æˆ·å¯ä»¥è€ƒè™‘ `appendfsync everysec` é€‰é¡¹ ï¼Œè®© Redis æ¯ç§’åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶ï¼ŒRedis æ€§èƒ½å‡ ä¹æ²¡å—åˆ°ä»»ä½•å½±å“ã€‚è€Œä¸”è¿™æ ·å³ä½¿å‡ºç°ç³»ç»Ÿå´©æºƒï¼Œç”¨æˆ·æœ€å¤šåªä¼šä¸¢å¤±ä¸€ç§’ä¹‹å†…äº§ç”Ÿçš„æ•°æ®ã€‚å½“ç¡¬ç›˜å¿™äºæ‰§è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼ŒRedis è¿˜ä¼šä¼˜é›…çš„æ”¾æ…¢è‡ªå·±çš„é€Ÿåº¦ä»¥ä¾¿é€‚åº”ç¡¬ç›˜çš„æœ€å¤§å†™å…¥é€Ÿåº¦ã€‚

**ç›¸å…³ issue** ï¼š[783ï¼šRedis çš„ AOF æ–¹å¼](https://github.com/Snailclimb/JavaGuide/issues/783)

**æ‹“å±•ï¼šRedis 4.0 å¯¹äºæŒä¹…åŒ–æœºåˆ¶çš„ä¼˜åŒ–**

Redis 4.0 å¼€å§‹æ”¯æŒ RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼ˆé»˜è®¤å…³é—­ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `aof-use-rdb-preamble` å¼€å¯ï¼‰ã€‚

å¦‚æœæŠŠæ··åˆæŒä¹…åŒ–æ‰“å¼€ï¼ŒAOF é‡å†™çš„æ—¶å€™å°±ç›´æ¥æŠŠ RDB çš„å†…å®¹å†™åˆ° AOF æ–‡ä»¶å¼€å¤´ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹, å¿«é€ŸåŠ è½½åŒæ—¶é¿å…ä¸¢å¤±è¿‡å¤šçš„æ•°æ®ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œ AOF é‡Œé¢çš„ RDB éƒ¨åˆ†æ˜¯å‹ç¼©æ ¼å¼ä¸å†æ˜¯ AOF æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå·®ã€‚

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://redis.io/topics/persistence

![image-20210807145107290.png](./images/image-20210807145107290.png)

**è¡¥å……å†…å®¹ï¼šAOF é‡å†™**

AOF é‡å†™å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°ã€‚

**<u>AOF é‡å†™æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„åå­—</u>**ï¼Œè¯¥åŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥å®ç°çš„ï¼Œç¨‹åºæ— é¡»å¯¹ç°æœ‰ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å…¥ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œã€‚

åœ¨æ‰§è¡Œ BGREWRITEAOF å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–° AOF æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF æ–‡ä»¶é‡å†™æ“ä½œã€‚

### 5.5.14 Rediså®ç°åˆ†å¸ƒå¼é”ä½ äº†è§£è¿‡å—ï¼Ÿï¼ˆå¸¸è§ï¼‰ä¸ºä»€ä¹ˆé‡‡ç”¨setnxèƒ½å®ç°åˆ†å¸ƒå¼é”ã€‚

### Qï¼šå¸¸è§é—®é¢˜

#### 5.5.1 redisçš„åŸºæœ¬æ•°æ®ç±»å‹

#### 5.5.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨redis

#### 5.5.3 æ€ä¹ˆæ ·èƒ½ç¡®ä¿ç¼“å­˜ä¸­æ•°æ®å’Œä¸»å­˜ä¸­æ•°æ®çš„ä¸€è‡´æ€§?

#### 5.5.4 redisé€Ÿåº¦ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«

#### 5.5.5 ç¼“å­˜ç©¿é€ï¼Œ ç¼“å­˜å‡»ç©¿ï¼Œ ç¼“å­˜é›ªå´©åŸºæœ¬æ¦‚å¿µåŠè§£å†³æ–¹æ¡ˆ

#### 5.5.6 [redis](https://www.nowcoder.com/jump/super-jump/word?word=redis)å“¨å…µé›†ç¾¤ç›¸å…³é—®é¢˜ï¼ˆæ€ä¹ˆä¸»ä»åŒæ­¥ï¼Œæ€ä¹ˆå“¨å…µé€‰ä¸¾ï¼Œ æ€ä¹ˆmasteré€‰ä¸¾ï¼‰

#### 5.5.7 åº•å±‚è·³è¡¨







# 6.Android

## 6.1 å®‰å“çš„å››å¤§æ§ä»¶

- Activityï¼šæè¿°UIï¼Œå¹¶ä¸”å¤„ç†ç”¨æˆ·ä¸æœºå™¨å±å¹•çš„äº¤äº’ã€‚
- Services:  å¤„ç†ä¸åº”ç”¨ç¨‹åºå…³è”çš„åå°æ“ä½œã€‚
- Broadcast Receiversï¼šå¤„ç†Androidæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¹‹é—´çš„é€šä¿¡ã€‚
- Content Providersï¼šå¤„ç†æ•°æ®å’Œæ•°æ®åº“ç®¡ç†æ–¹é¢çš„é—®é¢˜ã€‚

## 6.2 å®‰å“å…¶å®ƒçš„æ§ä»¶

æœ‰ä¸€äº›é™„ä»¶çš„ç»„ä»¶ç”¨äºä»¥ä¸Šæåˆ°çš„å®ä½“ã€ä»–ä»¬ä¹‹é—´é€»è¾‘ã€åŠä»–ä»¬ä¹‹é—´è¿çº¿çš„æ„é€ ã€‚è¿™äº›ç»„ä»¶å¦‚ä¸‹ï¼š

| ç»„ä»¶      | æè¿°                                             |
| :-------- | :----------------------------------------------- |
| Fragments | ä»£è¡¨æ´»åŠ¨ä¸­çš„ä¸€ä¸ªè¡Œä¸ºæˆ–è€…ä¸€éƒ¨åˆ†ç”¨æˆ·ç•Œé¢ã€‚         |
| Views     | ç»˜åˆ¶åœ¨å±å¹•ä¸Šçš„UIå…ƒç´ ï¼ŒåŒ…æ‹¬æŒ‰é’®ï¼Œåˆ—è¡¨ç­‰ã€‚         |
| Layouts   | æ§åˆ¶å±å¹•æ ¼å¼ï¼Œå±•ç¤ºè§†å›¾å¤–è§‚çš„Viewçš„ç»§æ‰¿ã€‚         |
| Intents   | ç»„ä»¶é—´çš„æ¶ˆæ¯è¿çº¿ã€‚                               |
| Resources | å¤–éƒ¨å…ƒç´ ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²èµ„æºã€å¸¸é‡èµ„æºåŠå›¾ç‰‡èµ„æºç­‰ã€‚ |
| Manifest  | åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ã€‚                             |

## 6.3 Activityçš„ç”Ÿå‘½å‘¨æœŸ

- onCreat åˆ›å»º
- onStart å¼€å§‹
- onResume æ¢å¤
- onPause æš‚åœ
- onStop åœæ­¢
- onDestroy é”€æ¯

![activity.jpg](./images/activity.jpg)

| onCreate()  | è¿™æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒï¼Œåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶è°ƒç”¨                       |
| ----------- | ------------------------------------------------------------ |
| onStart()   | è¿™ä¸ªå›è°ƒåœ¨æ´»åŠ¨ä¸ºç”¨æˆ·å¯è§æ—¶è¢«è°ƒç”¨                             |
| onResume()  | è¿™ä¸ªå›è°ƒåœ¨åº”ç”¨ç¨‹åºä¸ç”¨æˆ·å¼€å§‹å¯äº¤äº’çš„æ—¶å€™è°ƒç”¨                 |
| onPause()   | è¢«æš‚åœçš„æ´»åŠ¨æ— æ³•æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä¸èƒ½æ‰§è¡Œä»»ä½•ä»£ç ã€‚å½“å‰æ´»åŠ¨å°†è¦è¢«æš‚åœï¼Œä¸Šä¸€ä¸ªæ´»åŠ¨å°†è¦è¢«æ¢å¤æ—¶è°ƒç”¨ |
| onStop()    | å½“æ´»åŠ¨ä¸åœ¨å¯è§æ—¶è°ƒç”¨                                         |
| onDestroy() | å½“æ´»åŠ¨è¢«ç³»ç»Ÿé”€æ¯ä¹‹å‰è°ƒç”¨                                     |
| onRestart() | å½“æ´»åŠ¨è¢«åœæ­¢ä»¥åé‡æ–°æ‰“å¼€æ—¶è°ƒç”¨                               |

åªæœ‰ä¸»çº¿ç¨‹æ‰å¯ä»¥æ›´æ–°ç”¨æˆ·çš„ç•Œé¢

## 6.4 Service

æœåŠ¡æ˜¯ä¸€ä¸ªåå°è¿è¡Œçš„ç»„ä»¶ï¼Œæ‰§è¡Œé•¿æ—¶é—´è¿è¡Œä¸”ä¸éœ€è¦ç”¨æˆ·äº¤äº’çš„ä»»åŠ¡ã€‚å³ä½¿åº”ç”¨è¢«é”€æ¯ä¹Ÿä¾ç„¶å¯ä»¥å·¥ä½œã€‚æœåŠ¡åŸºæœ¬ä¸ŠåŒ…å«ä¸¤ç§çŠ¶æ€ -

| çŠ¶æ€    | æè¿°                                                         |
| :------ | :----------------------------------------------------------- |
| Started | Androidçš„åº”ç”¨ç¨‹åºç»„ä»¶ï¼Œå¦‚æ´»åŠ¨ï¼Œé€šè¿‡startService()å¯åŠ¨äº†æœåŠ¡ï¼Œåˆ™æœåŠ¡æ˜¯StartedçŠ¶æ€ã€‚ä¸€æ—¦å¯åŠ¨ï¼ŒæœåŠ¡å¯ä»¥åœ¨åå°æ— é™æœŸè¿è¡Œï¼Œå³ä½¿å¯åŠ¨å®ƒçš„ç»„ä»¶å·²ç»è¢«é”€æ¯ã€‚ |
| Bound   | å½“Androidçš„åº”ç”¨ç¨‹åºç»„ä»¶é€šè¿‡bindService()ç»‘å®šäº†æœåŠ¡ï¼Œåˆ™æœåŠ¡æ˜¯BoundçŠ¶æ€ã€‚BoundçŠ¶æ€çš„æœåŠ¡æä¾›äº†ä¸€ä¸ªå®¢æˆ·æœåŠ¡å™¨æ¥å£æ¥å…è®¸ç»„ä»¶ä¸æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¦‚å‘é€è¯·æ±‚ï¼Œè·å–ç»“æœï¼Œç”šè‡³é€šè¿‡IPCæ¥è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚ |



 ![services.jpg](./images/services.jpg)



| å›è°ƒ             | æè¿°                                                         |
| :--------------- | :----------------------------------------------------------- |
| onStartCommand() | å…¶ä»–ç»„ä»¶(å¦‚æ´»åŠ¨)é€šè¿‡è°ƒç”¨startService()æ¥è¯·æ±‚å¯åŠ¨æœåŠ¡æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚å¦‚æœä½ å®ç°è¯¥æ–¹æ³•ï¼Œä½ æœ‰è´£ä»»åœ¨å·¥ä½œå®Œæˆæ—¶é€šè¿‡stopSelf()æˆ–è€…stopService()æ–¹æ³•æ¥åœæ­¢æœåŠ¡ã€‚ |
| onBind           | å½“å…¶ä»–ç»„ä»¶æƒ³è¦é€šè¿‡bindService()æ¥ç»‘å®šæœåŠ¡æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚å¦‚æœä½ å®ç°è¯¥æ–¹æ³•ï¼Œä½ éœ€è¦è¿”å›IBinderå¯¹è±¡æ¥æä¾›ä¸€ä¸ªæ¥å£ï¼Œä»¥ä¾¿å®¢æˆ·æ¥ä¸æœåŠ¡é€šä¿¡ã€‚ä½ å¿…é¡»å®ç°è¯¥æ–¹æ³•ï¼Œå¦‚æœä½ ä¸å…è®¸ç»‘å®šï¼Œåˆ™ç›´æ¥è¿”å›nullã€‚ |
| onUnbind()       | å½“å®¢æˆ·ä¸­æ–­æ‰€æœ‰æœåŠ¡å‘å¸ƒçš„ç‰¹æ®Šæ¥å£æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚         |
| onRebind()       | å½“æ–°çš„å®¢æˆ·ç«¯ä¸æœåŠ¡è¿æ¥ï¼Œä¸”æ­¤å‰å®ƒå·²ç»é€šè¿‡onUnbind(Intent)é€šçŸ¥æ–­å¼€è¿æ¥æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚ |
| onCreate()       | å½“æœåŠ¡é€šè¿‡onStartCommand()å’ŒonBind()è¢«ç¬¬ä¸€æ¬¡åˆ›å»ºçš„æ—¶å€™ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚è¯¥è°ƒç”¨è¦æ±‚æ‰§è¡Œä¸€æ¬¡æ€§å®‰è£…ã€‚ |
| onDestroy()      | å½“æœåŠ¡ä¸å†æœ‰ç”¨æˆ–è€…è¢«é”€æ¯æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚ä½ çš„æœåŠ¡éœ€è¦å®ç°è¯¥æ–¹æ³•æ¥æ¸…ç†ä»»ä½•èµ„æºï¼Œå¦‚çº¿ç¨‹ï¼Œå·²æ³¨å†Œçš„ç›‘å¬å™¨ï¼Œæ¥æ”¶å™¨ç­‰ã€‚ |

## 6.5 Broadcast Receivers

å¹¿æ’­æ¥æ”¶å™¨ç”¨äºå“åº”æ¥è‡ªå…¶ä»–åº”ç”¨ç¨‹åºæˆ–è€…ç³»ç»Ÿçš„å¹¿æ’­æ¶ˆæ¯ã€‚è¿™äº›æ¶ˆæ¯æœ‰æ—¶è¢«ç§°ä¸ºäº‹ä»¶æˆ–è€…æ„å›¾ã€‚ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åˆå§‹åŒ–å¹¿æ’­æ¥è®©å…¶ä»–çš„åº”ç”¨ç¨‹åºçŸ¥é“ä¸€äº›æ•°æ®å·²ç»è¢«ä¸‹è½½åˆ°è®¾å¤‡ï¼Œå¹¶å¯ä»¥ä¸ºä»–ä»¬æ‰€ç”¨ã€‚è¿™æ ·å¹¿æ’­æ¥æ”¶å™¨å¯ä»¥å®šä¹‰é€‚å½“çš„åŠ¨ä½œæ¥æ‹¦æˆªè¿™äº›é€šä¿¡ã€‚

æœ‰ä»¥ä¸‹ä¸¤ä¸ªé‡è¦çš„æ­¥éª¤æ¥ä½¿ç³»ç»Ÿçš„å¹¿æ’­æ„å›¾é…åˆå¹¿æ’­æ¥æ”¶å™¨å·¥ä½œã€‚

- åˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨
- æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨

è¿˜æœ‰ä¸€ä¸ªé™„åŠ çš„æ­¥éª¤ï¼Œè¦å®ç°è‡ªå®šä¹‰çš„æ„å›¾ï¼Œä½ å¿…é¡»åˆ›å»ºå¹¶å¹¿æ’­è¿™äº›æ„å›¾ã€‚

### åˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨

å¹¿æ’­æ¥æ”¶å™¨éœ€è¦å®ç°ä¸ºBroadcastReceiverç±»çš„å­ç±»ï¼Œå¹¶é‡å†™onReceive()æ–¹æ³•æ¥æ¥æ”¶ä»¥Intentå¯¹è±¡ä¸ºå‚æ•°çš„æ¶ˆæ¯ã€‚

```java
public class MyReceiver extends BroadcastReceiver {
   @Override
   public void onReceive(Context context, Intent intent) {
      Toast.makeText(context, "Intent Detected.", Toast.LENGTH_LONG).show();
   }
}
```

### æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨

![broadcast.jpg](./images/broadcast.jpg)

åº”ç”¨ç¨‹åºé€šè¿‡åœ¨AndroidManifest.xmlä¸­æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨æ¥ç›‘å¬åˆ¶å®šçš„å¹¿æ’­æ„å›¾ã€‚å‡è®¾æˆ‘ä»¬å°†è¦æ³¨å†ŒMyReceiveræ¥ç›‘å¬ç³»ç»Ÿäº§ç”Ÿçš„ACTION_BOOT_COMPLETEDäº‹ä»¶ã€‚è¯¥äº‹ä»¶ç”±Androidç³»ç»Ÿçš„å¯åŠ¨è¿›ç¨‹å®Œæˆæ—¶å‘å‡ºã€‚

```xml
<application
   android:icon="@drawable/ic_launcher"
   android:label="@string/app_name"
   android:theme="@style/AppTheme" >
   <receiver android:name="MyReceiver">

      <intent-filter>
         <action android:name="android.intent.action.BOOT_COMPLETED">
         </action>
      </intent-filter>

   </receiver>
</application>
```

ç°åœ¨ï¼Œæ— è®ºä»€ä¹ˆæ—¶å€™Androidè®¾å¤‡è¢«å¯åŠ¨ï¼Œéƒ½å°†è¢«å¹¿æ’­æ¥æ”¶å™¨MyReceiveræ‰€æ‹¦æˆªï¼Œå¹¶ä¸”åœ¨onReceive()ä¸­å®ç°çš„é€»è¾‘å°†è¢«æ‰§è¡Œã€‚

æœ‰è®¸å¤šç³»ç»Ÿäº§ç”Ÿçš„äº‹ä»¶è¢«å®šä¹‰ä¸ºç±»Intentä¸­çš„é™æ€å¸¸é‡å€¼ã€‚ä¸‹é¢çš„è¡¨æ ¼åˆ—ä¸¾äº†é‡è¦çš„ç³»ç»Ÿäº‹ä»¶ã€‚

| äº‹ä»¶å¸¸é‡                              | æè¿°                                                 |
| :------------------------------------ | :--------------------------------------------------- |
| android.intent.action.BATTERY_CHANGED | æŒä¹…çš„å¹¿æ’­ï¼ŒåŒ…å«ç”µæ± çš„å……ç”µçŠ¶æ€ï¼Œçº§åˆ«å’Œå…¶ä»–ä¿¡æ¯ã€‚     |
| android.intent.action.BATTERY_LOW     | æ ‡è¯†è®¾å¤‡çš„ä½ç”µé‡æ¡ä»¶ã€‚                               |
| android.intent.action.BATTERY_OKAY    | æ ‡è¯†ç”µæ± åœ¨ç”µé‡ä½ä¹‹åï¼Œç°åœ¨å·²ç»å¥½äº†ã€‚                 |
| android.intent.action.BOOT_COMPLETED  | åœ¨ç³»ç»Ÿå®Œæˆå¯åŠ¨åå¹¿æ’­ä¸€æ¬¡ã€‚                           |
| android.intent.action.BUG_REPORT      | æ˜¾ç¤ºæŠ¥å‘Šbugçš„æ´»åŠ¨ã€‚                                  |
| android.intent.action.CALL            | æ‰§è¡Œå‘¼å«æ•°æ®æŒ‡å®šçš„æŸäººã€‚                             |
| android.intent.action.CALL_BUTTON     | ç”¨æˆ·ç‚¹å‡»"å‘¼å«"æŒ‰é’®æ‰“å¼€æ‹¨å·å™¨æˆ–è€…å…¶ä»–æ‹¨å·çš„åˆé€‚ç•Œé¢ã€‚ |
| android.intent.action.DATE_CHANGED    | æ—¥æœŸå‘ç”Ÿæ”¹å˜ã€‚                                       |
| android.intent.action.REBOOT          | è®¾å¤‡é‡å¯ã€‚                                           |

### å¹¿æ’­è‡ªå®šä¹‰æ„å›¾

å¦‚æœä½ æƒ³è¦åº”ç”¨ç¨‹åºä¸­ç”Ÿæˆå¹¶å‘é€è‡ªå®šä¹‰æ„å›¾ï¼Œä½ éœ€è¦åœ¨æ´»åŠ¨ç±»ä¸­é€šè¿‡sendBroadcast()æ¥åˆ›å»ºå¹¶å‘é€è¿™äº›æ„å›¾ã€‚å¦‚æœä½ ä½¿ç”¨sendStickyBroadcast(Intent)æ–¹æ³•ï¼Œåˆ™æ„å›¾æ˜¯æŒä¹…çš„(sticky)ï¼Œè¿™æ„å‘³è€…ä½ å‘å‡ºçš„æ„å›¾åœ¨å¹¿æ’­å®Œæˆåä¸€ç›´ä¿æŒç€ã€‚

```java
public void broadcastIntent(View view)
{
   Intent intent = new Intent();
   intent.setAction("com.runoob.CUSTOM_INTENT");
   sendBroadcast(intent);
}
```

com.runoob.CUSTOM_INTENTçš„æ„å›¾å¯ä»¥åƒä¹‹å‰æˆ‘ä»¬æ³¨å†Œç³»ç»Ÿäº§ç”Ÿçš„æ„å›¾ä¸€æ ·è¢«æ³¨å†Œã€‚

```xml
<application
   android:icon="@drawable/ic_launcher"
   android:label="@string/app_name"
   android:theme="@style/AppTheme" >
   <receiver android:name="MyReceiver">

      <intent-filter>
         <action android:name="com.runoob.CUSTOM_INTENT">
         </action>
      </intent-filter>

   </receiver>
</application>
```

## 6.6 å†…å®¹æä¾›è€…(Content Provider)

å†…å®¹æä¾›è€…ç»„ä»¶é€šè¿‡è¯·æ±‚ä»ä¸€ä¸ªåº”ç”¨ç¨‹åºå‘å…¶ä»–çš„åº”ç”¨ç¨‹åºæä¾›æ•°æ®ã€‚è¿™äº›è¯·æ±‚ç”±ç±» ContentResolver çš„æ–¹æ³•æ¥å¤„ç†ã€‚å†…å®¹æä¾›è€…å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®ã€‚æ•°æ®å¯ä»¥è¢«å­˜æ”¾åœ¨æ•°æ®åº“ï¼Œæ–‡ä»¶ï¼Œç”šè‡³æ˜¯ç½‘ç»œã€‚

![content.jpg](./images/content.jpg)

æœ‰æ—¶å€™éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ•°æ®ã€‚è¿™æ—¶å†…å®¹æä¾›è€…å˜å¾—éå¸¸æœ‰ç”¨ã€‚

å†…å®¹æä¾›è€…å¯ä»¥è®©å†…å®¹é›†ä¸­ï¼Œå¿…è¦æ—¶å¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„åº”ç”¨ç¨‹åºæ¥è®¿é—®ã€‚å†…å®¹æä¾›è€…çš„è¡Œä¸ºå’Œæ•°æ®åº“å¾ˆåƒã€‚ä½ å¯ä»¥æŸ¥è¯¢ï¼Œç¼–è¾‘å®ƒçš„å†…å®¹ï¼Œä½¿ç”¨ insert()ï¼Œ update()ï¼Œ delete() å’Œ query() æ¥æ·»åŠ æˆ–è€…åˆ é™¤å†…å®¹ã€‚å¤šæ•°æƒ…å†µä¸‹æ•°æ®è¢«å­˜å‚¨åœ¨ SQLite æ•°æ®åº“ã€‚

å†…å®¹æä¾›è€…è¢«å®ç°ä¸ºç±» ContentProvider ç±»çš„å­ç±»ã€‚éœ€è¦å®ç°ä¸€ç³»åˆ—æ ‡å‡†çš„ APIï¼Œä»¥ä¾¿å…¶ä»–çš„åº”ç”¨ç¨‹åºæ¥æ‰§è¡Œäº‹åŠ¡ã€‚

```java
public class MyApplication extends  ContentProvider {

}
```

### å†…å®¹URI

è¦æŸ¥è¯¢å†…å®¹æä¾›è€…ï¼Œä½ éœ€è¦ä»¥å¦‚ä¸‹æ ¼å¼çš„URIçš„å½¢å¼æ¥æŒ‡å®šæŸ¥è¯¢å­—ç¬¦ä¸²ï¼š

```
<prefix>://<authority>/<data_type>/<id>
```

ä»¥ä¸‹æ˜¯URIä¸­å„éƒ¨åˆ†çš„å…·ä½“è¯´æ˜ï¼š

| éƒ¨åˆ†      | è¯´æ˜                                                         |
| :-------- | :----------------------------------------------------------- |
| prefix    | å‰ç¼€ï¼šä¸€ç›´è¢«è®¾ç½®ä¸ºcontent://                                 |
| authority | æˆæƒï¼šæŒ‡å®šå†…å®¹æä¾›è€…çš„åç§°ï¼Œä¾‹å¦‚è”ç³»äººï¼Œæµè§ˆå™¨ç­‰ã€‚ç¬¬ä¸‰æ–¹çš„å†…å®¹æä¾›è€…å¯ä»¥æ˜¯å…¨åï¼Œå¦‚ï¼šcn.programmer.statusprovider |
| data_type | æ•°æ®ç±»å‹ï¼šè¿™ä¸ªè¡¨æ˜è¿™ä¸ªç‰¹æ®Šçš„å†…å®¹æä¾›è€…ä¸­çš„æ•°æ®çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼šä½ è¦é€šè¿‡å†…å®¹æä¾›è€…Contactsæ¥è·å–æ‰€æœ‰çš„é€šè®¯å½•ï¼Œæ•°æ®è·¯å¾„æ˜¯peopleï¼Œé‚£ä¹ˆURIå°†æ˜¯ä¸‹é¢è¿™æ ·ï¼šcontent://contacts/people |
| id        | è¿™ä¸ªæŒ‡å®šç‰¹å®šçš„è¯·æ±‚è®°å½•ã€‚ä¾‹å¦‚ï¼šä½ åœ¨å†…å®¹æä¾›è€…Contactsä¸­æŸ¥æ‰¾è”ç³»äººçš„IDå·ä¸º5ï¼Œé‚£ä¹ˆURIçœ‹èµ·æ¥æ˜¯è¿™æ ·ï¼šcontent://contacts/people/5 |

### åˆ›å»ºå†…å®¹æä¾›è€…

è¿™é‡Œæè¿°åˆ›å»ºè‡ªå·±çš„å†…å®¹æä¾›è€…çš„ç®€å•æ­¥éª¤ã€‚

- é¦–å…ˆï¼Œä½ éœ€è¦ç»§æ‰¿ç±» ContentProviderbase æ¥åˆ›å»ºä¸€ä¸ªå†…å®¹æä¾›è€…ç±»ã€‚
- å…¶æ¬¡ï¼Œä½ éœ€è¦å®šä¹‰ç”¨äºè®¿é—®å†…å®¹çš„ä½ çš„å†…å®¹æä¾›è€…URIåœ°å€ã€‚
- æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦åˆ›å»ºæ•°æ®åº“æ¥ä¿å­˜å†…å®¹ã€‚é€šå¸¸ï¼ŒAndroid ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œå¹¶åœ¨æ¡†æ¶ä¸­é‡å†™ onCreate() æ–¹æ³•æ¥ä½¿ç”¨ SQLiteOpenHelper çš„æ–¹æ³•åˆ›å»ºæˆ–è€…æ‰“å¼€æä¾›è€…çš„æ•°æ®åº“ã€‚å½“ä½ çš„åº”ç”¨ç¨‹åºè¢«å¯åŠ¨ï¼Œå®ƒçš„æ¯ä¸ªå†…å®¹æä¾›è€…çš„ onCreate() æ–¹æ³•å°†åœ¨åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚
- æœ€åï¼Œä½¿ç”¨<provider.../>æ ‡ç­¾åœ¨ AndroidManifest.xml ä¸­æ³¨å†Œå†…å®¹æä¾›è€…ã€‚

ä»¥ä¸‹æ˜¯è®©ä½ çš„å†…å®¹æä¾›è€…æ­£å¸¸å·¥ä½œï¼Œä½ éœ€è¦åœ¨ç±» ContentProvider ä¸­é‡å†™çš„ä¸€äº›æ–¹æ³•ï¼š

![content1.jpg](./images/content1.jpg)

- onCreate():å½“æä¾›è€…è¢«å¯åŠ¨æ—¶è°ƒç”¨ã€‚
- query():è¯¥æ–¹æ³•ä»å®¢æˆ·ç«¯æ¥å—è¯·æ±‚ã€‚ç»“æœæ˜¯è¿”å›æŒ‡é’ˆ(Cursor)å¯¹è±¡ã€‚
- insert():è¯¥æ–¹æ³•å‘å†…å®¹æä¾›è€…æ’å…¥æ–°çš„è®°å½•ã€‚
- delete():è¯¥æ–¹æ³•ä»å†…å®¹æä¾›è€…ä¸­åˆ é™¤å·²å­˜åœ¨çš„è®°å½•ã€‚
- update():è¯¥æ–¹æ³•æ›´æ–°å†…å®¹æä¾›è€…ä¸­å·²å­˜åœ¨çš„è®°å½•ã€‚
- getType():è¯¥æ–¹æ³•ä¸ºç»™å®šçš„URIè¿”å›å…ƒæ•°æ®ç±»å‹ã€‚

## 6.7 ç¢ç‰‡

ç¢ç‰‡æ˜¯æ´»åŠ¨çš„ä¸€éƒ¨åˆ†ï¼Œä½¿å¾—æ´»åŠ¨æ›´åŠ çš„æ¨¡å—åŒ–è®¾è®¡ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºç¢ç‰‡æ˜¯ä¸€ç§å­æ´»åŠ¨ã€‚

ä¸‹é¢æ˜¯å…³äºç¢ç‰‡çš„é‡è¦çŸ¥è¯†ç‚¹ -

- ç¢ç‰‡æ‹¥æœ‰è‡ªå·±çš„å¸ƒå±€ï¼Œè‡ªå·±çš„è¡Œä¸ºåŠè‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚
- å½“æ´»åŠ¨åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä½ å¯ä»¥åœ¨æ´»åŠ¨ä¸­æ·»åŠ æˆ–è€…ç§»é™¤ç¢ç‰‡ã€‚
- ä½ å¯ä»¥åˆå¹¶å¤šä¸ªç¢ç‰‡åœ¨ä¸€ä¸ªå•ä¸€çš„æ´»åŠ¨ä¸­æ¥æ„å»ºå¤šæ çš„UIã€‚
- ç¢ç‰‡å¯ä»¥è¢«ç”¨åœ¨å¤šä¸ªæ´»åŠ¨ä¸­ã€‚
- ç¢ç‰‡çš„ç”Ÿå‘½å‘¨æœŸå’Œå®ƒçš„å®¿ä¸»æ´»åŠ¨ç´§å¯†å…³è”ã€‚è¿™æ„å‘³ç€æ´»åŠ¨è¢«æš‚åœï¼Œæ‰€æœ‰æ´»åŠ¨ä¸­çš„ç¢ç‰‡è¢«åœæ­¢ã€‚
- ç¢ç‰‡å¯ä»¥å®ç°è¡Œä¸ºè€Œæ²¡æœ‰ç”¨æˆ·ç•Œé¢ç»„ä»¶ã€‚
- ç¢ç‰‡æ˜¯ Android API ç‰ˆæœ¬11ä¸­è¢«åŠ å…¥åˆ° Android APIã€‚

é€šè¿‡ç»§æ‰¿ Fragment ç±»æ¥åˆ›å»ºç¢ç‰‡ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨ å…ƒç´ åœ¨æ´»åŠ¨çš„å¸ƒå±€æ–‡ä»¶ä¸­å£°æ˜ç¢ç‰‡æ¥åœ¨ä½ çš„æ´»åŠ¨ä¸­æ’å…¥ç¢ç‰‡ã€‚

åœ¨å¼•å…¥ç¢ç‰‡ä¹‹å‰ï¼Œç”±äºæ¯æ¬¡ç»™å®šçš„ä¸€ä¸ªæ—¶é—´ç‚¹åœ¨å±å¹•ä¸Šåªèƒ½æ˜¾ç¤ºå•ä¸€çš„æ´»åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬æœ‰ä¸€ä¸ªå±€é™ã€‚æˆ‘ä»¬æ— æ³•åˆ†å‰²è®¾å¤‡å±å¹•å¹¶ä¸”ç‹¬ç«‹çš„æ§åˆ¶ä¸åŒçš„éƒ¨åˆ†ã€‚ä¼´éšç€ç¢ç‰‡çš„å¼•å…¥ï¼Œæˆ‘ä»¬è·å¾—äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œå¹¶ä½¿å¾—ä¸€ä¸ªæ—¶é—´ç‚¹åªèƒ½åœ¨å±å¹•ä¸Šæœ‰ä¸€ä¸ªå•ä¸€æ´»åŠ¨çš„é™åˆ¶è¢«ç§»é™¤ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æœ‰å•ä¸€çš„æ´»åŠ¨ï¼Œä½†æ¯ä¸ªæ´»åŠ¨ç”±å¤šä¸ªç¢ç‰‡ç»„è£…ï¼Œæ¯ä¸ªç¢ç‰‡æœ‰è‡ªå·±çš„å¸ƒå±€ï¼Œäº‹ä»¶å’Œå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•è®©ä¸¤ä¸ªç”±ç¢ç‰‡å®šä¹‰çš„UIæ¨¡å—ï¼Œåœ¨ä¸ºå¹³æ¿è®¾è®¡çš„æ´»åŠ¨ä¸­ç»„åˆï¼Œåœ¨ä¸ºæ‰‹æŒè®¾å¤‡è®¾è®¡çš„æ´»åŠ¨ä¸­åˆ†ç¦»ã€‚

![android_fragments.jpg](./images/android_fragments.jpg)

å½“è¿è¡Œåœ¨åœ¨å¹³æ¿å°ºå¯¸çš„è®¾å¤‡ä¸Šï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥åœ¨æ´»åŠ¨Aä¸­åµŒå…¥ä¸¤ä¸ªç¢ç‰‡ã€‚åœ¨æ‰‹æœºè®¾å¤‡å±å¹•ä¸Šï¼Œç”±äºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæ´»åŠ¨Aä»…åŒ…å«æœ‰æ–‡ç« åˆ—è¡¨çš„ç¢ç‰‡ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æ–‡ç« æ—¶ï¼Œå¯åŠ¨åŒ…å«ç¬¬äºŒä¸ªç¢ç‰‡çš„æ´»åŠ¨Bæ¥é˜…è¯»æ–‡ç« ã€‚

### ç¢ç‰‡çš„ç”Ÿå‘½å‘¨æœŸ

Android çš„ç¢ç‰‡æ‹¥æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ Android çš„æ´»åŠ¨å¾ˆç›¸ä¼¼ã€‚ä¸‹é¢ç®€å•ä»‹ç»å®ƒç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µã€‚

![fragment.jpg](./images/fragment.jpg)

è¿™æ˜¯åœ¨ç±»fragmentä¸­ä½ å¯ä»¥é‡å†™çš„æ–¹æ³•åˆ—è¡¨ï¼š

- onAttach(): ç¢ç‰‡å®ä¾‹è¢«å…³è”åˆ°æ´»åŠ¨å®ä¾‹ã€‚ç¢ç‰‡å’Œæ´»åŠ¨è¿˜æ²¡æœ‰å®Œå…¨åˆå§‹åŒ–ã€‚é€šå¸¸ï¼Œä½ åœ¨è¯¥æ–¹æ³•ä¸­è·å–åˆ°æ´»åŠ¨çš„å¼•ç”¨ï¼Œåœ¨ç¢ç‰‡å°†æ¥çš„åˆå§‹åŒ–å·¥ä½œä¸­è¢«ä½¿ç”¨ã€‚
- onCreate(): å½“åˆ›å»ºç¢ç‰‡æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚ä½ éœ€è¦åˆå§‹åŒ–ä¸€äº›ç¢ç‰‡çš„å¿…è¦ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶æ˜¯å½“ç¢ç‰‡è¢«æš‚åœã€åœæ­¢æ—¶éœ€è¦ä¿ç•™çš„ï¼Œä»¥ä¾¿è¢«æ¢å¤ã€‚
- onCreateView(): å½“ç¢ç‰‡å°†è¦ç¬¬ä¸€æ¬¡ç»˜åˆ¶å®ƒçš„ç”¨æˆ·ç•Œé¢æ—¶ç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚ä¸ºäº†ç»˜åˆ¶ç¢ç‰‡çš„UIï¼Œä½ éœ€è¦ä»è¯¥æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªä»£è¡¨ç¢ç‰‡æ ¹å¸ƒå±€çš„Viewç»„ä»¶ã€‚å¦‚æœè¯¥ç¢ç‰‡ä¸æä¾›ç”¨æˆ·ç•Œé¢ï¼Œç›´æ¥è¿”å›nullã€‚
- onActivityCreated: å½“å®¿ä¸»æ´»åŠ¨è¢«åˆ›å»ºï¼Œåœ¨onCreateView()æ–¹æ³•ä¹‹åè°ƒç”¨è¯¥æ–¹æ³•ã€‚æ´»åŠ¨å’Œç¢ç‰‡å®ä¾‹ä¸æ´»åŠ¨çš„è§†å›¾å±‚çº§è¢«åˆ›å»ºã€‚è¿™æ—¶ï¼Œè§†å›¾å¯ä»¥é€šè¿‡findViewById()æ–¹æ³•æ¥è®¿é—®ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥å®ä¾‹åŒ–éœ€è¦Contextå¯¹è±¡çš„å¯¹è±¡ã€‚
- onStart(): ç¢ç‰‡å¯è§æ—¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚
- onResume(): ç¢ç‰‡å¯äº¤äº’æ—¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚
- onPause(): å½“é¦–æ¬¡è¡¨æ˜ç”¨æˆ·å°†è¦ç¦»å¼€ç¢ç‰‡æ—¶ç³»ç»Ÿè°ƒç”¨è¯¥æ–¹æ³•ã€‚é€šå¸¸ï¼Œè¿™é‡Œä½ éœ€è¦æäº¤ä»»ä½•çš„ä¼šè¶…å‡ºç”¨æˆ·ä¼šè¯çš„æŒä¹…åŒ–çš„å˜åŒ–ã€‚
- onStop(): ç¢ç‰‡å°†è¦è¢«åœæ­¢æ—¶è°ƒç”¨ã€‚
- onDestroyView(): è°ƒç”¨è¯¥æ–¹æ³•åï¼Œç¢ç‰‡å°†è¦è¢«é”€æ¯ã€‚
- onDestroy(): è¯¥æ–¹æ³•è¢«ç”¨æ¥æ¸…ç†ç¢ç‰‡çš„çŠ¶æ€ã€‚ä½†åœ¨Androidå¹³å°å¹¶ä¸ä¿è¯ä¸€å®šè¢«è°ƒç”¨ã€‚

### å¦‚ä½•ä½¿ç”¨ç¢ç‰‡ï¼Ÿ

è¿™é‡Œä»‹ç»åˆ›å»ºç¢ç‰‡çš„ç®€å•æ­¥éª¤ã€‚

- é¦–å…ˆå†³å®šåœ¨æ´»åŠ¨ä¸­éœ€è¦ä½¿ç”¨å¤šå°‘ä¸ªç¢ç‰‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸¤ä¸ªç¢ç‰‡æ¥å¤„ç†è®¾å¤‡çš„æ¨ªå±å’Œç«–å±ä¸¤ç§æ¨¡å¼ã€‚
- ä¸‹ä¸€æ­¥ï¼ŒåŸºäºç¢ç‰‡æ•°é‡ï¼Œåˆ›å»ºç»§æ‰¿è‡ªç±»Fragmentçš„ç±»ã€‚ç±»FragmentåŒ…å«ä¸Šé¢æåˆ°çš„å›è°ƒå‡½æ•°ã€‚æ ¹æ®ä½ çš„éœ€æ±‚é‡å†™ä»»æ„çš„æ–¹æ³•ã€‚
- å¯¹åº”æ¯ä¸ªç‰‡æ®µï¼Œä½ éœ€è¦åœ¨XMLæ–‡ä»¶ä¸­åˆ›å»ºå¸ƒå±€ã€‚è¿™äº›æ–‡ä»¶ä¸­åŒ…å«å·²å®šä¹‰çš„ç¢ç‰‡çš„å¸ƒå±€ã€‚
- æœ€åï¼ŒåŸºäºéœ€æ±‚ä¿®æ”¹æ´»åŠ¨æ–‡ä»¶æ¥å®šä¹‰å®é™…çš„ç¢ç‰‡æ›¿æ¢é€»è¾‘ã€‚

### ç¢ç‰‡ç±»å‹

åŸºæœ¬çš„ç¢ç‰‡å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ç§ï¼š

- [å•å¸§ç¢ç‰‡](https://www.runoob.com/android/android-single-fragment.html) - å•å¸§ç¢ç‰‡è¢«å¦‚ç§»åŠ¨ç”µè¯ä¹‹ç±»çš„æ‰‹æŒè®¾å¤‡ä½¿ç”¨ã€‚ä¸€ä¸ªç¢ç‰‡å¦‚åŒä¸€ä¸ªè§†é¢‘ä¸€æ ·æ˜¾ç¤ºã€‚
- [åˆ—è¡¨ç¢ç‰‡](https://www.runoob.com/android/android-list-fragment.html) - åŒ…å«æœ‰ç‰¹æ®Šåˆ—è¡¨è§†å›¾çš„ç¢ç‰‡è¢«å«åšåˆ—è¡¨ç¢ç‰‡ã€‚
- [ç¢ç‰‡è¿‡æ¸¡](https://www.runoob.com/android/android-fragment-transitions.html) - ä¸ç¢ç‰‡äº‹åŠ¡ä¸€èµ·ä½¿ç”¨ã€‚å¯ä»¥ä»ä¸€ä¸ªç¢ç‰‡ç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªç¢ç‰‡ã€‚

## 6.8 æ„å›¾ Intent

Androidæ„å›¾æ˜¯ä¸€ä¸ªè¦æ‰§è¡Œçš„æ“ä½œçš„æŠ½è±¡æè¿°ã€‚å®ƒå¯ä»¥é€šè¿‡ startActivity æ¥å¯åŠ¨ä¸€ä¸ªæ´»åŠ¨ï¼ŒbroadcastIntent æ¥å‘é€å¹¿æ’­åˆ°ä»»ä½•å¯¹å®ƒæ„Ÿå…´è¶£çš„å¹¿æ’­æ¥å—å™¨ç»„ä»¶ï¼ŒstartService(Intent) æˆ–è€…bindService(Intentï¼Œ ServiceConnection, int) æ¥ä¸åå°æœåŠ¡é€šè®¯ã€‚

æ„å›¾æœ¬èº«ï¼ˆä¸€ä¸ª Intent å¯¹è±¡ï¼‰æ˜¯ä¸€ä¸ªè¢«åŠ¨çš„æ•°æ®ç»“æ„ï¼Œä¿å­˜ç€è¦æ‰§è¡Œæ“ä½œçš„æŠ½è±¡æè¿°ã€‚

ä¾‹å¦‚ï¼Œä½ æœ‰ä¸€ä¸ªæ´»åŠ¨ï¼Œéœ€è¦æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯å¹¶é€šè¿‡ Android è®¾å¤‡æ¥å‘é€é‚®ä»¶ã€‚ä¸ºäº†è¿™ä¸ªç›®çš„ï¼Œä½ çš„æ´»åŠ¨éœ€è¦å‘é€ä¸€ä¸ªå¸¦æœ‰åˆé€‚é€‰æ‹©å™¨çš„ ACTION_SEND åˆ° Android æ„å›¾å¤„ç†è€…ã€‚æŒ‡å®šçš„é€‰æ‹©å™¨ç»™å®šåˆé€‚çš„ç•Œé¢æ¥è®©ç”¨æˆ·å†³å®šå¦‚ä½•å‘é€ä»–çš„é‚®ä»¶æ•°æ®

```java
Intent email = new Intent(Intent.ACTION_SEND, Uri.parse("mailto:"));
email.putExtra(Intent.EXTRA_EMAIL, recipients);
email.putExtra(Intent.EXTRA_SUBJECT, subject.getText().toString());
email.putExtra(Intent.EXTRA_TEXT, body.getText().toString());
startActivity(Intent.createChooser(email, "Choose an email client from..."));
```

ä¸Šé¢çš„è¯­æ³•è°ƒç”¨ startActivity æ–¹æ³•æ¥å¼€å¯é‚®ä»¶æ´»åŠ¨ï¼Œä»£ç è¿è¡Œç»“æœçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![send_email.jpg](./images/send_email.jpg)

ä¾‹å¦‚ï¼Œä½ æœ‰ä¸€ä¸ªæ´»åŠ¨ï¼Œéœ€è¦åœ¨ Android è®¾å¤‡ä¸Šé€šè¿‡æµè§ˆå™¨æ‰“å¼€ä¸€ä¸ªURLã€‚ä¸ºäº†è¿™ä¸ªç›®çš„ï¼Œä½ çš„æ´»åŠ¨å‘é€ ACTION_WEB_SEARCH æ„å›¾åˆ° Android æ„å›¾å¤„ç†å™¨æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç»™å®šçš„ URL ã€‚æ„å›¾å¤„ç†å™¨é€šè¿‡è§£æä¸€ç³»åˆ—æ´»åŠ¨ï¼Œå¹¶é€‰æ‹©æœ€é€‚åˆä½ çš„æ„å›¾çš„ä¸€ä¸ªæ´»åŠ¨ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ˜¯ Web æµè§ˆå™¨æ´»åŠ¨ã€‚æ„å›¾å¤„ç†å™¨ä¼ é€’ä½ çš„ç½‘é¡µåœ°å€åˆ° Web æµè§ˆå™¨ï¼Œå¹¶æ‰“å¼€ Web æµè§ˆå™¨æ´»åŠ¨

```java
String q = "https://www.runoob.com";
Intent intent = new Intent(Intent.ACTION_WEB_SEARCH );
intent.putExtra(SearchManager.QUERY, q);
startActivity(intent);
```

ä¸Šé¢çš„ä¾‹å­å°†åœ¨Androidæœç´¢å¼•æ“ä¸ŠæŸ¥æ‰¾"www.runoob.com"ï¼Œå¹¶åœ¨ä¸€ä¸ªæ´»åŠ¨ä¸Šç»™å‡ºå…³é”®è¯çš„ç»“æœã€‚

å¯¹äºæ¯ä¸€ä¸ªç»„ä»¶-æ´»åŠ¨ï¼ŒæœåŠ¡ï¼Œå¹¿æ’­æ¥æ”¶å™¨éƒ½æœ‰ç‹¬ç«‹çš„æœºåˆ¶æ¥ä¼ é€’æ„å›¾ã€‚

| åºå· | æ–¹æ³•å’Œæè¿°                                                   |
| :--- | :----------------------------------------------------------- |
| 1    | Context.startActivity():æ„å›¾ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨ä¸€ä¸ªæ–°çš„æ´»åŠ¨æˆ–è€…è®©å·²å­˜åœ¨çš„æ´»åŠ¨åšä¸€äº›æ–°çš„äº‹æƒ…ã€‚ |
| 2    | Context.startService():æ„å›¾ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œå°†åˆå§‹åŒ–ä¸€ä¸ªæœåŠ¡ï¼Œæˆ–è€…æ–°çš„ä¿¡æ¯åˆ°ä¸€ä¸ªæŒç»­å­˜åœ¨çš„æœåŠ¡ã€‚ |
| 3    | Context.sendBroadcast():æ„å›¾ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œä¿¡æ¯å°†ä¼ é€’åˆ°æ‰€æœ‰å¯¹æ­¤æ„Ÿå…´è¶£çš„å¹¿æ’­æ¥æ”¶å™¨ã€‚ |

### æ„å›¾å¯¹è±¡

æ„å›¾å¯¹è±¡æ˜¯ä¸€åŒ…çš„ä¿¡æ¯ï¼Œç”¨äºç»„ä»¶æ¥æ”¶åˆ°çš„æ„å›¾å°±åƒ Android ç³»ç»Ÿæ¥å—åˆ°çš„ä¿¡æ¯ã€‚

æ„å›¾å¯¹è±¡åŒ…æ‹¬å¦‚ä¸‹çš„ç»„ä»¶ï¼Œå…·ä½“å–å†³äºè¦é€šä¿¡æˆ–è€…æ‰§è¡Œä»€ä¹ˆã€‚

åŠ¨ä½œ(Action)

è¿™æ˜¯æ„å›¾å¯¹è±¡ä¸­å¿…é¡»çš„éƒ¨åˆ†ï¼Œè¢«è¡¨ç°ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨å¹¿æ’­çš„æ„å›¾ä¸­ï¼ŒåŠ¨ä½œä¸€æ—¦å‘ç”Ÿï¼Œå°†ä¼šè¢«æŠ¥å‘Šã€‚åŠ¨ä½œå°†å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šæ„å›¾çš„å…¶ä»–éƒ¨åˆ†å¦‚ä½•è¢«ç»„ç»‡ã€‚Intent ç±»å®šä¹‰äº†ä¸€ç³»åˆ—åŠ¨ä½œå¸¸é‡å¯¹åº”ä¸åŒçš„æ„å›¾ã€‚è¿™é‡Œæ˜¯ä¸€ä»½[Androidæ„å›¾æ ‡å‡†åŠ¨ä½œ ](https://www.runoob.com/android/android-intents-filters.html)åˆ—è¡¨ã€‚

æ„å›¾å¯¹è±¡ä¸­çš„åŠ¨ä½œå¯ä»¥é€šè¿‡ setAction() æ–¹æ³•æ¥è®¾ç½®ï¼Œé€šè¿‡ getAction() æ–¹æ³•æ¥è¯»å–ã€‚

æ•°æ®(Data)

æ·»åŠ æ•°æ®è§„æ ¼åˆ°æ„å›¾è¿‡æ»¤å™¨ã€‚è¿™ä¸ªè§„æ ¼å¯ä»¥åªæ˜¯ä¸€ä¸ªæ•°æ®ç±»å‹(å¦‚å…ƒç±»å‹å±æ€§)ï¼Œä¸€æ¡ URI ï¼Œæˆ–è€…åŒæ—¶åŒ…æ‹¬æ•°æ®ç±»å‹å’Œ URI ã€‚ URI åˆ™ç”±ä¸åŒéƒ¨åˆ†çš„å±æ€§æ¥æŒ‡å®šã€‚

è¿™äº›æŒ‡å®š URL æ ¼å¼çš„å±æ€§æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯ä¹Ÿç›¸äº’ç‹¬ç«‹ -

- å¦‚æœæ„å›¾è¿‡æ»¤å™¨æ²¡æœ‰æŒ‡å®šæ¨¡å¼ï¼Œæ‰€æœ‰å…¶ä»–çš„ URI å±æ€§å°†è¢«å¿½ç•¥ã€‚
- å¦‚æœæ²¡æœ‰ä¸ºè¿‡æ»¤å™¨æŒ‡å®šä¸»æœºï¼Œç«¯å£å±æ€§å’Œæ‰€æœ‰è·¯å¾„å±æ€§å°†è¢«å¿½ç•¥ã€‚

setData() æ–¹æ³•åªèƒ½ä»¥ URI æ¥æŒ‡å®šæ•°æ®ï¼ŒsetType() åªèƒ½ä»¥å…ƒç±»å‹æŒ‡å®šæ•°æ®ï¼ŒsetDataAndType() å¯ä»¥åŒæ—¶æŒ‡å®š URI å’Œå…ƒç±»å‹ã€‚URI é€šè¿‡ getData() è¯»å–ï¼Œç±»å‹é€šè¿‡ getType() è¯»å–ã€‚

ä»¥ä¸‹æ˜¯åŠ¨ä½œ/æ•°æ®ç»„çš„ä¸€äº›å®ä¾‹ -

| åºå· | åŠ¨ä½œ/æ•°æ®ç»„å’Œæè¿°                                            |
| :--- | :----------------------------------------------------------- |
| 1    | ACTION_VIEW content://contacts/people/1ï¼šæ˜¾ç¤ºIDä¸º1çš„ç”¨æˆ·çš„ä¿¡æ¯ã€‚ |
| 2    | ACTION_DIAL content://contacts/people/1ï¼šæ˜¾ç¤ºç”µè¯æ‹¨å·å™¨ï¼Œå¹¶å¡«å……ç”¨æˆ·1çš„æ•°æ®ã€‚ |
| 3    | ACTION_VIEW tel:123ï¼šæ˜¾ç¤ºç”µè¯æ‹¨å·å™¨ï¼Œå¹¶å¡«å……ç»™å®šçš„å·ç ã€‚      |
| 4    | ACTION_DIAL tel:123ï¼šæ˜¾ç¤ºç”µè¯æ‹¨å·å™¨ï¼Œå¹¶å¡«å……ç»™å®šçš„å·ç ã€‚      |
| 5    | ACTION_EDIT content://contacts/people/1ï¼šç¼–è¾‘IDä¸º1çš„ç”¨æˆ·ä¿¡æ¯ã€‚ |
| 6    | ACTION_VIEW content://contacts/people/ï¼šæ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œä»¥ä¾¿æŸ¥çœ‹ã€‚ |
| 7    | ACTION_SET_WALLPAPERï¼šæ˜¾ç¤ºé€‰æ‹©å£çº¸è®¾ç½®ã€‚                     |
| 8    | ACTION_SYNCï¼šåŒæ­¥æ•°æ®ï¼Œé»˜è®¤çš„å€¼ä¸ºï¼šandroid.intent.action.SYNC |
| 9    | ACTION_SYSTEM_TUTORIALï¼šå¼€å¯å¹³å°å®šä¹‰çš„æ•™ç¨‹ï¼ˆé»˜è®¤æ•™ç¨‹æˆ–è€…å¯åŠ¨æ•™ç¨‹ï¼‰ |
| 10   | ACTION_TIMEZONE_CHANGEDï¼šå½“æ—¶åŒºè¢«æ”¹å˜æ—¶é€šçŸ¥                  |
| 11   | ACTION_UNINSTALL_PACKAGEï¼šè¿è¡Œé»˜è®¤çš„å¸è½½å™¨                   |

ç±»åˆ«

ç±»åˆ«æ˜¯æ„å›¾ä¸­å¯é€‰çš„éƒ¨åˆ†ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«è¯¥ç±»å‹ç»„ä»¶éœ€è¦å¤„ç†çš„æ„å›¾çš„é™„åŠ ä¿¡æ¯ã€‚addCategory() æ–¹æ³•ä¸ºæ„å›¾å¯¹è±¡æ·»åŠ ç±»åˆ«ï¼ŒremoveCategory() æ–¹æ³•åˆ é™¤ä¹‹å‰æ·»åŠ çš„ç±»åˆ«ï¼ŒgetCategories() è·å–æ‰€æœ‰è¢«è®¾ç½®åˆ°æ„å›¾å¯¹è±¡ä¸­çš„ç±»åˆ«ã€‚è¿™é‡Œæ˜¯[Androidæ„å›¾æ ‡å‡†ç±»åˆ«](https://www.runoob.com/android/android-intents-filters.html)åˆ—è¡¨ã€‚

å¯ä»¥æŸ¥çœ‹ä¸‹é¢ç« èŠ‚ä¸­çš„æ„å›¾è¿‡æ»¤å™¨æ¥äº†è§£æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ç±»åˆ«æ¥é€šè¿‡å¯¹åº”çš„æ„å›¾é€‰æ‹©åˆé€‚çš„æ´»åŠ¨ã€‚

é™„åŠ æ•°æ®

è¿™æ˜¯ä¼ é€’ç»™éœ€è¦å¤„ç†æ„å›¾çš„ç»„ä»¶çš„ä»¥é”®å€¼å¯¹æè¿°çš„é™„åŠ ä¿¡æ¯ã€‚é€šè¿‡ putExtras() æ–¹æ³•è®¾ç½®ï¼ŒgetExtras() æ–¹æ³•è¯»å–ã€‚è¿™é‡Œæ˜¯[Androidæ„å›¾æ ‡å‡†é™„åŠ æ•°æ®](https://www.runoob.com/android/android-intents-filters.html)åˆ—è¡¨ã€‚

æ ‡è®°

è¿™äº›æ ‡è®°æ˜¯æ„å›¾çš„å¯é€‰éƒ¨åˆ†ï¼Œè¯´æ˜Androidç³»ç»Ÿå¦‚ä½•æ¥å¯åŠ¨æ´»åŠ¨ï¼Œå¯åŠ¨åå¦‚ä½•å¤„ç†ç­‰ã€‚

| åºå· | æ ‡è®°å’Œè¯´æ˜                                                   |
| :--- | :----------------------------------------------------------- |
| 1    | FLAG_ACTIVITY_CLEAR_TASK :å¦‚æœåœ¨æ„å›¾ä¸­è®¾ç½®ï¼Œå¹¶é€šè¿‡ Context.startActivity ä¼ é€’ï¼Œè¿™ä¸ªæ ‡è®°å°†å¯¼è‡´ä¸è¯¥æ´»åŠ¨ç›¸å…³è”çš„æ‰€æœ‰å·²å­˜åœ¨çš„ä»»åŠ¡åœ¨æ´»åŠ¨å¯åŠ¨å‰è¢«æ¸…ç©ºã€‚æ´»åŠ¨å°†æˆä¸ºä¸€ä¸ªç©ºä»»åŠ¡çš„æ ¹ï¼Œæ‰€æœ‰æ—§çš„æ´»åŠ¨è¢«ç»“æŸã€‚è¯¥æ ‡è®°å¯ä»¥ä¸ FLAG_ACTIVITY_NEW_TASK ç»“åˆä½¿ç”¨ã€‚ |
| 2    | FLAG_ACTIVITY_CLEAR_TOP :å¦‚æœè®¾ç½®è¯¥æ ‡è®°ï¼Œæ´»åŠ¨å°†åœ¨å½“å‰è¿è¡Œçš„ä»»åŠ¡ä¸­è¢«å¯åŠ¨ã€‚è¿™å¹¶ä¸ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„æ´»åŠ¨å®ä¾‹ï¼Œæ‰€æœ‰çš„åœ¨å®ƒä¹‹ä¸Šçš„æ´»åŠ¨è¢«å…³é—­ï¼Œè¿™ä¸ªæ„å›¾ä½œä¸ºä¸€ä¸ªæ–°çš„æ„å›¾è¢«ä¼ é€’åˆ°å·²æœ‰çš„ï¼ˆç›®å‰åœ¨é¡¶éƒ¨çš„ï¼‰æ´»åŠ¨ã€‚ |
| 3    | FLAG_ACTIVITY_NEW_TASK :è¿™ä¸ªæ ‡è®°ä¸€èˆ¬ç”¨äºä½¿å¾—æ´»åŠ¨ç”¨äº"å¯åŠ¨å™¨"é£æ ¼çš„è¡Œä¸ºï¼šä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå¯ä»¥ç‹¬ç«‹å®Œæˆè¿è¡Œçš„æ•°æ®ï¼Œå¹¶å¯åŠ¨å®Œæ•´å„¿ç‹¬ç«‹çš„æ´»åŠ¨ã€‚ |

ç»„ä»¶åç§°

ç»„ä»¶åç§°å¯¹è±¡æ˜¯ä¸€ä¸ªå¯é€‰çš„åŸŸï¼Œä»£è¡¨æ´»åŠ¨ã€æœåŠ¡æˆ–è€…å¹¿æ’­æ¥æ”¶å™¨ç±»ã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™æ„å›¾å¯¹è±¡è¢«ä¼ é€’åˆ°å®ç°è®¾è®¡å¥½çš„ç±»çš„å®ä¾‹ï¼Œå¦åˆ™ï¼ŒAndroid ä½¿ç”¨å…¶ä»–æ„å›¾

æ„å›¾çš„ç±»å‹

Android æ”¯æŒä¸¤ç§ç±»å‹çš„æ„å›¾ã€‚

![intent.jpg](./images/intent.jpg)

æ˜¾å¼æ„å›¾

æ˜¾å¼æ„å›¾ç”¨äºè¿æ¥åº”ç”¨ç¨‹åºçš„å†…éƒ¨ä¸–ç•Œï¼Œå‡è®¾ä½ éœ€è¦è¿æ¥ä¸€ä¸ªæ´»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªæ´»åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ˜¾ç¤ºæ„å›¾ï¼Œä¸‹å›¾æ˜¾ç¤ºé€šè¿‡ç‚¹å‡»æŒ‰é’®è¿æ¥ç¬¬ä¸€ä¸ªæ´»åŠ¨åˆ°ç¬¬äºŒä¸ªæ´»åŠ¨ã€‚

![intent1.jpg](./images/intent1.jpg)

è¿™äº›æ„å›¾é€šè¿‡åç§°æŒ‡å®šç›®æ ‡ç»„ä»¶ï¼Œä¸€èˆ¬ç”¨äºåº”ç”¨ç¨‹åºå†…éƒ¨ä¿¡æ¯ - æ¯”å¦‚ä¸€ä¸ªæ´»åŠ¨å¯åŠ¨ä¸€ä¸ªä¸‹å±æ´»åŠ¨æˆ–è€…å¯åŠ¨ä¸€ä¸ªå…„å¼Ÿæ´»åŠ¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```java
// é€šè¿‡æŒ‡å®šç±»åçš„æ˜¾å¼æ„å›¾
Intent i = new Intent(FirstActivity.this, SecondAcitivity.class);

// å¯åŠ¨ç›®æ ‡æ´»åŠ¨
startActivity(i);
```

éšå¼æ„å›¾

è¿™äº›æ„å›¾æ²¡æœ‰ä¸ºç›®æ ‡å‘½åï¼Œç»„ä»¶åç§°çš„åŸŸä¸ºç©ºã€‚éšå¼æ„å›¾ç»å¸¸ç”¨äºæ¿€æ´»å…¶ä»–åº”ç”¨ç¨‹åºçš„ç»„ä»¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```java
Intent read1=new Intent();
read1.setAction(android.content.Intent.ACTION_VIEW);
read1.setData(ContactsContract.Contacts.CONTENT_URI);
startActivity(read1);
```

ä¸Šé¢çš„ä»£ç å°†ç»™å‡ºå¦‚ä¸‹ç»“æœï¼š

![intent4.jpg](./images/intent4.jpg)

ç›®æ ‡ç»„ä»¶æ¥æ”¶åˆ°æ„å›¾ï¼Œå¯ä»¥ä½¿ç”¨getExtras()æ–¹æ³•æ¥è·å–ç”±æºç»„ä»¶å‘é€çš„é™„åŠ æ•°æ®ã€‚ä¾‹å¦‚ï¼š

```java
// åœ¨ä»£ç ä¸­çš„åˆé€‚ä½ç½®è·å–åŒ…å¯¹è±¡
Bundle extras = getIntent().getExtras();

// é€šè¿‡é”®è§£å‹æ•°æ®
String value1 = extras.getString("Key1");
String value2 = extras.getString("Key2");
```

## 6.9 handler ï¼ˆéœ€è¦é‡ç‚¹ç†è§£ï¼‰

### 6.9.1 ä»€ä¹ˆæ˜¯handle?

handleræ˜¯Androidç»™æˆ‘ä»¬æä¾›ç”¨æ¥æ›´æ–°UIçš„ä¸€å¥—æœºåˆ¶ï¼Œä¹Ÿæ˜¯ä¸€å¥—æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®ƒå¤„ç†æ¶ˆæ¯ã€‚

åœ¨å®˜æ–¹çš„æè¿°ä¸­æåˆ°äº†Handlerä¸¤ä¸ªä¸»è¦ä½œç”¨ï¼š

- å»¶æ—¶å¤„ç†æ¶ˆæ¯æˆ–è€…Runnable
- è·¨è¿›ç¨‹é€šä¿¡

**Handlerä¸ä»…å¯ä»¥å®Œæˆä¸»çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä¹Ÿå¯ä»¥åšåˆ°å­çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡**

### 6.9.2  å¯ä»¥ä¸ä½¿ç”¨handleå—ï¼Ÿ

å› ä¸ºandroidåœ¨è®¾è®¡çš„æ—¶å€™å°±å°è£…äº†ä¸€å¥—æ¶ˆæ¯åˆ›å»ºã€ä¼ é€’ã€å¤„ç†ã€‚å¦‚æœä¸éµå¾ªå°±ä¸èƒ½æ›´æ–°UIä¿¡æ¯ï¼Œå°±ä¼šæŠ¥å‡ºå¼‚å¸¸ã€‚

### 6.9.3 å®‰å“ä¸ºä»€ä¹ˆè¦ä½¿ç”¨handle?

æœ€æ ¹æœ¬çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³å¤šçº¿ç¨‹å¹¶å‘çš„é—®é¢˜ï¼

â€‹      æ‰“ä¸ªæ¯”æ–¹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªactivityä¸­æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰åŠ é”ï¼Œå°±ä¼šå‡ºç°ç•Œé¢é”™ä¹±çš„é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœå¯¹è¿™äº›æ›´æ–°UIçš„æ“ä½œéƒ½åŠ é”å¤„ç†ï¼Œåˆä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å¤„äºå¯¹æ€§èƒ½çš„é—®é¢˜è€ƒè™‘ï¼ŒAndroidç»™æˆ‘ä»¬æä¾›è¿™ä¸€å¥—æ›´æ–°UIçš„æœºåˆ¶æˆ‘ä»¬åªéœ€è¦éµå¾ªè¿™ç§æœºåˆ¶å°±è¡Œäº†ã€‚ä¸ç”¨å†å»å…³ç³»å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œæ‰€æœ‰çš„æ›´æ–°UIçš„æ“ä½œï¼Œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»è½®è®­çš„ã€‚

### 6.9.4 Handleçš„å·¥ä½œæœºåˆ¶

- 1.Message æ¶ˆæ¯ï¼Œç†è§£ä¸ºçº¿ç¨‹é—´é€šè®¯çš„æ•°æ®å•å…ƒã€‚ä¾‹å¦‚åå°å­çº¿ç¨‹åœ¨å¤„ç†æ•°æ®å®Œæ¯•åéœ€è¦æ›´æ–°UIï¼Œåˆ™å¯å‘é€ä¸€æ¡åŒ…å«æ›´æ–°ä¿¡æ¯çš„Messageç»™UIçº¿ç¨‹ã€‚
- 2.Message Queue æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾é€šè¿‡Handlerå‘å¸ƒçš„æ¶ˆæ¯ï¼ŒæŒ‰ç…§å…ˆè¿›å…ˆå‡ºæ‰§è¡Œã€‚

- 3.Handleræ˜¯Messageçš„ä¸»è¦å¤„ç†è€…ï¼Œè´Ÿè´£å°†Messageæ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä»¥åŠå¯¹æ¶ˆ- æ¯é˜Ÿåˆ—ä¸­çš„Messageè¿›è¡Œå¤„ç†ã€‚

- 4.Looper å¾ªç¯å™¨ï¼Œæ‰®æ¼”Message Queueå’ŒHandlerä¹‹é—´æ¡¥æ¢çš„è§’è‰²ï¼Œå¾ªç¯å–å‡ºMessage
  Queueé‡Œé¢çš„Messageï¼Œå¹¶äº¤ä»˜ç»™ç›¸åº”çš„Handlerè¿›è¡Œå¤„ç†ã€‚

### 6.9.5 handleræœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ

- ä½¿ç”¨ä¸æ–¹ä¾¿
- å†…å­˜æ³„æ¼

## 6.10 LIfeCycle ï¼ˆç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶ï¼‰ä¸ LiveData

### 6.10.1 LifeCycle

ç®€å•çš„è¯´å°±æ˜¯ç”¨æ¥ç›‘å¬Activityä¸Fragmentçš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨LIfeCycleï¼Ÿ

ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶å¯æ‰§è¡Œæ“ä½œæ¥å“åº”å¦ä¸€ä¸ªç»„ä»¶ï¼ˆå¦‚ Activity å’Œ Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„å˜åŒ–ã€‚è¿™äº›ç»„ä»¶æœ‰åŠ©äºæ‚¨å†™å‡ºæ›´æœ‰æ¡ç†ä¸”å¾€å¾€æ›´ç²¾ç®€çš„ä»£ç ï¼Œè¿™æ ·çš„ä»£ç æ›´æ˜“äºç»´æŠ¤ã€‚

åœ¨å¼€å‘çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™éœ€è¦ç»Ÿè®¡é¡µé¢çš„å‘¨æœŸã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦æŠŠæ‰“å¼€çš„Activityéƒ½ä¿å­˜èµ·æ¥,åœ¨ä¸ä¿®æ”¹baseActivityçš„æ–¹å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨applicationä¸­æ³¨å†Œä¸€ä¸ªç›‘å¬Activityçš„ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ã€‚

ä¸¾ä¸€ä¸‹æˆ‘ä»¬æœ€å¸¸ç”¨çš„ MVP ä¾‹å­ï¼Œæ²¡å¼•è¿› lifecycle ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Activity æˆ–è€… Fragment é”€æ¯çš„æ—¶å€™ï¼Œå³ onDestroy çš„æ—¶å€™æ‰‹åŠ¨è°ƒç”¨ onDestroy æ–¹æ³•ï¼Œè¿™é‡Œä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œæ¯ä¸€æ¬¡åœ¨ Activity æˆ–è€… Fragment é”€æ¯çš„çƒ§å¼€åéƒ½è¦è°ƒç”¨ presenter.destory() æ–¹æ³•ï¼Œè¿™æ ·çš„ä»£ç æ¯ç‡¥ï¼Œæ¯«æ— æ„ä¹‰ã€‚

```java
class MyPresenter{
    public MyPresenter() {
    }

    void create() {
        //do something
    }

    void destroy() {
        //do something
    }
}

class MyActivity extends AppCompatActivity {
    private MyPresenter presenter;

    public void onCreate(...) {
        presenter= new MyPresenter ();
        presenter.create();
    }

    public void onDestroy() {
        super.onDestroy();
        presenter.destory();
    }
}
```

å°ç»“ï¼š

1. lifycycle å…¶å®æ˜¯ç”¨è§‚å¯Ÿè€…æ¨¡å¼å®ç°çš„ï¼Œå½“ Activity ç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„æ—¶å€™ï¼Œé€šçŸ¥ç›¸åº”çš„ Observers å³è§‚å¯Ÿè€…ã€‚
2. ä½¿ç”¨ lifecycleï¼Œæˆ‘ä»¬å¯ä»¥å°†é‡Šæ”¾èµ„æºçš„åŠ¨ä½œå†…èšåœ¨è‡ªèº«ï¼Œå‡å°‘ä¸è°ƒç”¨è€…ä¹‹é—´çš„è€¦åˆã€‚

### 6.10.1 LiveData

LiveData æ˜¯ä¸€ä¸ªå¯ä»¥è¢«è§‚å¯Ÿçš„æ•°æ®æŒæœ‰ç±»ï¼Œå®ƒå¯ä»¥æ„ŸçŸ¥ Activityã€Fragmentæˆ–Service ç­‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚ç®€å•æ¥è¯´ï¼Œä»–ä¸»è¦æœ‰ä¸€ä¸‹ä¼˜ç‚¹ã€‚

å®ƒå¯ä»¥åšåˆ°åœ¨ç»„ä»¶å¤„äºæ¿€æ´»çŠ¶æ€çš„æ—¶å€™æ‰ä¼šå›è°ƒç›¸åº”çš„æ–¹æ³•ï¼Œä»è€Œåˆ·æ–°ç›¸åº”çš„ UIï¼Œä¸ç”¨æ‹…å¿ƒå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚

å½“ config å¯¼è‡´ activity é‡æ–°åˆ›å»ºçš„æ—¶å€™ï¼Œä¸éœ€è¦æ‰‹åŠ¨å–å¤„ç†æ•°æ®çš„å‚¨å­˜å’Œæ¢å¤ã€‚å®ƒå·²ç»å¸®æˆ‘ä»¬å°è£…å¥½äº†ã€‚
å½“ Actiivty ä¸æ˜¯å¤„äºæ¿€æ´»çŠ¶æ€çš„æ—¶å€™ï¼Œå¦‚æœä½ æƒ³ livedata setValue ä¹‹åç«‹å³å›è°ƒ obsever çš„ onChange æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç­‰åˆ° Activity å¤„äºæ¿€æ´»çŠ¶æ€çš„æ—¶å€™æ‰å›è°ƒ obsever çš„ onChange æ–¹æ³•ï¼Œä½ å¯ä»¥ä½¿ç”¨ observeForever æ–¹æ³•ï¼Œä½†æ˜¯ä½ å¿…é¡»åœ¨ onDestroy çš„æ—¶å€™ 

å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œæ˜¯ä¸æ˜¯ç»å¸¸ä¼šç¢°åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œå½“ç½‘ç»œè¯·æ±‚ç»“æœå›æ¥çš„æ—¶å€™ï¼Œä½ ç»å¸¸éœ€è¦åˆ¤æ–­ Activity æˆ–è€… Fragment æ˜¯å¦å·²ç» Destroyï¼Œ å¦‚æœä¸æ˜¯ destroyï¼Œæ‰æ›´æ–° UIã€‚

è€Œå½“ä½ å¦‚æœä½¿ç”¨ Livedata çš„è¯ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨ Activity å¤„äº onStart æˆ–è€… onResume çš„çŠ¶æ€æ—¶ï¼Œä»–æ‰ä¼šè¿›è¡Œç›¸åº”çš„å›è°ƒï¼Œå› è€Œå¯ä»¥å¾ˆå¥½å¾—å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä¸å¿…å†™ä¸€å¤§å †çš„ activity.isDestroyed()ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ LiveData çš„ä½¿ç”¨ã€‚

## 6.11  å®‰å“å¸¸è§çš„è§†å›¾æ§ä»¶ä»¬

### 6.11.1 å®‰å“å¸ƒå±€

Androidä¸­å¸¸ç”¨çš„5å¤§å¸ƒå±€æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- çº¿æ€§å¸ƒå±€ï¼ˆLinearLayoutï¼‰ï¼šæŒ‰ç…§å‚ç›´æˆ–è€…æ°´å¹³æ–¹å‘å¸ƒå±€çš„ç»„ä»¶
- å¸§å¸ƒå±€ï¼ˆFrameLayoutï¼‰ï¼šç»„ä»¶ä»å±å¹•å·¦ä¸Šæ–¹å¸ƒå±€ç»„ä»¶
- è¡¨æ ¼å¸ƒå±€ï¼ˆTableLayoutï¼‰ï¼šæŒ‰ç…§è¡Œåˆ—æ–¹å¼å¸ƒå±€ç»„ä»¶ï¼Œè¡¨æ ¼å¸ƒå±€æ˜¯çº¿æ€§å¸ƒå±€çš„å­ç±»ã€‚
- ç›¸å¯¹å¸ƒå±€ï¼ˆRelativeLayoutï¼‰ï¼šç›¸å¯¹å…¶å®ƒç»„ä»¶çš„å¸ƒå±€æ–¹å¼
- ç»å¯¹å¸ƒå±€ï¼ˆAbsoluteLayoutï¼‰ï¼šæŒ‰ç…§ç»å¯¹åæ ‡æ¥å¸ƒå±€ç»„ä»¶
- ç½‘æ ¼å¸ƒå±€ï¼ˆGridLayoutï¼‰
- ConstraintLayoutï¼ˆçº¦æŸå¸ƒå±€ï¼‰æ–°ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¯ä»¥å®ç°åœ¨è®¾è®¡æ¨¡å¼ä¸­å®ŒæˆUIç»˜åˆ¶ã€‚

éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

å¦‚ä½•åˆ†è¾¨marginä¸padding?

- margin å†…è¾¹è·
- padding å¤–è¾¹è·

## 6.12 äº‹ä»¶åˆ†å‘æœºåˆ¶

## 6.13 Glide ç¼“å­˜æœºåˆ¶



## 6.14 å¯åŠ¨æ¨¡å¼

- standard(é»˜è®¤)
- singleTop
- singleTast
- singleInstance

## 6.15 MVC MCP MVVM

MVPä¸­viewå’Œpresenteräº’ç›¸æ€ä¹ˆè°ƒç”¨ï¼Ÿ

## 6.16 è‡ªå®šä¹‰ç»„ä»¶

## 6.17 ä¾èµ–æ³¨å…¥










# 7.å…¶ä»–

## 7.1 IO

### 7.1.1 Java IO æœ‰å“ªäº›ï¼Ÿ

UNIX ç³»ç»Ÿä¸‹ï¼Œ IO æ¨¡å‹ä¸€å…±æœ‰ 5 ç§ï¼š **åŒæ­¥é˜»å¡ I/O**ã€**åŒæ­¥éé˜»å¡ I/O**ã€**I/O å¤šè·¯å¤ç”¨**ã€**ä¿¡å·é©±åŠ¨ I/O** å’Œ**å¼‚æ­¥ I/O**ã€‚

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„ 5 ç§ IO æ¨¡å‹ã€‚

### 7.1.2 BIO NIO AIOçš„åŒºåˆ«

### BIO (Blocking I/O)

**BIO å±äºåŒæ­¥é˜»å¡ IO æ¨¡å‹** ã€‚

åŒæ­¥é˜»å¡ IO æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºå‘èµ· read è°ƒç”¨åï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚

åœ¨å®¢æˆ·ç«¯è¿æ¥æ•°é‡ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå½“é¢å¯¹åä¸‡ç”šè‡³ç™¾ä¸‡çº§è¿æ¥çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„ BIO æ¨¡å‹æ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„ I/O å¤„ç†æ¨¡å‹æ¥åº”å¯¹æ›´é«˜çš„å¹¶å‘é‡ã€‚

![6a9e704af49b4380bb686f0c96d33b81_tplv-k3u1fbpfcp-watermark.image](./images/6a9e704af49b4380bb686f0c96d33b81_tplv-k3u1fbpfcp-watermark.image)

###  NIO (Non-blocking/New I/O)

Java ä¸­çš„ NIO äº Java 1.4 ä¸­å¼•å…¥ï¼Œå¯¹åº” `java.nio` åŒ…ï¼Œæä¾›äº† `Channel` , `Selector`ï¼Œ`Buffer` ç­‰æŠ½è±¡ã€‚NIO ä¸­çš„ N å¯ä»¥ç†è§£ä¸º Non-blockingï¼Œä¸å•çº¯æ˜¯ Newã€‚å®ƒæ”¯æŒé¢å‘ç¼“å†²çš„ï¼ŒåŸºäºé€šé“çš„ I/O æ“ä½œæ–¹æ³•ã€‚ å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„ï¼ˆç½‘ç»œï¼‰åº”ç”¨ï¼Œåº”ä½¿ç”¨ NIO ã€‚

Java ä¸­çš„ NIO å¯ä»¥çœ‹ä½œæ˜¯ **I/O å¤šè·¯å¤ç”¨æ¨¡å‹**ã€‚ä¹Ÿæœ‰å¾ˆå¤šäººè®¤ä¸ºï¼ŒJava ä¸­çš„ NIO å±äºåŒæ­¥éé˜»å¡ IO æ¨¡å‹ã€‚

è·Ÿç€æˆ‘çš„æ€è·¯å¾€ä¸‹çœ‹çœ‹ï¼Œç›¸ä¿¡ä½ ä¼šå¾—åˆ°ç­”æ¡ˆï¼

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ **åŒæ­¥éé˜»å¡ IO æ¨¡å‹**ã€‚

![bb174e22dbe04bb79fe3fc126aed0c61_tplv-k3u1fbpfcp-watermark.image](./images/bb174e22dbe04bb79fe3fc126aed0c61_tplv-k3u1fbpfcp-watermark.image)



åŒæ­¥éé˜»å¡ IO æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼šä¸€ç›´å‘èµ· read è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„è¿™æ®µæ—¶é—´é‡Œï¼Œçº¿ç¨‹ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œç›´åˆ°åœ¨å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚

ç›¸æ¯”äºåŒæ­¥é˜»å¡ IO æ¨¡å‹ï¼ŒåŒæ­¥éé˜»å¡ IO æ¨¡å‹ç¡®å®æœ‰äº†å¾ˆå¤§æ”¹è¿›ã€‚é€šè¿‡è½®è¯¢æ“ä½œï¼Œé¿å…äº†ä¸€ç›´é˜»å¡ã€‚

ä½†æ˜¯ï¼Œè¿™ç§ IO æ¨¡å‹åŒæ ·å­˜åœ¨é—®é¢˜ï¼š**åº”ç”¨ç¨‹åºä¸æ–­è¿›è¡Œ I/O ç³»ç»Ÿè°ƒç”¨è½®è¯¢æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½çš„è¿‡ç¨‹æ˜¯ååˆ†æ¶ˆè€— CPU èµ„æºçš„ã€‚**

è¿™ä¸ªæ—¶å€™ï¼Œ**I/O å¤šè·¯å¤ç”¨æ¨¡å‹** å°±ä¸Šåœºäº†ã€‚

![88ff862764024c3b8567367df11df6ab_tplv-k3u1fbpfcp-watermark.image](./images/88ff862764024c3b8567367df11df6ab_tplv-k3u1fbpfcp-watermark.image)

IO å¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œçº¿ç¨‹é¦–å…ˆå‘èµ· select è°ƒç”¨ï¼Œè¯¢é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å°±ç»ªï¼Œç­‰å†…æ ¸æŠŠæ•°æ®å‡†å¤‡å¥½äº†ï¼Œç”¨æˆ·çº¿ç¨‹å†å‘èµ· read è°ƒç”¨ã€‚read è°ƒç”¨çš„è¿‡ç¨‹ï¼ˆæ•°æ®ä»å†…æ ¸ç©ºé—´->ç”¨æˆ·ç©ºé—´ï¼‰è¿˜æ˜¯é˜»å¡çš„ã€‚

> ç›®å‰æ”¯æŒ IO å¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ‰ selectï¼Œepoll ç­‰ç­‰ã€‚select ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯ç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿä¸Šéƒ½æœ‰æ”¯æŒ
>
> - **select è°ƒç”¨** ï¼šå†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒæ”¯æŒä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªç³»ç»Ÿè°ƒç”¨çš„å¯ç”¨çŠ¶æ€ã€‚å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒã€‚
> - **epoll è°ƒç”¨** ï¼šlinux 2.6 å†…æ ¸ï¼Œå±äº select è°ƒç”¨çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¼˜åŒ–äº† IO çš„æ‰§è¡Œæ•ˆç‡ã€‚

**IO å¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œé€šè¿‡å‡å°‘æ— æ•ˆçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘äº†å¯¹ CPU èµ„æºçš„æ¶ˆè€—ã€‚**

Java ä¸­çš„ NIO ï¼Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„**é€‰æ‹©å™¨ ( Selector )** çš„æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥è¢«ç§°ä¸º **å¤šè·¯å¤ç”¨å™¨**ã€‚é€šè¿‡å®ƒï¼Œåªéœ€è¦ä¸€ä¸ªçº¿ç¨‹ä¾¿å¯ä»¥ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å½“å®¢æˆ·ç«¯æ•°æ®åˆ°äº†ä¹‹åï¼Œæ‰ä¼šä¸ºå…¶æœåŠ¡ã€‚

<img src="./images/0f483f2437ce4ecdb180134270a00144_tplv-k3u1fbpfcp-watermark.image" alt="0f483f2437ce4ecdb180134270a00144_tplv-k3u1fbpfcp-watermark.image" style="zoom: 25%;" />



###  AIO (Asynchronous I/O)

AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥ IO æ¨¡å‹ã€‚

å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œ

AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥ IO æ¨¡å‹ã€‚

å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œ

![3077e72a1af049559e81d18205b56fd7_tplv-k3u1fbpfcp-watermark.image](./images/3077e72a1af049559e81d18205b56fd7_tplv-k3u1fbpfcp-watermark.image)

ç›®å‰æ¥è¯´ AIO çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ã€‚Netty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚è¿™æ˜¯å› ä¸ºï¼ŒNetty ä½¿ç”¨äº† AIO ä¹‹åï¼Œåœ¨ Linux ç³»ç»Ÿä¸Šçš„æ€§èƒ½å¹¶æ²¡æœ‰å¤šå°‘æå‡ã€‚

æœ€åï¼Œæ¥ä¸€å¼ å›¾ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ Java ä¸­çš„ BIOã€NIOã€AIOã€‚

<img src="./images/33b193457c928ae02217480f994814b6.png" alt="33b193457c928ae02217480f994814b6.png" style="zoom: 50%;" />



### 7.1.3 ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨

### 7.1.4 selectï¼Œpollï¼Œepoll

## 7.2 Linux

å¦‚ä½•ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹CPU/ç£ç›˜/å†…å­˜çš„å ç”¨ï¼Ÿ

top

å¦‚ä½•æ›´è¯¦ç»†æŸ¥çœ‹ç£ç›˜ï¼Ÿ

du/df/free

å¦‚ä½•æŸ¥çœ‹æ—¥å¿—ï¼Ÿ

awk/cat/cut

# 8.ç®—æ³•é¢˜

## 8.1 ç»™å‡ºä¸€ä¸ªæ•°ç»„åˆ¤æ–­æ•°ç»„ä¸­ï¼Œæ˜¯ä¸æ˜¯äºŒå‰æœç´¢æ ‘çš„ååºéå†



